### 24.2 如何创建并执行 Shell 脚本

本节详细介绍了在 Linux 系统中创建并执行一个 Shell 脚本所需要的三个基本步骤：**编写脚本**、**赋予执行权限**、**放置在可被 Shell 找到的位置**。

-----

#### 摘要

##### 1\. 第一步：编写脚本 (脚本文件格式)

  * Shell 脚本是**纯文本文件**，需要使用 `vim`, `gedit`, `nano` 等文本编辑器来创建。
  * 脚本文件必须遵循特定的格式：
      * **Shebang (`#!`)**: 脚本的**第一行必须是 `#!/bin/bash`** (或其他解释器的路径，如 `#!/usr/bin/python`)。这个特殊的 `#!` 符号告诉内核应该使用哪个程序来解释和执行这个脚本。
      * **注释 (`#`)**: 以 `#` 号开头的行是注释，用于给人阅读和理解代码，Shell 会忽略它们。
      * **命令**: 脚本的主体由一系列你平时在终端中输入的普通命令组成（例如 `echo 'Hello World!'`）。

##### 2\. 第二步：设置可执行权限

  * 默认情况下，新创建的文本文件是没有执行权限的，你必须手动添加。
  * 使用 `chmod` 命令来添加执行权限。常用的权限设置有两种：
      * `chmod 755 脚本名`: 脚本所有者可读/写/执行，同组用户和其他用户可读/执行。**（推荐，适用于共享脚本）**
      * `chmod 700 脚本名`: 只有脚本所有者拥有读/写/执行权限。**（适用于私人脚本）**

##### 3\. 第三步：放置脚本并执行

  * **执行方式**:
      * **指定路径执行**: 如果脚本不在 Shell 的搜索路径中，你必须提供它的路径才能执行，例如 `./hello_world` (表示执行当前目录下的 `hello_world`)。
      * **直接按名执行**: 如果想和系统命令（如 `ls`）一样直接输入脚本名就能执行，必须将脚本文件放置在 `$PATH` 环境变量所包含的目录中。
  * **`$PATH` 环境变量**: 这是一个由冒号分隔的目录列表。当你不带路径执行一个命令时，Shell 会自动在这个列表的目录中从左到右依次查找。
  * **脚本的理想位置**:
      * **个人脚本**: 推荐放在用户主目录下的 `bin` 目录，即 **`~/bin`**。大多数 Linux 发行版（如 Ubuntu）会自动将此目录添加到 `$PATH` 中（如果该目录存在）。
      * **系统级脚本 (所有用户)**: `/usr/local/bin`。
      * **系统级脚本 (仅管理员)**: `/usr/local/sbin`。

-----

### 使用案例：创建并运行一个完整的 "Hello World" 脚本

这个案例将带你走完从创建到能直接运行的全部流程。

1.  **第一步：编写脚本文件**
    使用 `nano` 编辑器创建一个名为 `hello_world` 的文件。

    ```bash
    nano hello_world
    ```

    在编辑器中输入以下内容：

    ```bash
    #!/bin/bash
    # 这是一个简单的 Hello World 脚本
    echo "Hello from my first script!"
    ```

    按 `Ctrl+X` -\> `Y` -\> `Enter` 保存并退出。

2.  **第二步：赋予执行权限**

    ```bash
    chmod 755 hello_world
    ```

3.  **第三步：创建 `~/bin` 目录并移动脚本**
    `mkdir -p` 选项能确保在目录不存在时创建它，而已存在时也不会报错。

    ```bash
    mkdir -p ~/bin
    mv hello_world ~/bin
    ```

4.  **第四步：让 `$PATH` 更新生效**
    `~/bin` 目录是新建的，为了让当前 Shell 能立刻找到它，你有两个选择：

      * **方法A (推荐)**: **关闭当前终端，然后重新打开一个新终端**。新终端会自动加载配置，将 `~/bin` 加入 `$PATH`。
      * **方法B**: 使用 `source` 命令立即重载配置文件。
        ```bash
        source ~/.bashrc
        ```

5.  **第五步：在任何位置直接执行脚本**
    现在，无论你当前在哪个目录下，都可以直接通过脚本名来运行它了。

    ```bash
    # 切换到一个完全无关的目录来验证
    cd /tmp

    # 直接输入脚本名执行
    hello_world
    ```

    **预期输出**:

    ```
    Hello from my first script!
    ```

    至此，你就成功地创建并部署了一个可以像系统原生命令一样方便使用的个人脚本。



### 24.3 更多的格式技巧

本节主要介绍了两种在编写 Shell 脚本时可以使用的格式化技巧，其核心目的都是为了**增强脚本的可读性和可维护性**，让脚本逻辑更清晰，便于自己或他人在未来进行修改。

-----

#### 摘要

##### 1\. 使用长选项 (`--long-option`)

  * **区别**: 许多 Linux 命令的选项都有短格式（如 `-a`）和长格式（如 `--all`）两种形式。
  * **使用原则**:
      * **在命令行中**: 为了输入快捷，推荐使用**短选项**。
      * **在 Shell 脚本中**: 为了代码清晰、易于理解，强烈推荐使用**长选项**。长选项本身就具有自解释性，读者无需查阅手册就能明白该选项的作用。
  * **示例**:
      * **命令行 (快捷)**: `ls -ad`
      * **脚本中 (清晰)**: `ls --all --directory`

##### 2\. 使用缩进与续行符 (`\`)

  * **功能**: 对于特别冗长和复杂的单行命令，可以使用**续行符（`\`）将其拆分成多行来书写。续行符必须是一行中最后一个字符**（其后直接就是换行）。
  * **增强可读性**: 结合**缩进**（使用空格或制表符），可以非常清晰地展示出命令的逻辑层次结构，使复杂的命令（如 `find` 的多条件组合）一目了然。
  * **适用场景**: 这个技巧主要用于**脚本编写**。虽然它在命令行中也能工作，但由于输入和编辑不便（且Tab键会触发补全），所以很少在交互式 Shell 中使用。

##### 3\. Vim 脚本编写配置 (附注)

文本附注中提到了一些有用的 Vim 编辑器配置，可以提升脚本编写体验，可将其添加到 `~/.vimrc` 文件中使其永久生效：

  * **`syntax on`**: 启用语法高亮，不同代码元素会显示不同颜色。
  * **`set hlsearch`**: 高亮显示所有搜索匹配项。
  * **`set tabstop=4`**: 将制表符（Tab）的宽度设置为 4 个空格（默认为8），便于排版。
  * **`set autoindent`**: 启用自动缩进，新起一行的缩进会自动与上一行对齐。

-----

### 使用案例：格式化一个复杂的 `find` 命令

这个案例直观地展示了使用续行符和缩进带来的巨大差异。

#### 格式化之前 (单行)

下面这个 `find` 命令功能强大，但挤在一行里，逻辑非常混乱，难以阅读和理解。

```bash
find playground \( -type f -not -perm 0600 -exec chmod 0600 '{}' ';' \) -or \( -type d -not -perm 0700 -exec chmod 0700 '{}' ';' \)
```

#### 格式化之后 (多行 + 缩进)

通过使用续行符 `\` 和缩进，我们将同一个命令改写成如下形式。现在，它的逻辑结构变得异常清晰：首先是 `playground` 目录，然后是一个由 `-or` 连接的两个条件组，每个组内部的条件和操作都一目了然。

```bash
find playground \
    \( \
        -type f \
        -not -perm 0600 \
        -exec chmod 0600 '{}' ';' \
    \) \
    -or \
    \( \
        -type d \
        -not -perm 0700 \
        -exec chmod 0700 '{}' ';' \
    \)
```

这种格式化的代码，无疑大大提升了脚本的**可读性和可维护性**。