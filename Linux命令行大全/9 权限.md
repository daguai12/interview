### 9.1 属主、属组以及其他用户

本节介绍了构成 Linux/UNIX 文件系统安全模型基础的三个核心概念：**属主 (owner)**、**属组 (group)** 和**其他用户 (world/others)**。文件的访问权限正是围绕这三个身份类别来设定的。

***

#### 摘要

##### 1. 三种基本身份

* **属主 (Owner)**: 文件或目录的拥有者，拥有最高控制权。
* **属组 (Group)**: 一个用户的集合。属主可以将文件权限授予其所在的属组，让组内其他成员也能访问。
* **其他用户 (Others/World)**: 系统上除了属主和属组成员之外的所有用户。

##### 2. 查看用户身份 (`id` 命令)

* 可以使用 `id` 命令来查看当前用户的身份信息。
* 输出内容包括：
    * **uid (User ID)**: 用户的唯一数字标识。
    * **gid (Group ID)**: 用户所属**主组**的唯一数字标识。
    * **groups**: 用户所属的所有组的列表。
* 不同的 Linux 发行版（如 Fedora 和 Ubuntu）在 uid/gid 的起始编号和默认所属组方面可能存在差异。

##### 3. 身份信息的存储位置

系统中的用户和组信息主要存储在以下几个文本文件中：

* **/etc/passwd**: 定义用户账户信息，包括用户名、uid、gid、主目录、登录 Shell 等。
* **/etc/group**: 定义用户组及其成员。
* **/etc/shadow**: 存储用户的加密密码信息，与前两个文件关联。

##### 4. 现代 Linux 的用户组策略

与过去将所有普通用户都放入一个通用组（如 `users` 组）的做法不同，现代 Linux 发行版普遍采用一种更安全的策略：**在创建新用户时，会自动创建一个与该用户名同名的、仅包含该用户的私有组**。这种方式使得权限管理更为灵活和安全。


### 9.2 读取、写入和执行

本节详细阐述了 Linux 文件系统的核心权限机制，即**读取 (read)**、**写入 (write)** 和**执行 (execute)**。这些权限可以分别对**属主 (owner)**、**属组 (group)** 和**其他用户 (others)**进行设置。

***

#### 摘要

##### 1. 理解权限字符串

通过 `ls -l` 命令可以看到一个 10 个字符的权限字符串，例如 `-rwxr-xr--`。

* **第 1 个字符**: 文件类型，常见类型包括：
    * `-`: 普通文件
    * `d`: 目录
    * `l`: 符号链接
* **后 9 个字符**: 文件模式，分为三组，每组三个字符 (`rwx`)：
    * **第 1-3 位**: **属主**的权限。
    * **第 4-6 位**: **属组**的权限。
    * **第 7-9 位**: **其他用户**的权限。

##### 2. 权限的含义

`r`、`w`、`x` 权限对**文件**和**目录**的意义不同：

| 权限 | 对文件的作用 | 对目录的作用 |
| :--- | :--- | :--- |
| **r (读取)** | 允许读取文件内容。 | 允许列出目录中的文件名 (需配合 `x` 权限)。 |
| **w (写入)** | 允许修改文件内容。 | 允许在目录中创建、删除、重命名文件 (需配合 `x` 权限)。 |
| **x (执行)** | 允许作为程序执行。 | 允许进入 (cd) 该目录。 |

##### 3. `chmod` - 修改权限

`chmod` 命令用于修改文件或目录的权限，只有文件属主或超级用户才能使用。它支持两种模式：

* **八进制表示法 (Octal Notation)**: 使用 3 个八进制数字来分别定义属主、属组和其他用户的权限。每个数字是 r(4)、w(2)、x(1) 权限值的总和。
    * **常用组合**: `7`(rwx), `6`(rw-), `5`(r-x), `4`(r--), `0`(---)
    * **使用案例**: `chmod 640 myfile.txt` (属主 rw-, 属组 r--, 其他人 ---)

* **符号表示法 (Symbolic Notation)**: 通过 `u` (属主), `g` (属组), `o` (其他人), `a` (所有人) 结合 `+` (添加), `-` (移除), `=` (精确设置) 和 `r`, `w`, `x` 来修改权限。
    * **使用案例**: `chmod u+x,g-w myfile.txt` (为属主添加执行权限，移除属组的写入权限)。

##### 4. `umask` - 设置默认权限

`umask` 命令用于设置新建文件和目录时的**默认权限掩码**。这个掩码定义了需要从完整权限中**移除**的权限。

* **工作原理**: 系统先假定一个基础权限（文件为 `666`，目录为 `777`），然后减去 umask 值。例如，`umask 0022` 会从属组和其他用户的权限中移除写入 (`w`) 权限。
* **使用案例**: `umask 0002` (这是常见的默认值)。

##### 5. 特殊权限

除了 `rwx`，还有三种特殊权限，它们通过第 4 个八进制数字或特定符号来设置：

* **setuid (`4` 或 `u+s`)**: 应用于可执行文件时，任何用户执行该程序时都将临时拥有**文件属主**的权限。
* **setgid (`2` 或 `g+s`)**: 应用于可执行文件时，程序将以**文件属组**的权限运行。应用于目录时，在该目录中创建的新文件将自动继承该**目录的属组**。
* **粘滞位 (Sticky Bit) (`1` 或 `+t`)**: 应用于目录时，只有目录所有者、文件所有者或超级用户才能删除或重命名该目录下的文件（常用于 `/tmp` 目录）。


### 9.3 改变用户身份

本节主要介绍了在 Linux 系统中临时改变用户身份的几种方法，这对于执行需要特定权限（尤其是超级用户权限）的管理任务至关重要。

***

#### 摘要

##### 1. `su` - 切换用户

`su` (substitute user) 命令用于启动一个属于其他用户的新 Shell 会话。

* **功能**: 允许你完全“变成”另一个用户，包括加载其环境变量。
* **常用语法**:
    * `su - [用户名]`: 启动一个指定用户的**登录 Shell**。`-` 选项 (等同于 `-l`) 非常重要，它会加载目标用户的完整环境并切换到其主目录。如果省略用户名，则默认为 `root` 用户。
    * `su -c 'command'`: 以其他用户身份仅执行单个命令，而不启动交互式 Shell。
* **认证方式**: 需要输入**目标用户**的密码（例如，切换到 root 需要输入 root 的密码）。

##### 2. `sudo` - 以其他用户身份执行命令

`sudo` (superuser do) 命令提供了一种更安全、更可控的方式来以其他用户（通常是 `root`）的身份执行命令。

* **功能**: 无需启动新 Shell，仅对当前命令授予特权。其权限由 `/etc/sudoers` 文件精确配置，可以限制特定用户只能执行特定的命令。
* **常用语法**:
    * `sudo command`: 以特权身份执行 `command`。
    * `sudo -l`: 列出当前用户被授权可以使用的 `sudo` 命令。
    * `sudo -i`: 启动一个交互式的超级用户 Shell，效果类似于 `su -`。
* **认证方式**: 需要输入**当前用户自己**的密码，而不是 root 密码。这避免了 root 密码的泄露。
* **发行版策略**: 像 Ubuntu 这样的现代发行版，默认禁用 root 账户的直接登录，并强制使用 `sudo` 来执行所有管理任务，这被认为是一种更安全的实践。

##### 3. `chown` 和 `chgrp` - 更改文件所有权

* **`chown` (change owner)**: 用于更改文件或目录的**属主**和**属组**。这是一个需要超级用户权限才能执行的命令。
    * **语法**: `chown [属主][:[属组]] 文件名`
    * **示例**:
        * `sudo chown bob:users myfile.txt`: 将文件的属主改为 `bob`，属组改为 `users`。
        * `sudo chown tony: myfile.txt`: 将文件的属主改为 `tony`，属组改为 `tony` 的默认登录组。
* **`chgrp` (change group)**: 一个功能更单一的旧命令，专门用于更改文件的属组。现在 `chown` 命令通常可以完全替代它。


### 9.3 改变用户身份

本节主要介绍了在 Linux 系统中临时改变用户身份的几种方法，这对于执行需要特定权限（尤其是超级用户权限）的管理任务至关重要。

***

#### 摘要

##### 1. `su` - 切换用户

`su` (substitute user) 命令用于启动一个属于其他用户的新 Shell 会话。

* **功能**: 允许你完全“变成”另一个用户，包括加载其环境变量。
* **常用语法**:
    * `su - [用户名]`: 启动一个指定用户的**登录 Shell**。`-` 选项 (等同于 `-l`) 非常重要，它会加载目标用户的完整环境并切换到其主目录。如果省略用户名，则默认为 `root` 用户。
    * `su -c 'command'`: 以其他用户身份仅执行单个命令，而不启动交互式 Shell。
* **认证方式**: 需要输入**目标用户**的密码（例如，切换到 root 需要输入 root 的密码）。

##### 2. `sudo` - 以其他用户身份执行命令

`sudo` (superuser do) 命令提供了一种更安全、更可控的方式来以其他用户（通常是 `root`）的身份执行命令。

* **功能**: 无需启动新 Shell，仅对当前命令授予特权。其权限由 `/etc/sudoers` 文件精确配置，可以限制特定用户只能执行特定的命令。
* **常用语法**:
    * `sudo command`: 以特权身份执行 `command`。
    * `sudo -l`: 列出当前用户被授权可以使用的 `sudo` 命令。
    * `sudo -i`: 启动一个交互式的超级用户 Shell，效果类似于 `su -`。
* **认证方式**: 需要输入**当前用户自己**的密码，而不是 root 密码。这避免了 root 密码的泄露。
* **发行版策略**: 像 Ubuntu 这样的现代发行版，默认禁用 root 账户的直接登录，并强制使用 `sudo` 来执行所有管理任务，这被认为是一种更安全的实践。

##### 3. `chown` 和 `chgrp` - 更改文件所有权

* **`chown` (change owner)**: 用于更改文件或目录的**属主**和**属组**。这是一个需要超级用户权限才能执行的命令。
    * **语法**: `chown [属主][:[属组]] 文件名`
    * **示例**:
        * `sudo chown bob:users myfile.txt`: 将文件的属主改为 `bob`，属组改为 `users`。
        * `sudo chown tony: myfile.txt`: 将文件的属主改为 `tony`，属组改为 `tony` 的默认登录组。
* **`chgrp` (change group)**: 一个功能更单一的旧命令，专门用于更改文件的属组。现在 `chown` 命令通常可以完全替代它。


### 9.4 行使权限

本节通过一个完整且常见的实际案例——**设置一个供多用户使用的共享目录**——来演示如何综合运用前面章节学到的权限管理知识。

***

#### 摘要

该案例的目标是为用户 `Bill` 和 `Karen` 创建一个共享音乐目录 `/usr/local/share/Music`，使两人都能在该目录中自由地创建和修改文件及子目录。拥有 `sudo` 权限的 `Bill` 执行了以下步骤：

1.  **创建用户组**:
    * 首先，创建一个名为 `music` 的新用户组，并将 `Bill` 和 `Karen` 都添加为该组的成员。

2.  **创建目录并设置基本权限**:
    * 使用 `sudo mkdir` 创建目录。此时目录的属主和属组都为 `root`。
    * 使用 `sudo chown :music ...` 将目录的**属组**更改为 `music`。
    * 使用 `sudo chmod 775 ...` 赋予目录 `drwxrwxr-x` 权限，使得 `music` 组的成员可以在其中创建文件。

3.  **解决新建文件的继承问题 (核心步骤)**:
    经过上述步骤后，仍然存在两个问题：
    * **问题一 (属组继承)**: 用户新建的文件，其属组默认是用户自己的主组（如 `bill` 组），而不是共享的 `music` 组。
    * **问题二 (默认权限)**: 默认的 `umask` (如 `0022`) 会导致新建的文件没有属组写入权限 (`-rw-r--r--`)。

    为了解决这两个问题，`Bill` 采取了以下措施：
    * **解决方案一 (设置 `setgid` 位)**: 对共享目录执行 `sudo chmod g+s /usr/local/share/Music`。设置 `setgid` 位后，在该目录下创建的所有新文件和子目录都将自动**继承父目录的属组**（即 `music` 组）。
    * **解决方案二 (修改 `umask`)**: 用户将自己的 `umask` 临时设置为 `0002`。这样，新建的文件将拥有 `rw-rw-r--` 权限，新目录将拥有 `rwxrwxr-x` 权限，确保了属组成员的可写权限。

4.  **验证结果**:
    * 完成以上配置后，`Bill` 创建的测试文件和目录，其属组正确地设置为 `music`，并且权限也允许组内其他成员（如 `Karen`）进行写入操作，成功实现了共享目录的目标。

**结论**: 正确配置共享目录不仅需要设置目录本身的权限 (`chmod 775`) 和归属 (`chown`)，还必须通过设置 `setgid` 位来保证新建文件的属组继承，并通过调整 `umask` 来确保新建文件具有正确的默认权限。


### 9.5 修改密码

本节介绍了在 Linux 系统中用于修改用户密码的 `passwd` 命令。

***

#### 摘要

##### 1. 修改自己的密码

* **命令**: 普通用户在终端中直接输入 `passwd` 并按回车。
* **流程**: 系统会提示用户：
    1.  输入当前的旧密码以进行验证。
    2.  输入新密码。
    3.  再次输入新密码以进行确认。
* **密码策略**: `passwd` 命令会强制执行“强密码”策略，拒绝接受以下类型的密码：
    * 过于简短的密码。
    * 与旧密码过于相似的密码。
    * 基于字典词汇的密码。
    * 其他容易被猜到的组合。

##### 2. 为其他用户修改密码 (超级用户权限)

* **命令**: 如果拥有超级用户权限，可以使用 `passwd [用户名]` 的格式为指定用户设置新密码。
* **特点**:
    * 超级用户在为他人重置密码时，**无需输入**该用户的旧密码。
    * 超级用户通常可以绕过强密码策略的限制。
* **其他功能**: 超级用户还可以使用 `passwd` 命令的其他选项来执行高级管理任务，例如锁定用户账户或设置密码过期策略。详情可查阅 `passwd` 的手册页。