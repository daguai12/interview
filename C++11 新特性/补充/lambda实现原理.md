å¥½é—®é¢˜ ğŸ‘ã€‚
C++ çš„ **lambda è¡¨è¾¾å¼**ï¼ˆåŒ¿åå‡½æ•°ï¼‰åœ¨è¯­æ³•ä¸Šå¾ˆç®€å•ï¼Œä½†æ˜¯èƒŒåå®ç°éå¸¸ç²¾å·§ã€‚æˆ‘ä»¬æ¥é€å±‚å‰–æä¸€ä¸‹å®ƒçš„å®ç°åŸç†ã€‚

---

## 1. Lambda çš„æœ¬è´¨

**Lambda æ˜¯ç¼–è¯‘å™¨ç”Ÿæˆçš„ä¸€ä¸ªâ€œåŒ¿åç±»â€çš„å®ä¾‹ã€‚**

* å½“ä½ å†™ä¸€ä¸ª `[](){ ... }` çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªç±»ï¼ˆclosure typeï¼Œé—­åŒ…ç±»å‹ï¼‰ã€‚
* è¿™ä¸ªç±»é‡è½½äº† `operator()`ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ª **ä»¿å‡½æ•°å¯¹è±¡**ï¼ˆfunction objectï¼‰ã€‚
* æ•è·çš„å˜é‡ä¼šè¢«ç¼–è¯‘å™¨ç¿»è¯‘æˆè¿™ä¸ªç±»çš„ **æˆå‘˜å˜é‡**ã€‚

---

## 2. ä¸€ä¸ªä¾‹å­

ä»£ç ï¼š

```cpp
int x = 42;
auto f = [x](int y) { return x + y; };
```

ç¼–è¯‘å™¨ä¼šç”Ÿæˆç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼ˆä¼ªä»£ç ï¼Œæ ‡å‡†é‡Œæè¿°çš„å®ç°æœºç†ï¼‰ï¼š

```cpp
// ç”Ÿæˆä¸€ä¸ªåŒ¿åç±»
class __Lambda_1 {
    int x;   // æ•è·å˜é‡ x

public:
    __Lambda_1(int x_) : x(x_) {}

    int operator()(int y) const {
        return x + y;
    }
};

// f å°±æ˜¯è¿™ä¸ªç±»çš„ä¸€ä¸ªå¯¹è±¡
__Lambda_1 f = __Lambda_1(x);
```

æ‰€ä»¥ `f(10)` æœ€ç»ˆå°±æ˜¯è°ƒç”¨ `f.operator()(10)`ï¼Œç»“æœ `52`ã€‚

---

## 3. æ•è·çš„ä¸åŒæ–¹å¼

æ•è·æ–¹å¼å¯¹åº”æˆå‘˜å˜é‡çš„ä¸åŒå®ç°ï¼š

### (1) æŒ‰å€¼æ•è· `[x]`

```cpp
int x = 42;
auto f = [x]() { return x; };
```

è½¬åŒ–ä¸ºï¼š

```cpp
class __Lambda {
    int x;  // æˆå‘˜å˜é‡ï¼Œæ‹·è´äº†ä¸€ä»½
public:
    __Lambda(int _x): x(_x) {}
    int operator()() const { return x; }
};
```

### (2) æŒ‰å¼•ç”¨æ•è· `[&x]`

```cpp
int x = 42;
auto f = [&x]() { return x; };
```

è½¬åŒ–ä¸ºï¼š

```cpp
class __Lambda {
    int& x; // æˆå‘˜å˜é‡ï¼Œä¿å­˜å¼•ç”¨
public:
    __Lambda(int& _x): x(_x) {}
    int operator()() const { return x; }
};
```

### (3) æ•è·æ‰€æœ‰å˜é‡ `[=]` / `[&]`

* `[=]` â†’ æŒ‰å€¼æ•è·å½“å‰ä½œç”¨åŸŸé‡Œç”¨åˆ°çš„å˜é‡
* `[&]` â†’ æŒ‰å¼•ç”¨æ•è·å½“å‰ä½œç”¨åŸŸé‡Œç”¨åˆ°çš„å˜é‡

å®é™…ä¸Šå°±æ˜¯ç¼–è¯‘å™¨å¸®ä½ æŠŠæ‰€æœ‰ç”¨åˆ°çš„å˜é‡éƒ½æ”¾åˆ°é—­åŒ…ç±»çš„æˆå‘˜é‡Œã€‚

---

## 4. `mutable` çš„ä½œç”¨

é»˜è®¤æƒ…å†µä¸‹ï¼Œlambda çš„ `operator()` æ˜¯ `const` çš„ï¼š

```cpp
auto f = [x]() { x++; }; // âŒ é”™è¯¯
```

è¿™æ˜¯å› ä¸ºç¼–è¯‘å™¨ç”Ÿæˆçš„ `operator()` é»˜è®¤æ˜¯ï¼š

```cpp
int operator()() const { ... }  // const é™å®š
```

åŠ ä¸Š `mutable` å°±å˜æˆäº†ï¼š

```cpp
auto f = [x]() mutable { x++; }; // âœ…
```

å¯¹åº”çš„ç”Ÿæˆä»£ç ï¼š

```cpp
int operator()() { x++; }  // é const
```

---

## 5. Lambda ä¸å‡½æ•°æŒ‡é’ˆçš„å…³ç³»

ä¸€ä¸ª lambda å¯ä»¥è½¬æ¢æˆå‡½æ•°æŒ‡é’ˆï¼Œå‰ææ˜¯ **æ²¡æœ‰æ•è·**ï¼š

```cpp
auto f = [](int a, int b){ return a + b; };
int (*fp)(int,int) = f;  // OK
```

åŸç†ï¼š

* æ²¡æœ‰æ•è·æ—¶ï¼Œlambda ç”Ÿæˆçš„ç±»æ²¡æœ‰æˆå‘˜å˜é‡ï¼Œ`operator()` æ˜¯ `static` çš„ï¼Œç¼–è¯‘å™¨å¯ä»¥è‡ªåŠ¨è½¬æˆå‡½æ•°æŒ‡é’ˆã€‚
* å¦‚æœæœ‰æ•è·ï¼Œé‚£å°±å¿…é¡»å­˜å‚¨ç¯å¢ƒ â†’ æ— æ³•è½¬ä¸ºæ™®é€šå‡½æ•°æŒ‡é’ˆï¼ˆåªèƒ½è½¬ä¸º `std::function` æˆ–ä¿æŒä¸ºé—­åŒ…å¯¹è±¡ï¼‰ã€‚

---

## 6. Lambda ä¸ `std::function`

```cpp
std::function<int(int)> f = [x](int y) { return x + y; };
```

è¿™é‡Œä¼šå‘ç”Ÿï¼š

1. ç¼–è¯‘å™¨ç”Ÿæˆé—­åŒ…ç±» `__Lambda`ã€‚
2. æ„é€ ä¸€ä¸ª `std::function<int(int)>`ï¼Œé‡Œé¢ä¿å­˜ä¸€ä¸ª type-erased çš„å‡½æ•°æŒ‡é’ˆå’Œå¯¹è±¡æŒ‡é’ˆï¼ŒæŒ‡å‘ `__Lambda`ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ `std::function` çš„æ€§èƒ½ä¼šæ¯”ç›´æ¥ç”¨é—­åŒ…å¯¹è±¡æ…¢ä¸€ç‚¹ï¼ˆå› ä¸ºæœ‰é¢å¤–çš„ç±»å‹æ“¦é™¤å’ŒåŠ¨æ€åˆ†å‘å¼€é”€ï¼‰ã€‚

---

## 7. Lambda çš„å­˜å‚¨å¤§å°

æ•è·çš„å˜é‡å†³å®šäº†é—­åŒ…å¯¹è±¡çš„å¤§å°ï¼š

```cpp
[]{}                   // sizeof = 1ï¼ˆç©ºç±»ä¼˜åŒ–ï¼‰
[x]{}                  // sizeof = sizeof(int)
[x, y]{}               // sizeof = sizeof(int)*2
[&x]{}                 // sizeof = sizeof(int*)
```

æ‰€ä»¥ lambda æœ¬è´¨å°±æ˜¯ä¸€ä¸ªå¸¦ `operator()` çš„â€œå°å¯¹è±¡â€ã€‚

---

## 8. æ€»ç»“

lambda çš„å®ç°æœºåˆ¶å¯ä»¥æ€»ç»“ä¸ºï¼š

1. **è¯­æ³•ç³–** â†’ ç¼–è¯‘å™¨ç”Ÿæˆä¸€ä¸ªåŒ¿åç±»ï¼ˆé—­åŒ…ç±»å‹ï¼‰ã€‚
2. **æ•è·å˜é‡** â†’ è½¬åŒ–ä¸ºé—­åŒ…ç±»çš„æˆå‘˜å˜é‡ã€‚
3. **å‡½æ•°ä½“** â†’ è½¬åŒ–ä¸º `operator()` çš„å®ç°ã€‚
4. **è°ƒç”¨ lambda** â†’ å®é™…å°±æ˜¯è°ƒç”¨é—­åŒ…å¯¹è±¡çš„ `operator()`ã€‚
5. **æ— æ•è· lambda** â†’ å¯ä»¥é€€åŒ–ä¸ºæ™®é€šå‡½æ•°æŒ‡é’ˆã€‚
6. **æœ‰æ•è· lambda** â†’ åªèƒ½ä½œä¸ºé—­åŒ…å¯¹è±¡ä½¿ç”¨ï¼Œæˆ–è€…åŒ…è£…è¿› `std::function`ã€‚

---

è¦ä¸è¦æˆ‘å¸®ä½ ç”»ä¸€å¼  **lambda è½¬æ¢æˆç±»çš„å®Œæ•´ç¤ºæ„å›¾ï¼ˆåŒ…å«ä¸åŒæ•è·æ¨¡å¼ã€operator()ã€mutable ç­‰ï¼‰**ï¼Œè¿™æ ·ä½ èƒ½ä¸€çœ¼çœ‹å‡ºæ‰€æœ‰è¯­æ³•ç³–å’Œç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç å…³ç³»ï¼Ÿ



## æ•è·\*thiså’Œthis

å¥½é—®é¢˜ ğŸ‘ã€‚
ä½ é—®çš„æ˜¯ **æ•è· `*this` å’Œæ•è· `this`** çš„åŒºåˆ«ï¼Œå®ƒä»¬ç¡®å®å¾ˆå®¹æ˜“æ··æ·†ã€‚æˆ‘ä»¬é€æ­¥æ‹†å¼€çœ‹ï¼š

---

## 1. æ•è· `this`

åœ¨ C++11 èµ·ï¼Œlambda é‡Œå¯ä»¥æ•è· `this` æŒ‡é’ˆï¼š

```cpp
struct Foo {
    int x = 42;
    auto getLambda() {
        return [this]() { return x; };  // æ•è· this
    }
};
```

ç¼–è¯‘å™¨å¤§æ¦‚ä¼šç”Ÿæˆè¿™æ ·çš„é—­åŒ…ç±»ï¼š

```cpp
class __Lambda {
    Foo* this_ptr;  // æˆå‘˜å˜é‡ï¼Œä¿å­˜ this æŒ‡é’ˆ
public:
    __Lambda(Foo* p): this_ptr(p) {}
    int operator()() const {
        return this_ptr->x;  // é€šè¿‡ this æŒ‡é’ˆè®¿é—®
    }
};
```

ç‰¹ç‚¹ï¼š

* æ•è·çš„æ˜¯ **æŒ‡é’ˆ**ï¼Œæ‰€ä»¥é—­åŒ…å¯¹è±¡å†…éƒ¨åªå­˜ `Foo*`ã€‚
* Lambda å’ŒåŸå§‹å¯¹è±¡ä¹‹é—´ **æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š

  * å¦‚æœ `Foo` å·²ç»ææ„ï¼Œè°ƒç”¨è¿™ä¸ª lambda ä¼šå¯¼è‡´æ‚¬ç©ºæŒ‡é’ˆã€‚
* å¯ä»¥ä¿®æ”¹ `Foo` çš„æˆå‘˜ï¼ˆå¦‚æœ `operator()` ä¸æ˜¯ `const` æˆ–ç”¨ `mutable`ï¼‰ã€‚

---

## 2. æ•è· `*this`

ä» **C++17** å¼€å§‹ï¼Œå¯ä»¥æ•è· `*this`ï¼š

```cpp
struct Foo {
    int x = 42;
    auto getLambda() {
        return [*this]() { return x; };  // æ•è· *this
    }
};
```

ç¼–è¯‘å™¨å¤§æ¦‚ä¼šç”Ÿæˆè¿™æ ·çš„é—­åŒ…ç±»ï¼š

```cpp
class __Lambda {
    Foo this_copy;  // æˆå‘˜å˜é‡ï¼Œå­˜çš„æ˜¯å¯¹è±¡çš„æ‹·è´
public:
    __Lambda(const Foo& obj): this_copy(obj) {}
    int operator()() const {
        return this_copy.x;  // è®¿é—®æ‹·è´
    }
};
```

ç‰¹ç‚¹ï¼š

* æ•è·çš„æ˜¯ **å¯¹è±¡å‰¯æœ¬**ï¼ˆé€šè¿‡æ‹·è´æ„é€ æˆ–ç§»åŠ¨æ„é€ ï¼‰ã€‚
* é—­åŒ…é‡Œå­˜äº†ä¸€ä»½å®Œæ•´çš„ `Foo`ï¼Œè€Œä¸æ˜¯æŒ‡é’ˆã€‚
* Lambda ä¸ä¾èµ–åŸå§‹å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸ä¼šæ‚¬æŒ‚ã€‚
* ä»£ä»·æ˜¯ï¼šå¦‚æœ `Foo` å¾ˆå¤§ï¼Œæ‹·è´å¼€é”€å¯èƒ½æ¯”è¾ƒé«˜ã€‚

---

## 3. ä¸¾ä¸ªä¾‹å­æ¥å¯¹æ¯”

```cpp
#include <iostream>
#include <functional>

struct Foo {
    int x;
    auto getLambdaThis() {
        return [this]() { return x; };  // æ•è· this æŒ‡é’ˆ
    }
    auto getLambdaStarThis() {
        return [*this]() { return x; }; // æ•è· this å¯¹è±¡å‰¯æœ¬
    }
};

int main() {
    Foo foo{42};

    auto f1 = foo.getLambdaThis();
    auto f2 = foo.getLambdaStarThis();

    foo.x = 100;

    std::cout << f1() << "\n";  // 100ï¼Œå¼•ç”¨åŸå¯¹è±¡
    std::cout << f2() << "\n";  // 42ï¼Œæ‹·è´å‰¯æœ¬
}
```

ç»“æœï¼š

* `f1()` è®¿é—®çš„æ˜¯åŸå¯¹è±¡ â†’ è¾“å‡º `100`ã€‚
* `f2()` è®¿é—®çš„æ˜¯æ•è·æ—¶çš„æ‹·è´ â†’ è¾“å‡º `42`ã€‚

---

## 4. æ›´ç›´è§‚çš„å¯¹æ¯”è¡¨

| æ•è·æ–¹å¼      | ä¿å­˜çš„å†…å®¹     | ç”Ÿå‘½å‘¨æœŸä¾èµ–  | è¡Œä¸ºç‰¹ç‚¹        |
| --------- | --------- | ------- | ----------- |
| `[this]`  | `Foo*` æŒ‡é’ˆ | ä¾èµ–åŸå¯¹è±¡å­˜æ´» | ä¿®æ”¹åŸå¯¹è±¡ï¼Œæ‚¬æŒ‚é£é™©  |
| `[*this]` | `Foo` çš„å‰¯æœ¬ | ä¸åŸå¯¹è±¡æ— å…³  | ä¸ä¼šæ‚¬æŒ‚ï¼Œä½†æœ‰æ‹·è´å¼€é”€ |

---

## 5. å°ç»“

* **`[this]`**ï¼šæ•è· `this` æŒ‡é’ˆï¼Œè®¿é—®åŸå§‹å¯¹è±¡ â†’ é«˜æ•ˆï¼Œä½†æœ‰æ‚¬æŒ‚é£é™©ã€‚
* **`[*this]`**ï¼ˆC++17 æ–°ç‰¹æ€§ï¼‰ï¼šæ•è·å¯¹è±¡å‰¯æœ¬ï¼Œlambda é‡Œç”¨çš„æ˜¯å‰¯æœ¬ â†’ å®‰å…¨ï¼Œä½†å¯èƒ½æœ‰æ‹·è´å¼€é”€ã€‚

---

è¦ä¸è¦æˆ‘å¸®ä½ ç”»ä¸€ä¸ª **å†…å­˜ç¤ºæ„å›¾**ï¼Œå¯¹æ¯” `[this]` å’Œ `[*this]` æ—¶é—­åŒ…å¯¹è±¡é‡Œé¢åˆ°åº•å­˜äº†ä»€ä¹ˆå­—æ®µï¼Œä»¥åŠè°ƒç”¨æ—¶è®¿é—®é“¾è·¯çš„åŒºåˆ«ï¼Ÿ


