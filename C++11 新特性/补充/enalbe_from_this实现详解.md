è¿™æ˜¯ä¸ªå¾ˆç»å…¸ä½†å®¹æ˜“è®©äººç–‘æƒ‘çš„é—®é¢˜ ğŸ‘
æˆ‘ä»¬æ¥é€å±‚æ‹†å¼€è§£é‡Š `std::enable_shared_from_this` ä¸ºä»€ä¹ˆè¦ä¾èµ– `weak_ptr`ï¼Œä»¥åŠå®ƒæ˜¯æ€ä¹ˆä¿è¯ä½ è°ƒç”¨ `shared_from_this()` å¾—åˆ°çš„ `shared_ptr` ä¸å¤–éƒ¨çš„ `shared_ptr` å…±äº«åŒä¸€ä¸ªæ§åˆ¶å—çš„ã€‚

---

## 1. é—®é¢˜èƒŒæ™¯

åœ¨ C++11 ä¹‹å‰ï¼Œå¾ˆå¤šäººä¼šåœ¨ç±»é‡Œé¢ç›´æ¥ä¿å­˜ä¸€ä¸ª `std::shared_ptr<T> self;` æ¥ä¿è¯è‡ªå·±åœ¨ç”¨æ—¶ä¸è¢«é”€æ¯ã€‚ä½†è¿™æ ·ä¼šå¯¼è‡´ **å¾ªç¯å¼•ç”¨**ï¼ˆå¯¹è±¡å†…éƒ¨æŒæœ‰ä¸€ä¸ª `shared_ptr` æŒ‡å‘è‡ªå·±ï¼‰ï¼Œå¯¹è±¡æ°¸è¿œä¸ä¼šææ„ã€‚

äºæ˜¯ï¼Œæ ‡å‡†åº“æä¾›äº† `std::enable_shared_from_this<T>`ï¼š

* è®©å¯¹è±¡å†…éƒ¨èƒ½å®‰å…¨åœ°æ‹¿åˆ°ä¸€ä¸ª `shared_ptr<T>` æŒ‡å‘è‡ªå·±ï¼›
* é¿å…å¾ªç¯å¼•ç”¨ï¼›
* å¹¶ä¸”è¿™ä¸ª `shared_ptr` å¿…é¡»å’Œå¤–éƒ¨çš„ `shared_ptr` å…±äº«åŒä¸€ä¸ª **æ§åˆ¶å—**ã€‚

---

## 2. æ§åˆ¶å—ï¼ˆcontrol blockï¼‰

`shared_ptr` çš„æ ¸å¿ƒæ˜¯ **æ§åˆ¶å—**ï¼Œå®ƒé‡Œé¢ä¿å­˜ï¼š

* **å¼ºå¼•ç”¨è®¡æ•°**ï¼ˆshared countï¼‰
* **å¼±å¼•ç”¨è®¡æ•°**ï¼ˆweak countï¼‰
* **å¯¹è±¡æŒ‡é’ˆ/é”€æ¯å™¨ç­‰å…ƒä¿¡æ¯**

ä¸åŒçš„ `shared_ptr` å¦‚æœæœ‰ä¸åŒçš„æ§åˆ¶å—ï¼Œå°±åƒæ˜¯ä¸¤ä¸ªå­¤ç«‹çš„è®¡æ•°å™¨ï¼Œç”Ÿå‘½å‘¨æœŸå°±åˆ†è£‚äº†ï¼Œè¿™ä¼šå¯¼è‡´**é‡å¤ææ„**æˆ–**æ‚¬æŒ‚æŒ‡é’ˆ**ã€‚
æ‰€ä»¥ **`shared_from_this()` å¿…é¡»ç¡®ä¿è¿”å›çš„ `shared_ptr` å’Œå¤–éƒ¨ä¼ è¿›æ¥çš„ `shared_ptr` å…±ç”¨åŒä¸€ä¸ªæ§åˆ¶å—**ã€‚

---

## 3. `enable_shared_from_this` çš„å…³é”®æœºåˆ¶

æ ¸å¿ƒæ€æƒ³ï¼š

* ç±» `enable_shared_from_this<T>` å†…éƒ¨æœ‰ä¸€ä¸ª `mutable weak_ptr<T> _weak_this;`
* å½“å¤–éƒ¨æœ‰äººç”¨ `shared_ptr<T>` ç®¡ç† `T` å¯¹è±¡æ—¶ï¼Œæ„é€  `shared_ptr` çš„æ—¶å€™ä¼šæ£€æŸ¥ï¼šå¦‚æœ `T` ç»§æ‰¿è‡ª `enable_shared_from_this<T>`ï¼Œå°±ä¼šå·å·æŠŠè¿™ä¸ª `shared_ptr` çš„æ§åˆ¶å—èµ‹ç»™ `_weak_this`ã€‚

è¿™æ ·ï¼š

* `_weak_this` ä¸å¢åŠ å¼ºå¼•ç”¨è®¡æ•°ï¼ˆæ‰€ä»¥ä¸ä¼šå¯¼è‡´å¾ªç¯å¼•ç”¨ï¼‰ã€‚
* `_weak_this` è®°å½•äº†â€œå¯¹è±¡å’Œæ§åˆ¶å—çš„å…³è”â€ã€‚

---

## 4. `shared_from_this()` çš„å®ç°é€»è¾‘

è°ƒç”¨ `shared_from_this()` æ—¶ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ï¼š

```cpp
std::shared_ptr<T> shared_from_this() {
    return std::shared_ptr<T>(_weak_this);
}
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒç›´æ¥ç”¨ `_weak_this.lock()` æ¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ `shared_ptr`ã€‚

* `lock()` ä¼šå»æ‰¾ `_weak_this` é‡Œçš„æ§åˆ¶å—ï¼›
* å¦‚æœå¯¹è±¡è¿˜æ´»ç€ï¼ˆå¼ºå¼•ç”¨è®¡æ•° > 0ï¼‰ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„ `shared_ptr`ï¼›
* è¿™ä¸ªæ–° `shared_ptr` å’Œå¤–éƒ¨çš„ `shared_ptr` æŒ‡å‘åŒä¸€ä¸ªæ§åˆ¶å—ã€‚

---

## 5. å¤–éƒ¨ `shared_ptr` æ˜¯å¦‚ä½•å¡«å…… `_weak_this` çš„ï¼Ÿ

è¿™ä¸€ç‚¹æ˜¯æ ‡å‡†åº“å®ç°ä¸­çš„å°æŠ€å·§ã€‚
åœ¨ `shared_ptr` çš„æ„é€ å‡½æ•°é‡Œï¼Œæœ‰ä¸€ä¸ªç‰¹æ®Šçš„åˆ†æ”¯ï¼Œå¤§æ¦‚åƒè¿™æ ·ï¼ˆä¼ªä»£ç ï¼‰ï¼š

```cpp
template<typename T>
shared_ptr<T>::shared_ptr(T* ptr) {
    // åˆ›å»ºæ§åˆ¶å—
    control_block* cb = new control_block(ptr);

    px = ptr;  // åŸå§‹æŒ‡é’ˆ
    pn = cb;   // æ§åˆ¶å—

    // å¦‚æœ T ç»§æ‰¿è‡ª enable_shared_from_this<T>ï¼ŒæŠŠè‡ªå·±æ³¨å†Œè¿›å»
    if constexpr (std::is_base_of_v<enable_shared_from_this<T>, T>) {
        ptr->_weak_this = *this;  // èµ‹å€¼æ—¶ä¸ä¼šå¢åŠ å¼ºå¼•ç”¨
    }
}
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä½ å†™ï¼š

```cpp
std::shared_ptr<Foo> sp(new Foo);
```

æ„é€  `shared_ptr` çš„æ—¶å€™ä¼šè‡ªåŠ¨æŠŠ `sp` å¡«åˆ° `Foo::_weak_this` é‡Œã€‚

---

## 6. æµç¨‹æ€»ç»“

æ•´ä½“æµç¨‹å¯ä»¥æ€»ç»“ä¸ºï¼š

1. ä½  `new Foo` å¹¶ç”¨ `shared_ptr` ç®¡ç†ï¼š

   * `shared_ptr` åˆ›å»ºæ§åˆ¶å—
   * å¦‚æœ `Foo` ç»§æ‰¿è‡ª `enable_shared_from_this`ï¼Œåˆ™æŠŠè‡ªå·±èµ‹ç»™ `_weak_this`

2. å½“ä½ åœ¨ `Foo` çš„æ–¹æ³•é‡Œè°ƒç”¨ `shared_from_this()`ï¼š

   * å†…éƒ¨ç”¨ `_weak_this.lock()` ç”Ÿæˆæ–°çš„ `shared_ptr`
   * è¿™ä¸ªæ–° `shared_ptr` å’Œå¤–éƒ¨çš„ `shared_ptr` å…±ç”¨åŒä¸€ä¸ªæ§åˆ¶å—

3. æœ€ç»ˆçš„æ•ˆæœï¼š

   * ä¸ä¼šé‡å¤åˆ›å»ºæ§åˆ¶å—
   * ä¸ä¼šé€ æˆå¾ªç¯å¼•ç”¨
   * å¯ä»¥å®‰å…¨åœ°ä»å¯¹è±¡å†…éƒ¨è·å¾— `shared_ptr`

---

## 7. ä¸€ä¸ªå°ä¾‹å­

```cpp
#include <memory>
#include <iostream>

struct Foo : std::enable_shared_from_this<Foo> {
    void hello() {
        auto self = shared_from_this();
        std::cout << "use_count=" << self.use_count() << "\n";
    }
};

int main() {
    auto sp1 = std::make_shared<Foo>();
    sp1->hello();  // use_count=2 ï¼ˆsp1 + selfï¼‰
}
```

è¿è¡Œæ—¶ï¼š

* `sp1` æ‹¥æœ‰æ§åˆ¶å—ï¼Œ`use_count=1`
* è°ƒç”¨ `hello()` â†’ `shared_from_this()` â†’ `_weak_this.lock()` â†’ `use_count=2`

è¯æ˜äº† `shared_from_this` è¿”å›çš„ç¡®å®æ˜¯å…±äº«çš„ `shared_ptr`ã€‚

---

è¦ä¸è¦æˆ‘å¸®ä½ ç”»ä¸€å¼  **å†…å­˜å¸ƒå±€ + æ§åˆ¶å—å’Œ weak\_ptr çš„å…³ç³»ç¤ºæ„å›¾**ï¼Œè¿™æ ·ä½ ä¼šæ›´ç›´è§‚åœ°çœ‹åˆ°ä¸ºä»€ä¹ˆ `_weak_this` èƒ½ä¿è¯å…±äº«åŒä¸€ä¸ªæ§åˆ¶å—ï¼Ÿ
