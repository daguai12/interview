å½“ç„¶å¯ä»¥ï¼Œæˆ‘ç»™ä½ å†™ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ï¼Œå±•ç¤º **åç¨‹å‡½æ•° â†’ promise â†’ co\_return â†’ final\_suspend â†’ å±€éƒ¨å˜é‡ææ„** çš„â€œå±•å¼€â€ç‰ˆä»£ç ã€‚ä¸ºäº†ç†è§£æ–¹ä¾¿ï¼Œæˆ‘ä¼šæ¨¡æ‹Ÿç¼–è¯‘å™¨ç”Ÿæˆçš„çŠ¶æ€æœºç»“æ„ï¼Œç”¨æ™®é€š C++ ä»£ç æ‰‹åŠ¨å±•å¼€ã€‚

---

```cpp
#include <coroutine>
#include <iostream>
#include <exception>

// ------------------------
// è¿”å›å¯¹è±¡ Task
// ------------------------
struct Task {
    struct promise_type {
        Task get_return_object() {
            std::cout << "get_return_object called\n";
            return Task{ std::coroutine_handle<promise_type>::from_promise(*this) };
        }

        // åˆå§‹æŒ‚èµ·
        std::suspend_always initial_suspend() { 
            std::cout << "initial_suspend\n"; 
            return {}; 
        }

        // æœ€ç»ˆæŒ‚èµ·
        std::suspend_always final_suspend() noexcept { 
            std::cout << "final_suspend\n"; 
            return {}; 
        }

        void return_void() { 
            std::cout << "return_void called\n"; 
        }

        void return_value(int v) { 
            std::cout << "return_value called: " << v << "\n"; 
            value = v;
        }

        void unhandled_exception() {
            std::cout << "unhandled_exception called\n";
            exception = std::current_exception();
        }

        int value{0};
        std::exception_ptr exception;
    };

    std::coroutine_handle<promise_type> handle;

    Task(std::coroutine_handle<promise_type> h) : handle(h) {}
    ~Task() { 
        if (handle) {
            std::cout << "Task destructor destroying coroutine frame\n";
            handle.destroy(); 
        }
    }
};

// ------------------------
// ä¸€ä¸ªå±€éƒ¨å¯¹è±¡ï¼Œç”¨æ¥è§‚å¯Ÿææ„é¡ºåº
// ------------------------
struct Local {
    Local(int i) : id(i) { std::cout << "Local " << id << " constructed\n"; }
    ~Local() { std::cout << "Local " << id << " destroyed\n"; }
    int id;
};

// ------------------------
// åç¨‹å‡½æ•°
// ------------------------
Task my_coroutine() {
    Local a{1};
    Local b{2};
    co_return 42;  // ä¼šè¢«ç¿»è¯‘ä¸º promise.return_value(42); ç„¶å goto final_suspend
}

// ------------------------
// æ‰‹åŠ¨å±•å¼€åç¨‹æ‰§è¡Œ
// ------------------------
int main() {
    std::cout << "=== Start ===\n";

    // æ‰‹åŠ¨æ¨¡æ‹Ÿç¼–è¯‘å™¨å±•å¼€
    Task::promise_type promise;

    // 1. åˆ›å»ºè¿”å›å¯¹è±¡
    Task t = promise.get_return_object();  

    // 2. åˆå§‹æŒ‚èµ·ç‚¹
    auto initial = promise.initial_suspend();
    (void)initial; // å¿½ç•¥ co_await è¿”å›å€¼
    std::cout << "Coroutine ready, returned Task to caller\n";

    // 3. åç¨‹ä½“é€»è¾‘
    try {
        Local a{1};
        Local b{2};

        // co_return 42 çš„ç¿»è¯‘
        promise.return_value(42);

        // goto final_suspend;
        // å±€éƒ¨å˜é‡ææ„ï¼ˆb -> aï¼‰
        std::cout << "Local variables will be destroyed\n";

    } catch(...) {
        promise.unhandled_exception();
    }

    // 4. final_suspend
    auto final = promise.final_suspend();
    (void)final;

    std::cout << "=== End ===\n";
    return 0;
}
```

---

### ğŸ”¹ ä»£ç è§£é‡Š

1. **promise\_type**ï¼š

   * ç®¡ç†åç¨‹çš„è¿”å›å¯¹è±¡ã€è¿”å›å€¼å’Œå¼‚å¸¸
   * å®šä¹‰äº† `initial_suspend()`ã€`final_suspend()`ã€`return_void()`ã€`return_value()`ã€`unhandled_exception()`

2. **Local**ï¼š

   * æ¨¡æ‹Ÿåç¨‹ä¸­çš„å±€éƒ¨å˜é‡ï¼Œè§‚å¯Ÿææ„é¡ºåº

3. **my\_coroutine()**ï¼š

   * åç¨‹ä½“é‡Œåˆ›å»ºä¸¤ä¸ªå±€éƒ¨å¯¹è±¡
   * `co_return 42` ä¼šè°ƒç”¨ `promise.return_value(42)` å¹¶è·³è½¬åˆ° final\_suspend

4. **main()**ï¼š

   * æ¨¡æ‹Ÿç¼–è¯‘å™¨ç”Ÿæˆçš„å±•å¼€æ­¥éª¤ï¼š

     1. è°ƒç”¨ `get_return_object()` è¿”å› Task ç»™è°ƒç”¨è€…
     2. æ‰§è¡Œ `initial_suspend()` â†’ å¯ä»¥æŒ‚èµ·åç¨‹
     3. æ‰§è¡Œåç¨‹ä½“ â†’ è°ƒç”¨ `return_value()`
     4. ææ„å±€éƒ¨å˜é‡
     5. æ‰§è¡Œ `final_suspend()`
     6. Task ææ„ â†’ é”€æ¯åç¨‹å¸§

---

### ğŸ”¹ è¾“å‡ºç¤ºä¾‹

```
=== Start ===
get_return_object called
initial_suspend
Coroutine ready, returned Task to caller
return_value called: 42
Local variables will be destroyed
final_suspend
Task destructor destroying coroutine frame
=== End ===
```

* å±€éƒ¨å˜é‡æŒ‰æ„é€ é¡ºåºé€†åºææ„ï¼ˆb -> aï¼‰
* `final_suspend()` åœ¨å±€éƒ¨å˜é‡ææ„åæ‰§è¡Œ
* Task ææ„æ—¶é”€æ¯åç¨‹å¸§

---

è¿™ä¸ªä»£ç å°±æ˜¯ **co\_return â†’ promise â†’ final\_suspend â†’ å±€éƒ¨å˜é‡ææ„ â†’ è¿”å›å¯¹è±¡ææ„** çš„å®Œæ•´å±•å¼€æ¨¡æ‹Ÿã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å†ç”»ä¸€å¼ **åç¨‹æ‰§è¡Œæµç¨‹å›¾**ï¼ŒæŠŠ **initial\_suspend â†’ åç¨‹ä½“ â†’ co\_return â†’ final\_suspend â†’ RAII ææ„** é¡ºåºæ ‡æ¸…æ¥šï¼Œè®©æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæ›´ç›´è§‚ã€‚

ä½ å¸Œæœ›æˆ‘ç”»å—ï¼Ÿ
