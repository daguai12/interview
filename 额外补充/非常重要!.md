å¥½ ğŸ‘ï¼Œä½ å¡åœ¨ **ã€Œä¸ºä»€ä¹ˆæ ˆå¸§ä¼šå±‚å±‚å åŠ ã€** è¿™é‡Œï¼Œæˆ‘æ¥ç”¨æ›´ç»†çš„â€œå‡½æ•°è°ƒç”¨è§†è§’â€å¸®ä½ æ‹†å¼€ã€‚

---

## 1. æ™®é€šå‡½æ•°è°ƒç”¨ vs åç¨‹ resume

å…ˆæƒ³è±¡ä¸€ä¸ªæ™®é€šå‡½æ•°ï¼š

```cpp
void foo() {
    bar();  // è°ƒç”¨ bar
    // ... bar è¿”å›ä¹‹åæ‰ä¼šç»§ç»­æ‰§è¡Œ foo
}
```

æ‰§è¡Œçš„æ—¶å€™ï¼š

* `foo()` çš„æ ˆå¸§å…ˆå»ºç«‹ã€‚
* è°ƒç”¨ `bar()` â†’ æ–°å»ºä¸€ä¸ª **bar æ ˆå¸§**ï¼Œå‹åœ¨ `foo` ä¸Šé¢ã€‚
* `bar()` ç»“æŸ â†’ bar çš„æ ˆå¸§å¼¹å‡ºï¼ŒCPU è¿”å›åˆ° `foo` çš„ä¸‹ä¸€è¡Œã€‚

ğŸ‘‰ è¿™æ˜¯â€œ**è°ƒç”¨ â†’ è¿”å›**â€çš„æ­£å¸¸æ¨¡å¼ï¼Œæ ˆå¸§ä¸ä¼šæ— é™å †å ï¼Œå› ä¸ºæ¯æ¬¡å‡½æ•°è°ƒç”¨å®Œéƒ½ä¼šå¼¹å‡ºã€‚

---

## 2. åç¨‹é‡Œçš„ `await_suspend` è°ƒç”¨é“¾

æ¥çœ‹ä½ ä¾‹å­é‡Œçš„ç‰‡æ®µï¼ˆç®€åŒ–ï¼‰ï¼š

```cpp
task loop_synchronously() {
    for (...) {
        co_await completes_synchronously();
    }
}
```

å½“ `loop_synchronously` æ‰§è¡Œåˆ° `co_await` æ—¶ï¼š

1. å®ƒè¿›å…¥ **`task::awaiter::await_suspend`**ï¼Œè¿™é‡Œä¼šè°ƒç”¨ `.resume()` æ¥å¯åŠ¨ `completes_synchronously`ã€‚
2. `.resume()` æ˜¯ä¸€ä¸ª**æ™®é€šå‡½æ•°è°ƒç”¨**ï¼Œæ‰€ä»¥æ­¤æ—¶çš„æ ˆæƒ…å†µæ˜¯ï¼š

```
æ ˆé¡¶
+------------------------+
| completes_synchronous$resume |
+------------------------+
| coroutine_handle::resume     |
+------------------------+
| task::awaiter::await_suspend |
+------------------------+
| loop_synchronously$resume    |
+------------------------+
```

çœ‹åˆ°æ²¡æœ‰ï¼Ÿ
**`await_suspend` è¿˜æ²¡æœ‰è¿”å›**ï¼Œå®ƒå°±è°ƒç”¨äº†ä¸‹ä¸€ä¸ª `.resume()`ï¼Œäºæ˜¯æ–°çš„æ ˆå¸§å°±å åœ¨ä¸Šé¢äº†ã€‚

---

## 3. ä¸ºä»€ä¹ˆä¸ä¼šå¼¹æ‰

å…³é”®ç‚¹åœ¨è¿™é‡Œï¼š

* `await_suspend()` å¹¶æ²¡æœ‰â€œreturnâ€å›åˆ° `loop_synchronously`ï¼›
* å®ƒæ˜¯â€œæ­£åœ¨æ‰§è¡Œä¸­â€ï¼Œç„¶å**åŒæ­¥è°ƒç”¨**äº† `resume()`ï¼Œæ‰€ä»¥å®ƒçš„æ ˆå¸§å¿…é¡»ä¿ç•™ï¼Œç­‰ä»¥å `resume()` ç»“æŸæ—¶å†è¿”å›ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼š

* æ™®é€šå‡½æ•° `A -> B`ï¼šB ç»“æŸï¼Œæ ˆå¸§å¼¹æ‰ï¼Œå›åˆ° Aã€‚
* åç¨‹é‡Œçš„ `await_suspend`ï¼šåœ¨ A è¿˜æ²¡ return çš„æ—¶å€™ï¼ŒA å°±å…ˆè°ƒç”¨äº† Bï¼Œæ‰€ä»¥ A çš„æ ˆå¸§å¿…é¡»ç•™ç€ï¼Œç­‰ B å®Œæˆåå†å›åˆ° Aã€‚

---

## 4. å¾ªç¯æ—¶çš„é€’å½’æ•ˆæœ

ç°åœ¨åŠ ä¸Šå¾ªç¯ï¼š

1. ç¬¬ä¸€æ¬¡ `co_await` â†’ `await_suspend()` â†’ è°ƒç”¨ `completes_synchronously$resume` â†’ å®ƒ `final_suspend` æ—¶åˆè°ƒç”¨ `loop_synchronously$resume`ã€‚
2. æ³¨æ„ï¼è¿™ä¸ª **æ–°çš„ `loop_synchronously$resume`** ä¸æ˜¯â€œæ—§çš„ç»§ç»­â€ï¼Œè€Œæ˜¯é€šè¿‡ `resume()` åˆåŒæ­¥å‹æ ˆäº†ä¸€å±‚ã€‚

äºæ˜¯æ ˆå°±åƒè¿™æ ·ï¼š

```
æ ˆé¡¶
| loop_synchronously$resume (ç¬¬2æ¬¡) |
| coroutine_handle::resume          |
| final_awaiter::await_suspend      |
| completes_synchronously$resume    |
| coroutine_handle::resume          |
| task::awaiter::await_suspend      |
| loop_synchronously$resume (ç¬¬1æ¬¡) |
```

æ¯æ¬¡å¾ªç¯éƒ½ä¼šå†åŠ ä¸€å±‚ï¼Œå®Œå…¨åƒé€’å½’ã€‚

---

## 5. ä¸ºä»€ä¹ˆ **çœ‹èµ·æ¥ä¸æ˜¯é€’å½’ï¼Œå®é™…ä¸Šæ˜¯é€’å½’**

* è¡¨é¢ï¼š`for (int i=0; i<count; i++) co_await ...;`
* å®é™…ï¼š
  æ¯æ¬¡ `co_await` ç­‰ä»·äºâ€œå½“å‰ `resume` è°ƒç”¨ä¸‹ä¸€ä¸ª `resume`â€ï¼Œæ‰€ä»¥é€»è¾‘ä¸Šå°±æ˜¯ï¼š

```
loop$resume()
  -> await_suspend()
    -> completes$resume()
      -> final_suspend()
        -> loop$resume()   // å†æ¬¡è°ƒç”¨è‡ªå·±ï¼
```

è¿™å°±æ˜¯â€œéšå¼é€’å½’â€ã€‚
å› ä¸º `.resume()` æ˜¯æ™®é€šå‡½æ•°è°ƒç”¨ï¼Œ**ä¸ä¼šæ¸…æ ˆ**ï¼Œæ‰€ä»¥æ ˆå¸§å±‚å±‚å †å ï¼Œç›´åˆ°çˆ†æ‰ã€‚

---

## 6. å¦‚æœæœ‰ symmetric transfer

å¦‚æœ runtime/ç¼–è¯‘å™¨æ”¯æŒå¯¹ç§°è½¬ç§»ï¼š

* åœ¨ `await_suspend` è°ƒç”¨ `.resume()` çš„æ—¶å€™ï¼Œä¸æ˜¯â€œå‹æ ˆè°ƒç”¨â€ï¼Œè€Œæ˜¯â€œç›´æ¥è·³è½¬â€ã€‚
* ç›¸å½“äºå‘Šè¯‰ CPUï¼šå½“å‰å‡½æ•°åˆ«ä¿ç•™äº†ï¼Œç›´æ¥è½¬åˆ°ç›®æ ‡ resumeã€‚
* é‚£ä¹ˆæ ˆå¸§å°±ä¸ä¼šä¸€å±‚å±‚å åŠ ï¼Œå§‹ç»ˆåªæœ‰ä¸€ä¸ªã€‚

---

âœ… æ‰€ä»¥æ€»ç»“ä½ çš„é—®é¢˜ï¼š

> **ä¸ºä»€ä¹ˆæ ˆå¸§ä¼šå±‚å±‚å åŠ ï¼Ÿ**

å› ä¸ºï¼š

1. `await_suspend` é‡Œç”¨çš„æ˜¯æ™®é€šå‡½æ•°è°ƒç”¨ `.resume()`ï¼›
2. æ™®é€šå‡½æ•°è°ƒç”¨å¿…é¡»æŠŠè°ƒç”¨è€…çš„æ ˆå¸§ç•™ç€ï¼Œç­‰è¢«è°ƒå‡½æ•°è¿”å›æ—¶å†ç»§ç»­ï¼›
3. ä½†åœ¨åç¨‹é“¾é‡Œï¼Œ`resume()` ä¸ä¼šé©¬ä¸Šè¿”å›ï¼ˆè€Œæ˜¯ç»§ç»­ co\_await é“¾ï¼‰ï¼Œæ‰€ä»¥æ–°çš„ `resume` ä¸€ç›´å¾€ä¸Šå ï¼›
4. æ¯æ¬¡å¾ªç¯ä¸€æ¬¡ï¼Œå°±åƒéšå¼é€’å½’ä¸€æ ·ï¼Œå¯¼è‡´æ ˆå¸§æ— é™ç§¯ç´¯ã€‚

---

è¦ä¸è¦æˆ‘å¸®ä½ ç”»ä¸€ä¸ª **â€œä¸€æ¬¡ co\_awaitâ€ vs â€œä¸¤æ¬¡å¾ªç¯ co\_awaitâ€ çš„æ ˆå¯¹æ¯”å›¾**ï¼ˆASCII/plantumlï¼‰ï¼Ÿè¿™æ ·ä½ èƒ½ç›´è§‚çœ‹åˆ°â€œå“¦ï¼ŒåŸæ¥æ ˆå¸§çœŸçš„æ˜¯å ä¸Šå»äº†â€ã€‚
