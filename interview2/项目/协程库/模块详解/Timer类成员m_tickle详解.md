`bool m_tickled = false;` æ˜¯ `TimerManager` ç±»ä¸­çš„ä¸€ä¸ª**å…³é”®æ ‡å¿—ä½æˆå‘˜å˜é‡**ï¼Œç”¨äº**æ§åˆ¶å®šæ—¶å™¨æ’å…¥åæ˜¯å¦éœ€è¦å”¤é†’è°ƒåº¦å™¨æˆ–æ‰§è¡Œå™¨çº¿ç¨‹ï¼ˆå¦‚ epoll\_waitï¼‰**ã€‚

---

## âœ… ä¸€å¥è¯æ€»ç»“ï¼š

> `m_tickled` çš„ä½œç”¨æ˜¯ **é¿å…é‡å¤å”¤é†’è°ƒåº¦å™¨çº¿ç¨‹ï¼ˆæ¯”å¦‚ epoll\_waitï¼‰**ï¼Œç¡®ä¿**åªåœ¨å¿…è¦æ—¶æ‰è§¦å‘å”¤é†’æ“ä½œ**ã€‚

---

## ğŸ§  èƒŒæ™¯åœºæ™¯ï¼š

å‡è®¾ä½ åœ¨ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼ˆIOManagerï¼‰ä¸­ä½¿ç”¨ `epoll_wait()` è¿›è¡Œ IO ç­‰å¾…ã€‚
è€Œ `TimerManager` ä¸­ç»´æŠ¤ç€ä¸€ä¸ªå®šæ—¶å™¨å † `m_timers`ã€‚

ç°åœ¨ä½ æ·»åŠ äº†ä¸€ä¸ªæ–°çš„å®šæ—¶å™¨ï¼Œå¦‚æœè¿™ä¸ªå®šæ—¶å™¨æ’åœ¨å½“å‰å®šæ—¶å™¨å †çš„æœ€å‰é¢ï¼ˆä¹Ÿå°±æ˜¯å³å°†è¶…æ—¶çš„é‚£ä¸ªï¼‰ï¼Œé‚£ä½ å°±å¿…é¡»**æ‰“æ–­ epoll\_wait å¹¶é‡æ–°è®¡ç®—è¶…æ—¶æ—¶é—´**ã€‚å¦åˆ™å¯èƒ½ä¼šé”™è¿‡è¿™ä¸ªå³å°†åˆ°æœŸçš„å®šæ—¶ä»»åŠ¡ã€‚

---

## ğŸ”„ m\_tickled çš„é€»è¾‘ä½œç”¨ï¼š

```cpp
void TimerManager::addTimer(std::shared_ptr<Timer> timer)
{
    bool at_front = false;
    {
        std::unique_lock<std::shared_mutex> write_lock(m_mutex);
        auto it = m_timers.insert(timer).first;

        // å¦‚æœæ–°åŠ å…¥çš„ timer åœ¨æœ€å‰é¢ï¼Œè¯´æ˜å®ƒæ˜¯â€œæœ€æ—©è¶…æ—¶çš„â€
        // ä¸”å°šæœªå”¤é†’ï¼ˆtickled = falseï¼‰ â†’ éœ€è¦å”¤é†’è°ƒåº¦å™¨
        at_front = (it == m_timers.begin()) && !m_tickled;

        if(at_front)
        {
            m_tickled = true; // è®¾ç½®æ ‡å¿—ä½ï¼Œè¡¨ç¤ºâ€œå·²è§¦å‘å”¤é†’â€
        }
    }

    if(at_front)
    {
        // å”¤é†’ epoll_waitï¼ˆæˆ–ç­‰å¾…çº¿ç¨‹ï¼‰ï¼Œé‡æ–°è®¡ç®— epoll è¶…æ—¶æ—¶é—´
        onTimerInsertedAtFront();
    }
}
```

---

## ğŸ“Œ `m_tickled` çš„ä½œç”¨å¯ä»¥æ€»ç»“ä¸ºï¼š

| è¡Œä¸º                           | è¯´æ˜                    |
| ---------------------------- | --------------------- |
| `m_tickled == false`         | å½“å‰æ²¡æœ‰çº¿ç¨‹å› å®šæ—¶å™¨è€Œè¢«å”¤é†’        |
| `m_tickled == true`          | è¡¨ç¤ºå·²æœ‰ä¸€æ¬¡â€œå”¤é†’è¯·æ±‚â€å‘é€ï¼Œä¸å†é‡å¤å”¤é†’ |
| åœ¨ `getNextTimer()` ä¸­ç½®ä¸º false | é‡æ–°å¤„ç†å®Œæœ€å‰é¢çš„å®šæ—¶å™¨åï¼Œæ ‡å¿—é‡ç½®    |

```cpp
uint64_t TimerManager::getNextTimer()
{
    std::shared_lock<std::shared_mutex> read_lock(m_mutex);

    m_tickled = false; // é‡ç½®ä¸º falseï¼Œå…è®¸ä¸‹ä¸€æ¬¡éœ€è¦æ—¶é‡æ–°å”¤é†’
    ...
}
```

---

## âœ… ç¤ºä¾‹æµç¨‹ï¼š

1. æœ‰ä¸ªçº¿ç¨‹åœ¨ `epoll_wait(timeout)` ç­‰å¾… IO æˆ–è¶…æ—¶ã€‚
2. æ–°çš„å®šæ—¶å™¨è¢«æ’å…¥è¿› `m_timers`ï¼Œå¦‚æœå®ƒæ’åœ¨æœ€å‰é¢ï¼š

   * `m_tickled == false`ï¼Œè§¦å‘ `onTimerInsertedAtFront()`ï¼ˆæ¯”å¦‚å”¤é†’çº¿ç¨‹ï¼‰
   * è®¾ç½® `m_tickled = true`ï¼Œé˜²æ­¢çŸ­æ—¶é—´å†…é‡å¤è§¦å‘ã€‚
3. è°ƒåº¦å™¨çº¿ç¨‹è‹é†’ï¼Œè°ƒç”¨ `getNextTimer()`ï¼Œæ¸…ç©º `m_tickled`ã€‚

---

## ğŸš« å¦‚æœæ²¡æœ‰ `m_tickled` ä¼šæ€ä¹ˆæ ·ï¼Ÿ

æ¯æ¬¡æ’å…¥å®šæ—¶å™¨éƒ½ä¼šå”¤é†’ `epoll_wait`ï¼Œå³ä½¿ä¸æ˜¯æœ€æ—©çš„å®šæ—¶å™¨ï¼Œè¿™ä¼šï¼š

* å¯¼è‡´è°ƒåº¦çº¿ç¨‹é¢‘ç¹è¢«å”¤é†’ï¼ˆæµªè´¹ CPUï¼‰
* é™ä½ç³»ç»Ÿæ€§èƒ½ï¼ˆå‡ºç°æ— æ„ä¹‰çš„ wakeupï¼‰
* æ— æ³•åŒºåˆ†æ˜¯å¦å·²æœ‰â€œå®šæ—¶å™¨å”¤é†’â€æ­£åœ¨ç­‰å¾…å¤„ç†ä¸­

---

## âœ… æ€»ç»“

| å±æ€§å         | ç±»å‹     | ä½œç”¨                                              |
| ----------- | ------ | ----------------------------------------------- |
| `m_tickled` | `bool` | é˜²æ­¢é¢‘ç¹è°ƒç”¨ `onTimerInsertedAtFront()`ï¼Œé¿å…é‡å¤å”¤é†’çº¿ç¨‹ï¼Œæé«˜æ€§èƒ½ |

å®ƒæ˜¯ Sylar æ¡†æ¶ä¸­ `TimerManager` çš„**å”¤é†’ä¼˜åŒ–å…³é”®å˜é‡**ã€‚

---

å¦‚ä½ æƒ³äº†è§£ `onTimerInsertedAtFront()` æ˜¯æ€ä¹ˆå”¤é†’ epoll æˆ–åç¨‹çš„ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸¦ä½ ç»§ç»­åˆ†æã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ



# ä¾‹å­

éå¸¸å¥½ï¼Œè¿™ä¸ªé—®é¢˜åˆ‡ä¸­é‡ç‚¹ã€‚æˆ‘ä»¬å°±é€šè¿‡ä¸€ä¸ª **å®é™…ä¾‹å­** æ¥è¯´æ˜ï¼š

---

## ğŸ”§ åœºæ™¯è¯´æ˜ï¼ˆæ²¡æœ‰åŠæ—¶å”¤é†’ epoll\_waitï¼Œä¼šé”™è¿‡å®šæ—¶å™¨ï¼‰ï¼š

### å‡è®¾å½“å‰æƒ…å†µå¦‚ä¸‹ï¼š

* **å½“å‰ epoll\_wait çš„è¶…æ—¶æ—¶é—´æ˜¯ 5 ç§’**ï¼ˆå› ä¸ºå®šæ—¶å™¨å †ä¸­æœ€è¿‘çš„ä¸€ä¸ªå®šæ—¶å™¨æ˜¯ 5 ç§’ååˆ°æœŸï¼‰ã€‚
* çº¿ç¨‹ç°åœ¨è°ƒç”¨ `epoll_wait(..., timeout=5000)` æ­£åœ¨é˜»å¡ç­‰å¾…ã€‚

### æ­¤æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ’å…¥äº†ä¸€ä¸ªæ–°çš„å®šæ—¶å™¨ï¼Œè®¾å®šçš„æ˜¯ **1 ç§’ååˆ°æœŸ**ï¼

---

## ğŸ˜¨ å¦‚æœä¸å”¤é†’ `epoll_wait()`ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

`epoll_wait` è¿˜åœ¨ç¡ï¼Œå®ƒçš„ 5 ç§’è¿˜æ²¡è¿‡ï¼

ä½†æ–°çš„å®šæ—¶å™¨åªéœ€ 1 ç§’åå°±è¦æ‰§è¡Œäº†ï¼Œç„¶è€Œï¼š

> âš ï¸ `epoll_wait()` ä¸ä¼šè‡ªåŠ¨çŸ¥é“è¿™ä¸ªå®šæ—¶å™¨å‘ç”Ÿäº†å˜åŒ–ï¼

### â° æ—¶é—´è½´æ¨¡æ‹Ÿï¼š

| æ—¶é—´ï¼ˆç§’ï¼‰ | çŠ¶æ€                                                  |
| ----- | --------------------------------------------------- |
| 0     | çº¿ç¨‹ A è¿›å…¥ `epoll_wait(timeout = 5000)`                |
| 1     | çº¿ç¨‹ B æ’å…¥äº†ä¸€ä¸ª â€œ1 ç§’ååˆ°æœŸâ€ çš„æ–°å®šæ—¶å™¨                           |
| 1.1   | æ²¡æœ‰å”¤é†’ `epoll_wait`ï¼ˆå› ä¸º `m_tickled == true`ï¼Œæˆ–æœªæ£€æµ‹æœ€å‰é¢å˜åŒ–ï¼‰ |
| 2     | æ–°å®šæ—¶å™¨**æœ¬åº”æ‰§è¡Œ**ï¼ˆä½†æ²¡äººå”¤é†’è°ƒåº¦å™¨ï¼‰                              |
| 5     | åŸæœ¬ 5 ç§’åˆ°æœŸçš„è€å®šæ—¶å™¨åˆ°äº† â†’ `epoll_wait` è¿”å›                   |
| 5.01  | çº¿ç¨‹ A æ‰å¼€å§‹å¤„ç†æ‰€æœ‰åˆ°æœŸå®šæ—¶å™¨ï¼Œæ–°æ’å…¥çš„å®šæ—¶å™¨å·²ç»æ™šäº† **3 ç§’**               |

---

## âœ… å¦‚æœæ’å…¥æ—¶åŠæ—¶å”¤é†’ï¼Œä¼šæ€ä¹ˆæ ·ï¼Ÿ

åªè¦åœ¨æ’å…¥è¿™ä¸ªæ›´æ—©çš„å®šæ—¶å™¨æ—¶ï¼š

```cpp
if (at_front && !m_tickled) {
    m_tickled = true;
    onTimerInsertedAtFront(); // âœ é€šè¿‡ pipe ç­‰æ–¹å¼å”¤é†’ epoll
}
```

é‚£ä¹ˆï¼š

* `epoll_wait` ä¼šæå‰è¢«å”¤é†’
* é‡æ–°è·å– `getNextTimer()`ï¼Œè®¡ç®—å‡ºç°åœ¨çš„æœ€æ—©åˆ°æœŸæ—¶é—´æ˜¯ 1 ç§’
* è®¾ç½®æ–°çš„ epoll è¶…æ—¶æ—¶é—´ä¸º 1 ç§’
* **å®šæ—¶å™¨èƒ½å‡†æ—¶æ‰§è¡Œ**

---

## ğŸ”„ æ€»ç»“ï¼š

| æ˜¯å¦å”¤é†’                 | ç»“æœ                 |
| -------------------- | ------------------ |
| âŒ æ²¡å”¤é†’ `epoll_wait()` | æ–°å®šæ—¶å™¨å¯èƒ½è¢«å»¶è¿Ÿæ‰§è¡Œï¼ˆé”™è¿‡å®šæ—¶ç‚¹ï¼‰ |
| âœ… æ­£ç¡®å”¤é†’å¹¶é‡æ–°è®¾ç½® epoll è¶…æ—¶ | å®šæ—¶å™¨å‡†æ—¶è§¦å‘ï¼Œè°ƒåº¦åŠæ—¶       |

---

è¿™ä¸ªæœºåˆ¶çš„æœ¬è´¨ç±»ä¼¼äºï¼š

> epoll ç­‰å¾…çš„æ˜¯ IO äº‹ä»¶ + å®šæ—¶å™¨è¶…æ—¶ï¼Œä½ å¿…é¡»æ˜ç¡®å‘Šè¯‰å®ƒå®šæ—¶å™¨å˜äº†ï¼

---

å¦‚æœä½ æƒ³çœ‹å…·ä½“åœ¨ Sylar æ¡†æ¶ä¸­æ˜¯æ€ä¹ˆé€šè¿‡ `pipe` + `tickle()` å”¤é†’ epoll çš„ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸¦ä½ åˆ†æ `IOManager::tickle()` å’Œ `epoll_wait` çš„å”¤é†’è·¯å¾„ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ
