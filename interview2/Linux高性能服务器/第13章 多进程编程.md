# 13.1 forkç³»ç»Ÿè°ƒç”¨

1. **`fork` çš„ä½œç”¨å’Œè¿”å›å€¼**
    
    - `fork()` ç”¨äºåˆ›å»ºæ–°è¿›ç¨‹ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šè¿”å›ä¸¤æ¬¡ï¼š
        
        - åœ¨çˆ¶è¿›ç¨‹ä¸­è¿”å›å­è¿›ç¨‹çš„ PIDã€‚
            
        - åœ¨å­è¿›ç¨‹ä¸­è¿”å› 0ã€‚
            
        - å¤±è´¥æ—¶è¿”å› -1ï¼Œå¹¶è®¾ç½® `errno`ã€‚
            
2. **è¿›ç¨‹å¤åˆ¶æœºåˆ¶**
    
    - `fork` å¤åˆ¶å½“å‰è¿›ç¨‹ï¼Œå¹¶åœ¨å†…æ ¸è¿›ç¨‹è¡¨ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹è¡¨é¡¹ã€‚
        
    - å¤åˆ¶çš„å†…å®¹åŒ…æ‹¬å †æ ˆæŒ‡é’ˆã€å¯„å­˜å™¨ç­‰ï¼Œä½†éƒ¨åˆ†å±æ€§ä¼šè¢«ä¿®æ”¹ï¼Œå¦‚ï¼š
        
        - æ–°è¿›ç¨‹çš„ `PID` é‡æ–°åˆ†é…ã€‚
            
        - ç»§æ‰¿ä½†æ¸…é™¤ä¿¡å·å¤„ç†å‡½æ•°ç­‰ã€‚
            
3. **æ•°æ®å¤åˆ¶æ–¹å¼ï¼ˆå†™æ—¶å¤åˆ¶ï¼ŒCopy-on-Writeï¼‰**
    
    - å­è¿›ç¨‹çš„ä»£ç å’Œçˆ¶è¿›ç¨‹å®Œå…¨ç›¸åŒï¼Œå¹¶å¤åˆ¶çˆ¶è¿›ç¨‹çš„æ•°æ®ï¼ˆå †ã€æ ˆã€é™æ€æ•°æ®ï¼‰ã€‚
        
    - ä½†æ•°æ®é‡‡ç”¨**å†™æ—¶å¤åˆ¶**ç­–ç•¥ï¼Œå³åªæœ‰åœ¨è¿›ç¨‹ä¿®æ”¹æ•°æ®æ—¶æ‰ä¼šåˆ†é…æ–°å†…å­˜å¹¶å¤åˆ¶æ•°æ®ï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚
        
4. **æ–‡ä»¶æè¿°ç¬¦å’Œå¼•ç”¨è®¡æ•°**
    
    - çˆ¶è¿›ç¨‹ä¸­æ‰“å¼€çš„æ–‡ä»¶åœ¨å­è¿›ç¨‹ä¸­ä»ç„¶æ‰“å¼€ï¼Œä¸”æ–‡ä»¶æè¿°ç¬¦çš„å¼•ç”¨è®¡æ•°å¢åŠ  1ã€‚
        
    - å…¶ä»–èµ„æºï¼ˆå¦‚å½“å‰å·¥ä½œç›®å½•ã€ç”¨æˆ·æ ¹ç›®å½•ç­‰ï¼‰çš„å¼•ç”¨è®¡æ•°ä¹Ÿç›¸åº”å¢åŠ ã€‚
        
5. **ä¼˜åŒ–å»ºè®®**
    
    - `fork` é€‚ç”¨äºéœ€è¦åˆ›å»ºæ–°è¿›ç¨‹ä½†å¸Œæœ›é¿å…å¤§é‡ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶çš„åœºæ™¯ã€‚
        
    - è‹¥è¿›ç¨‹ä½¿ç”¨å¤§é‡å†…å­˜ï¼Œé¢‘ç¹ `fork` å¯èƒ½å¸¦æ¥å¼€é”€ï¼Œåº”åˆç†åˆ©ç”¨å†™æ—¶å¤åˆ¶æœºåˆ¶ã€‚

***
# 13.2 execç³»åˆ—ç³»ç»Ÿè°ƒç”¨

`exec` ç³»åˆ—ç³»ç»Ÿè°ƒç”¨ç”¨äºåœ¨å½“å‰è¿›ç¨‹ä¸­æ‰§è¡Œæ–°çš„ç¨‹åºï¼Œæ›¿æ¢å½“å‰è¿›ç¨‹çš„ä»£ç å’Œæ•°æ®ï¼Œä½†ä¿ç•™è¿›ç¨‹ IDï¼ˆPIDï¼‰ã€‚å®ƒä»¬é€šå¸¸ä¸ `fork` ç»“åˆä½¿ç”¨ï¼Œä»¥åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹åæ‰§è¡Œä¸åŒçš„ç¨‹åºã€‚

### **`exec` ç³»åˆ—è°ƒç”¨çš„ä¸»è¦å‡½æ•°**

Linux æä¾›äº†å¤šä¸ª `exec` å˜ä½“ï¼Œå®ƒä»¬çš„ä¸»è¦åŒºåˆ«åœ¨äºå‚æ•°çš„ä¼ é€’æ–¹å¼ï¼š

| å‡½æ•°       | å‚æ•°ç±»å‹                                              | æè¿°                                |
| -------- | ------------------------------------------------- | --------------------------------- |
| `execl`  | `char *path, char *arg0, ..., NULL`               | ä»¥è·¯å¾„æ–¹å¼æŒ‡å®šå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå‚æ•°ä»¥å¯å˜å‚æ•°åˆ—è¡¨æä¾›          |
| `execv`  | `char *path, char *argv[]`                        | ä»¥è·¯å¾„æ–¹å¼æŒ‡å®šå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå‚æ•°ä»¥æ•°ç»„å½¢å¼æä¾›            |
| `execle` | `char *path, char *arg0, ..., NULL, char *envp[]` | åœ¨ `execl` åŸºç¡€ä¸Šå…è®¸æŒ‡å®šç¯å¢ƒå˜é‡             |
| `execve` | `char *path, char *argv[], char *envp[]`          | åœ¨ `execv` åŸºç¡€ä¸Šå…è®¸æŒ‡å®šç¯å¢ƒå˜é‡             |
| `execlp` | `char *file, char *arg0, ..., NULL`               | ä»¥æ–‡ä»¶åï¼ˆè€Œéå®Œæ•´è·¯å¾„ï¼‰æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæŸ¥æ‰¾ `PATH` å˜é‡ï¼‰ |
| `execvp` | `char *file, char *argv[]`                        | ä¸ `execlp` ç±»ä¼¼ï¼Œä½†å‚æ•°ä»¥æ•°ç»„å½¢å¼æä¾›          |


### **`exec` è°ƒç”¨çš„ç‰¹ç‚¹**

1. **ä¸ä¼šåˆ›å»ºæ–°è¿›ç¨‹**  
    `exec` ç›´æ¥æ›¿æ¢å½“å‰è¿›ç¨‹çš„ä»£ç æ®µå’Œæ•°æ®æ®µï¼Œä¸æ”¹å˜è¿›ç¨‹ IDï¼ˆPIDï¼‰ã€‚
    
2. **æ–‡ä»¶æè¿°ç¬¦ç»§æ‰¿**  
    è°ƒç”¨ `exec` åï¼ŒåŸè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ä¸ä¼šå…³é—­ï¼ˆé™¤éè¢« `FD_CLOEXEC` æ ‡è®°ï¼‰ã€‚
    
3. **ç¯å¢ƒå˜é‡çš„ç»§æ‰¿**
    
    - `execle` å’Œ `execve` å…è®¸æŒ‡å®šæ–°çš„ç¯å¢ƒå˜é‡ã€‚
        
    - å…¶ä»– `exec` è°ƒç”¨ä¼šé»˜è®¤ç»§æ‰¿å½“å‰è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ã€‚
        
4. **é€šå¸¸ä¸ `fork` ç»“åˆä½¿ç”¨**
    
    - `fork` ç”Ÿæˆæ–°è¿›ç¨‹ï¼Œ`exec` åœ¨å­è¿›ç¨‹ä¸­è°ƒç”¨ä»¥æ‰§è¡Œæ–°çš„ç¨‹åºã€‚
        
    - ä¾‹å¦‚ï¼Œ`shell` æ‰§è¡Œå‘½ä»¤æ—¶ä¼š `fork` ä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶å `exec` è¯¥å‘½ä»¤çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚
        


### **ç¤ºä¾‹ä»£ç **

ä½¿ç”¨ `execlp` åœ¨å­è¿›ç¨‹ä¸­æ‰§è¡Œ `ls -l` å‘½ä»¤ï¼š

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main() {
    printf("Before exec\n");

    execlp("ls", "ls", "-l", NULL);

    // exec æˆåŠŸæ‰§è¡Œåï¼Œä»¥ä¸‹ä»£ç ä¸ä¼šè¿è¡Œ
    perror("exec failed");
    return 1;
}
```

å¦‚æœ `execlp` æˆåŠŸæ‰§è¡Œï¼Œåˆ™ `ls -l` ä¼šæ›¿æ¢å½“å‰è¿›ç¨‹ï¼Œ`printf("Before exec")` ä¹‹åçš„ä»£ç ä¸ä¼šæ‰§è¡Œã€‚å¦‚æœ `exec` å¤±è´¥ï¼Œåˆ™ `perror` ä¼šè¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚


### **`fork` + `exec` ç»„åˆç¤ºä¾‹**

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main() {
    pid_t pid = fork();

    if (pid == 0) {  // å­è¿›ç¨‹
        printf("Child process executing ls -l\n");
        execlp("ls", "ls", "-l", NULL);
        perror("exec failed");
        exit(1);
    } else if (pid > 0) {  // çˆ¶è¿›ç¨‹
        printf("Parent process, child PID: %d\n", pid);
        wait(NULL);  // ç­‰å¾…å­è¿›ç¨‹å®Œæˆ
    } else {
        perror("fork failed");
    }

    return 0;
}
```

**è¿è¡Œç»“æœ**ï¼ˆç¤ºä¾‹ï¼‰ï¼š

```
Parent process, child PID: 1234
Child process executing ls -l
total 8
-rwxr-xr-x 1 user user  1234 Apr  4 10:00 a.out
-rw-r--r-- 1 user user   567 Apr  4 10:00 test.c
```


### **æ€»ç»“**

- `exec` ç³»åˆ—ç”¨äºæ›¿æ¢å½“å‰è¿›ç¨‹çš„ä»£ç ï¼Œä¸åˆ›å»ºæ–°è¿›ç¨‹ã€‚
    
- `exec` å¤±è´¥æ—¶è¿”å› `-1`ï¼Œå¦åˆ™ä¸ä¼šè¿”å›ï¼ˆå› ä¸ºæˆåŠŸæ‰§è¡Œåè¿›ç¨‹å·²æ›¿æ¢ï¼‰ã€‚
    
- é€‚ç”¨äº `fork` åçš„å­è¿›ç¨‹ï¼Œä»¥è¿è¡Œä¸åŒçš„ç¨‹åºã€‚
    
- é€‰æ‹©åˆé€‚çš„ `exec` å˜ä½“ï¼š
    
    - éœ€è¦ `PATH` æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶ â†’ `execlp` / `execvp`
        
    - éœ€è¦ä¼ é€’ç¯å¢ƒå˜é‡ â†’ `execle` / `execve`
        
    - å‚æ•°æ˜¯å˜é•¿åˆ—è¡¨ â†’ `execl`
        
    - å‚æ•°æ˜¯æ•°ç»„ â†’ `execv`
        

## **execleå’Œexeclp ä¸»è¦åŒºåˆ«æ€»ç»“**

| **åŠŸèƒ½**     | **execle**                  | **execlp**                     |
| ---------- | --------------------------- | ------------------------------ |
| **æ‰§è¡Œæ–‡ä»¶è·¯å¾„** | å¿…é¡»æä¾›å®Œæ•´è·¯å¾„ï¼Œå¦‚ `/bin/ls`        | åªéœ€æä¾›ç¨‹åºåï¼Œå¦‚ `ls`ï¼Œä¼šè‡ªåŠ¨æŸ¥æ‰¾ `PATH` å˜é‡ |
| **ç¯å¢ƒå˜é‡**   | å…è®¸ä¼ é€’è‡ªå®šä¹‰ `envp[]`ï¼Œä¸ä¼šç»§æ‰¿å½“å‰è¿›ç¨‹ç¯å¢ƒ | ç»§æ‰¿å½“å‰è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ï¼Œæ— æ³•æŒ‡å®šè‡ªå®šä¹‰ç¯å¢ƒå˜é‡        |
| **é€‚ç”¨åœºæ™¯**   | éœ€è¦æ§åˆ¶ç¯å¢ƒå˜é‡æ—¶ä½¿ç”¨                 | è®©ç¨‹åºè‡ªåŠ¨æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„æ—¶ä½¿ç”¨              |
|            |                             |                                |

**é€‰æ‹©å»ºè®®ï¼š**

- **å¦‚æœéœ€è¦æ§åˆ¶ç¯å¢ƒå˜é‡**ï¼ˆå¦‚ä¿®æ”¹ `PATH`ã€`LD_LIBRARY_PATH`ï¼‰â†’ **ç”¨ `execle`**ã€‚
    
- **å¦‚æœæƒ³è®©ç³»ç»Ÿè‡ªåŠ¨æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶**ï¼ˆå¦‚ `ls`ã€`gcc`ï¼‰â†’ **ç”¨ `execlp`**ã€‚

***

# 13.3 å¤„ç†åƒµå°¸è¿›ç¨‹å’Œå­¤å„¿è¿›ç¨‹


åœ¨ Linux/Unix è¿›ç¨‹ç®¡ç†ä¸­ï¼Œ**å­¤å„¿è¿›ç¨‹**ï¼ˆOrphan Processï¼‰å’Œ **åƒµå°¸è¿›ç¨‹**ï¼ˆZombie Processï¼‰æ˜¯ä¸¤ç§ç‰¹æ®Šçš„è¿›ç¨‹çŠ¶æ€ï¼Œé€šå¸¸ä¸ **`fork()`** å’Œ **`wait()`** ç›¸å…³ã€‚


## **1. å­¤å„¿è¿›ç¨‹ï¼ˆOrphan Processï¼‰**

### **å®šä¹‰**

å½“**çˆ¶è¿›ç¨‹å…ˆäºå­è¿›ç¨‹é€€å‡º**æ—¶ï¼Œå­è¿›ç¨‹å°±å˜æˆäº†**å­¤å„¿è¿›ç¨‹**ã€‚

- å­¤å„¿è¿›ç¨‹ä¸ä¼šè¢«ç»ˆæ­¢ï¼Œè€Œæ˜¯ç”± **`init` è¿›ç¨‹ï¼ˆPID=1ï¼‰æˆ– `systemd` è¿›ç¨‹æ¥ç®¡ï¼Œå¹¶æˆä¸ºå®ƒçš„å­è¿›ç¨‹ã€‚
    
- `init/systemd` è´Ÿè´£ç­‰å¾…ï¼ˆ`wait()`ï¼‰è¿™äº›å­¤å„¿è¿›ç¨‹ï¼Œé˜²æ­¢å®ƒä»¬å˜æˆåƒµå°¸è¿›ç¨‹ã€‚
    

### **ç¤ºä¾‹ä»£ç **

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main() {
    pid_t pid = fork();

    if (pid > 0) {
        printf("Parent process exiting, PID: %d\n", getpid());
        exit(0);  // çˆ¶è¿›ç¨‹å…ˆé€€å‡ºï¼Œå­è¿›ç¨‹å˜æˆå­¤å„¿è¿›ç¨‹
    } else if (pid == 0) {
        sleep(3);  // è®©å­è¿›ç¨‹å­˜æ´»æ›´ä¹…
        printf("Orphan process running, PID: %d, Parent PID: %d\n", getpid(), getppid());
    } else {
        perror("fork failed");
    }

    return 0;
}
```

### **è¿è¡Œç»“æœ**

```
Parent process exiting, PID: 1234
Orphan process running, PID: 1235, Parent PID: 1
```

- å­è¿›ç¨‹çš„ `PPID` å˜æˆäº† `1`ï¼ˆ`init`/`systemd` è¿›ç¨‹ï¼‰ã€‚
    
- è¿™ä¸ªå­è¿›ç¨‹å°±æ˜¯ **å­¤å„¿è¿›ç¨‹**ï¼Œç”± `init/systemd` è¿›ç¨‹æ¥ç®¡ã€‚
    

---

## **2. åƒµå°¸è¿›ç¨‹ï¼ˆZombie Processï¼‰**

### **å®šä¹‰**

å½“**å­è¿›ç¨‹é€€å‡ºåï¼Œçˆ¶è¿›ç¨‹æ²¡æœ‰è°ƒç”¨ `wait()` è¯»å–å…¶é€€å‡ºçŠ¶æ€**ï¼Œè¯¥å­è¿›ç¨‹çš„**è¿›ç¨‹è¡¨é¡¹ä»ç„¶ä¿ç•™**ï¼Œä½†è¿›ç¨‹æœ¬ä½“å·²ç»ˆæ­¢ï¼Œè¿™ç§è¿›ç¨‹ç§°ä¸º **åƒµå°¸è¿›ç¨‹**ã€‚

- åƒµå°¸è¿›ç¨‹ä¸ä¼šæ¶ˆè€— CPU æˆ–å†…å­˜ï¼Œä½†ä¼šå ç”¨ **è¿›ç¨‹è¡¨é¡¹**ï¼ˆæœ‰é™èµ„æºï¼‰ã€‚
    
- **å¦‚æœçˆ¶è¿›ç¨‹é€€å‡ºï¼Œåƒµå°¸è¿›ç¨‹ä¼šè‡ªåŠ¨è¢« `init/systemd` è¿›ç¨‹æ¸…ç†ã€‚**
    
- **å¦‚æœå¤§é‡åƒµå°¸è¿›ç¨‹ç´¯ç§¯ï¼Œå¯èƒ½å¯¼è‡´ç³»ç»Ÿèµ„æºæ¯ç«­ï¼**
    

### **ç¤ºä¾‹ä»£ç **

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main() {
    pid_t pid = fork();

    if (pid > 0) {  // çˆ¶è¿›ç¨‹
        printf("Parent process, PID: %d\n", getpid());
        sleep(10);  // çˆ¶è¿›ç¨‹ä¸è°ƒç”¨ wait()ï¼Œå­è¿›ç¨‹å˜æˆåƒµå°¸è¿›ç¨‹
    } else if (pid == 0) {  // å­è¿›ç¨‹
        printf("Child process exiting, PID: %d\n", getpid());
        exit(0);  // é€€å‡ºä½†çˆ¶è¿›ç¨‹æœªè°ƒç”¨ wait()ï¼Œè¿›å…¥åƒµå°¸çŠ¶æ€
    } else {
        perror("fork failed");
    }

    return 0;
}
```

### **è¿è¡Œæ­¥éª¤**

1. `fork()` ç”Ÿæˆå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ **ç«‹åˆ»é€€å‡º**ã€‚
    
2. çˆ¶è¿›ç¨‹ **ä¸è°ƒç”¨ `wait()`**ï¼Œå¯¼è‡´å­è¿›ç¨‹è¿›ç¨‹è¡¨é¡¹æœªè¢«æ¸…ç†ï¼Œè¿›å…¥ **åƒµå°¸çŠ¶æ€**ã€‚
    
3. **ç”¨ `ps` å‘½ä»¤æŸ¥çœ‹ï¼š**
    
    ```
    $ ps -aux | grep defunct
    ```
    
    çœ‹åˆ°ç±»ä¼¼ï¼š
    
    ```
    user   1235  0.0  0.0  0  0 ?    Z    00:00   0:00 [child] <defunct>
    ```
    
    `Z` è¡¨ç¤º **åƒµå°¸è¿›ç¨‹**ã€‚
    

---

## **3. å¦‚ä½•é¿å…åƒµå°¸è¿›ç¨‹ï¼Ÿ**

### **æ–¹æ³• 1ï¼šçˆ¶è¿›ç¨‹è°ƒç”¨ `wait()`**

```c
pid_t pid = fork();
if (pid > 0) {
    wait(NULL);  // å›æ”¶å­è¿›ç¨‹ï¼Œé˜²æ­¢å˜æˆåƒµå°¸è¿›ç¨‹
}
```

**ç¼ºç‚¹ï¼š** `wait()` æ˜¯é˜»å¡çš„ï¼Œå¯èƒ½å½±å“çˆ¶è¿›ç¨‹è¿è¡Œã€‚

---

### **æ–¹æ³• 2ï¼šä½¿ç”¨ `SIGCHLD` ä¿¡å·+`waitpid()`**

çˆ¶è¿›ç¨‹å¯ä»¥**æ•è· `SIGCHLD` ä¿¡å·**ï¼Œåœ¨å­è¿›ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨å›æ”¶ï¼š

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <signal.h>

void handle_sigchld(int sig) {
    while (waitpid(-1, NULL, WNOHANG) > 0);  // å›æ”¶æ‰€æœ‰å­è¿›ç¨‹
}

int main() {
    signal(SIGCHLD, handle_sigchld);  // æ³¨å†Œ SIGCHLD å¤„ç†å‡½æ•°

    if (fork() == 0) {  // å­è¿›ç¨‹
        printf("Child process exiting\n");
        exit(0);
    }

    sleep(5);  // æ¨¡æ‹Ÿçˆ¶è¿›ç¨‹ç»§ç»­è¿è¡Œ
    printf("Parent process exiting\n");
    return 0;
}
```

- `signal(SIGCHLD, handle_sigchld)` è®©çˆ¶è¿›ç¨‹åœ¨å­è¿›ç¨‹é€€å‡ºæ—¶æ‰§è¡Œ `waitpid()`ï¼Œéé˜»å¡åœ°å›æ”¶å­è¿›ç¨‹ï¼Œé˜²æ­¢åƒµå°¸è¿›ç¨‹ã€‚
    

---

## **4. å­¤å„¿è¿›ç¨‹ vs åƒµå°¸è¿›ç¨‹ æ€»ç»“**

|**å¯¹æ¯”é¡¹**|**å­¤å„¿è¿›ç¨‹ï¼ˆOrphan Processï¼‰**|**åƒµå°¸è¿›ç¨‹ï¼ˆZombie Processï¼‰**|
|---|---|---|
|**äº§ç”ŸåŸå› **|**çˆ¶è¿›ç¨‹å…ˆé€€å‡º**ï¼Œå­è¿›ç¨‹ä»åœ¨è¿è¡Œ|**å­è¿›ç¨‹å…ˆé€€å‡º**ï¼Œä½†çˆ¶è¿›ç¨‹æœª `wait()`|
|**å¤„ç†æ–¹å¼**|`init/systemd` è¿›ç¨‹æ¥ç®¡ï¼Œä¸ä¼šç§¯ç´¯|çˆ¶è¿›ç¨‹å¿…é¡» `wait()` æ¸…ç†ï¼Œå¦åˆ™ä¼šç§¯ç´¯|
|**å½±å“**|æ— å®³ï¼Œæ­£å¸¸è¿è¡Œ|å ç”¨è¿›ç¨‹è¡¨é¡¹ï¼Œå½±å“ç³»ç»Ÿèµ„æº|
|**å¦‚ä½•é¿å…**|æ— éœ€å¤„ç†|`wait()`ã€`SIGCHLD` ä¿¡å·å¤„ç†|

---

## **5. ä»€ä¹ˆæ—¶å€™ä¼šå‡ºç°å¤§é‡åƒµå°¸è¿›ç¨‹ï¼Ÿ**

1. **çˆ¶è¿›ç¨‹æ²¡æœ‰ `wait()` å­è¿›ç¨‹**
    
    - æœåŠ¡å™¨ç«¯ç¨‹åºåˆ›å»ºå¤šä¸ªå­è¿›ç¨‹å¤„ç†è¯·æ±‚ï¼Œä½†å¿˜è®° `wait()` ã€‚
        
    - è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ `waitpid()` æˆ– `SIGCHLD` å¤„ç†ã€‚
        
2. **çˆ¶è¿›ç¨‹é˜»å¡ï¼ˆå¦‚é™·å…¥æ­»å¾ªç¯ï¼‰**
    
    - çˆ¶è¿›ç¨‹ä¸ç»ˆæ­¢ï¼Œä½†ä¹Ÿä¸è°ƒç”¨ `wait()` ã€‚
        
    - è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥ä¸»å¾ªç¯é€»è¾‘ï¼Œé€‚å½“ `wait()` ã€‚
        
3. **å¤šçº¿ç¨‹ç¨‹åº fork() å­è¿›ç¨‹**
    
    - çº¿ç¨‹æ¨¡å‹å¯èƒ½å¯¼è‡´ `wait()` é€»è¾‘æ··ä¹±ï¼Œéƒ¨åˆ†å­è¿›ç¨‹æ— æ³•å›æ”¶ã€‚
        
    - è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ `pthread_atfork()` æˆ– **ä¸“é—¨çš„ç®¡ç†è¿›ç¨‹** å¤„ç† `wait()` ã€‚
        

---

## **6. ç»“è®º**

- **å­¤å„¿è¿›ç¨‹** ç”± `init/systemd` è¿›ç¨‹æ¥ç®¡ï¼Œæ— å®³ã€‚
    
- **åƒµå°¸è¿›ç¨‹** å¦‚æœæœªè¢« `wait()` å¤„ç†ï¼Œå¯èƒ½å¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½ï¼Œåº”ä½¿ç”¨ `wait()` æˆ– `SIGCHLD` ä¿¡å·å¤„ç†ã€‚
    
- **ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¿…é¡»é˜²æ­¢åƒµå°¸è¿›ç¨‹ç§¯ç´¯**ï¼Œé¿å…æœåŠ¡å™¨å¼‚å¸¸ã€‚
    

***

# 13.5 ä¿¡å·é‡

### **Linux ä¿¡å·é‡ï¼ˆSemaphoreï¼‰è¯¦è§£**

ä¿¡å·é‡ï¼ˆSemaphoreï¼‰æ˜¯ Linux è¿›ç¨‹åŒæ­¥å’Œäº’æ–¥çš„é‡è¦æœºåˆ¶ï¼Œä¸»è¦ç”¨äº**è§£å†³ä¸´ç•ŒåŒºé—®é¢˜**ï¼Œé˜²æ­¢å¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼Œä»è€Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

---

## **1. ä¿¡å·é‡çš„ç±»å‹**

Linux æä¾›äº†ä¸¤ç§ä¸»è¦çš„ä¿¡å·é‡ï¼š

1. **ç³»ç»Ÿ V ä¿¡å·é‡**ï¼ˆSystem V Semaphoresï¼‰ï¼šä½¿ç”¨ `semget`ã€`semop`ã€`semctl` ç­‰ç³»ç»Ÿè°ƒç”¨ï¼Œé€‚ç”¨äºè¿›ç¨‹é—´åŒæ­¥ã€‚
    
2. **POSIX ä¿¡å·é‡**ï¼ˆPOSIX Semaphoresï¼‰ï¼šä½¿ç”¨ `sem_init`ã€`sem_wait`ã€`sem_post`ã€`sem_destroy`ï¼Œæ”¯æŒ**è¿›ç¨‹å†…åŒæ­¥ï¼ˆçº¿ç¨‹åŒæ­¥ï¼‰å’Œè¿›ç¨‹é—´åŒæ­¥**ã€‚
    

---

## **2. ç³»ç»Ÿ V ä¿¡å·é‡**

### **2.1 ä¸»è¦ç³»ç»Ÿè°ƒç”¨**

|**å‡½æ•°**|**ä½œç”¨**|
|---|---|
|`semget()`|åˆ›å»ºæˆ–è·å–ä¸€ä¸ªä¿¡å·é‡é›†åˆ|
|`semop()`|æ‰§è¡Œ Pï¼ˆç­‰å¾…ï¼‰æˆ– Vï¼ˆä¿¡å·ï¼‰æ“ä½œ|
|`semctl()`|è·å–/è®¾ç½®ä¿¡å·é‡å€¼ï¼Œåˆ é™¤ä¿¡å·é‡|

### **2.2 ç³»ç»Ÿ V ä¿¡å·é‡çš„ä½¿ç”¨**

#### **1ï¸âƒ£ åˆ›å»ºä¿¡å·é‡**

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/sem.h>
#include <stdio.h>

int main() {
    key_t key = ftok("/tmp", 'a');  // ç”Ÿæˆå”¯ä¸€é”®å€¼
    int semid = semget(key, 1, IPC_CREAT | 0666);  // åˆ›å»º1ä¸ªä¿¡å·é‡
    if (semid == -1) {
        perror("semget failed");
        return 1;
    }
    printf("Semaphore ID: %d\n", semid);
    return 0;
}
```

- `semget()` åˆ›å»ºä¿¡å·é‡é›†åˆï¼ˆå¯ä»¥åŒ…å«å¤šä¸ªä¿¡å·é‡ï¼‰ã€‚
    
- `IPC_CREAT` é€‰é¡¹ç”¨äºåˆ›å»ºæ–°çš„ä¿¡å·é‡ã€‚
    

---

#### **2ï¸âƒ£ è®¾ç½®ä¿¡å·é‡åˆå€¼**

```c
#include <sys/sem.h>
#include <stdio.h>

int main() {
    key_t key = ftok("/tmp", 'a');
    int semid = semget(key, 1, IPC_CREAT | 0666);

    // åˆå§‹åŒ–ä¿¡å·é‡ä¸º 1ï¼ˆå¯ç”¨ï¼‰
    union semun {
        int val;
        struct semid_ds *buf;
        unsigned short *array;
    } arg;
    arg.val = 1;

    if (semctl(semid, 0, SETVAL, arg) == -1) {
        perror("semctl failed");
        return 1;
    }
    printf("Semaphore initialized\n");
    return 0;
}
```

- `semctl(semid, 0, SETVAL, arg)` è®¾ç½®ä¿¡å·é‡å€¼ã€‚
    
- `arg.val = 1` è®©ä¿¡å·é‡åˆå§‹å€¼ä¸º `1`ï¼Œè¡¨ç¤ºèµ„æºå¯ç”¨ã€‚
    

---

#### **3ï¸âƒ£ Pï¼ˆç­‰å¾…ï¼‰æ“ä½œ**

```c
#include <sys/sem.h>
#include <stdio.h>

int main() {
    key_t key = ftok("/tmp", 'a');
    int semid = semget(key, 1, 0666);

    struct sembuf sop;
    sop.sem_num = 0;  // ç¬¬ 0 ä¸ªä¿¡å·é‡
    sop.sem_op = -1;  // P æ“ä½œï¼Œç­‰å¾…èµ„æº
    sop.sem_flg = 0;

    printf("Waiting for semaphore...\n");
    semop(semid, &sop, 1);  // æ‰§è¡Œ P æ“ä½œ
    printf("Got semaphore!\n");

    return 0;
}
```

- `semop()` è¿›è¡Œ P æ“ä½œï¼ˆ`sem_op = -1`ï¼‰ï¼Œå¦‚æœä¿¡å·é‡ä¸º `0`ï¼Œè¿›ç¨‹ä¼šé˜»å¡ç­‰å¾…ã€‚
    

---

#### **4ï¸âƒ£ Vï¼ˆé‡Šæ”¾ï¼‰æ“ä½œ**

```c
struct sembuf sop;
sop.sem_num = 0;
sop.sem_op = 1;  // V æ“ä½œï¼Œé‡Šæ”¾èµ„æº
sop.sem_flg = 0;

semop(semid, &sop, 1);
printf("Semaphore released\n");
```

- `sem_op = 1`ï¼Œæ‰§è¡Œ V æ“ä½œï¼Œé‡Šæ”¾ä¿¡å·é‡ã€‚
    

---

#### **5ï¸âƒ£ åˆ é™¤ä¿¡å·é‡**

```c
semctl(semid, 0, IPC_RMID);
printf("Semaphore deleted\n");
```

- `IPC_RMID` é€‰é¡¹ç”¨äºåˆ é™¤ä¿¡å·é‡ã€‚
    

---

## **3. POSIX ä¿¡å·é‡**

### **3.1 ä¸»è¦ç³»ç»Ÿè°ƒç”¨**

| **å‡½æ•°**          | **ä½œç”¨**            |
| --------------- | ----------------- |
| `sem_init()`    | åˆå§‹åŒ–ä¿¡å·é‡ï¼ˆç”¨äºçº¿ç¨‹åŒæ­¥ï¼‰    |
| `sem_open()`    | åˆ›å»º/æ‰“å¼€ä¿¡å·é‡ï¼ˆç”¨äºè¿›ç¨‹é—´åŒæ­¥ï¼‰ |
| `sem_wait()`    | P æ“ä½œï¼ˆç­‰å¾…ï¼‰          |
| `sem_post()`    | V æ“ä½œï¼ˆé‡Šæ”¾ï¼‰          |
| `sem_destroy()` | é”€æ¯ä¿¡å·é‡             |
| `sem_close()`   | å…³é—­å·²æ‰“å¼€çš„ä¿¡å·é‡         |
| `sem_unlink()`  | åˆ é™¤å‘½åä¿¡å·é‡           |

---

### **3.2 çº¿ç¨‹åŒæ­¥ç¤ºä¾‹**

```c
#include <stdio.h>
#include <pthread.h>
#include <semaphore.h>

sem_t sem;

void *worker(void *arg) {
    sem_wait(&sem);  // P æ“ä½œ
    printf("Thread %ld is working...\n", (long)arg);
    sleep(2);
    sem_post(&sem);  // V æ“ä½œ
    return NULL;
}

int main() {
    pthread_t t1, t2;

    sem_init(&sem, 0, 1);  // åˆå§‹åŒ–ä¿¡å·é‡ï¼Œå€¼ä¸º1
    pthread_create(&t1, NULL, worker, (void *)1);
    pthread_create(&t2, NULL, worker, (void *)2);

    pthread_join(t1, NULL);
    pthread_join(t2, NULL);
    
    sem_destroy(&sem);  // é”€æ¯ä¿¡å·é‡
    return 0;
}
```

- `sem_init(&sem, 0, 1)`ï¼šåˆå§‹åŒ–ä¿¡å·é‡ï¼Œåˆå€¼ `1`ï¼Œçº¿ç¨‹é—´å…±äº«ã€‚
    
- `sem_wait()`ï¼šP æ“ä½œï¼Œè·å–ä¿¡å·é‡ã€‚
    
- `sem_post()`ï¼šV æ“ä½œï¼Œé‡Šæ”¾ä¿¡å·é‡ã€‚
    

---

### **3.3 è¿›ç¨‹é—´åŒæ­¥ç¤ºä¾‹**

#### **1ï¸âƒ£ åˆ›å»ºå‘½åä¿¡å·é‡**

```c
sem_t *sem = sem_open("/mysem", O_CREAT, 0666, 1);
```

- `"/mysem"` æ˜¯ä¿¡å·é‡åç§°ã€‚
    
- `O_CREAT` åˆ›å»ºä¿¡å·é‡ï¼Œåˆå€¼ `1`ã€‚
    

#### **2ï¸âƒ£ P æ“ä½œ**

```c
sem_wait(sem);
```

#### **3ï¸âƒ£ V æ“ä½œ**

```c
sem_post(sem);
```

#### **4ï¸âƒ£ å…³é—­å’Œåˆ é™¤ä¿¡å·é‡**

```c
sem_close(sem);
sem_unlink("/mysem");
```

---

## **4. ç³»ç»Ÿ V vs POSIX ä¿¡å·é‡**

|**ç‰¹æ€§**|**ç³»ç»Ÿ V ä¿¡å·é‡**|**POSIX ä¿¡å·é‡**|
|---|---|---|
|**API å¤æ‚åº¦**|å¤æ‚ï¼ˆ`semget`ã€`semop`ã€`semctl`ï¼‰|ç®€å•ï¼ˆ`sem_init`ã€`sem_wait`ã€`sem_post`ï¼‰|
|**è¿›ç¨‹é—´åŒæ­¥**|é€‚ç”¨|é€‚ç”¨ï¼ˆä½¿ç”¨ `sem_open`ï¼‰|
|**çº¿ç¨‹åŒæ­¥**|ä¸æ”¯æŒ|æ”¯æŒ|
|**æ€§èƒ½**|è¾ƒä½ï¼ˆç³»ç»Ÿè°ƒç”¨å¤šï¼‰|é«˜ï¼ˆç”¨æˆ·æ€æ“ä½œï¼‰|

---

## **5. ç»“è®º**

- **ç³»ç»Ÿ V ä¿¡å·é‡** é€‚ç”¨äº**è¿›ç¨‹é—´åŒæ­¥**ï¼Œä½† API å¤æ‚ï¼Œæ¨èä½¿ç”¨ POSIX ä¿¡å·é‡ã€‚
    
- **POSIX ä¿¡å·é‡** æ›´ç®€å•ï¼Œæ”¯æŒ**çº¿ç¨‹åŒæ­¥**ï¼Œæ˜¯ç°ä»£ Linux æ¨èçš„æ–¹å¼ã€‚
    

å¦‚æœæ˜¯**å¤šçº¿ç¨‹**ç¼–ç¨‹ï¼Œä¼˜å…ˆä½¿ç”¨ **POSIX ä¿¡å·é‡**ã€‚å¦‚æœéœ€è¦åœ¨**å¤šä¸ªè¿›ç¨‹é—´å…±äº«**ä¿¡å·é‡ï¼Œå¯ä»¥ä½¿ç”¨**POSIX è¿›ç¨‹é—´ä¿¡å·é‡ï¼ˆ`sem_open`ï¼‰**ã€‚

***

# 13.6 å…±äº«å†…å­˜

## **13.6.1`shmget` ç³»ç»Ÿè°ƒç”¨è¯¦è§£**

`shmget` æ˜¯ **System V å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰** çš„ç³»ç»Ÿè°ƒç”¨ä¹‹ä¸€ï¼Œç”¨äº**åˆ›å»ºæˆ–è·å–ä¸€ä¸ªå…±äº«å†…å­˜æ®µ**ï¼Œå¤šä¸ªè¿›ç¨‹å¯ä»¥é€šè¿‡è¿™ä¸ªå…±äº«å†…å­˜æ®µè¿›è¡Œ**é«˜æ•ˆçš„è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰**ã€‚


#### **1. `shmget` å‡½æ•°åŸå‹**

```c
#include <sys/ipc.h>
#include <sys/shm.h>

int shmget(key_t key, size_t size, int shmflg);
```

#### **å‚æ•°è¯´æ˜**

| **å‚æ•°**   | **ä½œç”¨**                     |
| -------- | -------------------------- |
| `key`    | å…±äº«å†…å­˜çš„å”¯ä¸€æ ‡è¯†ï¼ˆå¯ä»¥ç”¨ `ftok()` ç”Ÿæˆï¼‰ |
| `size`   | å…±äº«å†…å­˜çš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰                |
| `shmflg` | æ ‡å¿—ä½ï¼Œæ§åˆ¶å…±äº«å†…å­˜çš„åˆ›å»ºå’Œæƒé™           |

#### **è¿”å›å€¼**

- æˆåŠŸï¼šè¿”å›**å…±äº«å†…å­˜ ID**ï¼ˆ`shmid`ï¼‰ã€‚
    
- å¤±è´¥ï¼šè¿”å› `-1`ï¼Œå¹¶è®¾ç½® `errno`ã€‚
    

### **2. `shmget` çš„ `shmflg` é€‰é¡¹**

| **æ ‡å¿—ä½**     | **ä½œç”¨**                           |
| ----------- | -------------------------------- |
| `IPC_CREAT` | å¦‚æœå…±äº«å†…å­˜ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º                    |
| `IPC_EXCL`  | ä¸ `IPC_CREAT` ä¸€èµ·ä½¿ç”¨ï¼Œç¡®ä¿å”¯ä¸€æ€§ï¼ˆé˜²æ­¢é‡å¤åˆ›å»ºï¼‰ |
| `0666`      | è®¾ç½®å…±äº«å†…å­˜çš„è¯»å†™æƒé™ï¼ˆä¸æ–‡ä»¶æƒé™ç±»ä¼¼ï¼‰             |

### **3. `shmget` çš„ä½¿ç”¨ç¤ºä¾‹**

#### **ç¤ºä¾‹ï¼šåˆ›å»ºå…±äº«å†…å­˜**

```c
#include <stdio.h>
#include <sys/ipc.h>
#include <sys/shm.h>

#define SHM_SIZE 1024  // å…±äº«å†…å­˜å¤§å°

int main() {
    key_t key = ftok("/tmp", 'a');  // ç”Ÿæˆå”¯ä¸€ key
    if (key == -1) {
        perror("ftok failed");
        return 1;
    }

    int shmid = shmget(key, SHM_SIZE, IPC_CREAT | 0666);  // åˆ›å»ºå…±äº«å†…å­˜
    if (shmid == -1) {
        perror("shmget failed");
        return 1;
    }

    printf("Shared memory created, ID: %d\n", shmid);
    return 0;
}
```

#### **è¿è¡Œ**

```
Shared memory created, ID: 12345
```

- `ftok("/tmp", 'a')` ç”Ÿæˆå”¯ä¸€ `key`ã€‚
    
- `shmget()` åˆ›å»º **1KB** çš„å…±äº«å†…å­˜æ®µã€‚
    
***
## è¡¥å……ï¼š ftok()å‡½æ•°è¯¦è§£

### **`ftok()` å‡½æ•°è¯¦è§£**

`ftok()` æ˜¯ä¸€ä¸ªç”¨äº **ç”Ÿæˆ IPCï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰ å…³é”®å­—** çš„å‡½æ•°ï¼Œå®ƒå¸¸ç”¨äº **System V å…±äº«å†…å­˜ï¼ˆshmï¼‰ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆmsgï¼‰å’Œä¿¡å·é‡ï¼ˆsemï¼‰**ã€‚å®ƒå¯ä»¥æ ¹æ®**æ–‡ä»¶è·¯å¾„å’Œé¡¹ç›® ID** ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ `key_t` ç±»å‹é”®å€¼ï¼Œç¡®ä¿å¤šä¸ªè¿›ç¨‹å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ IPC èµ„æºã€‚


### **1. `ftok()` å‡½æ•°åŸå‹**

```c
#include <sys/types.h>
#include <sys/ipc.h>

key_t ftok(const char *pathname, int proj_id);
```

#### **å‚æ•°**

|**å‚æ•°**|**ä½œç”¨**|
|---|---|
|`pathname`|ç°æœ‰çš„**æ–‡ä»¶è·¯å¾„**ï¼ˆæ–‡ä»¶å¿…é¡»å­˜åœ¨ï¼‰|
|`proj_id`|**é¡¹ç›® ID**ï¼ŒèŒƒå›´ `0-255`ï¼Œç”¨æˆ·è‡ªå®šä¹‰çš„æ ‡è¯†ç¬¦|

#### **è¿”å›å€¼**

- æˆåŠŸï¼šè¿”å› **key_t** ç±»å‹çš„é”®å€¼ï¼ˆç”¨äº `shmget()`ã€`msgget()`ã€`semget()`ï¼‰ã€‚
    
- å¤±è´¥ï¼šè¿”å› `-1`ï¼Œå¹¶è®¾ç½® `errno`ã€‚
    

### **2. `ftok()` çš„ä½œç”¨**

- `ftok()` ç”Ÿæˆçš„ key æ˜¯åŸºäº `pathname` å’Œ `proj_id` è®¡ç®—çš„**å”¯ä¸€æ ‡è¯†ç¬¦**ã€‚
    
- **ç›¸åŒçš„ `pathname` å’Œ `proj_id`ï¼Œåœ¨ä¸åŒè¿›ç¨‹ä¸­ç”Ÿæˆçš„ `key_t` ç›¸åŒ**ï¼Œå¯ä»¥è®©ä¸åŒè¿›ç¨‹è®¿é—®åŒä¸€ä¸ª IPC èµ„æºã€‚
    


### **3. `ftok()` è®¡ç®— key çš„æ–¹å¼**

Linux é€šå¸¸ä½¿ç”¨å¦‚ä¸‹æ–¹å¼è®¡ç®— `key_t`ï¼š

1. `pathname` å¯¹åº”çš„**i-node ç¼–å·**ï¼ˆæ–‡ä»¶ç³»ç»Ÿä¸­çš„å”¯ä¸€æ ‡è¯†ï¼‰ã€‚
    
2. `proj_id` ä½œä¸ºä½ 8 ä½ã€‚
    
3. é€šè¿‡ç‰¹å®šç®—æ³•ç»„åˆæˆ `key_t` å€¼ã€‚
    

ğŸ“Œ **æ³¨æ„**ï¼š

- **å¦‚æœ `pathname` å¯¹åº”çš„æ–‡ä»¶è¢«åˆ é™¤ï¼Œç”Ÿæˆçš„ key å¯èƒ½ä¼šå˜**ï¼ˆå› ä¸º i-node å˜äº†ï¼‰ã€‚
    
- **ä¸åŒçš„ `proj_id` å¯ä»¥ç”Ÿæˆä¸åŒçš„ key**ï¼Œå³ä½¿ `pathname` ç›¸åŒã€‚
    


### **4. `ftok()` ä½¿ç”¨ç¤ºä¾‹**

#### **ç¤ºä¾‹ 1ï¼šç”Ÿæˆ key å¹¶åˆ›å»ºå…±äº«å†…å­˜**

```c
#include <stdio.h>
#include <sys/ipc.h>
#include <sys/shm.h>

#define SHM_SIZE 1024  // å…±äº«å†…å­˜å¤§å°

int main() {
    key_t key = ftok("/tmp", 'a');  // ç”Ÿæˆ key
    if (key == -1) {
        perror("ftok failed");
        return 1;
    }
    
    int shmid = shmget(key, SHM_SIZE, IPC_CREAT | 0666);  // åˆ›å»ºå…±äº«å†…å­˜
    if (shmid == -1) {
        perror("shmget failed");
        return 1;
    }

    printf("Shared memory created with key: %d, ID: %d\n", key, shmid);
    return 0;
}
```

**è¿è¡Œ**

```
Shared memory created with key: 12345, ID: 67890
```

ğŸ“Œ **æ³¨æ„**

- `ftok("/tmp", 'a')` ç”Ÿæˆ keyã€‚
    
- `shmget()` ä½¿ç”¨è¯¥ key åˆ›å»ºå…±äº«å†…å­˜ã€‚
    
- **ä¸åŒè¿›ç¨‹å¯ä»¥ä½¿ç”¨ç›¸åŒ key è®¿é—®è¯¥å…±äº«å†…å­˜**ã€‚
    

### 3 **ç¤ºä¾‹ 2ï¼šä½¿ç”¨ `ftok()` ç”Ÿæˆä¸åŒ IPC èµ„æº**

```c
key_t shm_key = ftok("/tmp", 'A');  // ç”¨äºå…±äº«å†…å­˜
key_t sem_key = ftok("/tmp", 'B');  // ç”¨äºä¿¡å·é‡
key_t msg_key = ftok("/tmp", 'C');  // ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—
```

ğŸ“Œ **è¿™æ ·ï¼Œå¤šä¸ª IPC èµ„æºå¯ä»¥åŸºäºåŒä¸€ä¸ªæ–‡ä»¶ï¼Œä½† `proj_id` ä¸åŒ**ï¼Œä¸ä¼šå†²çªã€‚

 

### **5. `ftok()` å¯èƒ½å¤±è´¥çš„æƒ…å†µ**

#### **âŒ `ftok()` è¿”å› `-1` çš„åŸå› **

| **åŸå› **               | **è§£å†³æ–¹æ¡ˆ**                      |
| -------------------- | ----------------------------- |
| `pathname` ä¸å­˜åœ¨       | ç¡®ä¿ `pathname` æŒ‡å‘çš„æ–‡ä»¶å­˜åœ¨         |
| æ²¡æœ‰è¯»æƒé™                | èµ‹äºˆ `pathname` è¯»æƒé™ï¼ˆ`chmod +r`ï¼‰ |
| `proj_id` è¶…è¿‡ `0-255` | é€‰æ‹© `0-255` ä¹‹é—´çš„æ•°               |

---

### **6. `ftok()` vs `random key`**

æœ‰æ—¶å¼€å‘è€…ä¼š**ä¸ç”¨ `ftok()`ï¼Œè€Œæ˜¯è‡ªå·±ç”Ÿæˆ key**ï¼š

```c
key_t key = 12345;  // ç›´æ¥å®šä¹‰ key
```

**å¯¹æ¯” `ftok()`ï¼š**

|**æ–¹æ³•**|**ä¼˜ç‚¹**|**ç¼ºç‚¹**|
|---|---|---|
|`ftok()`|**è‡ªåŠ¨ç”Ÿæˆ** keyï¼Œé¿å…å†²çª|**éœ€è¦æ–‡ä»¶å­˜åœ¨**|
|æ‰‹åŠ¨ `key_t`|**ä¸ä¾èµ–æ–‡ä»¶**|**å¯èƒ½ key å†²çª**|

ğŸ“Œ **å»ºè®®**

- **å•æœº**ï¼š`ftok()` æ›´å®‰å…¨ï¼Œé¿å… key å†²çªã€‚
    
- **è·¨æœº**ï¼ˆä¸åŒæœºå™¨ä¸Šï¼‰: `ftok()` **ä¸å¯ç”¨**ï¼Œéœ€è¦æ‰‹åŠ¨ keyã€‚
    


### **7. æ€»ç»“**

- `ftok()` ç”¨äº**ç”Ÿæˆå”¯ä¸€çš„ IPC å…³é”®å­—**ï¼Œä¾› `shmget()`ã€`msgget()`ã€`semget()` ä½¿ç”¨ã€‚
    
- `pathname` éœ€è¦æ˜¯**å­˜åœ¨çš„æ–‡ä»¶**ï¼Œ**ä¸èƒ½åˆ é™¤**ï¼Œå¦åˆ™ key å¯èƒ½å˜åŒ–ã€‚
    
- **ç›¸åŒ `pathname` å’Œ `proj_id` åœ¨ä¸åŒè¿›ç¨‹ä¸­ç”Ÿæˆçš„ key ç›¸åŒ**ï¼Œç”¨äº IPC å…±äº«ã€‚
    
- `proj_id` **åº”åœ¨ `0-255` ä¹‹é—´**ï¼Œä¸åŒ `proj_id` å¯ç”Ÿæˆ**ä¸åŒ IPC èµ„æº**ã€‚
    

å¦‚æœè¦åˆ›å»ºå¤šä¸ª IPC èµ„æºï¼ˆå…±äº«å†…å­˜ã€ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼Œå¯ä»¥ï¼š

```c
key_t key1 = ftok("/tmp", 'A');
key_t key2 = ftok("/tmp", 'B');
key_t key3 = ftok("/tmp", 'C');
```

è¿™æ ·ï¼Œ**ä¸åŒ IPC èµ„æºä¸ä¼šå†²çª**ã€‚ğŸš€

***
## **13.6.2 `shmat` å’Œ `shmdt` è¯¦è§£**

åœ¨ **System V å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰** æœºåˆ¶ä¸­ï¼Œ`shmat()` å’Œ `shmdt()` æ˜¯ä¸¤ä¸ªå…³é”®çš„ç³»ç»Ÿè°ƒç”¨ï¼š

- **`shmat()`**ï¼šå°†å…±äº«å†…å­˜**æ˜ å°„**åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œä½¿è¿›ç¨‹å¯ä»¥è®¿é—®å®ƒã€‚
    
- **`shmdt()`**ï¼šè§£é™¤å…±äº«å†…å­˜çš„æ˜ å°„ï¼Œä½¿è¿›ç¨‹ä¸å†è®¿é—®å®ƒã€‚
    

è¿™ä¸¤ä¸ªè°ƒç”¨æ˜¯ `shmget()` ä¹‹åçš„**å¿…è¦æ­¥éª¤**ï¼Œå¦åˆ™è¿›ç¨‹æ— æ³•ä½¿ç”¨å…±äº«å†…å­˜ã€‚


### **1. `shmat()` - å°†å…±äº«å†…å­˜æ˜ å°„åˆ°è¿›ç¨‹**

#### **å‡½æ•°åŸå‹**

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>

void *shmat(int shmid, const void *shmaddr, int shmflg);
```

#### **å‚æ•°**

| **å‚æ•°**    | **ä½œç”¨**                            |
| --------- | --------------------------------- |
| `shmid`   | å…±äº«å†…å­˜æ®µçš„ IDï¼ˆç”± `shmget()` è¿”å›ï¼‰        |
| `shmaddr` | æŒ‡å®šå…±äº«å†…å­˜çš„æŒ‚æ¥åœ°å€ï¼ˆé€šå¸¸è®¾ä¸º `NULL`ï¼Œè®©ç³»ç»Ÿè‡ªåŠ¨åˆ†é…ï¼‰  |
| `shmflg`  | æ ‡å¿—ä½ï¼Œé€šå¸¸è®¾ä¸º `0`ï¼ˆè¯»å†™ï¼‰ï¼Œ`SHM_RDONLY`ï¼ˆåªè¯»ï¼‰ |

#### **è¿”å›å€¼**

- æˆåŠŸï¼šè¿”å›å…±äº«å†…å­˜çš„**æŒ‡é’ˆ**ï¼ˆåœ°å€ï¼‰ã€‚
    
- å¤±è´¥ï¼šè¿”å› `(void *) -1`ï¼Œå¹¶è®¾ç½® `errno`ã€‚
    


#### **2. `shmdt()` - è§£é™¤å…±äº«å†…å­˜æ˜ å°„**

#### **å‡½æ•°åŸå‹**

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>

int shmdt(const void *shmaddr);
```

#### **å‚æ•°**

| **å‚æ•°**    | **ä½œç”¨**                        |
| --------- | ----------------------------- |
| `shmaddr` | å…±äº«å†…å­˜çš„æŒ‡é’ˆåœ°å€ï¼ˆä¹‹å‰ `shmat()` è¿”å›çš„åœ°å€ï¼‰ |

#### **è¿”å›å€¼**

- æˆåŠŸï¼šè¿”å› `0`ã€‚
    
- å¤±è´¥ï¼šè¿”å› `-1`ï¼Œå¹¶è®¾ç½® `errno`ã€‚
    

ğŸ“Œ **æ³¨æ„**

- `shmdt()` **ä¸ä¼šåˆ é™¤** å…±äº«å†…å­˜ï¼Œåªæ˜¯è§£é™¤æ˜ å°„ã€‚
    
- å¦‚æœ**æ‰€æœ‰è¿›ç¨‹éƒ½ `shmdt()` äº†å…±äº«å†…å­˜ï¼Œä¸”æ²¡æœ‰ `shmctl()` åˆ é™¤å®ƒï¼Œå®ƒä»ç„¶å­˜åœ¨**ï¼ˆç›´åˆ°ç³»ç»Ÿé‡å¯æˆ–è¢«æ‰‹åŠ¨åˆ é™¤ï¼‰ã€‚
    


### **3. `shmat()` å’Œ `shmdt()` çš„å®Œæ•´ç¤ºä¾‹**

#### **è¿›ç¨‹ 1ï¼ˆå†™å…¥å…±äº«å†…å­˜ï¼‰**

```c
#include <stdio.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <string.h>

#define SHM_SIZE 1024  // å…±äº«å†…å­˜å¤§å°

int main() {
    key_t key = ftok("/tmp", 'A');  // ç”Ÿæˆ key
    int shmid = shmget(key, SHM_SIZE, IPC_CREAT | 0666);  // è·å–å…±äº«å†…å­˜
    if (shmid == -1) {
        perror("shmget failed");
        return 1;
    }

    // æŒ‚æ¥å…±äº«å†…å­˜
    char *shmaddr = (char *)shmat(shmid, NULL, 0);
    if (shmaddr == (void *)-1) {
        perror("shmat failed");
        return 1;
    }

    // å†™å…¥æ•°æ®
    strcpy(shmaddr, "Hello, Shared Memory!");
    printf("Written to shared memory: %s\n", shmaddr);

    // è§£é™¤æ˜ å°„
    shmdt(shmaddr);
    return 0;
}
```


#### **è¿›ç¨‹ 2ï¼ˆè¯»å–å…±äº«å†…å­˜ï¼‰**

```c
#include <stdio.h>
#include <sys/ipc.h>
#include <sys/shm.h>

#define SHM_SIZE 1024

int main() {
    key_t key = ftok("/tmp", 'A');
    int shmid = shmget(key, SHM_SIZE, 0666);  // ä»…è·å–å·²å­˜åœ¨çš„å…±äº«å†…å­˜
    if (shmid == -1) {
        perror("shmget failed");
        return 1;
    }

    // æŒ‚æ¥å…±äº«å†…å­˜
    char *shmaddr = (char *)shmat(shmid, NULL, 0);
    if (shmaddr == (void *)-1) {
        perror("shmat failed");
        return 1;
    }

    // è¯»å–æ•°æ®
    printf("Read from shared memory: %s\n", shmaddr);

    // è§£é™¤æ˜ å°„
    shmdt(shmaddr);
    return 0;
}
```


#### **è¿›ç¨‹ 3ï¼ˆåˆ é™¤å…±äº«å†…å­˜ï¼‰**

```c
#include <sys/ipc.h>
#include <sys/shm.h>
#include <stdio.h>

int main() {
    key_t key = ftok("/tmp", 'A');
    int shmid = shmget(key, 1024, 0666);
    if (shmid == -1) {
        perror("shmget failed");
        return 1;
    }

    shmctl(shmid, IPC_RMID, NULL);  // åˆ é™¤å…±äº«å†…å­˜
    printf("Shared memory deleted\n");
    return 0;
}
```


### **4. `shmat()` å‚æ•°è¯¦ç»†è§£é‡Š**

#### **1ï¸âƒ£ `shmaddr = NULL`ï¼ˆæ¨èï¼‰**

```c
char *shmaddr = (char *)shmat(shmid, NULL, 0);
```

- è®©**ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©æ˜ å°„åœ°å€**ï¼ˆæ›´å®‰å…¨ï¼‰ã€‚
    
- é€‚ç”¨äºå¤§å¤šæ•°æƒ…å†µã€‚
    

#### **2ï¸âƒ£ æŒ‡å®š `shmaddr` åœ°å€**

```c
char *shmaddr = (char *)shmat(shmid, (void *)0x50000000, 0);
```

- æŒ‡å®šå›ºå®šåœ°å€ï¼ˆä¸æ¨èï¼‰ã€‚
    
- å¯èƒ½ä¸è¿›ç¨‹çš„å†…å­˜å¸ƒå±€å†²çªï¼Œå¯¼è‡´ `shmat()` å¤±è´¥ã€‚
    


### **5. `shmflg` æ ‡å¿—**

| **æ ‡å¿—**       | **ä½œç”¨**                              |
| ------------ | ----------------------------------- |
| `0`          | é»˜è®¤ï¼ˆè¯»å†™ï¼‰                              |
| `SHM_RDONLY` | ä»¥**åªè¯»æ¨¡å¼**æŒ‚æ¥                         |
| `SHM_RND`    | åœ°å€å‘ä¸‹å–æ•´åˆ° `SHMLBA`ï¼ˆLinux é€šå¸¸ä¸º 4096 å­—èŠ‚ï¼‰ |

#### **ç¤ºä¾‹ï¼šåªè¯»æ¨¡å¼**

```c
char *shmaddr = (char *)shmat(shmid, NULL, SHM_RDONLY);
```

- è¿›ç¨‹å¯ä»¥è¯»å–å…±äº«å†…å­˜ï¼Œä½†**ä¸èƒ½ä¿®æ”¹**ã€‚
    


### **6. `shmdt()` ç»†èŠ‚**

#### **`shmdt()` åªæ˜¯è§£é™¤æ˜ å°„ï¼Œä¸åˆ é™¤å…±äº«å†…å­˜**

```c
shmdt(shmaddr);
```

- è¿›ç¨‹**ä¸å†è®¿é—®**å…±äº«å†…å­˜ã€‚
    
- ä½†**å…±äº«å†…å­˜ä»ç„¶å­˜åœ¨**ï¼Œå¯ä»¥è¢«å…¶ä»–è¿›ç¨‹ä½¿ç”¨ã€‚
    
- éœ€è¦ `shmctl(shmid, IPC_RMID, NULL);` **åˆ é™¤å…±äº«å†…å­˜**ã€‚
    

### **7. `shmat()` / `shmdt()` vs `mmap()`**

| **ç‰¹æ€§**    | **`shmat()` / `shmdt()`ï¼ˆSystem Vï¼‰** | **`mmap()`ï¼ˆPOSIXï¼‰** |
| --------- | ----------------------------------- | ------------------- |
| **è¿›ç¨‹é—´é€šä¿¡** | æ˜¯ï¼ˆå…±äº«å†…å­˜ï¼‰                             | æ˜¯ï¼ˆæ–‡ä»¶æ˜ å°„ï¼‰             |
| **ä½¿ç”¨æ–¹å¼**  | `shmget()` + `shmat()`              | `mmap()`            |
| **å¯ç§»æ¤æ€§**  | System V å…¼å®¹                         | POSIX å…¼å®¹            |
| **å†…å­˜æŒä¹…åŒ–** | å¦                                   | å¯èƒ½ï¼ˆæ–‡ä»¶æ˜ å°„ï¼‰            |
| **çµæ´»æ€§**   | ä½ï¼ˆå›ºå®š `shmget()`ï¼‰                    | é«˜ï¼ˆå¯æ˜ å°„æ–‡ä»¶æˆ–åŒ¿åï¼‰         |

### **8. æ€»ç»“**

- `shmat(shmid, NULL, 0)` **æ˜ å°„å…±äº«å†…å­˜**ï¼Œè¿”å›åœ°å€ã€‚
    
- `shmdt(shmaddr)` **è§£é™¤æ˜ å°„**ï¼Œä½†ä¸åˆ é™¤å…±äº«å†…å­˜ã€‚
    
- **è¦åˆ é™¤å…±äº«å†…å­˜**ï¼Œå¿…é¡»è°ƒç”¨ `shmctl(shmid, IPC_RMID, NULL);`ã€‚
    
- å…±äº«å†…å­˜é€‚ç”¨äº**è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰**ï¼Œæ¯”æ¶ˆæ¯é˜Ÿåˆ—å’Œç®¡é“æ›´å¿«ã€‚ 

***
## **13.6.3 shmctl() è¯¦è§£**

`shmctl()` æ˜¯ Linux System V **å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰** ç›¸å…³çš„ **æ§åˆ¶ç³»ç»Ÿè°ƒç”¨**ï¼Œç”¨äº**ç®¡ç†å…±äº«å†…å­˜æ®µ**ã€‚å®ƒå¯ä»¥ç”¨äº**æŸ¥è¯¢ä¿¡æ¯ã€ä¿®æ”¹æƒé™å’Œåˆ é™¤å…±äº«å†…å­˜**ã€‚


### **1. `shmctl()` å‡½æ•°åŸå‹**

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>

int shmctl(int shmid, int cmd, struct shmid_ds *buf);
```

### **2. å‚æ•°è¯¦è§£**

|**å‚æ•°**|**ä½œç”¨**|
|---|---|
|`shmid`|**å…±äº«å†…å­˜æ®µ ID**ï¼ˆç”± `shmget()` è¿”å›ï¼‰|
|`cmd`|**æ§åˆ¶å‘½ä»¤**ï¼ˆæŒ‡å®šæ“ä½œç±»å‹ï¼Œå¦‚åˆ é™¤ã€ä¿®æ”¹æƒé™ç­‰ï¼‰|
|`buf`|**æ•°æ®ç»“æ„æŒ‡é’ˆ**ï¼ˆç”¨äºå­˜å‚¨æˆ–ä¿®æ”¹å…±äº«å†…å­˜çš„ä¿¡æ¯ï¼‰|


### **3. `cmd`ï¼ˆæ§åˆ¶å‘½ä»¤ï¼‰å¯é€‰å€¼**

| **`cmd`**    | **ä½œç”¨**                       |
| ------------ | ---------------------------- |
| `IPC_STAT`   | è·å–å…±äº«å†…å­˜çš„ä¿¡æ¯ï¼Œå­˜å…¥ `buf`           |
| `IPC_SET`    | ä¿®æ”¹ `buf` ç»“æ„ä¸­çš„å…±äº«å†…å­˜å±æ€§ï¼ˆå¦‚æƒé™ï¼‰     |
| `IPC_RMID`   | **åˆ é™¤å…±äº«å†…å­˜**                   |
| `SHM_LOCK`   | é”å®šå…±äº«å†…å­˜ï¼Œé˜²æ­¢è¢«äº¤æ¢åˆ°ç£ç›˜ï¼ˆä»… root ç”¨æˆ·å¯ç”¨ï¼‰ |
| `SHM_UNLOCK` | è§£é”å…±äº«å†…å­˜                       |


### **4. `struct shmid_ds` ç»“æ„ä½“**

`shmctl()` ç”¨ `struct shmid_ds` ç»“æ„ä½“å­˜å‚¨å…±äº«å†…å­˜çš„ä¿¡æ¯ï¼š

```c
struct shmid_ds {
    struct ipc_perm shm_perm;   // å…±äº«å†…å­˜æƒé™
    size_t shm_segsz;           // å…±äº«å†…å­˜å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    pid_t shm_lpid;             // æœ€åæ“ä½œè¯¥å…±äº«å†…å­˜çš„è¿›ç¨‹ ID
    pid_t shm_cpid;             // åˆ›å»ºè¯¥å…±äº«å†…å­˜çš„è¿›ç¨‹ ID
    shmatt_t shm_nattch;        // å½“å‰é™„åŠ åˆ°è¯¥å…±äº«å†…å­˜çš„è¿›ç¨‹æ•°
    time_t shm_atime;           // æœ€åä¸€æ¬¡ `shmat()` æ—¶é—´
    time_t shm_dtime;           // æœ€åä¸€æ¬¡ `shmdt()` æ—¶é—´
    time_t shm_ctime;           // å…±äº«å†…å­˜åˆ›å»ºæ—¶é—´
};
```

ğŸ“Œ **é‡ç‚¹å­—æ®µè§£é‡Š**

- **`shm_segsz`**ï¼šå…±äº«å†…å­˜å¤§å°ï¼ˆå­—èŠ‚ï¼‰ã€‚
    
- **`shm_nattch`**ï¼šå½“å‰æœ‰å¤šå°‘ä¸ªè¿›ç¨‹è¿æ¥åˆ°è¿™å—å…±äº«å†…å­˜ã€‚
    
- **`shm_perm.mode`**ï¼šå…±äº«å†…å­˜çš„è®¿é—®æƒé™ï¼ˆå¦‚ `0666`ï¼‰ã€‚
    
- **`shm_perm.uid / shm_perm.gid`**ï¼šåˆ›å»ºè€…ç”¨æˆ· ID å’Œç»„ IDã€‚
    


## **5. `shmctl()` ä½¿ç”¨ç¤ºä¾‹**

### **ç¤ºä¾‹ 1ï¼šè·å–å…±äº«å†…å­˜ä¿¡æ¯ï¼ˆ`IPC_STAT`ï¼‰**

```c
#include <stdio.h>
#include <sys/ipc.h>
#include <sys/shm.h>

int main() {
    key_t key = ftok("/tmp", 'A');
    int shmid = shmget(key, 1024, 0666);
    if (shmid == -1) {
        perror("shmget failed");
        return 1;
    }

    struct shmid_ds buf;
    if (shmctl(shmid, IPC_STAT, &buf) == -1) {
        perror("shmctl IPC_STAT failed");
        return 1;
    }

    printf("Shared Memory Size: %ld bytes\n", buf.shm_segsz);
    printf("Attached Processes: %ld\n", buf.shm_nattch);
    printf("Last attach time: %ld\n", buf.shm_atime);
    printf("Last detach time: %ld\n", buf.shm_dtime);
    
    return 0;
}
```

ğŸ“Œ **åŠŸèƒ½**

- **æŸ¥è¯¢** å…±äº«å†…å­˜ä¿¡æ¯ï¼Œå¦‚å¤§å°ã€å½“å‰è¿æ¥è¿›ç¨‹æ•°ã€æœ€è¿‘è®¿é—®æ—¶é—´ã€‚
    

### **ç¤ºä¾‹ 2ï¼šä¿®æ”¹å…±äº«å†…å­˜æƒé™ï¼ˆ`IPC_SET`ï¼‰**

```c
#include <stdio.h>
#include <sys/ipc.h>
#include <sys/shm.h>

int main() {
    key_t key = ftok("/tmp", 'A');
    int shmid = shmget(key, 1024, 0666);
    if (shmid == -1) {
        perror("shmget failed");
        return 1;
    }

    struct shmid_ds buf;
    if (shmctl(shmid, IPC_STAT, &buf) == -1) {
        perror("shmctl IPC_STAT failed");
        return 1;
    }

    buf.shm_perm.mode = 0644;  // ä¿®æ”¹æƒé™ä¸º 0644ï¼ˆæ‰€æœ‰è€…å¯è¯»å†™ï¼Œå…¶ä»–äººåªè¯»ï¼‰
    if (shmctl(shmid, IPC_SET, &buf) == -1) {
        perror("shmctl IPC_SET failed");
        return 1;
    }

    printf("Shared memory permissions changed to 0644\n");
    return 0;
}
```

ğŸ“Œ **åŠŸèƒ½**

- å…ˆç”¨ `IPC_STAT` è·å–ä¿¡æ¯ï¼Œç„¶å**ä¿®æ”¹æƒé™**ã€‚
    

### **ç¤ºä¾‹ 3ï¼šåˆ é™¤å…±äº«å†…å­˜ï¼ˆ`IPC_RMID`ï¼‰**

```c
#include <stdio.h>
#include <sys/ipc.h>
#include <sys/shm.h>

int main() {
    key_t key = ftok("/tmp", 'A');
    int shmid = shmget(key, 1024, 0666);
    if (shmid == -1) {
        perror("shmget failed");
        return 1;
    }

    if (shmctl(shmid, IPC_RMID, NULL) == -1) {
        perror("shmctl IPC_RMID failed");
        return 1;
    }

    printf("Shared memory deleted.\n");
    return 0;
}
```

ğŸ“Œ **åŠŸèƒ½**

- **åˆ é™¤å…±äº«å†…å­˜æ®µ**ï¼Œä½†ï¼š
    
    - **ä»ç„¶è¿æ¥çš„è¿›ç¨‹ä¸ä¼šç«‹å³å—åˆ°å½±å“**ï¼Œåªæœ‰å½“æ‰€æœ‰è¿›ç¨‹ `shmdt()` åï¼Œå†…å­˜æ‰ä¼šçœŸæ­£é‡Šæ”¾ã€‚
        

### **6. `shmctl()` å¤±è´¥çš„å¯èƒ½åŸå› **

| **é”™è¯¯ç  (`errno`)** | **å¯èƒ½åŸå› **               | **è§£å†³æ–¹æ¡ˆ**                        |
| ----------------- | ---------------------- | ------------------------------- |
| `EINVAL`          | `shmid` æ— æ•ˆ             | ç¡®ä¿ `shmid` æ­£ç¡®ï¼Œä½¿ç”¨ `shmget()` è·å–  |
| `EACCES`          | æ— æƒé™è®¿é—®                  | è¿è¡Œ `chmod` èµ‹äºˆæƒé™                 |
| `EFAULT`          | `buf` æŒ‡é’ˆéæ³•             | ç¡®ä¿ `buf` æŒ‡å‘æœ‰æ•ˆ `struct shmid_ds` |
| `EPERM`           | é root ç”¨æˆ·å°è¯• `SHM_LOCK` | ä»¥ root èº«ä»½è¿è¡Œ                     |


### **7. `shmctl()` vs `shmdt()` vs `shmget()`**

|**å‡½æ•°**|**ä½œç”¨**|
|---|---|
|`shmget()`|åˆ›å»ºå…±äº«å†…å­˜|
|`shmat()`|è¿›ç¨‹**è¿æ¥**å…±äº«å†…å­˜|
|`shmdt()`|è¿›ç¨‹**æ–­å¼€**å…±äº«å†…å­˜|
|`shmctl(IPC_STAT)`|è·å–å…±äº«å†…å­˜ä¿¡æ¯|
|`shmctl(IPC_SET)`|ä¿®æ”¹å…±äº«å†…å­˜æƒé™|
|`shmctl(IPC_RMID)`|**åˆ é™¤å…±äº«å†…å­˜**|


### **8. `shmctl()` ç›¸å…³çš„ç³»ç»Ÿå‘½ä»¤**

**Linux æä¾›äº† `ipcs` å’Œ `ipcrm` å‘½ä»¤æ¥ç®¡ç†å…±äº«å†…å­˜ï¼š**

### **æŸ¥çœ‹å…±äº«å†…å­˜**

```sh
ipcs -m
```

ğŸ“Œ **ç¤ºä¾‹è¾“å‡º**

```
------ Shared Memory Segments ------
key        shmid      owner      perms      bytes      nattch     
0x12345678 56789      user       666        1024       1
```

- `shmid`ï¼šå…±äº«å†…å­˜ ID
    
- `bytes`ï¼šå¤§å°
    
- `nattch`ï¼šå½“å‰è¿æ¥çš„è¿›ç¨‹æ•°
    

### **åˆ é™¤å…±äº«å†…å­˜**

```sh
ipcrm -m 56789
```

ğŸ“Œ `56789` æ˜¯ `shmid`ï¼Œç›¸å½“äº `shmctl(shmid, IPC_RMID, NULL);`ã€‚


### **9. æ€»ç»“**

âœ… `shmctl()` ä¸»è¦ç”¨äºï¼š

- **æŸ¥è¯¢å…±äº«å†…å­˜ä¿¡æ¯**ï¼ˆ`IPC_STAT`ï¼‰
    
- **ä¿®æ”¹æƒé™**ï¼ˆ`IPC_SET`ï¼‰
    
- **åˆ é™¤å…±äº«å†…å­˜**ï¼ˆ`IPC_RMID`ï¼‰
    

å¦‚æœæƒ³**åˆ é™¤å…±äº«å†…å­˜**ï¼š

- ä»£ç è°ƒç”¨ï¼š`shmctl(shmid, IPC_RMID, NULL);`
    
- å‘½ä»¤è¡Œè°ƒç”¨ï¼š`ipcrm -m <shmid>`
    

**ä½¿ç”¨ `shmat()` è¿æ¥å…±äº«å†…å­˜çš„è¿›ç¨‹å¿…é¡» `shmdt()` åï¼Œåˆ é™¤æ‰ç”Ÿæ•ˆ**ï¼ğŸš€

***

## **13.6.4 POSIX å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰è¯¦è§£**

POSIX å…±äº«å†…å­˜ï¼ˆ`shm_open` / `shm_unlink`ï¼‰æ˜¯ **è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰** çš„ä¸€ç§æ–¹å¼ï¼Œå®ƒæ¯” System V å…±äº«å†…å­˜æ›´**ç®€å•ã€å¯ç§»æ¤**ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨**æ–‡ä»¶æè¿°ç¬¦**æ¥ç®¡ç†ã€‚


### **1. POSIX å…±äº«å†…å­˜ vs. System V å…±äº«å†…å­˜**

| **ç‰¹æ€§**     | **POSIX å…±äº«å†…å­˜**            | **System V å…±äº«å†…å­˜**            |
| ---------- | ------------------------- | ---------------------------- |
| **åˆ›å»ºæ–¹å¼**   | `shm_open()`              | `shmget()`                   |
| **æ˜ å°„æ–¹å¼**   | `mmap()`                  | `shmat()`                    |
| **åˆ é™¤æ–¹å¼**   | `shm_unlink()`            | `shmctl(IPC_RMID)`           |
| **å‘½åæ–¹å¼**   | ä»¥**æ–‡ä»¶è·¯å¾„**å‘½åï¼ˆå¦‚`/shm_test`ï¼‰ | ç”¨**`key_t`** ç”Ÿæˆ `shmid`      |
| **è¿›ç¨‹è®¿é—®æ–¹å¼** | ä½¿ç”¨ **æ–‡ä»¶æè¿°ç¬¦**              | ç›´æ¥ä½¿ç”¨ `shmid`                 |
| **æ¸…ç†**     | **æŒä¹…åŒ–**ï¼Œè¿›ç¨‹é€€å‡ºåä»ç„¶å­˜åœ¨         | è¿›ç¨‹é€€å‡ºåå¯èƒ½ä»ç„¶å­˜åœ¨ï¼Œå¿…é¡» `shmctl()` åˆ é™¤ |

POSIX å…±äº«å†…å­˜æ˜¯**æ–‡ä»¶ç³»ç»Ÿå‹å¥½çš„æ–¹å¼**ï¼Œ**ä¸ `mmap()` ç»“åˆä½¿ç”¨**ï¼Œæ›´ç°ä»£ã€æ›´çµæ´»ã€‚


### **2. POSIX å…±äº«å†…å­˜ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨**

|**å‡½æ•°**|**ä½œç”¨**|
|---|---|
|`shm_open()`|åˆ›å»ºæˆ–æ‰“å¼€å…±äº«å†…å­˜å¯¹è±¡ï¼ˆè¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼‰|
|`ftruncate()`|è®¾ç½®å…±äº«å†…å­˜å¤§å°|
|`mmap()`|å°†å…±äº«å†…å­˜æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´|
|`munmap()`|è§£é™¤æ˜ å°„|
|`shm_unlink()`|åˆ é™¤å…±äº«å†…å­˜å¯¹è±¡|


### **3. POSIX å…±äº«å†…å­˜çš„ä½¿ç”¨æµç¨‹**

### **ğŸ“Œ è¿›ç¨‹ 1ï¼ˆå†™å…¥å…±äº«å†…å­˜ï¼‰**

```c
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>      // O_* å¸¸é‡
#include <sys/mman.h>   // mmap, shm_open
#include <unistd.h>     // ftruncate, close
#include <string.h>

#define SHM_NAME "/shm_test"
#define SHM_SIZE 1024

int main() {
    // 1ï¸âƒ£ åˆ›å»ºæˆ–æ‰“å¼€å…±äº«å†…å­˜å¯¹è±¡
    int shm_fd = shm_open(SHM_NAME, O_CREAT | O_RDWR, 0666);
    if (shm_fd == -1) {
        perror("shm_open failed");
        return 1;
    }

    // 2ï¸âƒ£ è®¾ç½®å…±äº«å†…å­˜å¤§å°
    if (ftruncate(shm_fd, SHM_SIZE) == -1) {
        perror("ftruncate failed");
        return 1;
    }

    // 3ï¸âƒ£ æ˜ å°„å…±äº«å†…å­˜åˆ°è¿›ç¨‹åœ°å€ç©ºé—´
    void *shm_ptr = mmap(0, SHM_SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, shm_fd, 0);
    if (shm_ptr == MAP_FAILED) {
        perror("mmap failed");
        return 1;
    }

    // 4ï¸âƒ£ å†™å…¥å…±äº«å†…å­˜
    strcpy((char *)shm_ptr, "Hello, POSIX Shared Memory!");
    printf("Written to shared memory: %s\n", (char *)shm_ptr);

    // 5ï¸âƒ£ è§£é™¤æ˜ å°„
    munmap(shm_ptr, SHM_SIZE);
    
    // 6ï¸âƒ£ å…³é—­æ–‡ä»¶æè¿°ç¬¦ï¼ˆä½†å…±äº«å†…å­˜ä»ç„¶å­˜åœ¨ï¼‰
    close(shm_fd);

    return 0;
}
```


#### **ğŸ“Œ è¿›ç¨‹ 2ï¼ˆè¯»å–å…±äº«å†…å­˜ï¼‰**

```c
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>      // O_* å¸¸é‡
#include <sys/mman.h>   // mmap, shm_open
#include <unistd.h>     // close

#define SHM_NAME "/shm_test"
#define SHM_SIZE 1024

int main() {
    // 1ï¸âƒ£ æ‰“å¼€å…±äº«å†…å­˜å¯¹è±¡
    int shm_fd = shm_open(SHM_NAME, O_RDONLY, 0666);
    if (shm_fd == -1) {
        perror("shm_open failed");
        return 1;
    }

    // 2ï¸âƒ£ æ˜ å°„å…±äº«å†…å­˜åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ï¼ˆåªè¯»æ¨¡å¼ï¼‰
    void *shm_ptr = mmap(0, SHM_SIZE, PROT_READ, MAP_SHARED, shm_fd, 0);
    if (shm_ptr == MAP_FAILED) {
        perror("mmap failed");
        return 1;
    }

    // 3ï¸âƒ£ è¯»å–æ•°æ®
    printf("Read from shared memory: %s\n", (char *)shm_ptr);

    // 4ï¸âƒ£ è§£é™¤æ˜ å°„
    munmap(shm_ptr, SHM_SIZE);
    
    // 5ï¸âƒ£ å…³é—­æ–‡ä»¶æè¿°ç¬¦
    close(shm_fd);

    return 0;
}
```


#### **ğŸ“Œ è¿›ç¨‹ 3ï¼ˆåˆ é™¤å…±äº«å†…å­˜ï¼‰**

```c
#include <stdio.h>
#include <fcntl.h>      
#include <sys/mman.h>   

#define SHM_NAME "/shm_test"

int main() {
    // åˆ é™¤å…±äº«å†…å­˜
    if (shm_unlink(SHM_NAME) == -1) {
        perror("shm_unlink failed");
        return 1;
    }

    printf("Shared memory deleted.\n");
    return 0;
}
```


### **4. è¯¦ç»†è§£é‡Š `shm_open()` / `shm_unlink()`**

#### **1ï¸âƒ£ `shm_open()` - åˆ›å»º/æ‰“å¼€å…±äº«å†…å­˜**

```c
int shm_fd = shm_open("/shm_test", O_CREAT | O_RDWR, 0666);
```

|**å‚æ•°**|**ä½œç”¨**|
|---|---|
|`"/shm_test"`|å…±äº«å†…å­˜åç§°ï¼ˆå¿…é¡»ä»¥ `/` å¼€å¤´ï¼Œç±»ä¼¼æ–‡ä»¶è·¯å¾„ï¼‰|
|`O_CREAT`|å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º|
|`O_RDWR`|ä»¥è¯»å†™æ¨¡å¼æ‰“å¼€|
|`0666`|è®¾å®šæƒé™ï¼ˆæ‰€æœ‰ç”¨æˆ·å¯è¯»å†™ï¼‰|

ğŸ”¹ **è¿”å›å€¼**ï¼šæ–‡ä»¶æè¿°ç¬¦ï¼ˆç”¨äº `mmap()`ï¼‰ã€‚


#### **2ï¸âƒ£ `ftruncate()` - è®¾ç½®å…±äº«å†…å­˜å¤§å°**

```c
ftruncate(shm_fd, 1024);
```

- `shm_open()` åªæ˜¯åˆ›å»ºäº†**æ–‡ä»¶**ï¼Œä½†é»˜è®¤å¤§å°æ˜¯ 0ï¼Œå¿…é¡»ç”¨ `ftruncate()` è®¾ç½®å¤§å°ã€‚
    


#### **3ï¸âƒ£ `mmap()` - æ˜ å°„å…±äº«å†…å­˜**

```c
void *shm_ptr = mmap(0, 1024, PROT_READ | PROT_WRITE, MAP_SHARED, shm_fd, 0);
```

|**å‚æ•°**|**ä½œç”¨**|
|---|---|
|`0`|è®©ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©åœ°å€|
|`1024`|å…±äº«å†…å­˜å¤§å°|
|`PROT_READ|PROT_WRITE`|
|`MAP_SHARED`|å…±äº«æ˜ å°„ï¼ˆå…¶ä»–è¿›ç¨‹å¯è§ï¼‰|
|`shm_fd`|å…±äº«å†…å­˜æ–‡ä»¶æè¿°ç¬¦|
|`0`|åç§»é‡ï¼ˆä¸€èˆ¬ä¸º 0ï¼‰|

ğŸ”¹ **è¿”å›å€¼**ï¼šæ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´çš„æŒ‡é’ˆã€‚


#### **4ï¸âƒ£ `shm_unlink()` - åˆ é™¤å…±äº«å†…å­˜**

```c
shm_unlink("/shm_test");
```

- ç±»ä¼¼ `unlink()`ï¼Œ**åˆ é™¤å…±äº«å†…å­˜å¯¹è±¡**ï¼ˆæ‰€æœ‰è¿›ç¨‹å…³é—­åæ‰çœŸæ­£é‡Šæ”¾ï¼‰ã€‚
    


### **5. é€‚ç”¨åœºæ™¯**

âœ… **POSIX å…±äº«å†…å­˜é€‚ç”¨äº**

- **å¤šè¿›ç¨‹æ•°æ®å…±äº«**ï¼ˆæ¯”ç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—æ›´å¿«ï¼‰
    
- **æœåŠ¡å™¨-å®¢æˆ·ç«¯æ¨¡å‹**ï¼ˆå¤šä¸ªè¿›ç¨‹è¯»å–åŒä¸€å†…å­˜ï¼‰
    
- **é«˜æ•ˆ IPCï¼ˆInter-Process Communicationï¼‰**
    
- **æ›´ç°ä»£çš„ Linux åº”ç”¨**
    


### **6. æ€»ç»“**

|**æ­¥éª¤**|**å‡½æ•°**|
|---|---|
|**åˆ›å»º/æ‰“å¼€å…±äº«å†…å­˜**|`shm_open()`|
|**è®¾ç½®å¤§å°**|`ftruncate()`|
|**æ˜ å°„å†…å­˜**|`mmap()`|
|**è¯»å†™æ•°æ®**|ç›´æ¥ä½¿ç”¨æŒ‡é’ˆæ“ä½œ|
|**è§£é™¤æ˜ å°„**|`munmap()`|
|**å…³é—­æ–‡ä»¶æè¿°ç¬¦**|`close()`|
|**åˆ é™¤å…±äº«å†…å­˜**|`shm_unlink()`|

POSIX å…±äº«å†…å­˜**æ›´æ˜“ç”¨ã€æ›´ç°ä»£**ï¼Œé€‚ç”¨äº**é«˜æ€§èƒ½å¤šè¿›ç¨‹é€šä¿¡**ï¼ğŸš€

***

# 13.7 æ¶ˆæ¯é˜Ÿåˆ—


### ğŸŒŸ ä¸€ã€åŸºæœ¬æ¦‚å¿µ

POSIX æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰æ˜¯åŸºäº **åå­—å‘½å** çš„ï¼Œå…è®¸è¿›ç¨‹é—´ä»¥**å…ˆè¿›å…ˆå‡º**çš„æ–¹å¼ä¼ é€’**ç»“æ„åŒ–æ¶ˆæ¯**ï¼Œé€‚åˆæœ‰ä¼˜å…ˆçº§ã€ç»“æ„åŒ–éœ€æ±‚çš„é€šä¿¡ã€‚

---

### ğŸ“š äºŒã€ç›¸å…³å¤´æ–‡ä»¶

```c
#include <mqueue.h>     // POSIX æ¶ˆæ¯é˜Ÿåˆ—ä¸»å¤´æ–‡ä»¶
#include <fcntl.h>      // O_CREAT ç­‰å¸¸é‡å®šä¹‰
#include <sys/stat.h>   // mode_t æƒé™è®¾ç½®
```

---

### ğŸ§± ä¸‰ã€ä¸»è¦å‡½æ•°åŠå‚æ•°

---

#### 1. `mqd_t mq_open(const char *name, int oflag, mode_t mode, struct mq_attr *attr);`

- **åŠŸèƒ½**ï¼šæ‰“å¼€æˆ–åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚
    
- **å‚æ•°è¯´æ˜**ï¼š
    
    - `name`ï¼šæ¶ˆæ¯é˜Ÿåˆ—åï¼Œå¿…é¡»ä»¥ `/` å¼€å¤´ï¼Œä¾‹å¦‚ `"/myqueue"`ã€‚
        
    - `oflag`ï¼š
        
        - `O_RDONLY`ï¼šåªè¯»
            
        - `O_WRONLY`ï¼šåªå†™
            
        - `O_RDWR`ï¼šå¯è¯»å¯å†™
            
        - `O_CREAT`ï¼šå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
            
        - `O_EXCL`ï¼šä¸ `O_CREAT` ä¸€èµ·ç”¨ï¼Œè‹¥å·²å­˜åœ¨åˆ™å¤±è´¥
            
    - `mode`ï¼šæƒé™ï¼Œä¾‹å¦‚ `0666` è¡¨ç¤ºç”¨æˆ·ã€ç»„ã€å…¶ä»–éƒ½æœ‰è¯»å†™æƒé™ã€‚
        
    - `attr`ï¼šå¯é€‰ï¼Œè®¾ç½®é˜Ÿåˆ—å±æ€§ï¼Œè‹¥ä¸º NULL ä½¿ç”¨é»˜è®¤å€¼ã€‚
        
        ```c
        struct mq_attr {
            long mq_flags;    // 0ï¼šé˜»å¡ï¼›O_NONBLOCKï¼šéé˜»å¡
            long mq_maxmsg;   // æœ€å¤§æ¶ˆæ¯æ•°
            long mq_msgsize;  // æ¯æ¡æ¶ˆæ¯çš„æœ€å¤§å¤§å°
            long mq_curmsgs;  // å½“å‰æ¶ˆæ¯æ•°ï¼ˆåªè¯»ï¼‰
        };
        ```
        

---

#### 2. `int mq_send(mqd_t mqdes, const char *msg_ptr, size_t msg_len, unsigned int msg_prio);`

- **åŠŸèƒ½**ï¼šå‘é€æ¶ˆæ¯ã€‚
    
- **å‚æ•°è¯´æ˜**ï¼š
    
    - `mqdes`ï¼šç”± `mq_open` è¿”å›çš„æè¿°ç¬¦ã€‚
        
    - `msg_ptr`ï¼šæ¶ˆæ¯å†…å®¹ã€‚
        
    - `msg_len`ï¼šæ¶ˆæ¯é•¿åº¦ï¼Œä¸èƒ½è¶…è¿‡ `mq_msgsize`ã€‚
        
    - `msg_prio`ï¼šä¼˜å…ˆçº§ï¼ˆ0 æ˜¯é»˜è®¤ï¼Œå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰ã€‚
        

---

#### 3. `ssize_t mq_receive(mqd_t mqdes, char *msg_ptr, size_t msg_len, unsigned int *msg_prio);`

- **åŠŸèƒ½**ï¼šæ¥æ”¶æ¶ˆæ¯ã€‚
    
- **å‚æ•°è¯´æ˜**ï¼š
    
    - `msg_ptr`ï¼šç”¨äºå­˜æ”¾æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚
        
    - `msg_len`ï¼šç¼“å†²åŒºå¤§å°ï¼Œåº” â‰¥ `mq_msgsize`ã€‚
        
    - `msg_prio`ï¼šè‹¥ä¸ä¸º NULLï¼Œä¼šè¿”å›æ¶ˆæ¯çš„ä¼˜å…ˆçº§ã€‚
        

---

#### 4. `int mq_close(mqd_t mqdes);`

- **åŠŸèƒ½**ï¼šå…³é—­é˜Ÿåˆ—æè¿°ç¬¦ã€‚
    
- **mq_unlink(name)`ï¼šåˆ é™¤æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆç±»ä¼¼` unlink` åˆ é™¤æ–‡ä»¶ï¼‰**ã€‚
    

---

#### 5. `int mq_getattr(mqd_t mqdes, struct mq_attr *attr);`

#### 6. `int mq_setattr(mqd_t mqdes, const struct mq_attr *newattr, struct mq_attr *oldattr);`

---

### ğŸ“Œ å››ã€å®Œæ•´ç¤ºä¾‹

#### **å‘é€è€…ï¼ˆsender.cï¼‰**

```c
#include <stdio.h>
#include <mqueue.h>
#include <string.h>

int main() {
    mqd_t mq;
    struct mq_attr attr = {
        .mq_flags = 0,
        .mq_maxmsg = 10,
        .mq_msgsize = 256,
        .mq_curmsgs = 0
    };

    mq = mq_open("/testmq", O_CREAT | O_WRONLY, 0644, &attr);

    if (mq == -1) {
        perror("mq_open");
        return 1;
    }

    char msg[] = "Hello POSIX MQ!";
    mq_send(mq, msg, strlen(msg) + 1, 0);

    mq_close(mq);
    return 0;
}
```

#### **æ¥æ”¶è€…ï¼ˆreceiver.cï¼‰**

```c
#include <stdio.h>
#include <mqueue.h>

int main() {
    mqd_t mq = mq_open("/testmq", O_RDONLY);
    if (mq == -1) {
        perror("mq_open");
        return 1;
    }

    char buffer[256];
    unsigned int prio;
    mq_receive(mq, buffer, sizeof(buffer), &prio);

    printf("Received: %s (prio: %u)\n", buffer, prio);

    mq_close(mq);
    mq_unlink("/testmq");  // åˆ é™¤é˜Ÿåˆ—
    return 0;
}
```

---

### ğŸ§© äº”ã€æ³¨æ„äº‹é¡¹

- æ¶ˆæ¯é˜Ÿåˆ—åå¿…é¡»ä»¥ `/` å¼€å¤´ï¼Œä¸èƒ½åŒ…å«å…¶ä»– `/`ã€‚
    
- é»˜è®¤å¤§å°ï¼ˆmq_msgsizeï¼‰æ˜¯æœ‰é™åˆ¶çš„ï¼ˆæ¯”å¦‚ 8192 å­—èŠ‚ï¼‰ã€‚
    
- å‘é€æ–¹å’Œæ¥æ”¶æ–¹åº”å…±äº«åŒä¸€ä¸ªåå­—ã€‚
    
- Linux ä¸Š POSIX MQ é»˜è®¤å­˜å‚¨äº `/dev/mqueue/`ã€‚
    

***

# 13.8 IPCå‘½ä»¤

`ipc` å‘½ä»¤æ˜¯ Linux ç³»ç»Ÿä¸­ç”¨æ¥æ˜¾ç¤ºæˆ–æ“ä½œè¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰èµ„æºçš„ä¸€ä¸ªå·¥å…·ã€‚å®ƒä¸»è¦ç”¨äºæŸ¥çœ‹å’Œç®¡ç†ï¼š

- **å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰**
    
- **æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰**
    
- **ä¿¡å·é‡ï¼ˆSemaphoreï¼‰**
    

---

## ğŸ§° ä¸€ã€å‘½ä»¤æ ¼å¼

```bash
ipc [é€‰é¡¹] <å­å‘½ä»¤>
```

æ³¨æ„ï¼šæœ‰äº›ç³»ç»Ÿä¸­è¯¥å‘½ä»¤å¯èƒ½åä¸º `ipcs` å’Œ `ipcrm`ï¼ˆ`ipc` æ˜¯ä¸€ç§æŠ½è±¡ç†è§£ï¼Œå®é™…ä¸Šæ˜¯å¤šä¸ªå‘½ä»¤ç»„åˆï¼‰ã€‚

---

## ğŸ“Œ äºŒã€å¸¸ç”¨å‘½ä»¤

### 1. `ipcs`ï¼šæŸ¥çœ‹ç³»ç»Ÿå½“å‰ IPC å¯¹è±¡

```bash
ipcs            # æŸ¥çœ‹æ‰€æœ‰ç±»å‹çš„ IPC
ipcs -m         # æŸ¥çœ‹å…±äº«å†…å­˜æ®µï¼ˆmemoryï¼‰
ipcs -q         # æŸ¥çœ‹æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆqueueï¼‰
ipcs -s         # æŸ¥çœ‹ä¿¡å·é‡ï¼ˆsemaphoreï¼‰
```

ğŸ” è¾“å‡ºç¤ºä¾‹ï¼š

```bash
------ Message Queues --------
key        msqid      owner      perms      used-bytes   messages    
0x00000000 32768      user       644        0            0           
```

å­—æ®µè§£é‡Šï¼š

- `key`ï¼šç”± ftok ç”Ÿæˆçš„ key å€¼
    
- `msqid`ï¼šç³»ç»Ÿä¸ºæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…çš„ ID
    
- `owner`ï¼šæ‹¥æœ‰è€…ç”¨æˆ·å
    
- `perms`ï¼šæƒé™ï¼ˆå¦‚ 644ï¼‰
    
- `messages`ï¼šå½“å‰æ¶ˆæ¯æ•°é‡
    

---

### 2. `ipcrm`ï¼šåˆ é™¤ IPC å¯¹è±¡

- åˆ é™¤å…±äº«å†…å­˜ï¼š
    

```bash
ipcrm -m <shmid>
```

- åˆ é™¤æ¶ˆæ¯é˜Ÿåˆ—ï¼š
    

```bash
ipcrm -q <msqid>
```

- åˆ é™¤ä¿¡å·é‡ï¼š
    

```bash
ipcrm -s <semid>
```

ä½ å¯ä»¥å…ˆç”¨ `ipcs` è·å–å¯¹è±¡ IDï¼Œå†ç”¨ `ipcrm` åˆ é™¤ã€‚

---

## ğŸ§ª ä¸‰ã€å®é™…æ¡ˆä¾‹

### åˆ›å»ºå¹¶æŸ¥çœ‹æ¶ˆæ¯é˜Ÿåˆ—

1. å†™ä¸€ä¸ªåˆ›å»ºé˜Ÿåˆ—çš„ç¨‹åºï¼Œè¿è¡Œåç”¨ï¼š
    

```bash
ipcs -q
```

æŸ¥çœ‹æ˜¯å¦åˆ›å»ºæˆåŠŸã€‚

### åˆ é™¤å­¤ç«‹ IPC èµ„æº

æœ‰æ—¶å€™è¿›ç¨‹å¼‚å¸¸é€€å‡ºä¼šç•™ä¸‹èµ„æºï¼Œä½¿ç”¨ï¼š

```bash
ipcs -m   # æ‰¾å‡ºå­¤ç«‹å…±äº«å†…å­˜æ®µ
ipcrm -m <shmid>
```

æ¸…ç†å¹²å‡€ã€‚

---

## ğŸ“„ å››ã€å¸¸è§é—®é¢˜

- IPC å¯¹è±¡åˆ›å»ºåä¸ä¼šè‡ªåŠ¨åˆ é™¤ï¼ˆéœ€æ‰‹åŠ¨æˆ–ç¨‹åºé€€å‡ºæ—¶å¤„ç†ï¼‰ã€‚
    
- å¦‚æœæŠ¥é”™å¦‚ `No space left on device`ï¼Œå¯èƒ½æ˜¯ IPC å¯¹è±¡å¤ªå¤šæœªé‡Šæ”¾ã€‚
    
- æƒé™é—®é¢˜æ—¶ï¼Œä½¿ç”¨ `sudo ipcs` æˆ– `sudo ipcrm`ã€‚
    

---

# 13.9åœ¨è¿›ç¨‹é—´ä¼ é€’æ–‡ä»¶æè¿°ç¬¦

## å‰ç½®çŸ¥è¯†:

`struct msghdr` æ˜¯ POSIX æ ‡å‡†ä¸‹ç”¨äº **`sendmsg()` / `recvmsg()`** ç³»ç»Ÿè°ƒç”¨ä¸­ï¼Œç”¨äºæè¿°**æ¶ˆæ¯å¤´**çš„æ•°æ®ç»“æ„ï¼Œå¸¸ç”¨äºï¼š

- å‘é€æˆ–æ¥æ”¶å¸¦æœ‰**è¾…åŠ©æ•°æ®**ï¼ˆcontrol messageï¼Œå¦‚æ–‡ä»¶æè¿°ç¬¦ã€IPä¿¡æ¯ç­‰ï¼‰çš„æ¶ˆæ¯
    
- æ”¯æŒ **scatter/gather I/O**ï¼ˆåˆ†æ•£è¯»ã€é›†ä¸­å†™ï¼‰
    
- Unix åŸŸå¥—æ¥å­—ã€åŸå§‹ socket ç¼–ç¨‹ã€é«˜çº§ socket ç¼–ç¨‹ç­‰åœºæ™¯

## ğŸ§± `struct msghdr` ç»“æ„ä½“å®šä¹‰ï¼ˆglibc ä¸­ï¼‰ï¼š

```c
struct msghdr {
    void         *msg_name;       // ç›®æ ‡åœ°å€ / æºåœ°å€ï¼ˆå¯ä»¥ä¸º NULLï¼‰
    socklen_t     msg_namelen;    // åœ°å€é•¿åº¦
    struct iovec *msg_iov;        // æ•°æ®ç¼“å†²åŒºæ•°ç»„ï¼ˆI/Oå‘é‡ï¼‰
    int           msg_iovlen;     // ç¼“å†²åŒºæ•°é‡
    void         *msg_control;    // æ§åˆ¶æ¶ˆæ¯ï¼ˆè¾…åŠ©æ•°æ®ï¼‰
    socklen_t     msg_controllen; // æ§åˆ¶æ¶ˆæ¯é•¿åº¦
    int           msg_flags;      // æ¥æ”¶æ ‡å¿—ï¼ˆä»…ç”¨äº recvmsgï¼‰
};
```

## ğŸ“ å„å­—æ®µè¯¦ç»†è§£é‡Šï¼š

| å­—æ®µå              | ç±»å‹               | ç”¨é€”                                                              |
| ---------------- | ---------------- | --------------------------------------------------------------- |
| `msg_name`       | `void *`         | ç›®æ ‡åœ°å€æˆ–æºåœ°å€ï¼ˆå¦‚ `struct sockaddr_in *`ï¼‰ï¼Œå¯ä¸º `NULL` è¡¨ç¤ºä¸å…³å¿ƒåœ°å€            |
| `msg_namelen`    | `socklen_t`      | åœ°å€é•¿åº¦ï¼Œå•ä½æ˜¯å­—èŠ‚                                                      |
| `msg_iov`        | `struct iovec *` | æŒ‡å‘ä¸€ç»„ `iovec`ï¼Œæ¯ä¸ª `iovec` ä»£è¡¨ä¸€å—ç¼“å†²åŒºï¼ˆç”¨äºæ”¯æŒ scatter/gather I/Oï¼‰        |
| `msg_iovlen`     | `int`            | `iovec` æ•°ç»„ä¸­çš„å…ƒç´ ä¸ªæ•°                                                |
| `msg_control`    | `void *`         | æŒ‡å‘æ§åˆ¶ä¿¡æ¯ï¼ˆcontrol messageï¼‰ï¼Œç”¨äºä¼ é€’è¾…åŠ©æ•°æ®                                |
| `msg_controllen` | `socklen_t`      | æ§åˆ¶ä¿¡æ¯ç¼“å†²åŒºçš„é•¿åº¦ï¼ˆå•ä½æ˜¯å­—èŠ‚ï¼‰                                               |
| `msg_flags`      | `int`            | **ä»…åœ¨ `recvmsg` è¿”å›æ—¶è®¾ç½®**ï¼Œè¡¨ç¤ºæ¥æ”¶åˆ°çš„é¢å¤–ä¿¡æ¯ï¼Œå¦‚ `MSG_TRUNC`, `MSG_CTRUNC` ç­‰ |

## ğŸ“¦ ç›¸å…³ç»“æ„ä½“ï¼š`struct iovec`

`msg_iov` æŒ‡å‘çš„æ˜¯ä¸€ç»„ `struct iovec`ï¼š

```c
struct iovec {
    void  *iov_base;  // ç¼“å†²åŒºèµ·å§‹åœ°å€
    size_t iov_len;   // ç¼“å†²åŒºé•¿åº¦
};
```


`struct cmsghdr` æ˜¯ **POSIX æ ‡å‡†**ä¸­ç”¨äºåœ¨ `msghdr` ç»“æ„ä½“ä¸­çš„ `msg_control` åŒºåŸŸä¸­ä¼ é€’â€œæ§åˆ¶æ¶ˆæ¯â€ï¼ˆ**control message**ï¼‰çš„ç»“æ„ä½“ï¼Œç”¨äºæè¿° **è¾…åŠ©æ•°æ®**ï¼Œæ¯”å¦‚ï¼š

- **å‘é€/æ¥æ”¶æ–‡ä»¶æè¿°ç¬¦**
    
- **ä¼ é€’ socket é€‰é¡¹ï¼ˆå¦‚ TTL, TOSï¼‰**
    
- **æ¥æ”¶åŸå§‹ IP å¤´ä¿¡æ¯**
    
- **æ¥æ”¶å¤šæ’­æ¥å£ã€é”™è¯¯ä¿¡æ¯ç­‰**
    

æ˜¯åº•å±‚ socket ç¼–ç¨‹ä¸­å¤„ç† **å¸¦å¤–æ•°æ®** çš„å…³é”®ç»“æ„ã€‚


## ğŸ§± `struct cmsghdr` å®šä¹‰ï¼ˆglibc ä¸­ï¼‰

```c
struct cmsghdr {
    socklen_t cmsg_len;    // æ§åˆ¶æ¶ˆæ¯çš„æ€»é•¿åº¦ï¼ŒåŒ…æ‹¬ cmsghdr + æ•°æ®
    int       cmsg_level;  // åè®®å±‚çº§ï¼ˆå¦‚ SOL_SOCKETï¼‰
    int       cmsg_type;   // æ§åˆ¶æ¶ˆæ¯çš„ç±»å‹ï¼ˆå¦‚ SCM_RIGHTSï¼‰
    // åé¢ç´§è·Ÿç€æ§åˆ¶æ•°æ®ï¼ˆé€šè¿‡ CMSG_DATA() å®è®¿é—®ï¼‰
};
```


## ğŸ“Œ å­—æ®µè§£é‡Šï¼š

| å­—æ®µå          | ç±»å‹          | è¯´æ˜                                               |
| ------------ | ----------- | ------------------------------------------------ |
| `cmsg_len`   | `socklen_t` | æ•´ä¸ªæ§åˆ¶æ¶ˆæ¯çš„é•¿åº¦ï¼ˆåŒ…æ‹¬ `cmsghdr` å’Œé™„åŠ æ•°æ®ï¼‰ï¼Œå•ä½æ˜¯å­—èŠ‚              |
| `cmsg_level` | `int`       | åè®®å±‚çº§ï¼Œå¸¸ç”¨çš„æ˜¯ `SOL_SOCKET`                           |
| `cmsg_type`  | `int`       | æ¶ˆæ¯ç±»å‹ï¼Œå¦‚ `SCM_RIGHTS`ï¼ˆä¼ è¾“æ–‡ä»¶æè¿°ç¬¦ï¼‰ã€`SCM_CREDENTIALS` ç­‰ |
| æ§åˆ¶æ•°æ®         | -           | å®é™…çš„æ•°æ®ï¼ˆå¦‚æ–‡ä»¶æè¿°ç¬¦ã€è®¤è¯ä¿¡æ¯ï¼‰ï¼Œç´§è·Ÿåœ¨ `cmsghdr` åé¢              |


## ğŸ“¦ å¸¸ç”¨å®å‡½æ•°ï¼ˆéƒ½åœ¨ `<sys/socket.h>` ä¸­å®šä¹‰ï¼‰

### `CMSG_SPACE(len)`

> ç”³è¯·æ§åˆ¶æ¶ˆæ¯ç¼“å†²åŒºæ‰€éœ€çš„æ€»ç©ºé—´ï¼ŒåŒ…å«ç»“æ„ä½“å’Œå¿…è¦çš„å¯¹é½å¡«å……ã€‚

```c
char control[CMSG_SPACE(sizeof(int))];  // æ§åˆ¶åŒºç”³è¯·
```

### `CMSG_LEN(len)`

> å®é™…çš„æ§åˆ¶æ¶ˆæ¯é•¿åº¦ï¼Œä¸åŒ…å« paddingï¼Œåªç”¨äºè®¾ç½® `cmsg_len` å­—æ®µã€‚

```c
cmsg->cmsg_len = CMSG_LEN(sizeof(int));
```

### `CMSG_FIRSTHDR(&msghdr)`

> è·å–ç¬¬ä¸€ä¸ª `cmsghdr` æŒ‡é’ˆã€‚

```c
struct cmsghdr *cmsg = CMSG_FIRSTHDR(&msg);
```

### `CMSG_NXTHDR(&msghdr, cmsg)`

> è·å–ä¸‹ä¸€ä¸ªæ§åˆ¶æ¶ˆæ¯ã€‚

### `CMSG_DATA(cmsg)`

> è·å–æ§åˆ¶æ•°æ®åŒºçš„æŒ‡é’ˆï¼ˆå¦‚ç”¨äºè¯»å†™æ–‡ä»¶æè¿°ç¬¦ç­‰ï¼‰ã€‚

```c
int fd = *((int *) CMSG_DATA(cmsg));
```

```c
#include <asm-generic/socket.h>
#include <sys/socket.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <assert.h>
#include <stdio.h>
#include <fcntl.h>

static const int CONTROL_LEN = CMSG_LEN(sizeof(int));

//å‘é€æ–‡ä»¶æè¿°ç¬¦,fdå‚æ•°æ˜¯ç”¨æ¥ä¼ é€’ä¿¡æ¯çš„UNIXåŸŸsocket,fd_to_sendå‚æ•°æ˜¯å¸¦å‘é€çš„æ–‡ä»¶æè¿°ç¬¦
void send_fd(int fd,int fd_to_send)
{
  struct iovec iov[1];
  struct msghdr msg;
  char buf[0];

  iov[0].iov_base = buf;
  iov[0].iov_len = 1;
  msg.msg_name = NULL;
  msg.msg_namelen = 0;
  msg.msg_iov = iov;
  msg.msg_iovlen = 1;

  cmsghdr cm;
  cm.cmsg_len = CONTROL_LEN;
  cm.cmsg_level = SOL_SOCKET;
  cm.cmsg_type = SCM_RIGHTS;
  *(int*)CMSG_DATA(&cm) = fd_to_send;
  msg.msg_control = &cm;
  msg.msg_controllen = CONTROL_LEN;

  sendmsg(fd,&msg,0);
}

//æ¥å—ç›®æ ‡æ–‡ä»¶
int recv_fd(int fd)
{
  struct iovec iov[1];
  struct msghdr msg;
  char buf[0];

  iov[0].iov_base = buf;
  iov[0].iov_len = 1;

  msg.msg_name = NULL;
  msg.msg_namelen = 0;
  msg.msg_iov = iov;
  msg.msg_iovlen = 1;

  cmsghdr cm;
  msg.msg_control = &cm;
  msg.msg_controllen = CONTROL_LEN;

  recvmsg(fd,&msg,0);
  int fd_to_read = *(int*)CMSG_DATA(&cm);
  return fd_to_read;
}

int main()
{
  int pipefd[2];
  int fd_to_pass = 0;

  //åˆ›å»ºçˆ¶å­è¿›ç¨‹è§çš„ç®¡é“ï¼Œæ–‡ä»¶æè¿°ç¬¦pipefd[0]å’Œpipefd[1]
  int ret = socketpair(PF_UNIX,SOCK_DGRAM,0,pipefd);
  assert(ret != -1);

  pid_t pid = fork();
  assert(pid >= 0);

  if(pid == 0)
  {
    close(pipefd[0]);
    fd_to_pass = open("test.txt",O_RDWR,0666);
    //å­è¿›ç¨‹é€šè¿‡ç®¡é“æ–‡ä»¶æè¿°ç¬¦å‘é€åˆ°çˆ¶è¿›ç¨‹ã€‚å¦‚æœæ–‡ä»¶test.txtæ‰“å¼€å¤±è´¥ï¼Œåˆ™å­è¿›ç¨‹å°†æ ‡å‡†è¾“å…¥æ–‡ä»¶æè¿°ç¬¦å‘é€åˆ°å­è¿›ç¨‹
    send_fd(pipefd[1],(fd_to_pass > 0) ? fd_to_pass : 0);
    close(fd_to_pass);
    exit(0);
  }

  close(pipefd[1]);
  fd_to_pass = recv_fd(pipefd[0]);
  char buf[1024];
  memset(buf,'\0',1024);
  read(fd_to_pass,buf,1024);
  printf("I got fd %d and data %s\n",fd_to_pass,buf);
  close(fd_to_pass);
}
```


# è¡¥å…… char buf[0]ï¼Œå ä½ç¬¦

å¥½çš„ï¼é‚£æˆ‘ä»¬ç”¨**é€šä¿—æ˜“æ‡‚çš„ä¾‹å­**æ¥è¯´æ˜ `char buf[0]` å’Œ `char buf[1]` çš„åŒºåˆ«ï¼Œå¹¶é€šè¿‡å‡ ä¸ª**ç®€å•ç›´ç™½çš„ä¾‹å­**æ¥å¸®åŠ©ä½ ç†è§£å®ƒä»¬çš„å®é™…ç”¨æ³•å’Œæ„ä¹‰ã€‚

---

## ğŸ§  å…ˆæ¥è§£é‡Šï¼š`char buf[0]` vs `char buf[1]`

è¿™ä¸¤ä¸ªå†™æ³•çœ‹èµ·æ¥å¥‡æ€ªï¼Œå…¶å®å®ƒä»¬éƒ½ä¸æ˜¯æ‹¿æ¥ç›´æ¥å­˜ä¸œè¥¿çš„ï¼Œè€Œæ˜¯ï¼š

> ğŸ“Œ ç”¨ä½œ**â€œå ä½ç¬¦â€**ï¼Œä»£è¡¨ **ç»“æ„ä½“åé¢ä¼šè·Ÿç€å˜é•¿æ•°æ®**ï¼Œé€šè¿‡åŠ¨æ€å†…å­˜åˆ†é…ã€‚

åŒºåˆ«åœ¨äºï¼š

|å†™æ³•|è¯´æ˜|
|---|---|
|`char buf[1]`|ä¼ ç»Ÿå†™æ³•ï¼Œä¸ºäº†å‘åå…¼å®¹è€ç¼–è¯‘å™¨ã€‚é»˜è®¤å°±æœ‰ä¸€ä¸ªå­—èŠ‚ç©ºé—´ï¼Œç¨å¾®ä¸ä¸¥è°¨ã€‚|
|`char buf[0]`|æ›´ç°ä»£çš„å†™æ³•ï¼Œ**æ²¡æœ‰å®é™…ç©ºé—´**ï¼Œå¿…é¡»æ­é…åŠ¨æ€åˆ†é…ã€‚æ›´å®‰å…¨ã€‚|

---

## âœ… ç¤ºä¾‹ 1ï¼šå­˜å‚¨ä¸€æ®µå˜é•¿åå­—çš„æ•°æ®ç»“æ„

å‡è®¾ä½ è¦å­˜äººçš„ä¿¡æ¯ï¼Œä½†åå­—é•¿åº¦ä¸å›ºå®šï¼Œæ€ä¹ˆåŠï¼Ÿ

```c
struct Person {
    int age;
    char name[0]; // ä¸æ˜¯çœŸæ­£çš„æ•°ç»„ï¼Œå ä½ç¬¦ï¼
};
```

### ä½¿ç”¨æ–¹å¼ï¼š

```c
int namelen = strlen("Alice") + 1;
struct Person *p = malloc(sizeof(struct Person) + namelen);
p->age = 18;
strcpy(p->name, "Alice");

printf("Name: %s, Age: %d\n", p->name, p->age);
```

### âœ… ä¸ºä»€ä¹ˆè¿™æ ·å¥½ï¼Ÿ

è¿™æ ·å¯ä»¥ï¼š

- ç”¨ä¸€å—è¿ç»­å†…å­˜ä¿å­˜æ‰€æœ‰æ•°æ®ï¼ˆé¿å…å¤šæ¬¡ mallocï¼‰
    
- èŠ‚çœå†…å­˜ã€æé«˜è®¿é—®æ•ˆç‡
    

---

## âœ… ç¤ºä¾‹ 2ï¼šå‘ä¸€ä¸ªç»“æ„ä½“ + æ•°æ®å—

æ¯”å¦‚æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ¶ˆæ¯å¤´ï¼Œåé¢æ˜¯æ¶ˆæ¯æ­£æ–‡ï¼š

```c
struct Message {
    int type;
    int length;
    char data[0]; // å ä½ï¼Œå®é™…æ•°æ®è·Ÿåœ¨ç»“æ„ä½“åé¢
};
```

### ç”¨æ³•ï¼š

```c
const char *text = "hello world!";
int len = strlen(text) + 1;

struct Message *msg = malloc(sizeof(struct Message) + len);
msg->type = 1;
msg->length = len;
strcpy(msg->data, text);

printf("Message: %s\n", msg->data);
```

---

## âœ… ç¤ºä¾‹ 3ï¼šå¸¦å˜é•¿æ•°ç»„çš„åè®®åŒ…

æƒ³è±¡ä¸€ä¸ªç®€å•çš„åè®®åŒ…ï¼Œå¤´éƒ¨å›ºå®šï¼Œæ•°æ®å¯å˜ï¼š

```c
struct Packet {
    uint8_t version;
    uint8_t command;
    uint16_t length;
    char payload[0];
};
```

é€šè¿‡ï¼š

```c
struct Packet *pkt = malloc(sizeof(struct Packet) + data_len);
memcpy(pkt->payload, data, data_len);
```

---

## ğŸ’¡ æ€»ç»“ï¼šä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ

ä½ ä¼šç”¨ `char buf[0]` æˆ– `char buf[1]`ï¼Œå½“ä½ éœ€è¦ï¼š

1. åœ¨ç»“æ„ä½“åé¢**è¿½åŠ å˜é•¿æ•°æ®**
    
2. ä½¿ç”¨ä¸€å— malloc å‡ºæ¥çš„å†…å­˜ä¿å­˜ç»“æ„ä½“å’Œå®ƒåé¢çš„æ•°æ®
    
3. é¿å…å¤šæ¬¡ mallocï¼Œæé«˜æ€§èƒ½
    
