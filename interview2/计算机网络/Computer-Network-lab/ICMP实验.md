在本次实验中，我们将探究ICMP协议的几个方面：  
- 由Ping程序生成的ICMP消息；  
- 由Traceroute程序生成的ICMP消息；  
- ICMP消息的格式和内容。  

在开始实验前，建议你复习课本第5.6节中关于ICMP的内容。本实验以Microsoft Windows操作系统为背景，但将其迁移到Unix或Linux环境也十分简单。  


### 1. ICMP与Ping  
让我们从捕获Ping程序生成的数据包开始ICMP的探索之旅。你可能记得，Ping程序是一个简单的工具，可让任何人（如网络管理员）验证主机是否在线。源主机中的Ping程序会向目标IP地址发送一个数据包；如果目标在线，目标主机中的Ping程序会通过向源主机回送一个数据包作为响应。正如你可能已经猜到的（鉴于本实验是关于ICMP的），这两个Ping数据包都是ICMP数据包。  

请执行以下操作：  
- 首先打开Windows命令提示符应用程序（可在“附件”文件夹中找到）。  
- 启动Wireshark数据包嗅探器，并开始Wireshark数据包捕获。  
- ping命令位于c:\windows\system32中，因此在MS-DOS命令行中输入“ping –n 10 hostname”或“c:\windows\system32\ping –n 10 hostname”（不带引号），其中hostname是另一大洲的主机。如果你在亚洲以外地区，可以输入香港科技大学的Web服务器地址www.ust.hk。参数“-n 10”表示应发送10条ping消息。然后按回车键运行Ping程序。  
- 当Ping程序终止时，停止Wireshark中的数据包捕获。  

实验结束时，你的命令提示符窗口应类似图1所示。在此示例中，源ping程序位于马萨诸塞州，目标Ping程序位于香港。从该窗口可以看到，源ping程序发送了10个查询数据包并接收了10个响应。此外请注意，对于每个响应，源端会计算往返时间（RTT），10个数据包的平均RTT为375毫秒。

图1 输入Ping命令后的命令提示符窗口  

图2 是在Wireshark过滤显示窗口中输入“icmp”后的截图。请注意，数据包列表显示20个数据包：源端发送的10个Ping查询包和源端接收的10个Ping响应包。另外注意，源端IP地址是192.168/12格式的私有地址（位于NAT之后），目标IP地址是香港科技大学Web服务器的地址。现在我们放大查看第一个数据包（客户端发送的），在下图的数据包内容区域中提供了该数据包的信息。我们看到，此数据包中的IP数据报协议号为01，这是ICMP的协议号，意味着该IP数据报的有效载荷是一个ICMP数据包。  


图2 展开Internet协议的Ping程序Wireshark输出  


图3 聚焦于同一个ICMP包，并在数据包内容窗口中展开了ICMP协议信息。可以看到，这个ICMP包的类型为8，代码为0，即所谓的ICMP“回显请求”包（参见课本图5.19）。另外注意，这个ICMP包包含校验和、标识符和序列号。  


图3 展开ICMP包的Ping数据包Wireshark捕获  


### 提交要求：  
你应提交一张类似于上图1的命令提示符窗口截图。在回答以下问题时，尽可能提交跟踪文件中用于回答问题的数据包打印件，并在打印件上标注以解释你的答案。要打印数据包，请使用“文件->打印”，选择“仅选定数据包”，选择“数据包摘要行”，并选择回答问题所需的最少数据包详细信息。  


### 请回答以下问题：  
1. **你的主机IP地址是什么？目标主机的IP地址是什么？**  
	我的主机IP地址为：10.138.217.63
	目标主机的IP地址为：143.89.209.9
2. **为什么ICMP包没有源端口和目标端口号？**  
	因为 ICMP（互联网控制报文协议）是网络层协议，其设计目的是为 IP 协议提供控制和错误报告功能，而非像传输层协议（如 TCP、UDP）那样用于端到端的进程通信。端口号是传输层特有的概念，用于标识接收方设备上的具体应用程序。而 ICMP 直接封装在 IP 数据报中（IP 协议号为 1），其报文交互围绕 IP 层的功能（如路由错误、可达性检测等），无需涉及应用层的端口寻址，因此不需要源端口和目标端口号。
3. **检查你的主机发送的一个ping请求包。这个ICMP包的类型和代码号是什么？这个ICMP包还有哪些其他字段？校验和、序列号和标识符字段各有多少字节？**  
	ICMP包的类型为8请求类型，代码号为0。
	这个ICMP还有校验和字段，序列号字段，大小端确认字段，数据字段。
	校验和为2bytes，序列号为2bytes，标识字段为2bytes。
	
### 2. ICMP与Traceroute  

现在让我们继续ICMP的探索之旅，捕获Traceroute程序生成的数据包。你可能记得，Traceroute程序可用于确定数据包从源到目标的路径。课本第1.4节和第5.6节讨论了Traceroute。  

Traceroute在Unix/Linux/MacOS和Windows中的实现方式不同：  
- 在Unix/Linux中，源端使用一个不太可能的目标端口号向目标发送一系列UDP数据包；  
- 在Windows中，源端向目标发送一系列ICMP数据包。  

对于这两种操作系统，程序都会发送第一个生存时间（TTL）为1的数据包，第二个TTL为2，依此类推。请记住，当数据包经过路由器时，路由器会递减其TTL值。当数据包到达TTL=1的路由器时，该路由器会向源端发送一个ICMP错误数据包。下面我们将使用Windows原生的tracert程序。一个更好的Windows Traceroute共享软件是pingplotter（www.pingplotter.com），我们将在Wireshark IP实验中使用它，因为它提供了我们需要的额外功能。  


#### 请执行以下操作：  
- 首先打开Windows命令提示符应用程序（可在“附件”文件夹中找到）。  
- 启动Wireshark数据包嗅探器，并开始Wireshark数据包捕获。  
- tracert命令位于c:\windows\system32中，因此在MS-DOS命令行中输入“tracert hostname”或“c:\windows\system32\tracert hostname”（不带引号），其中hostname是另一大洲的主机。（注意：在Windows机器上，命令是“tracert”而不是“traceroute”。）如果你不在欧洲，可输入法国计算机科学研究所INRIA的Web服务器地址www.inria.fr。然后按回车键运行Traceroute程序。  
- 当Traceroute程序终止时，停止Wireshark中的数据包捕获。  


#### 实验结束时，你的命令提示符窗口应类似图4所示：  
在此图中，客户端Traceroute程序位于马萨诸塞州，目标位于法国。从图中可以看到，对于每个TTL值，源程序会发送三个探测数据包。Traceroute会显示每个探测数据包的往返时间（RTT），以及返回ICMP TTL超时消息的路由器的IP地址（可能还有名称）。  


#### 图5显示了路由器返回的ICMP数据包的Wireshark窗口：  
请注意，这个ICMP错误数据包包含的字段比Ping的ICMP消息多得多。  


### 提交要求：  
对于实验的这部分，你应提交一张命令提示符窗口的截图。在回答以下问题时，尽可能提交跟踪文件中用于回答问题的数据包打印件，并在打印件上标注以解释你的答案。要打印数据包，请使用“文件->打印”，选择“仅选定数据包”，选择“数据包摘要行”，并选择回答问题所需的最少数据包详细信息。  


### 回答以下问题：  
5. **你的主机IP地址是什么？目标主机的IP地址是什么？**  
	源主机IP为：10.138.217.63
	目标主机IP为：128.93.162.83
6. **如果ICMP改为发送UDP数据包（如Unix/Linux中），探测数据包的IP协议号是否仍为01？如果不是，应该是什么？**  
	如果探测数据包使用 UDP 而非 ICMP，其 IP 协议号将不再是 01，而是17。
7. **检查截图中的ICMP回显数据包。它与本实验前半部分的ICMP ping查询数据包有何不同？如果有，具体区别是什么？**  
	这次的回显数据包添加了一个TTL字段
8. **检查截图中的ICMP错误数据包。它比ICMP回显数据包有更多字段，这些字段包含什么内容？**  
	
9. **检查源主机接收的最后三个ICMP数据包。这些数据包与ICMP错误数据包有何不同？为什么不同？**  
	
10. **在tracert测量中，是否有某个链路的延迟明显长于其他链路？参考图4的截图，是否存在延迟显著更长的链路？根据路由器名称，你能推测该链路两端的两个路由器的位置吗？**  


