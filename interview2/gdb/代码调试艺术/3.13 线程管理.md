### **3.13 çº¿ç¨‹ç®¡ç†**

å¯¹äºç°ä»£ç¨‹åºæ¥è®²ï¼Œå¤§å¤šæƒ…å†µä¸‹æ˜¯å¤šä¸ªçº¿ç¨‹åœ¨åŒæ—¶å·¥ä½œï¼Œä»è€Œå……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æºã€‚æµ‹è¯•ç¨‹åºä¹Ÿä¸ä¾‹å¤–ã€‚

ä¸ºäº†ä½¿ç¤ºä¾‹ç®€å•è€Œä¸”ä¸å½±å“åŠŸèƒ½ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸º `thread_management_example.cpp` çš„æ–‡ä»¶ï¼Œå¹¶æ–°å¢ä¸€ä¸ªå‡½æ•°æ¥åˆ›å»ºçº¿ç¨‹ã€‚

**ä»£ç æ¸…å•ï¼š`thread_management_example.cpp`**

```cpp
#include <iostream>
#include <thread>
#include <vector>
#include <chrono>

// å…¨å±€å˜é‡ï¼Œæ‰€æœ‰çº¿ç¨‹å…±äº«
int count = 0;

// çº¿ç¨‹å‡½æ•°
void do_work(int thread_id) {
    // 1. å¯¹å…¨å±€å˜é‡æ‰§è¡ŒåŠ 1æ“ä½œ
    count++;

    // 2. æ‰“å°ä¸€äº›ä¿¡æ¯
    std::cout << "Thread " << thread_id << " is working, count is " << count << std::endl;

    // 3. ç­‰å¾…3ç§’
    std::this_thread::sleep_for(std::chrono::seconds(3));

    std::cout << "Thread " << thread_id << " finished." << std::endl;
}

// åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹çš„å‡½æ•°
void start_threads(int thread_num) {
    std::vector<std::thread> threads;
    for (int i = 0; i < thread_num; ++i) {
        // åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹
        threads.emplace_back(do_work, i + 1);
    }

    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ
    for (auto& t : threads) {
        t.join();
    }
}

int main() {
    // å¯åŠ¨10ä¸ªçº¿ç¨‹
    start_threads(10);
    return 0;
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ`do_work` æ˜¯çº¿ç¨‹å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªçº¿ç¨‹IDï¼Œå¯¹å…¨å±€å˜é‡ `count` æ‰§è¡ŒåŠ 1æ“ä½œï¼Œç„¶åç­‰å¾…3ç§’å¹¶æ‰“å°ä¿¡æ¯ã€‚`start_threads` å‡½æ•°æ ¹æ®è¾“å…¥çš„ `thread_num` å‚æ•°æ¥åˆ›å»ºç›¸åº”æ•°é‡çš„çº¿ç¨‹ï¼Œå¹¶ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œç»“æŸã€‚

å› ä¸ºç”¨åˆ°äº†çº¿ç¨‹å‡½æ•°ï¼ˆ`std::thread`ï¼‰å’Œæ ‡å‡†åº“çš„`vector`ï¼Œæ‰€ä»¥éœ€è¦åŒ…å« `<thread>` å’Œ `<vector>` ç­‰ç›¸å…³å¤´æ–‡ä»¶ã€‚

å¦‚æœç›´æ¥ä½¿ç”¨ `g++ thread_management_example.cpp -o app` ç¼–è¯‘é“¾æ¥ä»£ç ï¼Œä¼šé“¾æ¥å¤±è´¥ï¼Œå¹¶æç¤º `undefined reference to 'pthread_create'`ã€‚

**é“¾æ¥å¤±è´¥ç¤ºä¾‹**

```bash
$ g++ thread_management_example.cpp -o app
/tmp/ccXXXXXX.o: In function `std::thread::thread<void (&)(int), int&>(void (&)(int), int&)':
thread_management_example.cpp:(.text._ZSt6threadC2IRFviEJRiEEOT_DpOT0_[_ZSt6threadC2IRFviEJRiEEOT_DpOT0_]+0x3b): undefined reference to `pthread_create'
collect2: error: ld returned 1 exit status
```

è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨ç¨‹åºä¸­ç”¨åˆ°äº†çº¿ç¨‹å‡½æ•°ï¼Œä½†æ˜¯é“¾æ¥æ—¶ä¸åŒ…å«çº¿ç¨‹åº“ã€‚æˆ‘ä»¬éœ€è¦åœ¨Makefileæˆ–ç¼–è¯‘å‘½ä»¤ä¸­æ·»åŠ çº¿ç¨‹åº“ `pthread`ã€‚

**æ·»åŠ  `pthread` å¹¶æˆåŠŸæ„å»º**

```bash
# -lpthread ä¹Ÿå¯ä»¥å†™ä¸º -pthread
g++ thread_management_example.cpp -o app -lpthread
```

å†æ¬¡æ‰§è¡Œå‘½ä»¤ï¼Œå³å¯æˆåŠŸæ„å»ºå‡ºå¯æ‰§è¡Œæ–‡ä»¶ `app`ã€‚

ç°åœ¨å¼€å§‹ç”¨gdbè°ƒè¯•å¤šçº¿ç¨‹ç¨‹åºã€‚å¯åŠ¨gdbåï¼Œå…ˆåœ¨ `start_threads` å‡½æ•°ä¸­è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œä»¥æ–¹ä¾¿è§‚å¯Ÿçº¿ç¨‹ä¿¡æ¯ã€‚å¯ä»¥æŠŠæ–­ç‚¹è®¾ç½®åœ¨ `for` å¾ªç¯ä¹‹åã€`join` ä¹‹å‰çš„ä½ç½®ï¼ˆå³ç¬¬32è¡Œï¼‰ï¼Œç„¶åæ‰§è¡Œ `r` å‘½ä»¤ï¼Œä½¿ç¨‹åºåœ¨è¯¥è¡Œå¤„ä¸­æ–­ã€‚

```bash
$ gdb ./app
(gdb) b 32
Breakpoint 1 at 0x1234: file thread_management_example.cpp, line 32.
(gdb) r
Starting program: /path/to/app
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[New Thread 0x7ffff7dae640 (LWP 12345)]
[New Thread 0x7ffff7d2d640 (LWP 12346)]
... (å…¶ä»–çº¿ç¨‹åˆ›å»ºä¿¡æ¯) ...
[New Thread 0x7ffff5a2b640 (LWP 12354)]

Breakpoint 1, start_threads (thread_num=10) at thread_management_example.cpp:32
32          for (auto& t : threads) {
```

ç¨‹åºåœ¨ç¬¬32è¡Œå¤„ä¸­æ–­ä¸‹æ¥ï¼Œæ­¤æ—¶10ä¸ªå­çº¿ç¨‹å·²ç»è¢«åˆ›å»ºå¹¶å¼€å§‹æ‰§è¡Œã€‚

### **3.13.1 æŸ¥çœ‹æ‰€æœ‰çº¿ç¨‹ä¿¡æ¯**

ä½¿ç”¨å‘½ä»¤ `info threads` æŸ¥çœ‹å½“å‰è¿›ç¨‹æ‰€æœ‰çš„çº¿ç¨‹ä¿¡æ¯ã€‚

**æŸ¥çœ‹æ‰€æœ‰çº¿ç¨‹**

```gdb
(gdb) info threads
  Id   Target Id         Frame
* 1    Thread 0x7ffff7fbe740 (LWP 12344) "app" main () at thread_management_example.cpp:40
  2    Thread 0x7ffff7dae640 (LWP 12345) "app" 0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff7dadc10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
  3    Thread 0x7ffff7d2d640 (LWP 12346) "app" 0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff7d2cc10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
  4    Thread 0x7ffff7cac640 (LWP 12347) "app" 0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff7cabb10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
  5    Thread 0x7ffff7c2b640 (LWP 12348) "app" 0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff7c2ac10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
  6    Thread 0x7ffff7baa640 (LWP 12349) "app" 0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff7ba9c10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
  7    Thread 0x7ffff7b29640 (LWP 12350) "app" 0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff7b28c10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
  8    Thread 0x7ffff7aa8640 (LWP 12351) "app" 0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff7aa7c10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
  9    Thread 0x7ffff7a27640 (LWP 12352) "app" 0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff7a26c10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
  10   Thread 0x7ffff5a2b640 (LWP 12353) "app" 0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff5a2ac10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
  11   Thread 0x7ffff59aa640 (LWP 12354) "app" 0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff59a9c10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
```

ä»ä¸Šé¢çš„ä¿¡æ¯å¯ä»¥çœ‹åˆ°ï¼Œå½“å‰è¿›ç¨‹å…±æœ‰11ä¸ªçº¿ç¨‹ï¼ˆ1ä¸ªä¸»çº¿ç¨‹ + 10ä¸ªå·¥ä½œçº¿ç¨‹ï¼‰ï¼Œç¼–å·ä¸º1\~11ã€‚å…¶ä¸­1å·çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰å‰é¢æœ‰ä¸€ä¸ª `*` å·ï¼Œè¡¨ç¤ºå®ƒæ˜¯å½“å‰GDBæ­£åœ¨å…³æ³¨çš„çº¿ç¨‹ã€‚æ¯ä¸ªçº¿ç¨‹ä¿¡æ¯è¿˜åŒ…å«å…¶æ‰§è¡Œä½ç½®ï¼Œå¯ä»¥çœ‹åˆ°2\~11å·è¿™10ä¸ªçº¿ç¨‹éƒ½å¤„äºç³»ç»Ÿ `nanosleep.c` æ–‡ä»¶ä¸­ï¼Œå› ä¸ºå®ƒä»¬éƒ½åœ¨è°ƒç”¨ `sleep_for` å‡½æ•°ã€‚

### **3.13.2 åˆ‡æ¢çº¿ç¨‹**

å½“å‰çº¿ç¨‹å¾ˆé‡è¦ï¼Œå› ä¸ºå¾ˆå¤šå‘½ä»¤ï¼ˆå¦‚ `bt`, `f`, `print`ï¼‰éƒ½æ˜¯é’ˆå¯¹å½“å‰çº¿ç¨‹æœ‰æ•ˆçš„ã€‚å¦‚æœæƒ³è¦æŸ¥çœ‹æŸä¸ªçº¿ç¨‹çš„å †æ ˆä¿¡æ¯ï¼Œå¿…é¡»å…ˆåˆ‡æ¢åˆ°è¯¥çº¿ç¨‹ã€‚åˆ‡æ¢çº¿ç¨‹çš„å‘½ä»¤æ˜¯ `thread çº¿ç¨‹ID`ã€‚

å¦‚æœæƒ³è¦åˆ‡æ¢åˆ°2å·çº¿ç¨‹ï¼Œåˆ™æ‰§è¡Œ `thread 2`ï¼ˆç®€å†™ä¸º `t 2`ï¼‰ã€‚

**åˆ‡æ¢åˆ°2å·çº¿ç¨‹**

```gdb
(gdb) thread 2
[Switching to thread 2 (Thread 0x7ffff7dae640 (LWP 12345))]
#0  0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff7dadc10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
28      ../sysdeps/unix/sysv/linux/nanosleep.c: No such file or directory.
(gdb) i threads
  Id   Target Id         Frame
  1    Thread 0x7ffff7fbe740 (LWP 12344) "app" main () at thread_management_example.cpp:40
* 2    Thread 0x7ffff7dae640 (LWP 12345) "app" 0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff7dadc10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
  ... (å…¶ä»–çº¿ç¨‹ä¿¡æ¯) ...
```

å†æ¬¡æ‰§è¡Œ `i threads` å‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ° `*` å·å·²ç»ç§»åˆ°äº†2å·çº¿ç¨‹å‰é¢ï¼Œç¡®è®¤åˆ‡æ¢æˆåŠŸã€‚ç°åœ¨ï¼Œå¯ä»¥ä½¿ç”¨å †æ ˆå‘½ä»¤æ¥æŸ¥çœ‹è¯¥çº¿ç¨‹çš„ä¿¡æ¯ã€‚

**æŸ¥çœ‹2å·çº¿ç¨‹çš„æ ˆå›æº¯ä¿¡æ¯**

```gdb
(gdb) bt
#0  0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff7dadc10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
#1  0x00007ffff7ea8b5f in __sleep (seconds=0) at ../sysdeps/posix/sleep.c:55
#2  0x000055555555566f in std::this_thread::sleep_for<long, std::ratio<1l, 1l> >(std::chrono::duration<long, std::ratio<1l, 1l> > const&) ()
#3  0x00005555555554f6 in do_work(int) (thread_id=1) at thread_management_example.cpp:17
#4  0x00005555555558d0 in void std::__invoke_impl<void, void (*)(int), int>(std::__invoke_other, void (*&&)(int), int&&) ()
#5  0x0000555555555869 in std::thread::_Invoker<std::tuple<void (*)(int), int> >::_M_invoke<0ul, 1ul>(std::_Index_tuple<0ul, 1ul>) ()
#6  0x000055555555580a in std::thread::_Invoker<std::tuple<void (*)(int), int> >::operator()() ()
#7  0x00005555555557d3 in std::thread::_State_impl<std::thread::_Invoker<std::tuple<void (*)(int), int> > >::_M_run() ()
#8  0x00007ffff7f40d90 in ?? () from /lib/x86_64-linux-gnu/libstdc++.so.6
#9  0x00007ffff7f93609 in start_thread (arg=<optimized out>) at pthread_create.c:477
#10 0x00007ffff7eb2293 in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95
```

å› ä¸ºå½“å‰æ ˆå¸§åœ¨ç³»ç»Ÿå‡½æ•° `nanosleep` ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œ `finish` å‘½ä»¤é€€å‡º `sleep_for` å‡½æ•°ï¼Œå›åˆ°æˆ‘ä»¬è‡ªå·±çš„ä»£ç  `do_work` å‡½æ•°ä¸­ã€‚

**å›åˆ°`do_work`å¹¶æŸ¥çœ‹å±€éƒ¨å˜é‡**

```gdb
(gdb) finish
Run till exit from #0  0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff7dadc10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
Thread 2 "app" finished.
0x000055555555550a in do_work (thread_id=1) at thread_management_example.cpp:19
19          std::cout << "Thread " << thread_id << " finished." << std::endl;
Value returned is $1 = 0
(gdb) i locals
thread_id = 1
```

æ‰§è¡Œ `finish` åï¼Œç¨‹åºåœåœ¨ç¬¬19è¡Œã€‚è¿™æ—¶ä½¿ç”¨ `i locals` å³å¯æŸ¥çœ‹åˆ°å½“å‰çº¿ç¨‹ï¼ˆ2å·çº¿ç¨‹ï¼‰çš„å±€éƒ¨å˜é‡ `thread_id` çš„å€¼ä¸º1ã€‚ï¼ˆæ³¨æ„ï¼šçº¿ç¨‹IDå’ŒGDBçš„çº¿ç¨‹ç¼–å·ä¸ä¸€å®šå®Œå…¨å¯¹åº”ï¼‰ã€‚

### **3.13.3 ä¸ºçº¿ç¨‹è®¾ç½®æ–­ç‚¹**

å¯ä»¥é€šè¿‡ `break` (æˆ– `b`) å‘½ä»¤ä¸ºç‰¹å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹è®¾ç½®æ–­ç‚¹ã€‚

ä¾‹å¦‚ï¼Œè¦ä¸º3å·å’Œ4å·çº¿ç¨‹åœ¨ä»£ç ç¬¬11è¡Œå¤„ï¼ˆ`count++`ï¼‰è®¾ç½®æ–­ç‚¹ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```gdb
(gdb) b 11 thread 3
Breakpoint 2 at 0x5555555554aa: file thread_management_example.cpp, line 11.
(gdb) b 11 thread 4
Breakpoint 3 at 0x5555555554aa: file thread_management_example.cpp, line 11.
```

è¿™ä¼šä¸ºçº¿ç¨‹3å’Œçº¿ç¨‹4åœ¨ä»£ç 11è¡Œå¤„è®¾ç½®æ–­ç‚¹ã€‚é€šè¿‡ `info b` å‘½ä»¤ä¹Ÿå¯ä»¥æŸ¥çœ‹æ–­ç‚¹ä¿¡æ¯ï¼Œå‘ç°åªæœ‰è¿™ä¸¤ä¸ªçº¿ç¨‹ä¼šåœ¨æ­¤å¤„ä¸­æ–­ï¼Œå…¶ä»–çº¿ç¨‹æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ä¸ä¼šå‘½ä¸­ã€‚

**æŸ¥çœ‹æ–­ç‚¹ä¿¡æ¯**

```gdb
(gdb) info b
Num     Type           Disp Enb Address            What
1       breakpoint     keep y   0x00005555555556cd in start_threads(int) at thread_management_example.cpp:32
2       breakpoint     keep y   0x00005555555554aa in do_work(int) at thread_management_example.cpp:11
        stop only in thread 3
3       breakpoint     keep y   0x00005555555554aa in do_work(int) at thread_management_example.cpp:11
        stop only in thread 4
```

### **3.13.4 ä¸ºçº¿ç¨‹æ‰§è¡Œå‘½ä»¤**

åœ¨è°ƒè¯•æ—¶ï¼Œå¯ä»¥ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡å®šçš„çº¿ç¨‹æ‰§è¡Œå‘½ä»¤ï¼Œè€Œæ— éœ€æ‰‹åŠ¨åˆ‡æ¢ã€‚å‘½ä»¤è¯­æ³•ä¸º `thread apply çº¿ç¨‹å· å‘½ä»¤`ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ‰€æœ‰çº¿ç¨‹æ‰§è¡Œ `print` å‘½ä»¤ï¼ŒæŸ¥çœ‹å®ƒä»¬å¯¹åº”çš„ `thread_id` å˜é‡çš„å€¼ã€‚ï¼ˆæ³¨æ„ï¼šæ­¤å‘½ä»¤åªå¯¹å·²è¿›å…¥ `do_work` å‡½æ•°çš„çº¿ç¨‹æœ‰æ•ˆï¼‰ã€‚

**ä¸ºæŒ‡å®šçº¿ç¨‹æ‰§è¡Œå‘½ä»¤**

```gdb
# åˆ‡æ¢å›ä¸»çº¿ç¨‹ï¼Œè®©å…¶ä»–çº¿ç¨‹ç»§ç»­æ‰§è¡Œç›´åˆ°å®ƒä»¬ç»“æŸ
(gdb) t 1
[Switching to thread 1 (Thread 0x7ffff7fbe740 (LWP 12344))]
#0  start_threads (thread_num=10) at thread_management_example.cpp:32
32          for (auto& t : threads) {
(gdb) thread apply 2 3 4 p thread_id
Thread 4 (Thread 0x7ffff7cac640 (LWP 12347)):
$2 = 3
Thread 3 (Thread 0x7ffff7d2d640 (LWP 12346)):
$3 = 2
Thread 2 (Thread 0x7ffff7dae640 (LWP 12345)):
$4 = 1
```

è¦ä½¿æ‰€æœ‰çº¿ç¨‹éƒ½æ‰§è¡Œå‘½ä»¤ï¼Œéœ€è¦å°†çº¿ç¨‹å·å†™ä¸º `all`ã€‚æŸ¥çœ‹æ¯ä¸ªçº¿ç¨‹çš„æ ˆå›æº¯ï¼ˆ`bt`ï¼‰æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå°¤å…¶æ˜¯åœ¨å¤§å‹ç¨‹åºä¸­è¯Šæ–­æ­»é”é—®é¢˜æ—¶ã€‚

**ä¸ºæ‰€æœ‰çº¿ç¨‹æ‰§è¡Œbtå‘½ä»¤**

```gdb
(gdb) thread apply all bt

Thread 11 (Thread 0x7ffff59aa640 (LWP 12354)):
#0  0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff59a9c10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
#1  0x00007ffff7ea8b5f in __sleep (seconds=0) at ../sysdeps/posix/sleep.c:55
#2  0x000055555555566f in std::this_thread::sleep_for<long, std::ratio<1l, 1l> >(std::chrono::duration<long, std::ratio<1l, 1l> > const&) ()
#3  0x00005555555554f6 in do_work(int) (thread_id=10) at thread_management_example.cpp:17
...

Thread 10 (Thread 0x7ffff5a2b640 (LWP 12353)):
#0  0x00007ffff7ea8bfb in __GI___nanosleep (remaining=0x0, requested_time=0x7ffff5a2ac10) at ../sysdeps/unix/sysv/linux/nanosleep.c:28
#1  0x00007ffff7ea8b5f in __sleep (seconds=0) at ../sysdeps/posix/sleep.c:55
#2  0x000055555555566f in std::this_thread::sleep_for<long, std::ratio<1l, 1l> >(std::chrono::duration<long, std::ratio<1l, 1l> > const&) ()
#3  0x00005555555554f6 in do_work(int) (thread_id=9) at thread_management_example.cpp:17
...

... (å…¶ä»–çº¿ç¨‹çš„æ ˆå›æº¯ä¿¡æ¯) ...

Thread 1 (Thread 0x7ffff7fbe740 (LWP 12344)):
#0  start_threads (thread_num=10) at thread_management_example.cpp:32
#1  0x00005555555555b2 in main () at thread_management_example.cpp:40

```

ç”±äºæ¯ä¸ªçº¿ç¨‹çš„æ ˆå¸§æ¯”è¾ƒå¤šï¼Œå±å¹•ä¸Šå¯èƒ½æ— æ³•å…¨éƒ¨æ˜¾ç¤ºã€‚ä½†è¯¥å‘½ä»¤ `thread apply all bt` æå¤§åœ°ç®€åŒ–äº†æ£€æŸ¥æ‰€æœ‰çº¿ç¨‹çŠ¶æ€çš„è¿‡ç¨‹ï¼Œæ˜¯å¤šçº¿ç¨‹è°ƒè¯•ä¸­çš„ä¸€ä¸ªåˆ©å™¨ã€‚



# æ¡ˆä¾‹è¯´æ˜

è¿™ä¸ªç°è±¡éå¸¸ç»å…¸ï¼Œå®ƒæ­ç¤ºäº† GDB åœ¨å¤šçº¿ç¨‹è°ƒè¯•ä¸­çš„ä¸€ä¸ªé‡è¦è¡Œä¸ºï¼š**é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä½ è®©ä¸€ä¸ªçº¿ç¨‹ç»§ç»­æ‰§è¡Œæ—¶ï¼Œå…¶ä»–æ‰€æœ‰çº¿ç¨‹ä¹Ÿä¼šä¸€èµ·æ‰§è¡Œã€‚**

ç®€å•æ¥è¯´ï¼Œå…¶ä»–çº¿ç¨‹ç»“æŸæ˜¯å› ä¸ºåœ¨ä½ è¾“å…¥ `finish` å‘½ä»¤åï¼Œå®ƒä»¬ä¹Ÿè·Ÿç€â€œè‡ªç”±å¥”è·‘â€å¹¶æ‰§è¡Œå®Œäº†è‡ªå·±çš„æ‰€æœ‰ä»»åŠ¡ã€‚

-----

### \#\# äº‹ä»¶å‘ç”Ÿçš„è¿‡ç¨‹

1.  **åˆå§‹çŠ¶æ€**ï¼šä½ æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼ˆåŒ…æ‹¬çº¿ç¨‹2, 4, 6, 7, 8, 9ç­‰ï¼‰éƒ½åˆšåˆšå®Œæˆäº†3ç§’çš„ä¼‘çœ ï¼Œå…¨éƒ¨å¤„äºâ€œç¡é†’â€çŠ¶æ€ï¼Œå‡†å¤‡æ‰§è¡Œä¸‹ä¸€è¡Œä»£ç ã€‚

2.  **ä½ çš„å‘½ä»¤**ï¼šä½ åœ¨çº¿ç¨‹4ä¸Šè¾“å…¥äº† `finish` å‘½ä»¤ã€‚è¿™ä¸ªå‘½ä»¤çš„æ„æ€æ˜¯â€œç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°å½“å‰å‡½æ•°ï¼ˆ`sleep_for`ï¼‰è¿”å›â€ã€‚

3.  **GDB çš„è¡Œä¸º**ï¼šä¸ºäº†å®Œæˆ `finish` å‘½ä»¤ï¼ŒGDBéœ€è¦è®©ç¨‹åº**æ¢å¤è¿è¡Œ**ã€‚GDBçš„é»˜è®¤æ¨¡å¼ï¼ˆ`scheduler-locking off`ï¼‰æ˜¯ï¼Œä¸€æ—¦ç¨‹åºæ¢å¤è¿è¡Œï¼Œ**æ‰€æœ‰**å¯ä»¥è¿è¡Œçš„çº¿ç¨‹éƒ½ä¼šè¢«æ“ä½œç³»ç»Ÿè°ƒåº¦ï¼Œä¸€èµ·å‘å‰æ‰§è¡Œã€‚

4.  **å¤šçº¿ç¨‹â€œèµ›è·‘â€** ğŸï¸ï¼š

      * å°±åœ¨çº¿ç¨‹4æ‰§è¡Œ `sleep_for` å‰©ä½™æŒ‡ä»¤çš„è¿™æçŸ­æ—¶é—´å†…ï¼Œå…¶ä»–é‚£äº›åŒæ ·å·²ç»ç¡é†’çš„çº¿ç¨‹ï¼ˆçº¿ç¨‹2, 6, 7, 8, 9ç­‰ï¼‰ä¹Ÿå¼€å§‹é£é€Ÿæ‰§è¡Œã€‚
      * å®ƒä»¬æ‰§è¡Œäº† `sleep_for` åé¢çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯æ‰“å° â€œfinishedâ€ çš„æ¶ˆæ¯ï¼Œç„¶åèµ°åˆ°äº†çº¿ç¨‹å‡½æ•°çš„æœ«å°¾ï¼Œäºæ˜¯å°±è‡ªç„¶é€€å‡ºäº†ã€‚
      * ä½ çœ‹åˆ°çš„ `[Thread ... exited]` æ˜¯ GDB å‘Šè¯‰ä½ è¿™ä¸ªçº¿ç¨‹å·²ç»è¿è¡Œç»“æŸå¹¶é”€æ¯äº†ã€‚

5.  **æœ€ç»ˆç»“æœ**ï¼šæœ€åï¼Œçº¿ç¨‹4ä¹Ÿå®Œæˆäº† `finish` çš„ç›®æ ‡ï¼ŒæˆåŠŸåœ°ä» `sleep_for` è¿”å›ï¼Œå¹¶åœåœ¨äº†ä½ è‡ªå·±å†™çš„ `do_work` å‡½æ•°çš„ç¬¬20è¡Œã€‚ä½†æ­¤æ—¶ï¼Œå…¶ä»–å¾ˆå¤šçº¿ç¨‹å·²ç»è·‘å®Œå¹¶é€€å‡ºäº†ã€‚

-----

### \#\# å¦‚ä½•åªæ‰§è¡Œå½“å‰çº¿ç¨‹ï¼Ÿ

å¦‚æœä½ å¸Œæœ›åœ¨è°ƒè¯•æ—¶ï¼Œåªè®©å½“å‰ä½ å…³æ³¨çš„çº¿ç¨‹ï¼ˆæ¯”å¦‚çº¿ç¨‹4ï¼‰æ‰§è¡Œï¼Œè€Œè®©å…¶ä»–æ‰€æœ‰çº¿ç¨‹éƒ½ä¿æŒæš‚åœï¼Œä½ å¯ä»¥ä½¿ç”¨ GDB çš„ **`scheduler-locking`** å‘½ä»¤ã€‚

  * **é”å®šæ‰§è¡Œ**ï¼šåœ¨æ‰§è¡Œ `finish`, `next`, `step` æˆ– `continue` ä¹‹å‰ï¼Œå…ˆè¾“å…¥è¿™ä¸ªå‘½ä»¤ï¼š

    ```gdb
    (gdb) set scheduler-locking on
    ```

    è¿™æ ·è®¾ç½®ä¹‹åï¼Œåªæœ‰ä½ å½“å‰é€‰æ‹©çš„çº¿ç¨‹ä¼šåŠ¨ï¼Œå…¶ä»–çº¿ç¨‹éƒ½ä¼šè¢« GDB â€œå†»ç»“â€ã€‚

  * **è§£é™¤é”å®š**ï¼šå½“ä½ å¸Œæœ›æ‰€æœ‰çº¿ç¨‹æ¢å¤æ­£å¸¸æ‰§è¡Œæ—¶ï¼Œå¯ä»¥æŠŠå®ƒå…³æ‰ï¼š

    ```gdb
    (gdb) set scheduler-locking off
    ```

**æ€»ç»“**ï¼šä½ é‡åˆ°çš„æƒ…å†µæ˜¯ GDB é»˜è®¤è¡Œä¸ºå¯¼è‡´çš„â€œå¤šçº¿ç¨‹èµ›è·‘â€ã€‚è¦è¿›è¡Œç²¾ç»†çš„å•çº¿ç¨‹è°ƒè¯•ï¼Œè¯·è®°å¾—ä½¿ç”¨ `set scheduler-locking on`ã€‚