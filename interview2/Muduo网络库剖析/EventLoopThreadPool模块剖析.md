## EventLoopThreadPoolæ¨¡å—çš„ä½œç”¨

**äº‹ä»¶å¾ªç¯çº¿ç¨‹æ± **
å®ƒçš„ä½œç”¨æ˜¯ï¼š
- ç®¡ç†ä¸€ç»„å­çº¿ç¨‹ï¼Œæ¯ä¸ªå­çº¿ç¨‹éƒ½æŒæœ‰è‡ªå·±çš„ EventLoop
- è´Ÿè´£æ ¹æ®éœ€è¦æŠŠäº‹ä»¶/ä»»åŠ¡åˆ†å‘åˆ°ä¸åŒçš„ EventLoop ä¸Š

## EventLoopThreadPoolæˆå‘˜å˜é‡

```c++
EventLoop* baseLoop_;  // ä¸»çº¿ç¨‹ EventLoopï¼ŒAcceptor ä½¿ç”¨çš„
std::string name_;
bool started_;
int numThreads_;       // çº¿ç¨‹æ•°é‡
int next_;             // ä¸‹ä¸€ä¸ªè¦åˆ†å‘çš„ loop ç¼–å·
std::vector<std::unique_ptr<EventLoopThread>> threads_;
std::vector<EventLoop*> loops_; // ä¿å­˜æ‰€æœ‰å­çº¿ç¨‹ EventLoop çš„æŒ‡é’ˆ
```


###  EventLoop\* baseLoop\_

ğŸ‘‰ **ä½œç”¨**ï¼š

* æŒ‡å‘**ä¸»çº¿ç¨‹ï¼ˆAcceptor æ‰€åœ¨çº¿ç¨‹ï¼‰çš„ EventLoop å¯¹è±¡**
* ç”¨äºç›‘å¬å®¢æˆ·ç«¯æ–°è¿æ¥äº‹ä»¶

ğŸ‘‰ **ä¸ºä»€ä¹ˆè¦æœ‰å®ƒ**ï¼š

* **Acceptor è´Ÿè´£ accept æ–°è¿æ¥ï¼Œä¸€èˆ¬åªåœ¨ä¸»çº¿ç¨‹çš„ EventLoop ä¸Šç›‘å¬**
* å­çº¿ç¨‹ä¸è´Ÿè´£ç›‘å¬ï¼Œåªè´Ÿè´£å¤„ç† I/Oã€è¯»å†™äº‹ä»¶

ğŸ‘‰ **åœ¨ getNextLoop() é‡Œçš„ä½œç”¨**ï¼š

* å¦‚æœçº¿ç¨‹æ± æœªå¯åŠ¨ï¼ˆçº¿ç¨‹æ•°ä¸º 0ï¼‰ï¼Œæˆ–è€…æ²¡æœ‰å­çº¿ç¨‹ EventLoopï¼Œç›´æ¥è¿”å› `baseLoop_`ï¼Œåœ¨ä¸»çº¿ç¨‹é‡Œå¤„ç†æ‰€æœ‰äº‹ä»¶


###  std::string name\_

ğŸ‘‰ **ä½œç”¨**ï¼š

* ç»™çº¿ç¨‹æ± èµ·ä¸ªåå­—ï¼Œç”¨äºæ—¥å¿—ã€è°ƒè¯•ã€æ’æŸ¥é—®é¢˜æ—¶åŒºåˆ†ä¸åŒçº¿ç¨‹æ± 

ğŸ‘‰ **åº”ç”¨åœºæ™¯**ï¼š

* å¤šä¸ª TcpServer æˆ– EventLoopThreadPool å…±å­˜æ—¶ï¼ŒåŒºåˆ†å®ƒä»¬ç”¨çš„
* ç”Ÿæˆæ¯ä¸ªå­çº¿ç¨‹åå­—æ—¶ç”¨ï¼Œæ¯”å¦‚ï¼š

  ```cpp
  snprintf(buf, sizeof buf, "%s%d", name_.c_str(), i);
  ```


###  bool started\_

ğŸ‘‰ **ä½œç”¨**ï¼š

* æ ‡å¿—çº¿ç¨‹æ± æ˜¯å¦å·²å¯åŠ¨

ğŸ‘‰ **ä¸ºä»€ä¹ˆè¦æœ‰å®ƒ**ï¼š

* é˜²æ­¢ `start()` è¢«è°ƒç”¨å¤šæ¬¡
* ä¿è¯çº¿ç¨‹æ± åªèƒ½å¯åŠ¨ä¸€æ¬¡ï¼Œé‡å¤è°ƒç”¨æ˜¯æ— æ•ˆç”šè‡³å±é™©çš„

ğŸ‘‰ **ä½¿ç”¨åœºæ™¯**ï¼š

```cpp
assert(!started_);
started_ = true;
```


###  int numThreads\_

ğŸ‘‰ **ä½œç”¨**ï¼š

* æŒ‡å®šçº¿ç¨‹æ± ä¸­**è¦å¯åŠ¨çš„å­çº¿ç¨‹æ•°é‡**

ğŸ‘‰ **ä¸ºä»€ä¹ˆè¦æœ‰å®ƒ**ï¼š

* åŠ¨æ€é…ç½®çº¿ç¨‹æ± å¤§å°
* ç”¨æˆ·å¯ä»¥æ ¹æ®æœºå™¨ CPU æ ¸å¿ƒæ•°ã€ä¸šåŠ¡ç±»å‹æ¥è°ƒæ•´çº¿ç¨‹æ± è§„æ¨¡

ğŸ‘‰ **ä½¿ç”¨åœºæ™¯**ï¼š

* åœ¨ `start()` ä¸­ï¼Œæ ¹æ® `numThreads_` å¾ªç¯åˆ›å»ºå­çº¿ç¨‹
* åœ¨ `TcpServer` ä¸­ï¼š

  ```cpp
  server.setThreadNum(4); // å¯åŠ¨ 4 ä¸ªå­çº¿ç¨‹ EventLoop
  ```


###  int next\_

ğŸ‘‰ **ä½œç”¨**ï¼š

* è®°å½•ä¸‹ä¸€ä¸ªè¦è¿”å›çš„ EventLoop ç¼–å·
* **ç”¨äº getNextLoop() ä¸­å®ç°è½®è¯¢ï¼ˆRound Robinï¼‰ç®—æ³•**

ğŸ‘‰ **ä¸ºä»€ä¹ˆè¦æœ‰å®ƒ**ï¼š

* çº¿ç¨‹æ± ç®¡ç†çš„ EventLoop æ•°é‡æœ‰é™ï¼Œæ¯æ¬¡åˆ†é…è¿æ¥/ä»»åŠ¡è¦**å‡åŒ€åˆ†å¸ƒåˆ°ä¸åŒçº¿ç¨‹**
* é˜²æ­¢æŸä¸ªçº¿ç¨‹è¿‡è½½ï¼Œå…¶ä»–çº¿ç¨‹ç©ºé—²

ğŸ‘‰ **ä½¿ç”¨åœºæ™¯**ï¼š

```cpp
loop = loops_[next_];
++next_;
if (next_ >= loops_.size())
    next_ = 0;
```

### std::vector<std::unique_ptr<EventLoopThread\>>threads_

ğŸ‘‰ **ä½œç”¨**ï¼š

* ä¿å­˜æ‰€æœ‰å­çº¿ç¨‹çš„ `EventLoopThread` å¯¹è±¡ï¼ˆç”¨ unique\_ptr ç®¡ç†å†…å­˜ï¼‰

ğŸ‘‰ **ä¸ºä»€ä¹ˆè¦æœ‰å®ƒ**ï¼š

* çº¿ç¨‹æ± ç®¡ç†å­çº¿ç¨‹ï¼Œé¿å…æ³„éœ²
* ä¾¿äºç»Ÿä¸€é”€æ¯ã€ææ„æ—¶é‡Šæ”¾èµ„æº

ğŸ‘‰ **è®¾è®¡ç»†èŠ‚**ï¼š

* ç”¨ `unique_ptr` è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œä¸ç”¨æ‰‹åŠ¨ delete
* ä¿è¯çº¿ç¨‹æ± é”€æ¯æ—¶ï¼Œæ‰€æœ‰å­çº¿ç¨‹éƒ½å®‰å…¨é”€æ¯

ğŸ‘‰ **ç”¨æ³•**ï¼š

* `start()` ä¸­ï¼š

  ```cpp
  threads_.push_back(std::unique_ptr<EventLoopThread>(t));
  ```

##  std::vector\<EventLoop\*> loops\_

ğŸ‘‰ **ä½œç”¨**ï¼š

* ä¿å­˜æ‰€æœ‰å­çº¿ç¨‹å†…çš„ EventLoop æŒ‡é’ˆï¼Œæ–¹ä¾¿è°ƒåº¦ã€åˆ†å‘ä»»åŠ¡ã€å¹¿æ’­æ¶ˆæ¯

ğŸ‘‰ **ä¸ºä»€ä¹ˆè¦æœ‰å®ƒ**ï¼š

* EventLoopThread è´Ÿè´£ç®¡ç†çº¿ç¨‹ï¼Œä½† TcpServer è°ƒç”¨ `getNextLoop()` æˆ– `getAllLoops()` æ—¶éœ€è¦æ‹¿åˆ°å­çº¿ç¨‹å†…çš„ EventLoop æ‰èƒ½åˆ†å‘ä»»åŠ¡
* **EventLoop å’Œ EventLoopThread æ˜¯ä¸€å¯¹ä¸€å…³ç³»ï¼Œä½† TcpServer åªå…³å¿ƒ EventLoopï¼Œä¸å…³å¿ƒçº¿ç¨‹æœ¬èº«**

ğŸ‘‰ **è®¾è®¡ç»†èŠ‚**ï¼š

* æ¯ä¸ª EventLoopThread å¯åŠ¨åè°ƒç”¨ `startLoop()`ï¼Œå°†å­çº¿ç¨‹å†… EventLoop æŒ‡é’ˆè¿”å›å¹¶åŠ å…¥ loops\_
* loops\_ å’Œ threads\_ çš„é¡ºåºä¸€ä¸€å¯¹åº”ï¼Œè½®è¯¢è°ƒåº¦ä¾é  loops\_ æ•°ç»„

**ç”¨æ³•**ï¼š

```cpp
loops_.push_back(t->startLoop());
```


## EventLoopThreadPoolæˆå‘˜å‡½æ•°

### start()

```c++
void EventLoopThreadPool::start(const ThreadInitCallback& cb)
{
    started_ = true;
    for (int i = 0; i < numThreads_; ++i)
    {
        char buf[name_.size() + 32];
        snprintf(buf, sizeof buf, "%s%d",name_.c_str(),i);
        EventLoopThread *t = new EventLoopThread(cb,buf);
        threads_.push_back(std::unique_ptr<EventLoopThread>(t));
        loops_.push_back(t->startLoop());
    }

    // æ•´ä¸ªæœåŠ¡ç«¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿è¡Œç€baseloop
    if (numThreads_ == 0 && cb)
    {
        cb(baseLoop_);
    }
}
```


#### ä½œç”¨æ¦‚è¿°ï¼š

**å¯åŠ¨çº¿ç¨‹æ± ï¼š**

* åˆ›å»º `numThreads_` ä¸ª `EventLoopThread`
* æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ `EventLoop`
* å¯åŠ¨å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹å†…éƒ¨è¿è¡Œ `loop()`
* ä¸»çº¿ç¨‹ï¼ˆAcceptor æ‰€åœ¨çº¿ç¨‹ï¼‰å¦‚æœæ²¡æœ‰å­çº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ‰§è¡Œå›è°ƒ



#### `started_ = true;`

ğŸ‘‰ **ä½œç”¨**ï¼š

* è®¾ç½®å¯åŠ¨æ ‡å¿—ï¼Œè¯´æ˜çº¿ç¨‹æ± å·²ç»å¯åŠ¨ï¼Œåç»­ä¸å…è®¸å†è°ƒ `start()`


#### `for (int i = 0; i < numThreads_; ++i)`

ğŸ‘‰ **ä½œç”¨**ï¼š

* å¯åŠ¨ `numThreads_` ä¸ªå­çº¿ç¨‹ EventLoop

---

#### `snprintf(buf, sizeof buf, "%s%d", name_.c_str(), i);`

ğŸ‘‰ **ä½œç”¨**ï¼š

* ç”Ÿæˆå­çº¿ç¨‹çš„åå­—ï¼Œæ¯”å¦‚ï¼š

  ```
  "WorkerThread0"
  "WorkerThread1"
  ```

ğŸ‘‰ **ä¸ºä»€ä¹ˆ**ï¼š

* æ–¹ä¾¿æ’æŸ¥æ—¥å¿—ã€è°ƒè¯•å®šä½å“ªä¸ªçº¿ç¨‹åœ¨è·‘


#### `EventLoopThread* t = new EventLoopThread(cb, buf);`

ğŸ‘‰ **ä½œç”¨**ï¼š

* åˆ›å»ºä¸€ä¸ª `EventLoopThread` å¯¹è±¡
* çº¿ç¨‹å¯åŠ¨åä¼šåœ¨å­çº¿ç¨‹é‡Œåˆ›å»ºä¸€ä¸ª `EventLoop`
* `cb` æ˜¯çº¿ç¨‹å¯åŠ¨æ—¶è¦æ‰§è¡Œçš„åˆå§‹åŒ–å›è°ƒï¼ˆå¯ä»¥ä¸ºç©ºï¼‰

ğŸ‘‰ **å‚æ•°å«ä¹‰**ï¼š

* `cb`ï¼šçº¿ç¨‹ EventLoop åˆ›å»ºåã€loop å‰æ‰§è¡Œçš„åˆå§‹åŒ–å‡½æ•°
* `buf`ï¼šçº¿ç¨‹åå­—

#### `threads_.push_back(std::unique_ptr<EventLoopThread>(t));`

ğŸ‘‰ **ä½œç”¨**ï¼š

* ç”¨ `unique_ptr` ç®¡ç† `EventLoopThread` å†…å­˜ï¼Œé˜²æ­¢æ³„éœ²ï¼Œçº¿ç¨‹æ± ææ„æ—¶ç»Ÿä¸€é‡Šæ”¾

---

#### `loops_.push_back(t->startLoop());`

ğŸ‘‰ **ä½œç”¨**ï¼š

* è°ƒç”¨ `EventLoopThread::startLoop()`
* è¿™ä¸ªå‡½æ•°ï¼š

  1. åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹
  2. å­çº¿ç¨‹é‡Œåˆ›å»º `EventLoop`
  3. å°†å­çº¿ç¨‹å†…çš„ `EventLoop*` è¿”å›ï¼ŒåŠ å…¥ `loops_`

ğŸ‘‰ **ä¸ºä»€ä¹ˆè¦å­˜ loops\_**ï¼š

* æ–¹ä¾¿åé¢ `TcpServer::getNextLoop()` è°ƒç”¨ï¼Œè½®è¯¢åˆ†å‘è¿æ¥ã€ä»»åŠ¡åˆ°å„çº¿ç¨‹ EventLoop

---

#### `if (numThreads_ == 0 && cb) cb(baseLoop_);`

ğŸ‘‰ **ä½œç”¨**ï¼š

* å¦‚æœçº¿ç¨‹æ± çº¿ç¨‹æ•°æ˜¯ 0ï¼ˆå•çº¿ç¨‹æ¨¡å¼ï¼‰
* è€Œä¸”æä¾›äº†å›è°ƒ `cb`ï¼Œå°±ç›´æ¥åœ¨**ä¸»çº¿ç¨‹çš„ EventLoop** ä¸Šæ‰§è¡Œåˆå§‹åŒ–å›è°ƒ

ğŸ‘‰ **ä¸ºä»€ä¹ˆ**ï¼š

* ä¿è¯å•çº¿ç¨‹æ¨¡å¼ä¸‹ä¹Ÿèƒ½æ‰§è¡Œåˆå§‹åŒ–é…ç½®ï¼Œæ¯”å¦‚æ³¨å†Œå®šæ—¶å™¨ã€è®¾ç½®å‚æ•°ç­‰
