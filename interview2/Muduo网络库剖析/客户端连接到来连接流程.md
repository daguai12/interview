
```cpp
mainLoop æ£€æµ‹åˆ° listenFd å¯è¯»
 â””â”€â”€ Acceptor::handleRead()             // accept æ–°è¿æ¥
      â””â”€â”€ è°ƒç”¨ TcpServer::newConnectionCallback
            â””â”€â”€ ä» EventLoopThreadPool é‡Œè½®è¯¢è·å–ä¸€ä¸ª subLoop
            â””â”€â”€ åˆ›å»º TcpConnection å¯¹è±¡
            â””â”€â”€ subLoop->runInLoop() å°† TcpConnection åˆå§‹åŒ–å·¥ä½œåŠ å…¥å­çº¿ç¨‹äº‹ä»¶é˜Ÿåˆ—

```
æ–°è¿æ¥æ¥äº† â†’ é€‰ subLoop â†’ åˆ›å»º TcpConnection â†’ æ³¨å†Œ Channel

# TcpServer::newConnectionCallback()è°ƒç”¨é“¾

ğŸ‘‰ å½“æœ‰æ–°è¿æ¥åˆ°æ¥ï¼Œ`Acceptor::handleRead()` æ¥æ”¶åˆ°è¿æ¥ï¼Œè°ƒç”¨ `newConnectionCallback_`ï¼ˆå°±æ˜¯ `TcpServer::newConnection()`ï¼‰
**åœ¨ TcpServer::newConnection() ä¸­è¦é€‰æ‹©ä¸€ä¸ª subLoop æ¥ç®¡ç†è¿™ä¸ªæ–°è¿æ¥**

## è¯¦ç»†è°ƒç”¨é“¾

### â‘  `TcpServer::newConnection(int sockfd, const InetAddress& peerAddr)`

```cpp
void TcpServer::newConnection(int sockfd, const InetAddress& peerAddr)
{
    EventLoop* ioLoop = threadPool_->getNextLoop(); // è½®è¯¢é€‰ä¸€ä¸ª subLoop
    ...
}
```

ğŸ‘‰ è¿™é‡Œè°ƒç”¨ `EventLoopThreadPool::getNextLoop()`ï¼Œè¿”å›ä¸€ä¸ª subLoop


### â‘¡ `EventLoopThreadPool::getNextLoop()`

```cpp
EventLoop* EventLoopThreadPool::getNextLoop()
{
    EventLoop* loop = baseLoop_;

    if (!loops_.empty())
    {
        // è½®è¯¢è°ƒåº¦
        loop = loops_[next_];
        ++next_;
        if (next_ >= loops_.size())
        {
            next_ = 0;
        }
    }

    return loop;
}
```

âœ”ï¸ è¿™ä¸ªå°±æ˜¯**è½®è¯¢è´Ÿè½½å‡è¡¡**

* `loops_`ï¼šä¿å­˜æ‰€æœ‰å­çº¿ç¨‹çš„ subLoop æŒ‡é’ˆ
* `next_`ï¼šè®°å½•å½“å‰è°ƒåº¦åˆ°å“ªä¸ª subLoop
* æ¯è°ƒç”¨ä¸€æ¬¡ `getNextLoop()`ï¼Œ`next_` è‡ªå¢ï¼Œè¶…å‡ºå°±å½’é›¶ï¼Œå½¢æˆ**å¾ªç¯è°ƒåº¦**

**å¦‚æœæ²¡æœ‰å­çº¿ç¨‹ï¼ˆå• Reactorï¼‰**ï¼Œå°±è¿”å› `baseLoop_`



```
TcpServer::newConnection()
  â””â”€â”€ EventLoopThreadPool::getNextLoop()
        â”œâ”€â”€ if (loops_.empty())
        â”‚     â””â”€â”€ è¿”å› baseLoop_
        â””â”€â”€ else
              â”œâ”€â”€ å– loops_[next_]
              â”œâ”€â”€ next_++
              â”œâ”€â”€ next_ >= loops_.size() ? next_=0
              â””â”€â”€ è¿”å› loop
```


###  ä½œç”¨æ€»ç»“

| åŠ¨ä½œ                  | ä½œç”¨                            |
| :------------------ | :---------------------------- |
| `getNextLoop()`     | è½®è¯¢é€‰æ‹©ä¸€ä¸ª subLoopï¼Œè¿›è¡Œæ–°è¿æ¥çš„ IO äº‹ä»¶ç®¡ç† |
| `next_` è½®è¯¢ç´¢å¼•        | ç®€å• round-robin è´Ÿè½½å‡è¡¡ï¼Œå¹³å‡åˆ†é…è¿æ¥è´Ÿè½½  |
| æ²¡æœ‰å­çº¿ç¨‹æ—¶è¿”å› baseLoop\_ | å•çº¿ç¨‹æ¨¡å¼å…¼å®¹                       |


# åˆ›å»ºTcpConnectionå¯¹è±¡

## ğŸ“Œ è°ƒç”¨é“¾è¯¦ç»†è¿‡ç¨‹

---

### â‘  `TcpServer::newConnection()`

ğŸ‘‰ æ¥ä¸Šæ–‡ï¼Œç»§ç»­å¾€ä¸‹çœ‹ï¼š

```cpp
void TcpServer::newConnection(int sockfd, const InetAddress& peerAddr)
{
    EventLoop* ioLoop = threadPool_->getNextLoop();

    char buf[64];
    snprintf(buf, sizeof buf, "%s:%d", peerAddr.toIpPort().c_str(), nextConnId_);
    ++nextConnId_;
    std::string connName = name_ + buf;

    // åˆ›å»º TcpConnection å¯¹è±¡ï¼Œæ”¾åˆ° shared_ptr ä¸­
    TcpConnectionPtr conn(new TcpConnection(ioLoop, connName, sockfd, localAddr, peerAddr));

    connections_[connName] = conn; // ä¿å­˜åˆ°mapé‡Œï¼Œæ–¹ä¾¿ç®¡ç†

    // è®¾ç½®å„ç§å›è°ƒ
    conn->setConnectionCallback(connectionCallback_);
    conn->setMessageCallback(messageCallback_);
    conn->setWriteCompleteCallbac(writeCompleteCallback_);
    conn->setCloseCallback(
        std::bind(&TcpServer::removeConnection, this, std::placeholders::_1));

    // æŠŠè¿™ä¸ªè¿æ¥æ­£å¼åŠ å…¥ subLoop
    ioLoop->runInLoop(
        std::bind(&TcpConnection::connectEstablished, conn));
}
```

---

### ğŸ“Œ â‘¡ `TcpConnection` æ„é€ å‡½æ•°

```cpp
TcpConnection::TcpConnection(EventLoop* loop,
                             const std::string& name,
                             int sockfd,
                             const InetAddress& localAddr,
                             const InetAddress& peerAddr)
    : loop_(loop),
      name_(name),
      state_(kConnecting),
      socket_(new Socket(sockfd)),
      channel_(new Channel(loop, sockfd)),
      localAddr_(localAddr),
      peerAddr_(peerAddr)
{
    socket_->setKeepAlive(true);
    channel_->setReadCallback(
        std::bind(&TcpConnection::handleRead, this, std::placeholders::_1));
    channel_->setWriteCallback(
        std::bind(&TcpConnection::handleWrite, this));
    channel_->setCloseCallback(
        std::bind(&TcpConnection::handleClose, this));
    channel_->setErrorCallback(
        std::bind(&TcpConnection::handleError, this));
}
```

ğŸ‘‰ **åšäº†ä»€ä¹ˆï¼š**

* ä¿å­˜ loopã€åå­—ã€sockfdã€åœ°å€ä¿¡æ¯
* åˆ›å»º `Socket` å’Œ `Channel`ï¼ŒChannel å…³è” subLoop å’Œ sockfd
* ç»™ Channel ç»‘å®šå„ç§å›è°ƒï¼ˆè¯»ã€å†™ã€å…³é—­ã€é”™è¯¯ï¼‰
* çŠ¶æ€æ ‡è®°ä¸º `kConnecting`
* è®¾ç½® KeepAlive

---

### ğŸ“Œ â‘¢ runInLoop â†’ connectEstablished

```cpp
ioLoop->runInLoop(
    std::bind(&TcpConnection::connectEstablished, conn));
```

ğŸ‘‰ `runInLoop()` ä¿è¯åœ¨ subLoop æ‰€åœ¨çº¿ç¨‹å®‰å…¨æ‰§è¡Œã€‚

**æœ€ç»ˆè°ƒç”¨ï¼š**

```cpp
void TcpConnection::connectEstablished()
{
    setState(kConnected);
    channel_->tie(shared_from_this());
    channel_->enableReading();

    connectionCallback_(shared_from_this());
}
```

* çŠ¶æ€æ”¹ä¸º `kConnected`
* tie ç»‘å®š TcpConnectionï¼Œé˜²æ­¢ Channel è°ƒç”¨è¿‡ç¨‹ä¸­ TcpConnection æå‰ææ„
* enableReadingï¼ŒæŠŠç›‘å¬ `EPOLLIN` åŠ åˆ° subLoop çš„ epoll é‡Œ
* è°ƒç”¨ä¸Šå±‚çš„ `connectionCallback_` é€šçŸ¥ç”¨æˆ·

---

## ğŸ“Š ğŸ“¦ å°ç»“ï¼šè°ƒç”¨é“¾å›¾

```
TcpServer::newConnection(sockfd, peerAddr)
 â””â”€â”€ EventLoopThreadPool::getNextLoop()    // è·å– subLoop
 â””â”€â”€ new TcpConnection(...)               // åˆ›å»ºè¿æ¥å¯¹è±¡
      â””â”€â”€ new Socket + new Channel        // æ„é€ å‡½æ•°é‡Œ
      â””â”€â”€ set å„ç§å›è°ƒåˆ° Channel
 â””â”€â”€ ioLoop->runInLoop(connectEstablished)
      â””â”€â”€ connectEstablished()
          â””â”€â”€ tie(), enableReading(), ä¸Šå±‚å›è°ƒ
```

---

## ğŸ“Œ ğŸ“– ä½œç”¨æ€»ç»“

| åŠ¨ä½œ                            | ä½œç”¨                                   |
| :---------------------------- | :----------------------------------- |
| `new TcpConnection()`         | åˆ›å»ºè¿æ¥å¯¹è±¡ï¼Œç»‘å®š socket å’Œäº‹ä»¶ Channel         |
| Channel ç»‘å®šå›è°ƒ                  | å°†è¯¥è¿æ¥çš„è¯»/å†™/å…³é—­/é”™è¯¯äº‹ä»¶å¤„ç†å‡½æ•°æŒ‚è½½åˆ° Channel      |
| runInLoop(connectEstablished) | ä¿è¯åœ¨ subLoop æ‰€åœ¨çº¿ç¨‹å†…å®‰å…¨æ‰§è¡Œè¿æ¥åˆå§‹åŒ–å’Œ epoll æ³¨å†Œ |
| connectEstablished()          | è®¾ç½®çŠ¶æ€ã€tieä¿æŠ¤ã€æ³¨å†Œè¯»äº‹ä»¶ã€è§¦å‘ç”¨æˆ·å›è°ƒ              |

---

## ğŸ“– ğŸŒˆ è¦ä¸è¦æˆ‘å†ç»™ä½ ç”»ä¸€ä¸‹**handleRead â†’ æ¶ˆæ¯æ”¶å‘ â†’ å›è°ƒè§¦å‘**é‚£ä¸€æ®µè°ƒç”¨é“¾ï¼Ÿ

æå®šäº†ä½ å°±åŸºæœ¬æŒæ¡ Muduo æ ¸å¿ƒæ‰§è¡Œé“¾äº† ğŸ”¥ï¼è¦çš„è¯ç›´æ¥è¯´ï¼
