好的，这是根据您提供的文本内容，保留原始结构和标题整理的结果。

### **37.3 编写 daemon 指南**

在编写守护进程（daemon）时，应遵循以下几个关键指南，以确保其健壮和稳定。

#### **1. 正确处理终止信号 (`SIGTERM`)**

* **生命周期**: Daemon 通常只有在系统关闭时才会终止。
* **终止机制**: 在系统关闭时，`init` 进程会向其所有子进程（包括 daemon）发送 **`SIGTERM`** 信号。
* **默认行为**: `SIGTERM` 的默认动作是终止进程。
* **清理工作**: 如果 daemon 在终止前需要做一些清理工作（例如，保存状态、关闭数据库连接），那么它**必须**为 `SIGTERM` 信号建立一个处理器（handler）。
* **时间限制**: 这个清理工作必须快速完成。`init` 进程在发送 `SIGTERM` 信号后，通常会等待一小段时间（例如 5 秒），然后会向所有尚未终止的进程发送一个不可被捕获的 **`SIGKILL`** 信号，强制杀死它们。

#### **2. 避免资源泄露**

由于 daemon 是长时间运行的，因此要特别小心潜在的资源泄露问题。在短生命周期的程序中不明显的微小泄露，会在 daemon 中随着时间的推移不断累积，最终导致严重问题。

* **内存泄露**: 确保所有动态分配的内存都能在不再需要时被正确释放。
* **文件描述符泄露**: 确保所有打开的文件描述符都能在不再需要时被关闭。

如果这类 bug 影响到了 daemon 的运行，唯一的解决方案通常是杀死并重启它。

#### **3. 确保只有一个实例运行 (Singleton Pattern)**

很多 daemon 需要确保在同一时刻只有一个实例处于活跃状态。例如，让两个 `cron` daemon 同时运行并试图执行相同的计划任务是毫无意义且可能有害的。

实现这一目标的技术（通常使用文件锁来创建一个“锁文件”或“PID 文件”）将在 **55.6 节**中详细介绍。