### **46.9 System V 消息队列的缺点**

在 UNIX 系统中，进程间的数据传输机制可分为两类：
* **无分隔符的字节流**: 管道、FIFO、UNIX domain 流 socket。
* **有分隔符的消息**: System V 消息队列、POSIX 消息队列、UNIX domain 数据报 socket。

System V 消息队列的一个与众不同的特性是它能够为每个消息加上一个数字**类型 (`mtype`)**。应用程序可以利用这个特性来实现消息的**选择性读取**或**优先级队列**。

尽管有此优点，但 System V 消息队列也存在几个显著的缺点，导致在现代应用程序中通常**不推荐使用**它。

---

#### **主要缺点**

1.  **使用标识符而非文件描述符**
    * 消息队列是通过**标识符 (identifier)** 引用的，而不是像大多数其他 UNIX I/O 机制那样使用**文件描述符 (file descriptor)**。
    * **后果**: 这意味着各种基于文件描述符的高级 I/O 技术（如 `select()`, `poll()` 以及 `epoll`）**无法**应用于消息队列上。这使得编写需要同时处理消息队列和其他 I/O（如网络套接字）的程序变得更加复杂。

2.  **使用键 (Key) 而非文件名**
    * 消息队列使用整数**键 (key)** 而不是文件名来标识，这增加了额外的程序设计复杂性（如需要处理 `ftok()` 或 `IPC_PRIVATE` 带来的问题）。
    * 同时也需要使用 `ipcs` 和 `ipcrm` 等专用命令来替代通用的 `ls` 和 `rm`。

3.  **无连接与生命周期管理困难**
    * 消息队列是**无连接**的，内核不会像对待管道或 socket 那样维护引用队列的进程数。
    * **后果**: 这导致了两个难以回答的问题：
        * **何时能安全删除队列？** 过早地删除队列会导致其他进程数据丢失。
        * **如何确保不再使用的队列一定会被删除？** 如果所有相关进程都退出了而没有一个进程负责删除队列，这个队列会一直作为“垃圾”残留在系统中，占用资源。

4.  **资源限制**
    * 消息队列的总数、单个消息的大小以及单个队列的总容量都受到内核参数的限制。
    * **后果**: 如果一个应用程序需要超出系统默认的限制，那么在部署和安装应用程序时就需要进行额外的、依赖于特定系统的配置工作。

---

#### **结论与替代方案**

总体上来讲，**最好在新项目中避免使用 System V 消息队列**。当需要使用根据类型选择消息的功能时，应考虑使用其他替代方案：

* **POSIX 消息队列 (第 52 章)**: 这是 System V 消息队列的一个现代化替代方案，它也支持消息优先级。
* **使用多个基于文件描述符的通道**: 例如，如果需要传输“普通”和“优先”两种消息，可以创建两组 FIFO 或 UNIX domain socket，然后使用 `select()` 或 `poll()` 来同时监控这两个通道上的文件描述符，从而实现类似的功能，同时又能与标准的 I/O 模型无缝集成。