### **46.5 消息队列的限制**

大多数 UNIX 实现会对 System V 消息队列的操作施加各种各样的限制，以防止系统资源被耗尽。下面将对 Linux 系统上的限制进行介绍。

#### **Linux 上的限制**

Linux 会对队列操作施加下列限制。括号中列出了达到限制时所影响到的系统调用以及产生的 `errno` 错误码。

  * **`MSGMNI`**:

      * **含义**: 系统级别的限制，规定了系统中最多能创建的消息队列**标识符**的数量（即消息队列的总数）。
      * **影响**: `msgget()`, `ENOSPC`

  * **`MSGMAX`**:

      * **含义**: 系统级别的限制，规定了**单条消息**中最多可写入的字节数（即 `mtext` 字段的最大长度）。
      * **影响**: `msgsnd()`, `EINVAL`

  * **`MSGMNB`**:

      * **含义**: **单个消息队列**中一次最多能保存的字节数总和。这个系统级参数用来初始化新创建队列的 `msqid_ds.msg_qbytes` 字段，该字段后续可由特权进程通过 `msgctl()` 修改。
      * **影响**: `msgsnd()`，阻塞或返回 `EAGAIN`

> **其他 UNIX 系统上的限制**:
> 一些其他 UNIX 实现还定义了 `MSGTQL`（系统中所有队列的消息总数上限）和 `MSGPOOL`（所有队列的数据缓冲池总大小上限），但 Linux 没有规定这些限制。

#### **查看和修改限制**

在 Linux 上，可以通过 `/proc` 文件系统中的文件来查看和修改这些限制。

**表 46-1：System V 消息队列限制**

| 限制       | 上限值 (x86-32)           | `/proc/sys/kernel/` 中的对应文件 |
| :------- | :--------------------- | :------------------------- |
| `MSGMNI` | 32768                  | `msgmni`                   |
| `MSGMAX` | (依赖于可用内存)              | `msgmax`                   |
| `MSGMNB` | 2147483647 (`INT_MAX`) | `msgmnb`                   |

**查看示例**:

```bash
# 查看系统上消息队列的最大数量
$ cat /proc/sys/kernel/msgmni
32000

# 查看单条消息的最大字节数
$ cat /proc/sys/kernel/msgmax
8192

# 查看单个队列的最大字节数
$ cat /proc/sys/kernel/msgmnb
16384
```

特权用户可以通过向这些 `/proc` 文件写入新值来动态地修改这些限制。

**编程接口**:
程序可以使用 Linux 特有的 `msgctl()` `IPC_INFO` 操作来获取一个 `msginfo` 结构体，其中包含了上述各种消息队列的限制值。