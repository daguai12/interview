### **59.8 域名系统（DNS）**

在介绍 `getaddrinfo()` 等函数之前，需要先解释 DNS 是如何维护主机名和 IP 地址之间的映射关系的。

#### **历史背景：`/etc/hosts`**

在 DNS 出现以前，主机名和 IP 地址之间的映射关系是在一个本地手工维护的 `/etc/hosts` 文件中进行定义的。该文件包含了形如下面的记录：

```
# IP-Address  Full-Qualified-Hostname  Aliases
198.51.100.3  www.kernel.org           linux-kernel
...
```

这种模式扩展性很差，随着网络中主机数量的爆炸式增长（如因特网），这种方式已经变得不可行。

#### **DNS 的核心思想**

DNS (Domain Name System) 被设计用来解决这个问题。其关键思想如下：

  * **层级命名空间**: 将主机名组织在一个树状的层级命名空间中。
  * **域名**: 一个节点的域名由该节点到根节点的路径中所有节点的名字连接而成，各名字之间用点 (`.`) 分隔。
  * **分布式管理**: 没有一个单一的组织或系统管理整个层级。相反，存在一个 DNS 服务器的层级，每台服务器只负责管理树的一个分支（一个**区域 (zone)**）。
  * **解析过程**: 当一个程序调用 `getaddrinfo()` 来解析一个域名时，它会使用一组库函数（解析器库）来与本地的 DNS 服务器通信。如果本地服务器无法提供所需信息，它就会与其他 DNS 服务器通信以获取信息。

**DNS 层级示意图 (对应原文图 59-2):**

```
                    . (Root)
                    |
      +-------------+-------------+
      |             |             |
     .com          .org          .nz
      |             |             |
   google         kernel        ac
      |             |             |
     www           www          otago
                                  |
                                 www
```

#### **递归和迭代的解析请求**

DNS 解析请求可以分为两类：

  * **递归请求 (Recursive Request)**: 请求者要求服务器处理**整个**解析任务。当本地主机上的一个应用程序调用 `getaddrinfo()` 时，该函数会向本地 DNS 服务器发起一个递归请求。
  * **迭代请求 (Iterative Request)**: 如果本地 DNS 服务器自己没有缓存相关信息，它就会**迭代地**解析这个域名。

**迭代解析示例** (解析 `www.otago.ac.nz`):

1.  本地 DNS 服务器向一个**根名字服务器**查询 `www.otago.ac.nz`。
2.  根服务器回复：“我不认识全名，但你可以去问 `.nz` 的服务器，这是它的地址。”
3.  本地 DNS 服务器向 `.nz` 服务器查询 `www.otago.ac.nz`。
4.  `.nz` 服务器回复：“你可以去问 `.ac.nz` 的服务器。”
5.  本地 DNS 服务器向 `.ac.nz` 服务器查询。
6.  `.ac.nz` 服务器回复：“你可以去问 `otago.ac.nz` 的服务器。”
7.  最后，本地 DNS 服务器向 `otago.ac.nz` 的权威服务器查询，并最终获取 `www.otago.ac.nz` 对应的 IP 地址。

#### **顶级域 (Top-Level Domains, TLD)**

紧跟在匿名根节点下面的节点被称为顶级域（TLD）。TLD 可以分为两类：

  * **通用 TLD (gTLD)**: 例如 `.com` (商业), `.org` (组织), `.net` (网络), `.edu` (教育), `.gov` (美国政府), `.mil` (美国军方)，以及近年来新增的 `.info`, `.name` 等。
  * **国家代码 TLD (ccTLD)**: 每个国家都有一个由 2 个字符组成的名字，例如 `.de` (德国), `.nz` (新西兰), `.us` (美国), `.cn` (中国)。