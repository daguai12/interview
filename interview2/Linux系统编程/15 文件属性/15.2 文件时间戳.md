### **15.2 文件时间戳**

`stat` 结构体中的 `st_atime`、`st_mtime` 和 `st_ctime` 字段包含了文件的时间戳，它们以自 1970 年 1 月 1 日（Epoch）以来所历经的秒数为单位进行记录。

  * **`st_atime` (access time)**: 文件的**上次访问时间**。
  * **`st_mtime` (modification time)**: 文件内容的**上次修改时间**。
  * **`st_ctime` (status change time)**: 文件状态（即 i-node 内信息，如权限、所有者）的**上次发生变更的时间**。

下表总结了各种系统调用及库函数对文件自身及其父目录的时间戳字段（a, m, c 分别代表 atime, mtime, ctime）的影响。

**表 15-2：各种函数对文件时间戳的影响**

| 函数                            | 文件或目录 |  父目录  |  注释   |       |       |       |                                       |
| :---------------------------- | :---: | :---: | :---: | :---- | ----- | ----- | ------------------------------------- |
|                               | **a** | **m** | **c** | **a** | **m** | **c** |                                       |
| `chmod()`                     |       |       |   •   |       |       |       | 与 `fchmod()` 相同                       |
| `chown()`                     |       |       |   •   |       |       |       | 与 `lchown()` 和 `fchown()` 相同          |
| `exec()`                      |   •   |       |       |       |       |       |                                       |
| `link()`                      |       |       |   •   |       | •     | •     | 影响第二个参数（新链接）的父目录                      |
| `mkdir()`                     |       |       |       |       | •     | •     |                                       |
| `mkfifo()`                    |       |       |       |       | •     | •     |                                       |
| `mknod()`                     |       |       |       |       | •     | •     |                                       |
| `mmap()`                      |   •   |       |       |       |       |       |                                       |
| `msync()`                     |       |   •   |   •   |       |       |       | 仅当对 `MAP_SHARED` 映射进行更新时              |
| `open()`, `creat()` (新建文件时)   |       |       |       |       | •     | •     |                                       |
| `open()`, `creat()` (截断现有文件时) |       |   •   |   •   |       |       |       |                                       |
| `pipe()`                      |   -   |   -   |   -   | -     | -     | -     | 不影响文件系统时间戳                            |
| `read()`                      |   •   |       |       |       |       |       | 与 `readv()`, `pread()` 相同             |
| `readdir()`                   |   •   |       |       |       |       |       | 仅当实际从磁盘读取目录时更新                        |
| `rename()`                    |       |       |   •   |       | •     | •     | 同时影响文件更名前后的父目录。SUSv3不强制要求改变文件`ctime`。 |
| `rmdir()`                     |       |       |       |       | •     | •     | 与 `remove(directory)` 相同              |
| `sendfile()`                  |   •   |       |       |       |       |       | 改变了输入文件（源文件）的 `atime`                 |
| `setxattr()`                  |       |       |   •   |       |       |       | 与 `fsetxattr()`, `lsetxattr()` 相同     |
| `symlink()`                   |       |       |       |       | •     | •     | 设置链接（而非目标文件）的时间戳                      |
| `truncate()`                  |       |   •   |   •   |       |       |       | 与 `ftruncate()` 相同                    |
| `unlink()`                    |       |       |   •   |       | •     | •     | 与 `remove(file)` 相同。会改变文件的 `ctime`。   |
| `utime()`                     |   •   |   •   |   •   |       |       |       | 与 `utimes()`, `futimes()` 等相同         |
| `write()`                     |       |   •   |   •   |       |       |       | 与 `writev()`, `pwrite()` 相同           |

> **关于 `atime`**: 为提升性能，可以通过 `mount` 选项（如 `noatime`, `relatime`）或 `open()` 的 `O_NOATIME` 标志来阻止或减少对文件上次访问时间的更新，因为这可以减少磁盘的写操作次数。

> **关于创建时间**: 大多数 UNIX 系统（包括 Linux）不会记录文件的创建时间。最新的 BSD 系统会使用名为 `st_birthtime` 的 `stat` 字段来记录这一时间。

#### **纳秒时间戳**

对于 `stat` 结构所含的 3 个时间戳字段，Linux 从 2.6 版本将其精度提升至**纳秒级**。这对于需要根据文件时间戳先后顺序来做决定的程序（比如 `make`）可以提高其精度。

  * **文件系统支持**: 并非所有文件系统都支持纳秒级精度的时间戳。JFS、XFS、ext4 以及 Btrfs 文件系统支持，但 ext2、ext3 以及 Reiserfs 文件系统则不支持。
  * **glibc API 支持**: 从 glibc 2.3 起，每个时间戳字段（如 `st_atim`）都被定义为 `timespec` 结构体，该结构体包含了秒和纳秒两个部分。
    ```c
    struct timespec {
        time_t tv_sec;  /* seconds */
        long   tv_nsec; /* nanoseconds */
    };
    ```
    为了向后兼容，传统的字段名（如 `st_atime`）被定义为访问秒级部分的宏。而要访问纳秒级部分，则需要使用 `st_atim.tv_nsec` 这样的形式。


#### **15.2.1 使用 utime()和 utimes()来改变文件时间戳**

使用 `utime()` 或与之相关的系统调用，可显式改变存储于文件 i-node 中的文件**上次访问时间戳（atime）和上次修改时间戳（mtime）**。`tar` 和 `unzip` 之类的程序会使用这些系统调用去重置解压后文件的原始时间戳。

**`utime()`**

```c
#include <utime.h>

int utime(const char *pathname, const struct utimbuf *buf);
```

  * **`pathname`**: 标识欲修改时间戳的文件。若该参数为符号链接，则会被解引用（跟随链接）。
  * **`buf`**: 可以是 `NULL`，也可以是指向 `utimbuf` 结构的指针。
    ```c
    struct utimbuf {
        time_t actime;   /* access time */
        time_t modtime;  /* modification time */
    };
    ```

`utime()` 的运作方式根据 `buf` 参数的不同分为两种情况：

1.  **`buf` 为 `NULL`**: 将文件的 `atime` 和 `mtime` **同时设置为当前时间**。此时，调用进程需要拥有文件，并且对文件有写权限。
2.  **`buf` 不为 `NULL`**: 将文件的 `atime` 和 `mtime` 设置为 `utimbuf` 结构中指定的值。此时，调用进程**必须是文件的所有者**或拥有特权（仅有写权限是不够的）。

> 注意：只要 `utime()` 调用成功，总会将文件的**上次状态更改时间 (`ctime`)** 置为当前时间。

要仅更改两个时间戳中的一个，需要先用 `stat()` 获取两个时间戳的当前值，然后修改其中一个再调用 `utime()`。例如，将文件的修改时间设置为与访问时间相同：

```c
struct stat sb;
struct utimbuf utb;

stat(pathname, &sb);
utb.actime = sb.st_atime;
utb.modtime = sb.st_atime; // 设置 modtime 等于 atime
utime(pathname, &utb);
```

**`utimes()`, `futimes()`, `lutimes()`**

这些是 `utime()` 的变体：

  * **`utimes()`**: 功能与 `utime()` 类似，但它使用 `struct timeval` 数组来指定时间，从而可以达到**微秒级**精度。
  * **`futimes()`**: 与 `utimes()` 类似，但它通过一个已打开的**文件描述符 `fd`** 而不是路径名来指定文件。
  * **`lutimes()`**: 与 `utimes()` 类似，但如果 `pathname` 是一个符号链接，它**不会**解引用，而是更改链接**自身**的时间戳。

#### **15.2.2 使用 utimensat()和 futimens()改变文件时间戳**

`utimensat()` 系统调用和 `futimens()` 库函数是更新文件时间戳的现代化接口，它们提供了比旧接口更强大的功能：

  * **纳秒级精度**: 可以按纳秒级精度设置时间戳。
  * **独立设置**: 可独立设置某一个时间戳而保持另一个不变，避免了 `stat()` + `utime()` 的竞态条件。
  * **独立设为当前时间**: 可独立将任一时间戳置为当前时间。

**`utimensat()`**

```c
#include <fcntl.h> /* Definition of AT_* constants */
#include <sys/stat.h>

int utimensat(int dirfd, const char *pathname,
              const struct timespec times[2], int flags);
```

`times` 参数是一个包含两个 `timespec` 结构的数组（`times[0]` 对应 `atime`，`times[1]` 对应 `mtime`）。

```c
struct timespec {
    time_t tv_sec;        /* seconds */
    long   tv_nsec;       /* nanoseconds */
};
```

该接口最强大的功能在于 `tv_nsec` 字段可以使用两个特殊值：

  * **`UTIME_NOW`**: 将对应的时间戳（`atime` 或 `mtime`）**设置为当前时间**。
  * **`UTIME_OMIT`**: 使对应的时间戳**保持不变**。

`flags` 参数可以设置为 `AT_SYMLINK_NOFOLLOW`，使其在 `pathname` 是符号链接时，不进行解引用。

以下代码片段演示了如何将文件的上次访问时间置为当前时间，同时保持上次修改时间不变：

```c
struct timespec times[2];

// 访问时间：不关心秒，只设置 nsec 为 UTIME_NOW
times[0].tv_sec = 0;
times[0].tv_nsec = UTIME_NOW;

// 修改时间：不关心秒，只设置 nsec 为 UTIME_OMIT
times[1].tv_sec = 0;
times[1].tv_nsec = UTIME_OMIT;

utimensat(AT_FDCWD, pathname, times, 0);
```

**`futimens()`**

```c
#include <sys/stat.h>

int futimens(int fd, const struct timespec times[2]);
```

`futimens()` 库函数的功能与 `utimensat()` 相同，但它通过一个已打开的**文件描述符 `fd`** 来指定文件。