### **15.5 i-node 标志（ext2 扩展文件属性）**

某些 Linux 文件系统允许为文件和目录设置各种各样的 **i-node flags (i-node 标志)**。该特性是一种非标准的 Linux 扩展功能，有时也称其为 **ext2 扩展文件属性**。

  * **支持的文件系统**: `ext2` 是首个支持 i-node 标志的 Linux 文件系统。随后，其他文件系统，如 `Btrfs`、`ext3`、`ext4`、`Reiserfs`、`XFS` 以及 `JFS`，也纷纷加入支持。
  * **使用方法**:
      * 在 shell 中，可通过 `lsattr` 命令查看 i-node 标志，通过 `chattr` 命令来设置。
        ```bash
        $ touch a
        $ lsattr a
        ---------------- a
        $ sudo chattr +i a    # 设置 'i' (不可修改) 标志
        $ lsattr a
        ----i----------- a
        ```
      * 在程序中，可利用 `ioctl()` 系统调用来获取并修改 i-node 标志。

下表总结了所支持的 i-node 标志，展示了 `ioctl()` 使用的常量名称和 `chattr` 命令使用的选项字母。

**表 15-6：i-node 标志**
| 常量 | `chattr` 选项 | 用途 |
| :--- | :--- | :--- |
|`FS_APPEND_FL`| `a` | 仅能在尾部追加（需要特权）|
|`FS_COMPR_FL`| `c` | 启用文件压缩（未实现）|
|`FS_DIRSYNC_FL`| `D` | 目录更新同步（自 Linux 2.6 起）|
|`FS_IMMUTABLE_FL`| `i` | 不可变更（需要特权）|
|`FS_JOURNAL_DATA_FL`| `j` | 针对数据启用日志功能（需要特权）|
|`FS_NOATIME_FL`| `A` | 不更新文件的上次访问时间|
|`FS_NODUMP_FL`| `d` | 不转储 (dump)|
|`FS_NOTAIL_FL`| `t` | 禁用尾部打包 (tail-packing)|
|`FS_SECRM_FL`| `s` | 安全删除（未实现）|
|`FS_SYNC_FL`| `S` | 文件（和目录）同步更新|
|`FS_TOPDIR_FL`| `T` | 以 Orlov 策略来处理顶层目录（自 Linux 2.6 起）|
|`FS_UNRM_FL`| `u` | 可恢复已删除的文件（未实现）|

#### **标志详解**

  * **`FS_APPEND_FL` (`a`)**: 文件只能以追加模式写入。可用于日志文件。只有特权级进程（`CAP_LINUX_IMMUTABLE`）可设置。
  * **`FS_IMMUTABLE_FL` (`i`)**: 文件不可更改。既不能更新数据（`write`, `truncate`），也不能改变元数据（`chmod`, `chown`, `unlink`, `rename` 等）。只有特权级进程（`CAP_LINUX_IMMUTABLE`）可设置，一旦设定，即便是特权进程也无法修改文件。
  * **`FS_JOURNAL_DATA_FL` (`j`)**: 对文件数据启用日志功能。仅 `ext3` 和 `ext4` 支持。
  * **`FS_NOATIME_FL` (`A`)**: 访问文件时不更新其上次访问时间 (`atime`)，可提升 I/O 性能。
  * **`FS_NODUMP_FL` (`d`)**: 在使用 `dump(8)` 备份系统时跳过具有此标志的文件。
  * **`FS_DIRSYNC_FL` (`D`)**: 使得对目录的更新（如创建、删除文件）同步发生。
  * **`FS_SYNC_FL` (`S`)**: 令对文件的更新保持同步，效果如同总是以 `O_SYNC` 标志打开文件一样。
  * **`FS_NOTAIL_FL` (`t`)**: 禁用尾部打包。仅 Reiserfs 文件系统支持。
  * **`FS_TOPDIR_FL` (`T`)**: 标志着目录将采用 Orlov 块分配策略，以期将相关文件在磁盘上彼此靠近存储，缩短寻道时间。仅 `ext2`/`ext3`/`ext4` 支持。
  * **未实现的标志**: `FS_COMPR_FL` (压缩)、`FS_SECRM_FL` (安全删除)、`FS_UNRM_FL` (可恢复删除) 目前在主流内核中并未实现。

#### **继承规则**

一般而言，如果针对某一目录设置了 i-node 标志，那么新建于其下的文件和子目录会自动**继承**这些标志。但有两个例外：

1.  `FS_DIRSYNC_FL` (`D`): 只能应用于目录，因此也只能被新建的**子目录**继承。
2.  `FS_IMMUTABLE_FL` (`i`): **不会被任何**新建的文件或子目录继承，因为该标志会阻止在目录中创建任何新条目。

#### **在程序中访问标志**

在程序中可以分别调用 `ioctl()` 的 `FS_IOC_GETFLAGS` 和 `FS_IOC_SETFLAGS` 操作来获取和修改 i-node 标志。

以下代码演示了如何为文件设置 `FS_NOATIME_FL` 标志：

```c
#include <sys/ioctl.h>
#include <linux/fs.h>

int flags;

// 获取当前标志
ioctl(fd, FS_IOC_GETFLAGS, &flags);

// 添加 NOATIME 标志
flags |= FS_NOATIME_FL;

// 设置新标志
ioctl(fd, FS_IOC_SETFLAGS, &flags);
```

要改变文件的 i-node 标志，进程的有效用户 ID 需匹配文件的用户 ID（属主），或者进程享有特权（`CAP_FOWNER`）。