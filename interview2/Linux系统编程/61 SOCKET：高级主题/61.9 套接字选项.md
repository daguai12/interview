
### **61.9 套接字选项**

套接字选项能影响到套接字操作的多个功能特性。系统调用 `setsockopt()` 和 `getsockopt()` 分别是用来设定和获取套接字选项的。

#### **`setsockopt()` 和 `getsockopt()`**

```c
#include <sys/socket.h>

int getsockopt(int sockfd, int level, int optname,
               void *optval, socklen_t *optlen);

int setsockopt(int sockfd, int level, int optname,
               const void *optval, socklen_t optlen);
```

**参数详解**:

  * **`sockfd`**: 指向套接字的文件描述符。
  * **`level`**: 指定套接字选项所适用的协议层。对于本书中描述的大多数套接字选项，`level` 都会设为 **`SOL_SOCKET`**，这表示选项作用于通用的套接字 API 层。
  * **`optname`**: 标识具体的套接字选项名称（例如 `SO_TYPE`, `SO_REUSEADDR`）。
  * **`optval`**: 一个指向缓冲区的指针。
      * 在 `setsockopt()` 中，该缓冲区包含**待设置**的选项值。
      * 在 `getsockopt()` 中，该缓冲区用于**返回**获取到的选项值。
  * **`optlen`**: `optval` 缓冲区的大小（字节数）。
      * 对于 `setsockopt()`，这是一个**值参数**。
      * 对于 `getsockopt()`，这是一个**值-结果 (value-result)** 参数。调用前，需要将其初始化为缓冲区的大小；调用返回后，它会被内核修改为实际写入到缓冲区中的字节数。

**继承与共享**:

  * **继承**: 由 `accept()` 返回的新套接字文件描述符，会从监听套接字中**继承**可设定的套接字选项值。
  * **共享**: 套接字选项与**打开的文件描述 (open file description)** 相关联。这意味着通过 `dup()` 或 `fork()` 调用复制而来的文件描述符副本，与原始的文件描述符**共享**同一套套接字选项。

-----

#### **一个简单的例子：`SO_TYPE`**

`SO_TYPE` 是一个只读的套接字选项，可以用来获取套接字的类型（例如 `SOCK_STREAM` 或 `SOCK_DGRAM`）。

当一个程序通过 `exec()` 继承了一个套接字文件描述符（例如，由 `inetd` 调用的程序）而不知道其类型时，这个选项就非常有用。

**用法示例**:

```c
int type;
socklen_t len;

len = sizeof(type);
if (getsockopt(sockfd, SOL_SOCKET, SO_TYPE, &type, &len) == -1) {
    perror("getsockopt");
    // handle error
}

// 此时，变量 'type' 就包含了套接字类型，
// 例如 SOCK_STREAM 或 SOCK_DGRAM
```

由于 `SO_TYPE` 是只读的，因此不能用 `setsockopt()` 来修改一个已存在套接字的类型。