### **61.12 TCP vs. UDP**

鉴于 TCP 可提供可靠的数据传输而 UDP 无法保证这一点，一个很自然的问题是：“那为何还要用 UDP 呢？” 答案是，在特定场景下，UDP 具备 TCP 所没有的优势。

以下是一些选择使用 UDP 而不是 TCP 的原因：

**1. 更低的连接开销**
* 一个 UDP 服务器可以在**单个 socket** 上接收来自多个客户端的数据报，并向它们发送回复。
* 它不必为每个客户端创建和终止一个单独的连接。因此，使用 UDP 传送单条消息的**开销比 TCP 要小**。

**2. 对于简单的请求-响应式通信速度更快**
* UDP 不需要建立连接（没有三次握手）和终止连接（没有四次挥手）的过程。
* 在最好的情况下，一次请求-响应通信所需的时间：
    * **TCP**: `2 * RTT + SPT` (一次 RTT 用于连接建立，一次 RTT 用于请求响应 + 服务器处理时间)
    * **UDP**: `1 * RTT + SPT` (直接发送请求并接收响应 + 服务器处理时间)
* UDP **节省了一个完整的网络往返时间 (RTT)**。在长距离或高延迟的网络中（例如跨洲际通信），这个时间差可能达到数百毫秒，这使得 UDP 对 DNS (域名解析) 等需要快速响应的应用极具吸引力。

**3. 支持广播和组播**
* UDP 套接字可以进行**广播**（将数据报发送到网络中的所有主机）和**组播**（将数据报发送到指定的一组主机上）。
* 而 TCP 是面向连接的、点对点的协议，不支持这些功能。

**4. 适用于可容忍丢包的实时应用**
* 某些特定类型的应用（例如，**视频流和音频流**）不需要 TCP 提供的完全可靠性。
* 对这些应用来说，因 TCP 尝试重传丢失数据包而造成的**延时，可能比简单地丢失几个数据包更糟糕**（例如，视频长时间卡顿比画面出现短暂花屏更影响体验）。
* 因此，这类应用更倾向于使用 UDP，并在应用程序层面采用特定的恢复策略来应对偶尔的丢包现象。

---
#### **在 UDP 之上实现可靠性**

如果一个应用程序选择使用 UDP 但又需要可靠性保证，那么它**必须自行实现**可靠性保障功能。这通常至少需要：
* 序列号 (Sequence numbers)
* 确认机制 (Acknowledgments)
* 丢包重传 (Retransmission of lost packets)
* 重复报文检测 (Duplicate packet detection)

然而，如果还需要流量控制和拥塞控制等更高级的功能，那么最好还是直接使用 TCP。在 UDP 之上完整地重新实现 TCP 的所有功能是非常复杂的，并且其性能很可能达不到内核中经过高度优化的 TCP 实现。