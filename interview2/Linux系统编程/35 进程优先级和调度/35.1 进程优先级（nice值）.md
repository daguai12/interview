### **35.1 进程优先级（nice 值）**

Linux 调度进程使用 CPU 的默认模型是**循环时间共享 (round-robin time-sharing)**。在这种模型中，每个进程轮流使用 CPU 一小段时间，这段时间被称为**时间片 (time slice)**。

进程的 **`nice` 值**允许进程间接地影响内核的调度算法。

  * **范围**: 每个进程都有一个 `nice` 值，其取值范围为 **-20 (最高优先级)** 到 **+19 (最低优先级)**。
  * **默认值**: 新进程的默认 `nice` 值为 0。
  * **名称由来**: 非特权进程只能降低自己的优先级（即设置一个大于 0 的 `nice` 值），这样做相当于对其他进程“友好 (nice)”，该特性也由此得名。
  * **继承**: `nice` 值在 `fork()` 创建子进程时被继承，并在 `exec()` 调用中得到保持。

#### **nice 值的影响**

`nice` 值是一个**权重因素**，它使内核调度器倾向于调度拥有更高优先级的进程，但并不会导致低优先级的进程完全无法用到 CPU。从 Linux 内核 2.6.23 开始，`nice` 值之间的调度权重差异被拉大，这意味着高优先级的进程会比在旧内核中获得明显更多的 CPU 时间。

#### **获取和修改优先级**

`getpriority()` 和 `setpriority()` 系统调用允许一个进程获取和修改自身或其他进程的 `nice` 值。

```c
#include <sys/resource.h>

int getpriority(int which, id_t who);
int setpriority(int which, id_t who, int prio);
```

`which` 和 `who` 参数共同用于标识目标进程：

  * **`PRIO_PROCESS`**: 操作单个进程。`who` 是一个 PID。如果 `who` 为 0，则表示调用进程自身。
  * **`PRIO_PGRP`**: 操作一个进程组中的所有成员。`who` 是一个 PGID。如果 `who` 为 0，则表示调用进程的进程组。
  * **`PRIO_USER`**: 操作一个真实用户 ID 所拥有的所有进程。`who` 是一个 UID。如果 `who` 为 0，则表示调用进程的真实 UID。

##### **`getpriority()`**

  * 返回指定进程中**优先级最高**（即 `nice` 数值最小）的那个值。
  * **错误处理**: 由于 `getpriority()` 可以在成功时返回 `-1`（一个有效的 `nice` 值），因此必须通过以下方式来可靠地检查错误：
    ```c
    errno = 0; // 调用前清零 errno
    prio = getpriority(which, who);
    if (prio == -1 && errno != 0) {
        // 发生了错误
        perror("getpriority");
    }
    ```

##### **`setpriority()`**

  * 将指定进程的 `nice` 值设置为 `prio`。
  * `prio` 的有效范围是 -20 到 +19。超出范围的值会被自动设置为最接近的边界值。

#### **权限**

  * **特权进程 (`CAP_SYS_NICE`)**: 能够修改任意进程的优先级。
  * **非特权进程 (Linux 2.6.12 及之后版本)**:
      * **降低优先级**: 可以将自己或其他进程的 `nice` 值设置为一个**更高**（更不友好）的数值。
      * **提升优先级**: 能够**提升**自己或其他进程的优先级（即将 `nice` 值设置为一个更低的数值），但这受限于 **`RLIMIT_NICE`** 资源限制。
      * 一个非特权进程能设置的 `nice` 值下限为 `20 - rlim_cur`，其中 `rlim_cur` 是 `RLIMIT_NICE` 的当前软限制。例如，如果一个进程的 `RLIMIT_NICE` 软限制是 25，那么它就可以将自己的 `nice` 值最高提升到 `20 - 25 = -5`。

-----

#### **程序示例**

程序清单 35-1 使用 `setpriority()` 来修改进程的 `nice` 值，接着调用 `getpriority()` 来验证变更是否生效。

**程序清单 35-1：修改和获取进程的 nice 值**

```c
#include <sys/resource.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

int main(int argc, char *argv[]) {
    int which, who, prio;
    
    if (argc != 4 || strchr("pgu", argv[1][0]) == NULL) {
        fprintf(stderr, "Usage: %s {p|g|u} who prio\n", argv[0]);
        fprintf(stderr, "    'p' means process ID, 'g' means process group ID, "
                        "'u' means user ID\n");
        exit(EXIT_FAILURE);
    }

    // 解析命令行参数
    which = (argv[1][0] == 'p') ? PRIO_PROCESS :
            (argv[1][0] == 'g') ? PRIO_PGRP : PRIO_USER;
    who = atoi(argv[2]);
    prio = atoi(argv[3]);

    // 设置优先级
    if (setpriority(which, who, prio) == -1) {
        perror("setpriority");
        exit(EXIT_FAILURE);
    }
    
    // 获取并验证新的优先级
    errno = 0; // 必须在调用前清零
    prio = getpriority(which, who);
    if (prio == -1 && errno != 0) {
        perror("getpriority");
        exit(EXIT_FAILURE);
    }

    printf("Nice value of process(es) is %d\n", prio);

    exit(EXIT_SUCCESS);
}
```

**编译和运行演示**

1.  **编译程序**: `gcc nice_demo.c -o nice_demo`
2.  **运行一个后台任务**: `sleep 60 &`
3.  **作为普通用户降低其优先级**:
    ```bash
    $ sleep 60 &
    [1] 12345
    $ ./nice_demo p 12345 10
    Nice value of process(es) is 10
    ```
4.  **作为普通用户尝试提升其优先级 (将会失败)**:
    ```bash
    $ ./nice_demo p 12345 5
    setpriority: Permission denied
    ```
5.  **作为超级用户提升其优先级**:
    ```bash
    $ sudo ./nice_demo p 12345 -10
    Nice value of process(es) is -10
    ```