好的，这是根据您提供的文本内容，保留原始结构和标题整理的结果。

### **18.1 目录和（硬）链接**

在文件系统中，目录的存储方式类似于普通文件，但有两点区别：

1.  在其 i-node 条目中，目录被标记为一种不同的文件类型。
2.  目录是一种经特殊组织的文件，其内容本质上是一个表格，包含了**文件名**和 **i-node 编号**的对应关系。

#### **目录操作的限制**

  * 进程**不能**使用 `read()` 直接读取目录的内容，必须使用专门的系统调用和库函数（如 `readdir()`）。
  * 进程也**不能**使用 `write()` 直接改变目录的内容。目录的修改只能通过内核间接完成，即调用 `open()` (创建文件)、`link()` (创建链接)、`mkdir()` (创建目录)、`unlink()` (删除链接) 等系统调用。

#### **i-node 和目录结构的关系**

i-node 表中并不包含文件名，文件名仅作为目录内容中的一个条目，映射到一个 i-node 编号上。文件系统的根目录 (`/`) 总是存储在 i-node 2 中，内核解析路径名时便从此处着手。

**概念示意图 (以 `/etc/passwd` 为例):**

```
1. 路径名: /etc/passwd

2. 内核从 i-node 2 (根目录 '/') 开始查找
   -> 在 '/' 目录的数据中找到条目 "etc" -> 指向 i-node 6134

3. 内核读取 i-node 6134 (目录 '/etc')
   -> 在 '/etc' 目录的数据中找到条目 "passwd" -> 指向 i-node 8012

4. 内核读取 i-node 8012 (文件 '/etc/passwd')
   -> 在 i-node 8012 中找到指向文件数据块的指针，从而访问文件内容
```

#### **硬链接 (Hard Links)**

这种文件名与 i-node 分离的设计，使得我们可以在相同或不同目录中创建多个名称，让它们都指向同一个 i-node。这些名称被称为**链接**，或**硬链接**。

所有原生 Linux 和 UNIX 文件系统均支持硬链接，但许多非 UNIX 文件系统（如 VFAT）则不支持。

可在 shell 中利用 `ln` 命令为一个已存在的文件创建新的硬链接。

**演示:**

```bash
# 1. 创建一个文件
$ echo "hello world" > abc
$ ls -li abc
131583 -rw-r--r-- 1 mtk users 12 Sep 11 09:21 abc
# i-node 号是 131583，链接数是 1

# 2. 为 abc 创建一个名为 xyz 的硬链接
$ ln abc xyz

# 3. 检查两个文件，它们有相同的 i-node 号和链接数 (变为 2)
$ ls -li abc xyz
131583 -rw-r--r-- 2 mtk users 12 Sep 11 09:21 abc
131583 -rw-r--r-- 2 mtk users 12 Sep 11 09:21 xyz

# 4. 移除其中一个名字
$ rm abc

# 5. 检查另一个名字，文件依然存在，链接数降为 1
$ ls -li xyz
131583 -rw-r--r-- 1 mtk users 12 Sep 11 09:21 xyz
$ cat xyz
hello world
```

  * **链接计数**: i-node 中有一个字段记录了指向它的硬链接数量。
  * **文件删除**: `rm` 命令实际上是“移除链接”。它从目录中删除一个文件名，并将对应 i-node 的链接计数减一。**仅当 i-node 的链接计数降为 0 时**，内核才会真正删除文件的 i-node 和其占用的数据块。
  * **地位平等**: 同一个文件的所有硬链接地位都是平等的，没有主次之分。

> **从文件描述符到文件名**: 正因为一个文件（i-node）可以有多个名字（链接），甚至可以没有名字（当所有链接被删除但文件仍被进程打开时），所以不存在一个简单、可移植的方法来从一个文件描述符反向查找到其文件名。

#### **硬链接的限制**

对硬链接的限制有二，均可用下一节的符号链接来加以规避：

1.  硬链接**必须**与其指向的文件驻留在**同一个文件系统**中（因为 i-node 编号的唯一性仅在单个文件系统内有效）。
2.  **不能为目录创建硬链接**（由非特权用户），这是为了避免在文件系统中产生循环，从而使 `find` 等程序陷入无限递归。
    > **现代替代方案**: 使用**绑定挂载 (bind mount)** 可以获得与为目录创建硬链接相似的效果。