### **18.11 针对目录文件描述符的相关操作**

始于内核版本 2.6.16，Linux 提供了一系列以 `at` 结尾的新系统调用（如 `openat()`, `fstatat()` 等）。这些调用在执行与传统系统调用相似任务的同时，还提供了一些附加功能，其核心是改变了对相对路径名的解析方式。

下表对这些调用进行了归纳。

**表 18-2：使用目录文件描述符来解释相对路径的系统调用**

| 新接口            | 类似的传统接口      | 备注                                         |
| :------------- | :----------- | :----------------------------------------- |
| `faccessat()`  | `access()`   | 支持 `AT_EACCESS` 和 `AT_SYMLINK_NOFOLLOW` 标志 |
| `fchmodat()`   | `chmod()`    |                                            |
| `fchownat()`   | `chown()`    | 支持 `AT_SYMLINK_NOFOLLOW` 标志                |
| `fstatat()`    | `stat()`     | 支持 `AT_SYMLINK_NOFOLLOW` 标志                |
| `linkat()`     | `link()`     | 支持 `AT_SYMLINK_FOLLOW` 标志                  |
| `mkdirat()`    | `mkdir()`    |                                            |
| `openat()`     | `open()`     |                                            |
| `readlinkat()` | `readlink()` |                                            |
| `renameat()`   | `rename()`   |                                            |
| `symlinkat()`  | `symlink()`  |                                            |
| `unlinkat()`   | `unlink()`   | 支持 `AT_REMOVEDIR` 标志                       |
| `utimensat()`  | `utimes()`   | 支持 `AT_SYMLINK_NOFOLLOW` 标志                |

#### **工作原理 (以 openat() 为例)**

`openat()` 系统调用类似于传统的 `open()`，只是增加了一个 `dirfd` 参数。

```c
#include <fcntl.h>

int openat(int dirfd, const char *pathname, int flags, ...);
```

`dirfd` 参数的作用如下：

1.  如果 `pathname` 是一个**相对路径**，那么它将以 `dirfd` 这个文件描述符所指向的目录作为**参照点**进行解析，而**不是**进程的当前工作目录。
2.  如果 `pathname` 是一个**相对路径**，且 `dirfd` 为特殊值 `AT_FDCWD`，那么 `pathname` 将相对于进程的**当前工作目录**进行解析（此时行为与传统的 `open()` 完全一致）。
3.  如果 `pathname` 是一个**绝对路径**，那么 `dirfd` 参数将被**忽略**。

此外，许多 `*at()` 系列调用还增加了一个 `flags` 参数，用于修改调用语义。其中最常见的标志是 `AT_SYMLINK_NOFOLLOW`，其含义是如果 `pathname` 的最后一部分是符号链接，那么系统调用将操作于**符号链接本身**，而非其指向的文件。

#### **引入 `at()` 系列调用的原因**

支持 `*at()` 系列系统调用主要有两个原因：

1.  **避免竞态条件 (Race Conditions)**: 传统上，程序可能会先检查路径的某个部分，然后再打开它。在这两个操作之间，路径的组成部分可能会被恶意改变。通过先安全地打开一个指向目录的文件描述符 `dirfd`，然后再使用 `openat()` 和一个相对路径来操作该目录内的文件，可以避免这类竞态条件。

2.  **实现每线程的“虚拟”当前工作目录**: 当前工作目录是**进程级**的属性，被进程中的所有线程共享。对于多线程应用程序，如果希望每个线程能独立地在不同目录下工作，就可以让每个线程维护一个自己的目录文件描述符，并使用 `*at()` 系列调用来执行所有相对于该描述符的操作，从而模拟出“每线程一个当前工作目录”的功能。

**标准化与可用性**:
这些系统调用未在 SUSv3 中规范，但 SUSv4 将其包括在内。为了在程序中获得这些函数的声明，必须在包含相应头文件之前定义特性测试宏（例如 `_XOPEN_SOURCE` 为 700 或更高）。