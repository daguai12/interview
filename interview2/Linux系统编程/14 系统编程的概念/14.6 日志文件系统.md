### **14.6 日志文件系统**

`ext2` 文件系统是传统 UNIX 文件系统的优秀典范，但它有一个显著的短板：系统崩溃之后，为确保文件系统的完整性，重启时必须对文件系统进行一次完整的一致性检查（使用 `fsck` 程序）。

**问题所在**:
* 系统崩溃时，对文件的更新可能只完成了一部分，导致文件系统元数据（目录项、i-node 信息、数据块指针等）处于不一致状态。
* 为修复这种不一致状态，`fsck` 需要遍历整个文件系统。在大型文件系统上，这个过程可能会持续数小时，这对于需要保持高可用性的系统（如网络服务器）来说是无法接受的。

#### **日志文件系统的工作原理**

采用**日志文件系统 (journaling filesystem)**，则无需在系统崩溃后进行漫长的一致性检查。
* **日志 (Journal)**: 在实际更新磁盘上的元数据之前，日志文件系统会将这些更新操作以**事务 (transaction)** 的方式，预先记录于一个专用的磁盘日志文件中。
* **崩溃恢复**: 在事务处理过程中，一旦系统崩溃，系统重启时只需读取日志文件，即可重做（redo）任何不完整的更新，从而快速为文件系统恢复到一致性状态。
* **优点**: 即使是超大型的日志文件系统，崩溃恢复过程通常也只在几秒钟内就能完成，因而对于有高可用性需求的系统极具吸引力。
* **缺点**: 日志文件系统会增加文件更新的时间开销，因为需要额外执行一次对日志文件的写入操作。

> **元数据 vs 数据日志**: 某些日志文件系统只会记录文件**元数据**的更新，这能保证文件系统的结构完整，但如果系统崩溃，仍可能会造成文件**数据**的丢失。像 `ext3`、`ext4` 和 `Reiserfs` 等文件系统提供了记录数据更新的选项，但这会进一步降低文件 I/O 的性能。

#### **Linux 支持的日志文件系统**

以下列出了 Linux 所支持的主要日志文件系统：

* **Reiserfs**: 首个被集成进 Linux 内核（版本 2.4.1）的日志文件系统。其显著特性是 "tail packing"，可以将小文件（或大文件的尾部）与元数据打包存储在同一个磁盘块中，从而节省磁盘空间。
* **ext3**: 在 `ext2` 的基础上增加了日志功能。其最大优点是从 `ext2` 升级到 `ext3` 非常简单（无需备份和恢复数据），并且支持反向降级。
* **JFS**: 由 IBM 开发，被集成于内核版本 2.4.20。
* **XFS**: 最初由 SGI 为其 Irix 操作系统开发，后被移植到 Linux。它是一个高性能的 64 位文件系统，被集成于内核版本 2.4.24。

#### **新一代文件系统**

除了上述文件系统，还有两种提供了日志功能并支持多种其他高级特性的文件系统：

* **ext4**: `ext3` 文件系统的“接班人”。其特性包括 `extents`（用于减少文件碎片化的连续块分配方式）、在线磁盘碎片整理、更快捷的文件系统检查以及纳秒级时间戳支持。
* **Btrfs** (B-tree FS): 一种自下而上进行设计的新型文件系统，意在提供一系列现代化特性，其中包括 `extents`、可写快照、数据和元数据的校验和、在线文件系统检查和碎片整理、高效的小文件打包存放等。