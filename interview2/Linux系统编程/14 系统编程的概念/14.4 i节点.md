### **14.4 i 节点**

针对驻留于文件系统上的每个文件（或目录），文件系统的 i-node 表会包含一个 **i-node**（索引节点的简称）。i-node 是通过它在 i-node 表中的序号来标识的，这个数字就是**i-node 号 (i-number)**。我们使用 `ls -li` 命令时，显示的第一列就是文件的 i-node 号。

一个 i-node 维护了关于文件的所有元数据信息，如下所示：

* **文件类型**: 例如，是常规文件、目录、符号链接，还是字符/块设备等。
* **文件属主 (UID)** 和 **文件属组 (GID)**。
* **访问权限**: 针对属主（user）、属组（group）以及其他用户（others）的读、写、执行权限。
* **3个时间戳**:
    * **最后访问时间 (`atime`)**: `ls -lu` 显示的时间。
    * **最后修改时间 (`mtime`)**: 文件内容最后一次被修改的时间，`ls -l` 默认显示的时间。
    * **最后状态改变时间 (`ctime`)**: i-node 信息（如权限、属主）最后一次改变的时间，`ls -lc` 显示的时间。
    * （注意：大多数 Linux 文件系统不会记录文件的创建时间。）
* **硬链接数量**: 指向此 i-node 的硬链接总数。
* **文件大小**: 以字节为单位。
* **分配的块数量**: 实际分配给文件的块数量（通常以 512 字节块为单位）。对于包含“空洞”（hole）的稀疏文件，这个值可能远小于根据文件字节大小计算出的块数。
* **指向文件数据块的指针**。

#### **ext2 中的 i 节点和数据块指针**

类似于大多数 UNIX 文件系统，`ext2` 在存储文件时，其数据块不一定连续存放。为了能定位到所有的数据块，内核在 i-node 内维护有一组指针。

在 `ext2` 中，每个 i-node 包含 15 个指针，其结构如下，旨在高效地服务于从小文件到巨型文件的各种需求：

1.  **12 个直接指针 (Direct Pointers)**
    * i-node 中的前 12 个指针**直接**指向文件的前 12 个数据块。对于绝大多数小文件（例如，在 4KB 块大小的文件系统中，可覆盖 12 * 4KB = 48KB），只需一次 I/O 读取 i-node 即可获得所有数据块的位置，访问速度非常快。

2.  **1 个单间接指针 (Single Indirect Pointer)**
    * 第 13 个指针指向一个“指针块”（间接块）。这个块里面不包含文件数据，而是**装满了指向文件数据块的指针**。例如，在一个 4KB 块大小的文件系统中，一个间接块可以存放 1024 个指针，从而可以多引用 1024 * 4KB = 4MB 的数据。

3.  **1 个双间接指针 (Double Indirect Pointer)**
    * 第 14 个指针指向一个二级指针块。这个块里的每个指针又指向一个一级指针块（类似上面的单间接块），最终再指向数据块。这极大地扩展了文件的大小范围。

4.  **1 个三间接指针 (Triple Indirect Pointer)**
    * 第 15 个指针增加了一层间接关系，用于支持理论上高达 TB 级别的巨型文件。

**这种设计的优点:**
* **大小灵活**: 在保持 i-node 结构大小固定的同时，支持任意大小的文件。
* **小文件优先**: 对系统中占绝大多数的小文件访问效率极高。
* **支持“空洞”**: 对于稀疏文件中的“空洞”部分，文件系统只需在相应的指针位置存一个 0 值，表示没有分配数据块，而无需为这些空洞浪费任何磁盘空间。
* **空间利用率**: 允许文件块以不连续的方式存储，可以更有效地利用磁盘的零散空闲空间，降低了空闲空间的碎片化程度。

![[Pasted image 20250909154513.png]]