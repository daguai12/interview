### **14.3 文件系统**

文件系统是对常规文件和目录的组织集合。用于创建文件系统的命令是 `mkfs`。

Linux 的强项之一便是支持种类繁多的文件系统，如下所示：
* 传统的 `ext2` 文件系统。
* 各种原生 UNIX 文件系统，比如 Minix、System V 以及 BSD 文件系统。
* 微软的 FAT、FAT32 以及 NTFS 文件系统。
* ISO 9660 CD-ROM 文件系统。
* Apple Macintosh 的 HFS。
* 一系列网络文件系统，包括 NFS、SMB (CIFS) 等。
* 一系列**日志文件系统 (journaling filesystems)**，包括 `ext3`、`ext4`、Reiserfs、JFS、XFS 以及 Btrfs。

从 Linux 的专有文件 `/proc/filesystems` 中可以查看当前内核支持的文件系统类型。

> **FUSE (用户空间文件系统)**: 从 Linux 2.6.14 开始，FUSE 机制允许开发者在用户空间以普通程序的形式完整实现一个文件系统，而无需修改内核。

#### **ext2 文件系统**

多年来，`ext2`（第二代扩展文件系统）是 Linux 上使用最为广泛的文件系统。近来，随着各种日志文件系统的兴起，对 `ext2` 的使用已日趋减少。本章将以 `ext2` 为例来介绍通用文件系统的概念。

![[Pasted image 20250909153417.png]]
#### **文件系统结构**

在文件系统中，用来分配空间的基本单位是**逻辑块 (logical block)**，它由磁盘设备上若干个连续的**物理块**组成。例如，在 `ext2` 文件系统上，逻辑块的大小通常为 1024、2048 或 4096 字节。

一个磁盘分区上的文件系统通常由以下几部分组成：

1.  **引导块 (Boot Block)**
    * 总是作为文件系统的首块。
    * 它不为文件系统所用，仅包含用来引导操作系统的信息。虽然只有一个引导块会被实际使用，但所有文件系统都会预留这个位置。

2.  **超级块 (Superblock)**
    * 紧随引导块之后的一个独立块。
    * 包含关于文件系统本身的参数信息，例如：i-node 表的容量、逻辑块的大小、文件系统的总大小等。
    * 正是因为超级块的存在，同一块磁盘的不同分区上可以拥有类型、大小、块大小等参数都完全不同的文件系统。

3.  **i-node 表 (Inode Table)**
    * 文件系统中的每个文件或目录都在 i-node 表中对应着唯一一条记录（一个 i-node）。
    * 这条记录登记了关乎文件的各种信息（元数据），将在下一节深入讨论。

4.  **数据块 (Data Blocks)**
    * 文件系统的大部分空间都用于存放数据，这些数据构成了文件和目录的实际内容。

> **ext2 的块组结构**:
> 就 `ext2` 文件系统而言，情况要更复杂一些。在引导块之后，`ext2` 文件系统被划分为一系列大小相等的**块组 (block group)**。每个块组都包含了一份超级块的拷贝、自身的 i-node 表和数据块。`ext2` 文件系统会尽量在同一个块组内存储一个文件的所有数据块，以期在对文件进行线性访问时，通过减少磁头移动（寻道）来提升性能。


# 实际布局

下面是 ext2 文件系统布局的 ASCII 艺术图，以及每个部分的详细解释。

### ext2 文件系统整体布局

```ascii
<------------------------------------ 整个磁盘分区 ------------------------------------->
+-------------+---------------------+---------------------+---------------------+----
| Boot Block  |   Block Group 0     |   Block Group 1     |   Block Group 2     | ...
| (引导块)    | (块组 0)            | (块组 1)            | (块组 2)            |
+-------------+---------------------+---------------------+---------------------+----
^
|
(通常为 1024 字节的偏移)
```

### 单个块组（Block Group）的详细布局

每个块组都是文件系统的一个微缩模型，包含了管理自身所需的所有元数据。

```ascii
<----------------------------------- 单个块组 (Block Group) ----------------------------------->
+------------+-----------------+--------------+--------------+-------------+----------------+
| Superblock | Group           | Block Bitmap | Inode Bitmap | Inode Table |   Data Blocks  |
| (超级块)   | Descriptors     | (块位图)     | (Inode 位图) | (Inode 表)  |   (数据块)     |
|   [副本]   | (块组描述符表)  |              |              |             |                |
|            |     [副本]      |              |              |             |                |
+------------+-----------------+--------------+--------------+-------------+----------------+
^            ^                 ^              ^              ^             ^
| Block 0    | Block 1         | Block 2      | Block 3      | Block 4..N  | Block N+1..M
(块边界)
```

-----

### 各部分详细解释

1.  **Boot Block (引导块)**

      * **位置**: 文件系统的最开始，通常占用第一个块（Block 0）。
      * **作用**: 这个块是为引导加载程序（Boot Loader）保留的。它不属于 ext2 文件系统的核心结构，但文件系统会特意留出这片空间。如果这个分区是启动分区，引导加载程序（如 GRUB）的代码就会被安装在这里，用于启动操作系统。

2.  **Block Group (块组)**

      * 整个文件系统被分割成一系列连续的块组，每个块组的大小是相同的。
      * 这种设计的目的是：
          * **减少寻道时间**: 将一个文件的 inode 和它的数据块放在同一个块组内，这样磁头就不需要大范围移动来读取文件信息和内容。
          * **提高可靠性**: 关键的元数据（如 Superblock 和块组描述符表）会在多个块组中保存副本，当主副本损坏时可以从备份中恢复。

3.  **Superblock (超级块)**

      * **位置**: 每个块组的开头都可能有一个副本，但只有 **Block Group 0** 中的那个是主超级块。
      * **作用**: 这是整个文件系统的“总指挥部”，存储了文件系统的全局信息，例如：
          * 总 Inode 数量、总块数量。
          * 未分配的 Inode 和块的数量。
          * 每个块组包含的块数和 Inode 数。
          * 文件系统的“魔数”（Magic Number），用于识别 ext2 文件系统 (`0xEF53`)。
          * 文件系统的状态（如干净卸载 `clean` 或有错误 `error`）。
          * 挂载时间、写入时间等。
      * 如果超级块损坏，整个文件系统将无法被识别和挂载，所以它的备份至关重要。

4.  **Group Descriptors (块组描述符表, GDT)**

      * **位置**: 紧跟在超级块之后。和超级块一样，它在多个块组中也有副本。
      * **作用**: 这是一张“目录”，描述了文件系统中所有块组的信息。表中的每一项都对应一个块组，并记录了这个块组的元数据信息存放的位置，例如：
          * 该块组的块位图（Block Bitmap）在哪个块。
          * 该块组的 Inode 位图（Inode Bitmap）在哪个块。
          * 该块组的 Inode 表（Inode Table）从哪个块开始。
          * 该块组中空闲块、空闲 Inode 和目录的数量。

5.  **Block Bitmap (块位图)**

      * **作用**: 这是一个用二进制位来表示的“账本”，记录了当前块组中**所有数据块（Data Blocks）的使用情况**。
      * **机制**: 每一位（bit）对应一个数据块。如果位的值是 `1`，表示对应的数据块已被占用；如果是 `0`，表示空闲可用。
      * 当需要为文件分配新的数据块时，系统会在这里快速查找一个为 `0` 的位。

6.  **Inode Bitmap (Inode 位图)**

      * **作用**: 和块位图类似，它记录了当前块组中**所有 Inode 的使用情况**。
      * **机制**: 每一位（bit）对应一个 Inode 表中的条目。`1` 表示已使用，`0` 表示空闲。
      * 当需要创建新文件或目录时，系统会在这里查找一个为 `0` 的位来分配一个新的 Inode。

7.  **Inode Table (Inode 表)**

      * **作用**: 这是当前块组中所有 Inode 的“档案库”。每个文件或目录都由一个 Inode 来描述（Inode 是 Index Node 的缩写，即索引节点）。
      * **内容**: 每个 Inode 结构体都存储了文件的**元数据（Metadata）**，除了文件名之外的所有信息，例如：
          * 文件类型（普通文件、目录、符号链接等）。
          * 文件权限（读、写、执行）。
          * 文件所有者（UID）和所属组（GID）。
          * 文件大小。
          * 时间戳（创建时间、修改时间、访问时间）。
          * 指向存储文件内容的**数据块的指针**。这是 Inode 最核心的部分。

8.  **Data Blocks (数据块)**

      * **作用**: 这是文件系统中真正**存储文件内容**的地方。
      * **特点**: 块组中绝大部分空间都是数据块。一个文件的具体内容被保存在一个或多个数据块中。Inode 表中的指针就是指向这些数据块的。对于目录文件，其数据块中存储的是该目录下的文件名及对应 Inode 编号的列表。

希望这个 ASCII 图和详细的解释能帮助你清晰地理解 ext2 文件系统的布局！