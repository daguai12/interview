### **56.1 概述**

在一个典型的客户端/服务器场景中，应用程序使用 socket 进行通信。服务器将自己的 socket 绑定到一个众所周知的地址（名称）上，以便客户端能够定位到它。

**`socket()` 系统调用**:
`socket()` 系统调用用于创建一个 socket，它返回一个文件描述符，用于在后续的系统调用中引用该 socket。

```c
#include <sys/socket.h>

int socket(int domain, int type, int protocol);
```

-----

#### **通信 Domain**

一个 socket 存在于一个**通信 domain** 中，它确定了：

  * 识别 socket 的方法（即 socket “地址”的格式）。
  * 通信的范围（是在同一主机上的进程间，还是通过网络连接的不同主机上的进程间）。

现代操作系统至少支持下列 domain：

  * **`AF_UNIX`**: (也称为 `AF_LOCAL`) 允许在**同一主机**上的应用程序之间进行通信。
  * **`AF_INET`**: 允许在使用 **IPv4** 网络连接的主机上的应用程序之间进行通信。
  * **`AF_INET6`**: 允许在使用 **IPv6** 网络连接的主机上的应用程序之间进行通信。

**表 56-1：socket domain**


| Domain         | 通信范围            | 地址格式                    | 地址结构           |
| :------------- | :-------------- | :---------------------- | :------------- |
| **`AF_UNIX`**  | 同一主机            | 路径名                     | `sockaddr_un`  |
| **`AF_INET`**  | 通过 IPv4 网络连接的主机 | 32 位 IPv4 地址 + 16 位端口号  | `sockaddr_in`  |
| **`AF_INET6`** | 通过 IPv6 网络连接的主机 | 128 位 IPv6 地址 + 16 位端口号 | `sockaddr_in6` |

> **`AF_` vs `PF_`**:
> 在一些代码中可能会看到 `PF_UNIX` 而不是 `AF_UNIX`。`AF` 表示“地址族 (address family)”，`PF` 表示“协议族 (protocol family)”。在实践中，两者已无区别，`PF_` 常量被定义为对应 `AF_` 常量的同义词。SUSv3 规范了 `AF_` 常量，因此本书将一直使用 `AF_` 常量。

-----

#### **socket 类型**

每个 domain 都至少提供了两种 socket 类型：流 (stream) 和数据报 (datagram)。

| 属性          | 流 (Stream) | 数据报 (Datagram) |
| :---------- | :--------- | :------------- |
| **可靠地递送？**  | **是**      | **否**          |
| **消息边界保留？** | **否**      | **是**          |
| **面向连接？**   | **是**      | **否**          |

  * **流 socket (`SOCK_STREAM`)**:

      * 提供一个**可靠的、双向的、字节流**通信信道。
      * **可靠**: 保证数据要么完整无缺地到达，要么收到传输失败的通知。
      * **字节流**: 与管道一样，不存在消息边界的概念。
      * **面向连接**: 使用前必须与另一个对等 socket 建立连接。
      * 在 Internet domain 中，流 socket 通常使用**传输控制协议 (TCP)**。因此常被称为 **TCP socket**。

  * **数据报 socket (`SOCK_DGRAM`)**:

      * 以被称为**数据报 (datagram)** 的消息为单位进行数据交换。
      * **不可靠**: 消息的到达可能是无序的、重复的，或者根本无法到达。
      * **保留消息边界**: 读取操作一次会读取一条完整的消息。
      * **无连接**: 使用时无需与另一个 socket 建立持久连接。
      * 在 Internet domain 中，数据报 socket 使用**用户数据报协议 (UDP)**。因此常被称为 **UDP socket**。

-----

#### **核心 socket 系统调用**

  * **`socket()`**: 创建一个新 socket。
  * **`bind()`**: 将一个 socket 绑定到一个地址上（通常由服务器使用）。
  * **`listen()`**: 允许一个流 socket 接受接入的连接（仅用于流 socket，由服务器使用）。
  * **`accept()`**: 在一个监听的流 socket 上接受一个连接（仅用于流 socket，由服务器使用）。
  * **`connect()`**: 建立与另一个 socket 之间的连接（通常由客户端使用）。

#### **Socket I/O**

  * 可以使用传统的 `read()` 和 `write()` 系统调用进行 I/O。
  * 也可以使用一组 socket 特有的系统调用（如 `send()` 和 `recv()`）来完成。
  * 默认情况下，这些 I/O 调用是**阻塞**的。可以通过 `fcntl()` 设置 `O_NONBLOCK` 标记来执行非阻塞 I/O。