
### **33.5 Linux POSIX 线程的实现**

Linux 系统下主要有两种 POSIX 线程（Pthreads） API 的实现：

  * **LinuxThreads**：最初的、较旧的实现。
  * **NPTL (Native POSIX Threads Library)**：现代的实现，用以取代 LinuxThreads。NPTL 性能更好，也更符合 POSIX 标准。它的运行需要 Linux 2.6 或更高版本的内核支持。

**关键点**：LinuxThreads 已经**过时**，自 glibc 2.4 版本起已不再被支持。所有新的开发都基于 NPTL。

### **33.5.1 LinuxThreads**

这是 Linux 上曾长期使用的主流线程实现。

  * **实现要点**：

      * 使用 `clone()` 系统调用创建线程，但线程间**不共享**进程ID（PID）。
      * 会创建一个额外的**管理线程**，用于处理其他线程的创建与终止。
      * 内部实现**严重依赖信号**，这导致线程同步操作延迟较高。应用程序也不能使用被其占用的信号。

  * **与 POSIX 标准的主要偏差**：

      * **身份不统一**：在不同线程中调用 `getpid()` 会返回不同的值。线程不共享用户和组ID（凭证）、nice值、会话ID和进程组ID。
      * **资源不共享**：资源限制（resource limits）、文件记录锁、间隔定时器（interval timers）、System V 信号量 `semadj` 值等本应是进程范围的属性，但在 LinuxThreads 中却成了每个线程私有的。
      * **信号处理混乱**：发送给进程的信号只能由特定线程接收，而不是任意一个未阻塞该信号的线程。发往进程组的信号会被所有线程处理，而不是由一个线程代表处理。
      * **工具显示问题**：`ps` 命令会把每个线程（包括管理线程）都显示为独立的进程。`times()` 和 `getrusage()` 返回的是单个线程的资源使用情况，而非整个进程的总和。

### **33.5.2 NPTL**

NPTL 的设计目标是解决 LinuxThreads 的所有缺陷。

  * **设计优点**：

      * **高度兼容标准**：非常接近 SUSv3 Pthreads 标准。
      * **性能卓越**：对于包含大量线程的程序，性能远超 LinuxThreads，并且支持创建海量线程（例如 10 万个）。

  * **内核支持（Linux 2.6+）**：

      * NPTL 的实现推动了 Linux 内核的重大改进，包括：**线程组**概念、用于高效同步的 **futex**、终止整个进程的 `exit_group()` 系统调用、以及能高效处理成千上万个线程的**新调度器**。

  * **实现要点**：

      * 同样使用 `clone()` 创建线程，但增加了 `CLONE_THREAD` 标志，确保所有线程**共享同一个进程ID**。
      * **不需要管理线程**。
      * 内部仅使用两个实时信号，依赖性远低于 LinuxThreads。
      * 使用 `ps -L` 命令才能看到进程中的各个线程信息，否则只会显示为一条记录。

  * **标准一致性**：

      * NPTL 解决了 LinuxThreads 绝大部分不符合标准的问题。随着内核版本的迭代（从 2.6.9 到 2.6.16 及以后），早期存在的一些不一致问题（如资源限制、备选信号栈继承等）也逐步被修复。目前，只有少数细微差异（如 nice 值不共享）仍然存在。

### **33.5.3 哪一种线程实现**

本节讨论如何识别和选择系统上的线程库。

  * **如何找出当前线程实现**：

      * 对于 glibc 2.3.2 及以上版本，可使用以下命令查看默认的线程库：
        ```bash
        getconf GNU_LIBPTHREAD_VERSION
        ```
        输出中会包含 "NPTL" 或 "linuxthreads" 字样。
      * 对于旧系统，可以通过 `ldd` 找到 C 库路径，然后直接运行该库文件来获取版本信息。

  * **如何选择使用的线程实现**：

      * 在同时提供两种实现的旧系统上，可以通过环境变量 `LD_ASSUME_KERNEL` 来“欺骗”动态链接器，强制其使用 LinuxThreads。例如，通过设置一个不支持 NPTL 的旧内核版本号（如 2.2.5）：
        ```bash
        LD_ASSUME_KERNEL=2.2.5 ./my_threaded_app
        ```
      * 这主要用于运行那些依赖于 LinuxThreads 非标准行为的旧程序。