### **49.9 MAP_NORESERVE 和过度利用交换空间**

#### **概念：懒交换预留与过度利用**
一些应用程序会创建非常大的内存映射，但实际上只使用其中一小部分分散的内存页（所谓的“稀疏数组”）。

* **问题**: 如果内核在创建映射时就为整个区域预留了等量的交换空间 (swap space)，那么大部分交换空间都会被浪费。
* **懒交换预留 (Lazy Swap Reservation)**: 为解决此问题，内核可以只在应用程序**实际访问**某个内存页时，才为其预留交换空间。
* **过度利用 (Overcommitment)**: 这种“懒预留”策略的一个结果是，系统中所有进程请求的虚拟内存总量可以超过实际物理内存 (RAM) 与交换空间的总和。这种情况被称为**交换空间的过度利用**。
* **风险**: 过度利用通常可以正常工作，但如果所有进程都试图使用它们所申请的全部内存，那么系统的 RAM 和交换空间就会被耗尽。此时，内核会通过**杀死**系统中的一个或多个进程来缓解内存压力。

#### **控制过度利用的机制**
内核如何处理交换空间的预留，是由 `mmap()` 调用时是否使用了 `MAP_NORESERVE` 标记，以及系统级的 `/proc/sys/vm/overcommit_memory` 文件共同控制的。

**表 49-4：`mmap()` 中处理交换空间预留**

| `/proc/.../overcommit_memory` 的值 | **不**指定 `MAP_NORESERVE` | **指定** `MAP_NORESERVE` |
| :------------------------------- | :---------------------- | :--------------------- |
| **0** (默认)                       | 拒绝明显的过度利用               | **允许**过度利用             |
| **1**                            | **允许**过度利用              | **允许**过度利用             |
| **2** (自 Linux 2.6 起)            | 严格的过度利用检查               | 严格的过度利用检查              |

* **`overcommit_memory = 0`**: 内核使用一种启发式算法来拒绝“明显”的过度分配请求，但会遵从 `MAP_NORESERVE` 标志的建议。
* **`overcommit_memory = 1`**: 内核总是允许过度利用，忽略 `MAP_NORESERVE` 标志。
* **`overcommit_memory = 2`**: 内核采用严格的过度利用检查。所有进程的虚拟内存分配总和不能超过 `SwapSpace + RAM * (overcommit_ratio / 100)`。`overcommit_ratio` 的值位于 `/proc/sys/vm/overcommit_ratio` 文件中。

> **注意**: 过度利用的监控只适用于需要使用交换空间的映射，即**私有可写映射**和**共享匿名映射**。只读映射和共享文件映射（其本身就是交换空间）则不受此限制。

---
#### **OOM 杀手 (Out-of-Memory Killer)**
当系统因内存过度利用而耗尽内存时，内核中一个被称为 **OOM 杀手**的代码会被激活，它的任务是选择并杀死一个或多个进程以释放内存。

* **选择策略**: OOM 杀手会根据一组启发式规则来确定“最佳”的牺牲进程。
    * **更容易被杀死**: 消耗内存越多的进程、创建了很多子进程的进程、`nice` 值较高的（优先级较低的）进程。
    * **一般不会被杀死**: 特权进程、正在访问裸设备的进程、已经运行了很长时间或消耗了大量 CPU 的进程。
* **杀死方式**: OOM 杀手会向被选中的进程发送一个 `SIGKILL` 信号。

##### **控制 OOM 杀手**
从 Linux 内核 2.6.11 开始，可以通过以下 `/proc` 文件来影响 OOM 杀手的行为：
* **/proc/PID/oom_score**: 一个只读文件，显示了内核赋给该进程的“不良”分数。分数越高，该进程被 OOM 杀手选中的可能性就越大。
* **/proc/PID/oom_adj**: 一个可写文件，可以被设置成 -16 到 +15 之间的值。
    * 负数会降低 `oom_score` 值，使进程更不容易被杀死。
    * 正数会增大 `oom_score` 值。
    * 特殊值 **-17** 会完全禁止 OOM 杀手杀死该进程。