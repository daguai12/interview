### **49.3 解除映射区域：munmap()**

`munmap()` 系统调用执行与 `mmap()` 相反的操作，即从调用进程的虚拟地址空间中删除一个映射。

```c
#include <sys/mman.h>

int munmap(void *addr, size_t length);
```

  * **`addr`**: 待解除映射区域的起始地址，它**必须与一个分页边界对齐**。
  * **`length`**: 指定了待解除映射区域的大小（字节数）。

通常，我们会解除整个由 `mmap()` 创建的映射。因此，`addr` 可以指定为上一个 `mmap()` 调用返回的地址，`length` 的值也与 `mmap()` 调用中使用的 `length` 值一样。

```c
// 假设 addr 和 length 是之前 mmap() 调用返回的值和使用的长度
if (munmap(addr, length) == -1) {
    perror("munmap");
    // handle error
}
```

#### **其他特性**

  * 也可以只解除一个映射中的部分区域，或者指定一个跨越多个映射的地址范围。
  * 如果在由 `addr` 和 `length` 指定的地址范围中不存在映射，那么 `munmap()` 将不起任何作用并返回 0（表示成功）。
  * 在解除映射期间，内核会删除进程在指定地址范围内的所有**内存锁**（通过 `mlock()` 或 `mlockall()` 建立）。
  * 当一个进程终止或执行 `exec()` 之后，该进程中所有的映射都会被**自动解除**。

#### **重要提示：与文件同步**

对于**共享文件映射 (`MAP_SHARED`)**，调用 `munmap()` **并不能保证**映射区域中的内容会被写入到底层文件中。

为确保一个共享文件映射的内容会被写入磁盘，在使用 `munmap()` 解除映射之前，**必须**先调用 **`msync()`**。