好的，这是对您提供的关于 Wireshark 过滤器的内容进行的总结和优化，使其更易于阅读和理解，同时保留了您原有的标题结构。

---

### **4.5 过滤器**

过滤器是您在分析网络数据包时的强大工具。它通过设定一系列规则（表达式），帮助您筛选出想要关注的数据包，或者隐藏掉不想看到的数据包。

Wireshark 提供两种主要类型的过滤器：

* **捕获过滤器 (Capture Filters):** 在 **捕获数据包的过程中** 使用。只有符合规则的数据包才会被捕获并保存。这对于提升性能、节省资源非常有用。
* **显示过滤器 (Display Filters):** 在 **数据包捕获完成之后** 使用。它不会删除任何数据包，只是暂时从您的视图中隐藏不符合规则的数据包。

接下来，我们详细了解捕获过滤器。

### **4.5.1 捕获过滤器**

捕获过滤器在开始捕获流量之前设置，主要目的是 **提升性能**。当您处理大量流量，但只关心其中一小部分时（例如，只关心某个特定服务的流量），使用捕获过滤器可以避免处理器和内存浪费在那些您根本不会分析的数据包上。

**如何设置捕-获过滤器：**

1.  选择 `Capture -> Options`。
2.  在弹出的对话框中，找到您要使用的网络接口。
3.  在对应的“捕获过滤器”一栏中，输入您的过滤表达式。
    * 如果表达式语法 **正确**，输入框会变为 **绿色**。
    * 如果表达式语法 **错误**，输入框会变为 **红色**。
4.  例如，要只捕获与端口 `262` 相关的所有流量，您可以输入 `port 262`。
5.  点击 `Start` 开始捕获。此时，Wireshark 将只记录进出端口 `262` 的数据包。

#### **1．捕获过滤器的BPF语法**

捕获过滤器使用一种名为 **伯克利数据包过滤器 (Berkeley Packet Filter, BPF)** 的语法。这种语法是许多网络工具的标准。

一个 BPF 过滤器被称为一个 **表达式 (expression)**，它由一个或多个 **原语 (primitive)** 组成。

每个原语通常包含 **限定词 (qualifier)** 和 **ID (名字或数字)**。

**常见的限定词：**

* **Type (类型):** 指明 ID 代表什么。例如 `host`, `net`, `port`。
* **Dir (方向):** 指明流量是源于还是发往该 ID。例如 `src` (source), `dst` (destination)。
* **Proto (协议):** 指明要匹配的协议。例如 `ether`, `ip`, `tcp`, `udp`。

![[Pasted image 20250912223000.png]]

**组合原语：**

您可以使用逻辑运算符将多个原语组合成更复杂的表达式：

* **与 (AND):** `&&`
* **或 (OR):** `||`
* **非 (NOT):** `!`

**示例：**
捕获源地址为 `192.168.0.10` **并且** 端口为 `80` 的流量。
`src host 192.168.0.10 && port 80`

---

#### **2．主机名和地址过滤器**

这是最常用的过滤器类型，用于定位特定设备的流量。

* **按 IPv4 地址过滤:**
    `host 172.16.16.149`
* **按 IPv6 地址过滤:**
    `host 2001:db8:85a3:8a2e:370:7334`
* **按主机名过滤:**
    `host testserver2`
* **按 MAC 地址过滤:**
    `ether host 00-1a-a0-52-e2-a0`
* **结合方向限定词:**
    * 只看 **来自** 该主机的流量: `src host 172.16.16.149`
    * 只看 **发往** 该主机的流量: `dst host 172.16.16.149`

> **注意:** 如果不指定类型限定词（如 `host`），则默认为 `host`。因此，`dst 172.16.16.149` 与 `dst host 172.16.16.149` 效果相同。

---

#### **3．端口过滤器**

用于根据 TCP/UDP 端口号筛选流量，常用于定位特定应用程序。

* **捕获特定端口的流量:**
    `port 8080`
* **捕获除了特定端口外的所有流量:**
    `!port 8080`
* **结合方向，捕获发往 Web 服务器的流量:**
    `dst port 80`

---

#### **4．协议过滤器**

用于按网络协议（而非端口）进行过滤。

* **只看 ICMP 流量:**
    `icmp`
* **看除了 IPv6 以外的所有流量:**
    `!ip6`

---

#### **5．协议域过滤器**

这是 BPF 语法的一项高级功能，它允许您检查协议头中特定位置的字节值来进行过滤。

**基本语法:** `proto[offset:size]`
* `proto`: 协议名称 (如 `tcp`, `icmp`)。
* `offset`: 从协议头开始的字节偏移量（从 0 开始）。
* `size`: （可选）要检查的字节数，默认为 1。

**示例 1：检查 ICMP 类型**
只捕获 ICMP 目标不可达（类型 3）的数据包。类型字段在 ICMP 头的第 0 个字节。
`icmp[0] == 3`

**示例 2：检查 ICMP 类型和代码**
捕获 ICMP 主机不可达（类型 3，代码 1）的数据包。我们需要检查从偏移量 0 开始的 2 个字节，其十六进制值应为 `0x0301`。
`icmp[0:2] == 0x0301`

**示例 3：检查 TCP 标志位（位掩码过滤）**
TCP 标志位位于头部偏移量为 13 的字节中，但每个标志只占 1 位。因此，不能简单地用 `==` 来判断。我们需要使用 **位与 (`&`)** 运算符。

* **捕获设置了 RST 标志的数据包 (RST 标志位的值为 4):**
    `tcp[13] & 4 == 4`
* **捕获设置了 PSH 标志的数据包 (PSH 标志位的值为 8):**
    `tcp[13] & 8 == 8`

---

#### **6．捕获过滤器表达式样例**

下表提供了一些常用的捕获过滤器表达式。

| 过滤器                             | 说明                                 |
| :------------------------------ | :--------------------------------- |
| `tcp[13] & 32 == 32`            | 设置了 URG 位的 TCP 数据包                 |
| `tcp[13] & 16 == 16`            | 设置了 ACK 位的 TCP 数据包                 |
| `tcp[13] & 8 == 8`              | 设置了 PSH 位的 TCP 数据包                 |
| `tcp[13] & 4 == 4`              | 设置了 RST 位的 TCP 数据包                 |
| `tcp[13] & 2 == 2`              | 设置了 SYN 位的 TCP 数据包                 |
| `tcp[13] & 1 == 1`              | 设置了 FIN 位的 TCP 数据包                 |
| `tcp[13] == 18`                 | TCP SYN-ACK 数据包 (SYN 和 ACK 位同时被设置) |
| `ether host 00:00:00:00:00:00`  | 流入或流出指定 MAC 地址的流量 (请替换为你的 MAC)     |
| `!ether host 00:00:00:00:00:00` | 不流入或流出指定 MAC 地址的流量 (请替换为你的 MAC)    |
| `broadcast`                     | 仅广播流量                              |
| `icmp`                          | ICMP 流量                            |
| `ip`                            | 仅 IPv4 流量                          |
| `ip6`                           | 仅 IPv6 流量                          |
| `udp`                           | 仅 UDP 流量                           |

---

### **4.5.2 显示过滤器**

显示过滤器 (Display Filters) 应用于 **已经捕获** 的数据包文件，它能帮助您从现有数据中筛选出符合条件的特定数据包进行查看。您可以在 Wireshark 主界面上方的 **“Filter”文本框** 中直接输入显示过滤器表达式。

与捕获过滤器最大的不同是，显示过滤器 **不会丢弃任何数据包**，它只是暂时隐藏了不符合条件的数据包。您随时可以通过清空过滤表达式来查看全部捕获内容。

一个常见的用途是临时隐藏“噪音”流量，例如，当您分析特定问题时，可以暂时用 `!arp` 过滤器隐藏所有的 ARP 广播包，以便专注于更有价值的数据。

创建显示过滤器主要有两种方法：使用图形化的“过滤器表达式对话框”（适合初学者）和直接手动输入表达式（更高效）。

#### **1．过滤器表达式对话框（简单方法）**

对于初学者来说，这是一个非常友好的工具，可以帮助您在不熟悉具体语法的情况下构建有效的过滤器。

**它的工作方式很简单：**

1.  **选择协议域:** 在对话框的协议列表中，展开协议（例如 `TCP`）并选择您感兴趣的字段（例如 `tcp.port`）。
2.  **选择关系:** 选择一个比较关系，比如 `==` (等于), `>` (大于) 等。
3.  **输入值:** 输入您要匹配的值（例如 `80`）。
4.  **生成表达式:** 对话框会自动为您生成格式正确的过滤器表达式，例如 `tcp.port == 80`。

虽然这个方法很直观，但当您熟悉语法后，会发现手动输入过滤器效率更高。

#### **2．过滤器表达式语法结构（高级方法）**

显示过滤器的语法非常有条理，通常遵循 `协议.字段.子字段` 的格式。例如，`ip.addr` 指的是 IP 协议中的 `addr` (地址) 字段。

**比较操作符 (Comparison Operators)**
您可以使用比较操作符来匹配字段的值。

* **示例1:** 查找 IP 地址为 `192.168.0.1` 的所有数据包。
    `ip.addr == 192.168.0.1`

* **示例2:** 查找长度小于或等于 `128` 字节的数据包。
    `frame.len <= 128`

下表是所有可用的比较操作符：

| 操作符  | 说明    |
| :--- | :---- |
| `==` | 等于    |
| `!=` | 不等于   |
| `>`  | 大于    |
| `<`  | 小于    |
| `>=` | 大于或等于 |
| `<=` | 小于或等于 |

**逻辑运算符 (Logical Operators)**
您可以使用逻辑运算符来组合多个表达式，创建更强大的过滤器。

* **示例:** 显示来自 `192.168.0.1` **或者** `192.168.0.2` 的数据包。
    `ip.addr == 192.168.0.1 or ip.addr == 192.168.0.2`

下表是所有可用的逻辑操作符：

| 操作符   | 说明          |
| :---- | :---------- |
| `and` | 两个条件需同时满足   |
| `or`  | 其中一个条件被满足即可 |
| `xor` | 有且仅有一个条件被满足 |
| `not` | 没有条件被满足     |

#### **3．显示过滤器表达式实例**

下面是一些在实际分析中非常常用的显示过滤器表达式。

| 过滤器                                  | 说明                              |
| :----------------------------------- | :------------------------------ |
| `!tcp.port == 3389`                  | 排除 RDP 流量（远程桌面协议）               |
| `tcp.flags.syn == 1`                 | 具有 SYN 标志位的 TCP 数据包 (TCP 连接请求)  |
| `tcp.flags.rst == 1`                 | 具有 RST 标志位的 TCP 数据包 (TCP 连接重置)  |
| `!arp`                               | 排除 ARP 流量                       |
| `http`                               | 所有 HTTP 流量                      |
| `tcp.port == 23 \|\| tcp.port == 21` | 文本管理流量 (Telnet 或 FTP)           |
| `smtp \|\| pop \|\| imap`            | 文本 email 流量 (SMTP, POP, 或 IMAP) |

---

### **4.5.3 保存过滤器规则**

当您发现自己频繁使用某些特定的过滤器时，为了避免每次都重新输入，Wireshark 允许您将这些规则保存下来以便将来快速调用。捕获过滤器和显示过滤器的保存方法略有不同。

**保存捕获过滤器 (Saving Capture Filters)**

您可以按照以下步骤将常用的捕获过滤器表达式保存起来：

1.  选择 `Capture -> Capture Filters` 打开对话框。
2.  点击左下角的 `+` 按钮来添加一个新规则。
3.  在 **Filter Name** 栏中为您的过滤器起一个容易识别的名字。
4.  在 **Filter String** 栏中输入完整的过滤器表达式。
5.  点击 `OK` 保存，该过滤器就会出现在列表中供您随时选用。

**保存显示过滤器 (Saving Display Filters)**

保存常用的显示过滤器更加便捷：

1.  在主界面的 **Filter 文本框** 中输入您想要保存的显示过滤器表达式。
2.  点击文本框左侧的 **“书签”** 或 **“带状”** 图标。
3.  在弹出的菜单中，选择 **“保存此过滤器”** 相关的选项。
4.  在弹出的对话框中，为您的过滤器命名，然后点击 `OK` 即可保存。


---

### **4.5.4 在工具栏中增加显示过滤器

对于那些您最常使用的显示过滤器，Wireshark 提供了一个极为方便的功能：将它们直接添加为工具栏上的快捷按钮。这样，您只需单击一下按钮即可应用复杂的过滤器。

**操作步骤如下：**

1.  在主界面的 **Filter 文本框** 中，输入您想要添加为快捷按钮的显示过滤器表达式。
2.  点击文本框右侧的 **`+`** 按钮。
3.  下方会出现一个新的对话框。在 **Label (标签)** 输入框中，为这个按钮起一个简短且有意义的名字（例如，“TCP Resets”）。
4.  点击 `OK`。

完成以上步骤后，一个以您命名的按钮就会出现在过滤器工具栏上。现在，您随时可以点击这个按钮来快速应用该过滤器，极大地提升了在不同场景下分析问题的效率。

> **提示:** 这些自定义的快捷按钮会被保存在您的个人配置中。您可以参考 Wireshark 内置的大量过滤器作为范例来创建自己的规则。