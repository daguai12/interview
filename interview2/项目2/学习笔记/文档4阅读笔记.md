# C++ åç¨‹çš„æ¦‚å¿µ

## ä¸€ã€ä»€ä¹ˆæ˜¯ C++ åç¨‹ï¼Ÿ

åœ¨ C++20 ä¸­ï¼Œå¦‚æœä½ åœ¨ä¸€ä¸ªå‡½æ•°é‡Œä½¿ç”¨äº†ä»¥ä¸‹ä»»æ„å…³é”®å­—ä¹‹ä¸€ï¼š

* `co_await`ï¼šè¡¨ç¤ºæŒ‚èµ·ç­‰å¾…æŸä¸ªå¼‚æ­¥æ“ä½œå®Œæˆï¼›
* `co_yield`ï¼šç”¨äºç”Ÿæˆå€¼ï¼ˆç±»ä¼¼äº Python ä¸­çš„ç”Ÿæˆå™¨ï¼‰ï¼›
* `co_return`ï¼šç”¨äºä»åç¨‹ä¸­è¿”å›ç»“æœã€‚

åªè¦å‡½æ•°ä½“å†…å‡ºç°äº†è¿™äº›å…³é”®å­—ä¹‹ä¸€ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šè¢«ç¼–è¯‘å™¨ **è‡ªåŠ¨å˜æˆåç¨‹**ã€‚

---

## äºŒã€åç¨‹çš„ä¸‰å¤§æ ¸å¿ƒç»„æˆ

æ¯ä¸€ä¸ªåç¨‹åœ¨è¿è¡Œæ—¶ï¼Œç¼–è¯‘å™¨ä¼šåœ¨èƒŒåè‡ªåŠ¨åˆ›å»ºä¸€å¥—â€œæ¡†æ¶â€ï¼ˆframeï¼‰ï¼Œè¿™ä¸ªæ¡†æ¶ç”±ä¸‰ç§é‡è¦çš„å¯¹è±¡ç»„æˆï¼š

### 1. **promise å¯¹è±¡**

* è™½ç„¶å« `promise`ï¼Œä½†å®ƒ **è·Ÿ `std::promise` æ²¡æœ‰å…³ç³»**ã€‚
* å®ƒæ˜¯ç¼–è¯‘å™¨ç”Ÿæˆçš„å¯¹è±¡ï¼Œç”¨æ¥ **ä»£è¡¨åç¨‹çš„è¡Œä¸º**ã€‚
* ä½ å¯ä»¥é€šè¿‡è¿™ä¸ªå¯¹è±¡ï¼š

  * æ§åˆ¶åç¨‹ä½•æ—¶æŒ‚èµ·/æ¢å¤ï¼›
  * è·å–åç¨‹çš„è¿”å›å€¼ï¼›
  * æ•è·åç¨‹æŠ›å‡ºçš„å¼‚å¸¸ã€‚

> å¯ä»¥ç†è§£ä¸ºï¼š`promise` å°±æ˜¯åç¨‹ä¸ç”¨æˆ·ä¹‹é—´æ²Ÿé€šçš„æ¡¥æ¢ã€‚

### 2. **åç¨‹å¥æŸ„ï¼ˆhandleï¼‰**

* æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª **æŒ‡å‘åç¨‹å¸§çš„æŒ‡é’ˆ**ã€‚
* ç”¨å®ƒå¯ä»¥è®¿é—®åç¨‹çš„ promiseï¼Œä¹Ÿå¯ä»¥æ¢å¤ï¼ˆresumeï¼‰æˆ–é”€æ¯ï¼ˆdestroyï¼‰åç¨‹ã€‚
* è¿™æ˜¯ä½ åœ¨å¤–éƒ¨æ“ä½œåç¨‹çš„å…¥å£ã€‚

> ç±»ä¼¼äºâ€œé¥æ§å™¨â€ï¼Œä½ é€šè¿‡åç¨‹å¥æŸ„æ§åˆ¶åç¨‹è¿è¡ŒçŠ¶æ€ã€‚

### 3. **åç¨‹çŠ¶æ€**

* ä¸ºäº†è®©åç¨‹åœ¨ `co_await` çš„æ—¶å€™æŒ‚èµ·ã€ç¨åå†æ¢å¤ï¼Œå®ƒå¿…é¡»è®°å½•å½“å‰æ‰§è¡Œåˆ°å“ªä¸€è¡Œã€å±€éƒ¨å˜é‡çš„å€¼ç­‰ç­‰ã€‚
* æ‰€ä»¥åç¨‹çš„çŠ¶æ€éœ€è¦ä¿å­˜åœ¨ä¸€ä¸ªâ€œå¸§â€ï¼ˆframeï¼‰é‡Œï¼Œä¾›ä¸‹ä¸€æ¬¡æ¢å¤ä½¿ç”¨ã€‚

---

## ä¸‰ã€ä»€ä¹ˆæ˜¯åç¨‹å¸§ï¼ˆCoroutine Frameï¼‰ï¼Ÿ

### æ¿€æ´»å¸§ï¼ˆactivation frameï¼‰= æ ˆå¸§ + åç¨‹å¸§

#### 1. **æ ˆå¸§ï¼ˆstack frameï¼‰**

* è·Ÿæ™®é€šå‡½æ•°ä¸€æ ·ï¼Œå½“åç¨‹è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä¹Ÿä¼šæœ‰æ ˆå¸§åˆ›å»ºã€‚
* ä¸€æ—¦åç¨‹è¿”å›ï¼Œæ ˆå¸§å°±ä¼šè¢«é”€æ¯ã€‚

#### 2. **åç¨‹å¸§ï¼ˆcoroutine frameï¼‰**

* ä¸“é—¨ä¸ºåç¨‹ä¿å­˜çŠ¶æ€çš„å†…å­˜åŒºåŸŸã€‚
* åŒ…å«äº†ä¸Šé¢æåˆ°çš„ä¸‰å¤§å¯¹è±¡ï¼ˆpromiseã€handleã€çŠ¶æ€ï¼‰ã€‚
* å®ƒä¸æ˜¯åœ¨æ ˆä¸Šåˆ†é…çš„ï¼Œè€Œæ˜¯é€šå¸¸ **åœ¨å †ä¸Šåˆ†é…** çš„ã€‚
* ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºåç¨‹å¯ä»¥åœ¨æŒ‚èµ·åè„±ç¦»è°ƒç”¨æ ˆï¼Œå¼‚æ­¥æ¢å¤ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨æ ˆä¸Šé‚£ç§â€œè°ƒç”¨å®Œå°±é”€æ¯â€çš„å†…å­˜ã€‚

> æ‰“ä¸ªæ¯”æ–¹ï¼š
>
> * æ™®é€šå‡½æ•°ï¼šåƒä¸€ä¸ªæ‰“ç”µè¯çš„äººï¼Œç”µè¯æŒ‚äº†ï¼ˆå‡½æ•°ç»“æŸï¼‰ï¼Œä¸€åˆ‡å°±æ²¡äº†ã€‚
> * åç¨‹ï¼šåƒå‘äº†æ¡è¯­éŸ³ä¿¡æ¯ï¼Œæ¥æ”¶è€…å¯ä»¥è¿‡ä¸€ä¼šå†å¬ï¼Œæ‰€ä»¥ä¿¡æ¯å†…å®¹è¦æ”¾åœ¨æ‰‹æœºï¼ˆå †å†…å­˜ï¼‰é‡Œï¼Œä¸æ˜¯å˜´å·´ï¼ˆæ ˆï¼‰é‡Œã€‚

---

## å››ã€å†…å­˜ç®¡ç†è¯´æ˜

åç¨‹å¸§æ˜¯ç”±ç¼–è¯‘å™¨ä¸ºä½ ç”Ÿæˆçš„ï¼Œä½†å®ƒæ˜¯ **åœ¨å †ä¸Šåˆ†é…çš„**ï¼ˆé€šå¸¸ï¼‰ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„ï¼š

* **ä½ è‡ªå·±è¦è´Ÿè´£é”€æ¯** åç¨‹å¥æŸ„ï¼ˆä¹Ÿå°±æ˜¯é‡Šæ”¾åç¨‹å¸§ï¼‰ï¼Œå¦åˆ™å°±ä¼š **å†…å­˜æ³„æ¼**ã€‚
* æœ‰ä¸€ç§æƒ…å†µå¯ä»¥ä¼˜åŒ–ï¼šå¦‚æœç¼–è¯‘å™¨ç¡®å®šåç¨‹çš„ç”Ÿå‘½å‘¨æœŸ **ä¸€å®šçŸ­äºè°ƒç”¨å®ƒçš„å‡½æ•°**ï¼Œå®ƒä¹Ÿå¯ä»¥å°è¯•ä»æ ˆå¸§ä¸­åˆ†é…è¿™å—å†…å­˜ï¼Œé¿å…å †åˆ†é…ã€‚

---

## äº”ã€åç¨‹çš„æ‰§è¡Œè¿‡ç¨‹ç®€åŒ–ç‰ˆ

è°ƒç”¨ä¸€ä¸ªåç¨‹å‡½æ•°æ—¶ï¼Œå…¶å®åšäº†ä¸¤ä»¶äº‹ï¼š

1. **æ­£å¸¸å‡½æ•°çš„é‚£ä¸€å¥—**ï¼š

   * å…¥æ ˆã€åˆ›å»ºæ ˆå¸§ã€‚
2. **åç¨‹çš„ç‰¹æ®Šéƒ¨åˆ†**ï¼š

   * ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…åç¨‹å¸§ï¼ˆå †ä¸Šï¼‰ï¼›
   * åˆå§‹åŒ– promiseï¼›
   * è¿”å›åç¨‹å¥æŸ„ç»™ä½ ï¼Œä¾›åç»­ resume/useã€‚

---

## æ€»ç»“ä¸€å¥è¯ï¼š

> **C++ åç¨‹ = æ™®é€šå‡½æ•° + çŠ¶æ€ä¿å­˜ + å¼‚æ­¥æŒ‚èµ·æ¢å¤èƒ½åŠ› + ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„åç¨‹å¸§ã€‚**

å®ƒé€šè¿‡ `promise` å¯¹è±¡æš´éœ²æ¥å£ï¼Œé€šè¿‡ `å¥æŸ„` æ“ä½œæ¢å¤/é”€æ¯ï¼Œé€šè¿‡ `åç¨‹å¸§` ä¿å­˜ä¸­é—´çŠ¶æ€ï¼Œåœ¨å †ä¸Šå­˜æ´»ï¼Œä¸å†å±€é™äºå‡½æ•°è°ƒç”¨æ ˆã€‚


# ç¤ºä¾‹è®²è§£

éå¸¸å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªç»å…¸çš„ C++20 åç¨‹ç¤ºä¾‹ï¼Œæ‰‹åŠ¨å®ç°äº†ä¸€ä¸ªå¯ `co_yield` å¤šæ¬¡ã€å¯è·å–æœ€ç»ˆ `co_return` ç»“æœçš„åç¨‹å¯¹è±¡ `Task`ã€‚ä½ æä¾›çš„ä»£ç è®¾è®¡éå¸¸ä¸¥è°¨ï¼Œä¹ŸåŒ…å«äº† C++ åç¨‹æœºåˆ¶ä¸­å‡ ä¹æ‰€æœ‰æ ¸å¿ƒæ¦‚å¿µï¼š`promise_type`ã€åç¨‹å¥æŸ„ã€æŒ‚èµ·/æ¢å¤æ§åˆ¶ã€yield æœºåˆ¶ã€å¼‚å¸¸å¤„ç†ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­‰ã€‚

æˆ‘ä¼š **æŒ‰æ¨¡å—é€æ­¥è¯¦ç»†è®²è§£æ•´æ®µä»£ç **ï¼ŒåŒ…æ‹¬ä½ éœ€è¦ç†è§£çš„åº•å±‚æœºåˆ¶ã€è®¾è®¡åŸå› å’Œè¯­è¨€ç‰¹æ€§ã€‚

---

## ğŸŒ± ç¬¬ä¸€æ­¥ï¼šåç¨‹ç›¸å…³åŸºç¡€çŸ¥è¯†å¤ä¹ ï¼ˆå¿«é€Ÿï¼‰

### C++20 åç¨‹çš„äº”å¤§æ ¸å¿ƒç»„ä»¶

æ¯ä¸€ä¸ªåç¨‹éƒ½ä¼šå…³è”ä»¥ä¸‹ç»„ä»¶ï¼Œç”±ç¼–è¯‘å™¨è‡ªåŠ¨ç®¡ç†ï¼š

| ç»„ä»¶                                    | è¯´æ˜                               |
| ------------------------------------- | -------------------------------- |
| `promise_type`                        | ç”¨æˆ·å®šä¹‰çš„ç±»ï¼Œç”¨æ¥ç®¡ç†åç¨‹çš„çŠ¶æ€ã€äº§å‡ºå’Œå¼‚å¸¸ç­‰ï¼Œå¿…é¡»æä¾›ç‰¹å®šæ¥å£ |
| `co_await`, `co_yield`, `co_return`   | åç¨‹å…³é”®å­—ï¼Œç”¨æ¥æŒ‚èµ·ã€ç”Ÿæˆå€¼å’Œè¿”å›å€¼               |
| `std::coroutine_handle<promise_type>` | åç¨‹å¥æŸ„ï¼Œå¯ä»¥æ“ä½œè¯¥åç¨‹ï¼Œå¦‚ resumeã€destroy    |
| `initial_suspend` / `final_suspend`   | æ§åˆ¶åç¨‹å¯åŠ¨åæ˜¯å¦ç«‹å³æŒ‚èµ·ã€ç»“æŸåæ˜¯å¦æŒ‚èµ·            |
| åç¨‹å¸§ï¼ˆCoroutine Frameï¼‰                  | åç¨‹çš„â€œçŠ¶æ€å¿«ç…§â€ï¼Œä¿å­˜åœ¨å †ä¸Šï¼Œç”± `handle` æŒ‡å‘    |

---

## ğŸ§± ç¬¬äºŒæ­¥ï¼šç”¨æˆ·åç¨‹ç±»å‹ `Task`

è¿™æ˜¯ä½ ä½œä¸ºç”¨æˆ·å±‚çœ‹åˆ°çš„â€œåç¨‹å¯¹è±¡â€ï¼Œæ•´ä¸ª `Task` æ˜¯å›´ç»• `promise_type` å’Œ `handle_type` æ„å»ºçš„å£³ã€‚

### `class Task`

```cpp
class Task {
public:
  class promise_type;
  using handle_type = std::coroutine_handle<promise_type>;
  ...
};
```

#### ğŸ“Œ `promise_type` æ˜¯åç¨‹èƒŒåçš„â€œæ§åˆ¶å™¨â€

è¿™ä¸ª `Task::promise_type` æ˜¯å¿…é¡»å®šä¹‰çš„ï¼Œå› ä¸ºç¼–è¯‘å™¨åœ¨å¤„ç†åç¨‹å‡½æ•° `run()` æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨è¿™äº›æ¥å£ï¼š

* `get_return_object()`
* `initial_suspend()`
* `yield_value(...)`
* `return_value(...)`
* `unhandled_exception()`
* `final_suspend()`

#### ğŸ“Œ `handle_type` æ˜¯æŒ‡å‘åç¨‹å¸§çš„æŒ‡é’ˆ

å®ƒæ˜¯æ§åˆ¶åç¨‹è¿è¡Œçš„ä¸»è¦æ¥å£ã€‚ä½ å¯ä»¥é€šè¿‡å®ƒï¼š

* `resume()` åç¨‹
* `destroy()` é”€æ¯åç¨‹å¸§
* `done()` åˆ¤æ–­æ˜¯å¦ç»“æŸ
* `promise()` è·å–å†…éƒ¨çš„ `promise_type`

---

## ğŸš€ ç¬¬ä¸‰æ­¥ï¼šé‡ç‚¹åˆ†æ promise\_type

```cpp
class promise_type {
  friend class Task;

public:
  Task get_return_object();
  constexpr std::suspend_always initial_suspend();
  void return_value(std::string result);
  std::suspend_always yield_value(int value);
  void unhandled_exception();
  constexpr std::suspend_always final_suspend() noexcept;

private:
  std::exception_ptr m_exception{nullptr};
  std::optional<std::string> m_result{std::nullopt};
  std::optional<int> m_yield{std::nullopt};
};
```

### ğŸ‘‡ æ–¹æ³•åˆ†æï¼š

#### âœ… `get_return_object()`

* ç”±ç¼–è¯‘å™¨è‡ªåŠ¨è°ƒç”¨ï¼Œç”¨äºè¿”å›åç¨‹çš„å°è£…å¯¹è±¡ã€‚
* å®ƒè¿”å›çš„æ˜¯ `Task`ï¼Œé€šè¿‡ `handle_type::from_promise(*this)` è·å–å¥æŸ„æŒ‡å‘å½“å‰ `promise_type` çš„åç¨‹å¸§ã€‚

```cpp
Task get_return_object() {
    auto handle = handle_type::from_promise(*this);
    return Task(handle);
}
```

#### âœ… `initial_suspend()`

* æ§åˆ¶åç¨‹åˆ›å»ºå®Œæˆåæ˜¯å¦ç«‹å³æŒ‚èµ·ã€‚
* è¿”å› `std::suspend_always{}` è¡¨ç¤ºï¼š**åˆ›å»ºåç¨‹åç«‹å³æŒ‚èµ·ï¼Œéœ€è¦æ‰‹åŠ¨ resume() æ‰èƒ½å¼€å§‹è¿è¡Œ**ã€‚

```cpp
constexpr std::suspend_always initial_suspend() { return {}; }
```

#### âœ… `yield_value(int)`

* æ¯æ¬¡ `co_yield xxx` ä¼šè‡ªåŠ¨è°ƒç”¨æ­¤å‡½æ•°ã€‚
* ä½ åœ¨è¿™é‡Œå­˜å‚¨äº† yield çš„å€¼ï¼Œä¹‹ååœ¨ `Task::next()` ä¸­å–å‡ºã€‚

```cpp
std::suspend_always yield_value(int value) {
    m_yield = value;
    return {};
}
```

#### âœ… `return_value(std::string)`

* åç¨‹ä½¿ç”¨ `co_return` è¿”å›å€¼æ—¶ï¼Œè°ƒç”¨æ­¤å‡½æ•°ã€‚
* å­˜å‚¨äº†è¿”å›å€¼ `m_result`ï¼Œä¾›å¤–éƒ¨é€šè¿‡ `.result()` è®¿é—®ã€‚

```cpp
void return_value(std::string result) {
    m_result = result;
}
```

#### âœ… `unhandled_exception()`

* å¦‚æœåç¨‹å†…éƒ¨æŠ›å‡ºå¼‚å¸¸ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚
* å­˜å‚¨å¼‚å¸¸ä¾›å¤–éƒ¨ rethrowã€‚

```cpp
void unhandled_exception() {
    m_exception = std::current_exception();
}
```

#### âœ… `final_suspend()`

* åç¨‹æ‰§è¡Œå®Œåä¼šè‡ªåŠ¨è°ƒç”¨ï¼Œç”¨æ¥å†³å®šåç¨‹æ˜¯å¦æŒ‚èµ·ç­‰å¾…é”€æ¯ï¼Œæˆ–ç›´æ¥é”€æ¯ã€‚
* è¿”å› `suspend_always{}` è¯´æ˜ï¼š**ç»“æŸåä»ç„¶æŒ‚èµ·ï¼Œéœ€ resume() æ¥å½»åº•å®Œæˆé”€æ¯æµç¨‹ã€‚**

```cpp
constexpr std::suspend_always final_suspend() noexcept { return {}; }
```


## ğŸ§© ç¬¬å››æ­¥ï¼š`Task` ç±»çš„è®¾è®¡ä¸å¤–éƒ¨æ¥å£åˆ†æ

### ğŸ¯ ç›®æ ‡

`Task` å°è£…äº†åç¨‹è¿è¡Œçš„æ•´ä¸ªè¿‡ç¨‹ï¼Œä¸ºç”¨æˆ·æä¾›ä¸‰ä¸ªä¸»è¦æ¥å£ï¼š

* `next()`ï¼šé©±åŠ¨åç¨‹å‘å‰æ‰§è¡Œï¼Œæ‹¿åˆ° `co_yield` å‡ºæ¥çš„å€¼ã€‚
* `result()`ï¼šåœ¨åç¨‹æ‰§è¡Œç»“æŸåæ‹¿åˆ°æœ€ç»ˆ `co_return` çš„è¿”å›å€¼ã€‚
* `resume()`ï¼šç›´æ¥æ¢å¤åç¨‹ï¼ˆä½†ä¸é€‚ç”¨äº yield æ§åˆ¶æµç¨‹ï¼‰ã€‚

---

## âœ³ï¸ æ„é€ å‡½æ•°ä¸ææ„å‡½æ•°è®¾è®¡

```cpp
Task(handle_type handle) : m_handle(handle) {}
~Task() {
  m_handle.destroy();
}
```

* æ„é€ ï¼šä¼ å…¥å¥æŸ„ï¼Œä¿å­˜åˆ°æˆå‘˜å˜é‡ä¸­ã€‚
* ææ„ï¼šé”€æ¯å¥æŸ„ï¼ˆæ„å‘³ç€é”€æ¯åç¨‹å¸§ï¼Œé‡Šæ”¾å †ä¸Šå†…å­˜ï¼‰ã€‚

â—ï¸æ³¨æ„ï¼š

> `std::coroutine_handle::destroy()` ä¼šè°ƒç”¨ `operator delete` æ¥é‡Šæ”¾åç¨‹å¸§ï¼Œå› æ­¤æ¯ä¸€ä¸ªåç¨‹çš„æœ€ç»ˆé”€æ¯éƒ½å¿…é¡»ç”±ç”¨æˆ·è´Ÿè´£ï¼

---

## ğŸ” ç§»åŠ¨æ„é€ ä¸ç§»åŠ¨èµ‹å€¼

```cpp
Task(Task&& other) : m_handle(other.m_handle) {
  other.m_handle = nullptr;
}

Task& operator=(Task&& other) {
  if (m_handle) {
    m_handle.destroy(); // é‡Šæ”¾åŸèµ„æº
  }
  m_handle = other.m_handle;
  other.m_handle = nullptr;
  return *this;
}
```

âœ… æ”¯æŒç§»åŠ¨æ„é€ /èµ‹å€¼ï¼›
ğŸš« ç¦æ­¢æ‹·è´æ„é€ /èµ‹å€¼ï¼›

ç›®çš„æ˜¯ï¼š

* é¿å…å¥æŸ„é‡å¤ææ„ï¼›
* å¼ºåˆ¶ä½ åœ¨æ˜ç¡®éœ€è¦æ—¶æ‰ç§»åŠ¨æ‰€æœ‰æƒã€‚

---

## ğŸš€ å…³é”®å‡½æ•°ä¸€ï¼š`next()` â€” é©±åŠ¨åç¨‹

```cpp
std::optional<int> next() {
  promise_type &p = m_handle.promise(); // å–å‡º promise

  p.m_yield = std::nullopt; // å…ˆæ¸…é™¤ä¸Šä¸€æ¬¡ yield å€¼
  p.m_exception = nullptr;  // æ¸…é™¤ä¸Šä¸€æ¬¡å¼‚å¸¸

  if (!m_handle.done()) {
    m_handle.resume(); // æ¢å¤åç¨‹è¿è¡Œ
  }

  if (p.m_exception) {
    std::rethrow_exception(p.m_exception);
  }

  return p.m_yield; // è¿”å›æ–°çš„ yield å€¼
}
```

### æ ¸å¿ƒæµç¨‹ï¼š

1. æ¸…ç©ºæ—§çš„ `yield` å€¼ï¼Œå‡†å¤‡è·å–æ–°çš„ã€‚
2. å¦‚æœåç¨‹è¿˜æ²¡ç»“æŸï¼ˆ`!done()`ï¼‰ï¼Œå°±è°ƒç”¨ `resume()`ï¼Œç»§ç»­è¿è¡Œã€‚
3. è‹¥åç¨‹æŠ›å‡ºå¼‚å¸¸ï¼Œé€šè¿‡ `promise.m_exception` é‡æ–°æŠ›å‡ºã€‚
4. è¿”å›è¿™æ¬¡ `co_yield` çš„å€¼ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚

---

## ğŸ“¦ å…³é”®å‡½æ•°äºŒï¼š`result()` â€” è·å–è¿”å›å€¼

```cpp
std::optional<std::string> result() {
  return m_handle.promise().m_result;
}
```

åç¨‹æ‰§è¡Œåˆ° `co_return` æ—¶ï¼Œä¼šé€šè¿‡ `promise_type::return_value()` å­˜å‚¨è¿”å›å€¼ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥è®¿é—®ã€‚

---

## ğŸŒ€ ç¬¬äº”æ­¥ï¼šrun() åç¨‹å‡½æ•°åˆ†æ

```cpp
Task run(int i) {
  std::cout << "task " << i << " start" << std::endl;
  co_yield 1;
  for (int i = 2; i <= 5; i++) {
    co_yield i;
  }
  std::cout << "task " << i << " end" << std::endl;
  co_return "task run finish";
}
```

è¿™å°±æ˜¯ä¸€ä¸ªçœŸæ­£çš„ **åç¨‹å‡½æ•°**ã€‚å› ä¸ºå®ƒåŒ…å«äº† `co_yield` å’Œ `co_return`ï¼Œæ‰€ä»¥ä¼šè¢«ç¼–è¯‘å™¨è§†ä¸ºåç¨‹ã€‚

### ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆé€»è¾‘å¦‚ä¸‹ï¼š

1. ç¼–è¯‘å™¨åˆ›å»º `promise_type` å¯¹è±¡ã€‚
2. è°ƒç”¨ `promise.get_return_object()` â†’ æ„é€  `Task`ã€‚
3. è°ƒç”¨ `initial_suspend()` â†’ æ§åˆ¶æ˜¯å¦ç«‹åˆ»æŒ‚èµ·ï¼ˆæœ¬ä¾‹ä¸­ç«‹åˆ»æŒ‚èµ·ï¼‰ã€‚
4. `next()` é©±åŠ¨åç¨‹æ‰§è¡Œï¼š

   * æ‰§è¡Œåˆ° `co_yield` â†’ æ‰§è¡Œ `yield_value()` â†’ è¿”å›å€¼ç»™è°ƒç”¨è€…ã€‚
   * ä¸‹ä¸€æ¬¡ resume ä» `co_yield` ä¹‹åç»§ç»­è¿è¡Œã€‚
5. æ‰§è¡Œ `co_return` â†’ æ‰§è¡Œ `return_value()`ã€‚
6. è¿è¡Œ `final_suspend()`ï¼Œåç¨‹æš‚åœä½†ä¸ç«‹å³é”€æ¯ã€‚

---

## ğŸ¬ æœ€åä¸€æ­¥ï¼š`main()` ä¸­çš„è¿è¡Œé€»è¾‘

```cpp
int main() {
  auto task = run(5);
  std::optional<int> val;
  while ((val = task.next())) {
    std::cout << "get yield value: " << (*val) << std::endl;
  }
  std::cout << "get return value: " << (*task.result()) << std::endl;
}
```

### è¿è¡Œæµç¨‹åˆ†æï¼š

1. è°ƒç”¨ `run(5)` â†’ åˆ›å»ºåç¨‹ï¼Œè¿”å› `Task` å¯¹è±¡ï¼Œä½†åç¨‹æ²¡æœ‰å¼€å§‹æ‰§è¡Œï¼ˆå› ä¸º `initial_suspend()` è¿”å›äº† suspendï¼‰ã€‚
2. `task.next()`ï¼š

   * æ¢å¤åç¨‹ï¼Œå¼€å§‹æ‰§è¡Œï¼›
   * æ‰“å° `task 5 start`ï¼›
   * æ‰§è¡Œ `co_yield 1`ï¼Œä¿å­˜ yield å€¼ï¼ŒæŒ‚èµ·ï¼›
   * `next()` è¿”å› 1ï¼›
   * è¾“å‡º `get yield value: 1`
3. ä¸‹ä¸€è½® `task.next()`ï¼š

   * æ¢å¤åç¨‹ï¼›
   * è¿›å…¥ for å¾ªç¯ï¼Œyield 2 â†’ yield 3 â†’ ... â†’ yield 5ï¼›
   * æ¯æ¬¡éƒ½æŒ‚èµ·å¹¶è¿”å›ä¸€ä¸ªå€¼ï¼›
   * æ‰“å°å¯¹åº”å€¼ã€‚
4. æœ€åä¸€æ¬¡ resumeï¼š

   * æ‰“å° `task 5 end`ï¼›
   * æ‰§è¡Œ `co_return "task run finish"`ï¼›
   * è¿›å…¥ `final_suspend()` æŒ‚èµ·ï¼›
   * `next()` è¿”å›ç©ºã€‚
5. `result()` è¿”å›æœ€ç»ˆå­—ç¬¦ä¸²ã€‚

---

## ğŸ§  æ€»ç»“çŸ¥è¯†ç‚¹

| çŸ¥è¯†ç‚¹                                     | è¯´æ˜                                    |
| --------------------------------------- | ------------------------------------- |
| åç¨‹å‡½æ•°ç­¾å                                  | è‡ªåŠ¨ç”±ç¼–è¯‘å™¨è½¬åŒ–ä¸ºçŠ¶æ€æœº                          |
| `promise_type`                          | ç®¡ç†åç¨‹çŠ¶æ€ã€è¿”å›å€¼ã€å¼‚å¸¸ã€yield å€¼                 |
| `co_yield` / `co_return`                | è§¦å‘ `yield_value()` å’Œ `return_value()` |
| `coroutine_handle`                      | æ§åˆ¶ resume/destroyï¼Œè®¿é—® promise          |
| `initial_suspend()` / `final_suspend()` | æ§åˆ¶åç¨‹ä½•æ—¶æŒ‚èµ·                              |
| å †ä¸Šåç¨‹å¸§                                   | è‡ªåŠ¨æ„å»ºï¼Œæ‰‹åŠ¨é‡Šæ”¾ï¼ˆ`destroy()`ï¼‰                |
| `std::optional`                         | å¤„ç† yield/return çš„å¯ç©ºè¯­ä¹‰                 |

---

è¿™æ˜¯ä¸€ä¸ªé«˜åº¦æ‰‹å·¥æ§åˆ¶çš„åç¨‹å®ç°æ–¹å¼ï¼Œåœ¨å­¦ä¹  C++20 åç¨‹æœºåˆ¶æ—¶éå¸¸é€‚åˆç”¨æ¥äº†è§£åº•å±‚è¿è¡Œé€»è¾‘ã€‚å¦‚æœä½ åç»­è¦å†™åç¨‹è°ƒåº¦å™¨ã€ä»»åŠ¡ç³»ç»Ÿã€å¼‚æ­¥æ¡†æ¶ï¼ŒæŒæ¡è¿™ä¸€å±‚çŸ¥è¯†è‡³å…³é‡è¦ã€‚

# éƒ¨åˆ†æ‰§è¡Œæµç¨‹è¯¦è§£

å¥½é—®é¢˜ï¼

ä½ é—®çš„æ˜¯ï¼š

> `m_handle.done()` ä»€ä¹ˆæ—¶å€™ä¼šè¿”å› `true`ï¼Ÿ

è¿™ä¸ªæ˜¯ C++20 åç¨‹ä¸­éå¸¸å…³é”®çš„æœºåˆ¶ï¼Œæˆ‘ä»¬æ¥ **è¯¦ç»†è§£é‡Š `std::coroutine_handle::done()` çš„è¯­ä¹‰ã€ä½œç”¨æ—¶æœºï¼Œä»¥åŠä½ ç»™å‡ºçš„åç¨‹ä¸­å®ƒä½•æ—¶ä¸ºçœŸ**ã€‚

---

## âœ… ä¸€ã€`std::coroutine_handle::done()` æ˜¯ä»€ä¹ˆï¼Ÿ

```cpp
bool std::coroutine_handle::done() const noexcept;
```

è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯åˆ¤æ–­ï¼š

> **åç¨‹æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆï¼Œä¸èƒ½å† resumeã€‚**

* å¦‚æœåç¨‹è¿˜æ²¡æœ‰è¿è¡Œå®Œï¼Œåˆ™ `done() == false`
* å¦‚æœåç¨‹å·²ç»ï¼š

  * æ­£å¸¸è¿è¡Œåˆ° `co_return`
  * æˆ–è€…æŠ›å‡ºå¼‚å¸¸ä¸”æœªæ¢å¤
  * æˆ–è€…æ•´ä¸ªçŠ¶æ€æœºèµ°åˆ°ç»ˆæ­¢çŠ¶æ€

  é‚£ä¹ˆå°±ä¼šå˜æˆ **å®ŒæˆçŠ¶æ€ï¼ˆdoneï¼‰**ï¼Œæ­¤æ—¶ï¼š

  ```cpp
  handle.done() == true
  ```

---

## âœ… äºŒã€åç¨‹å®ŒæˆçŠ¶æ€çš„åˆ¤æ–­æ ‡å‡†

`done()` çš„åˆ¤æ–­å’Œ `final_suspend()` æœ‰å¼ºç›¸å…³å…³ç³»ã€‚

### â–¶ï¸ åç¨‹ç”Ÿå‘½å‘¨æœŸï¼ˆæ ¸å¿ƒæµç¨‹ï¼‰ï¼š

1. åˆ›å»ºåç¨‹å¸§ï¼›
2. `initial_suspend()` â†’ suspendï¼ˆæŒ‚èµ·ï¼‰ï¼›
3. è°ƒç”¨ `resume()`ï¼š

   * è¿è¡Œåç¨‹é€»è¾‘ï¼›
   * é‡åˆ° `co_yield` â†’ æ‰§è¡Œ `yield_value()` â†’ å†æ¬¡ suspendï¼›
   * resume â†’ ç»§ç»­æ‰§è¡Œåç»­é€»è¾‘ï¼›
4. é‡åˆ° `co_return` æˆ–é€»è¾‘æœ«å°¾ï¼š

   * è°ƒç”¨ `return_value()`ï¼ˆæˆ– `return_void()`ï¼‰ï¼›
   * è·³è½¬åˆ° `final_suspend()`ï¼›
   * å¦‚æœ `final_suspend()` è¿”å› `suspend_always`ï¼Œé‚£ä¹ˆæ­¤æ—¶åç¨‹ä»ç„¶æŒ‚èµ·ï¼Œä½†é€»è¾‘ä¸Šå·²å®Œæˆï¼›
5. å¦‚æœå†æ¬¡ resumeï¼Œè¿è¡Œå®Œæˆ `final_suspend()` åï¼Œå°±å˜æˆ `done()` ä¸º trueã€‚

---

## âœ… ä¸‰ã€ç»“åˆä½ çš„ä»£ç åˆ†æ `done()` ä¸º true çš„æ—¶æœº

çœ‹ä½ çš„åç¨‹å‡½æ•°ï¼š

```cpp
Task run(int i) {
  std::cout << "task " << i << " start" << std::endl;
  co_yield 1;
  for (int i = 2; i <= 5; i++) {
    co_yield i;
  }
  std::cout << "task " << i << " end" << std::endl;
  co_return "task run finish";
}
```

åç¨‹æ‰§è¡Œé¡ºåºæ˜¯ï¼š

| æ¬¡æ•°         | æ‰§è¡Œè¯­å¥                                          | è¯´æ˜                |
| ---------- | --------------------------------------------- | ----------------- |
| 1st        | æ‰“å° start + `co_yield 1`                       | yield 1ï¼ŒæŒ‚èµ·        |
| 2nd        | `co_yield 2`                                  | yield 2ï¼ŒæŒ‚èµ·        |
| 3rd\~5th   | yield 3 â†’ yield 4 â†’ yield 5                   | æ¯æ¬¡æŒ‚èµ·              |
| 6th        | æ‰“å° end â†’ `co_return "..."`                    | è¿›å…¥ final\_suspend |
| 7th resume | resume å®Œ final\_suspendï¼Œ**æ­¤æ—¶ done() == true** |                   |

---

## âœ… å››ã€ç¤ºæ„å›¾è¯´æ˜

```text
            +----------------------+
            | initial_suspend()    |
            | return suspend_always|
            +----------------------+
                       |
                       v
               ç”¨æˆ·è°ƒç”¨ resume()
                       |
                       v
            +----------------------+
            | run() æ‰§è¡Œä¸»ä½“é€»è¾‘   |
            | è§¦å‘ co_yield         |
            +----------------------+
                       |
                       v
            +----------------------+
            | yield_value()        |
            | return suspend_always|
            +----------------------+
                       |
            (resume again ç»§ç»­ run)
                       |
                       v
            +----------------------+
            | run åˆ° co_return     |
            | è°ƒç”¨ return_value()  |
            +----------------------+
                       |
                       v
            +----------------------+
            | final_suspend()      |
            | return suspend_always|
            +----------------------+
                       |
            (æœ€åä¸€æ¬¡ resume)
                       |
                       v
               åç¨‹å½»åº•ç»“æŸï¼Œdone() == true
```

---

## âœ… äº”ã€ç»“è®º

> `m_handle.done()` ä¼šåœ¨åç¨‹ **å®Œå…¨æ‰§è¡Œå®Œæ¯•** å¹¶ä¸”å·²ç»ä» `final_suspend()` resume åå˜æˆ `true`ã€‚

æ‰€ä»¥ä½ åœ¨ `next()` é‡Œè¿™æ ·å†™æ˜¯åˆç†çš„ï¼š

```cpp
if (!m_handle.done()) {
    m_handle.resume(); // å¦‚æœæ²¡ç»“æŸï¼Œå°±ç»§ç»­æ‰§è¡Œ
}
```

ä¸€æ—¦åç¨‹ç»“æŸï¼Œåç»­è°ƒç”¨ `resume()` ä¼šæ˜¯ undefined behaviorï¼ˆUBï¼‰ï¼Œæ‰€ä»¥å¿…é¡»ç”¨ `done()` ä¿æŠ¤ã€‚

---

å¦‚æœä½ æƒ³éªŒè¯ `done()` çš„å˜åŒ–è¿‡ç¨‹ï¼Œä½ å¯ä»¥åœ¨ `next()` ä¸­æ‰“å°ï¼š

```cpp
std::cout << "done before resume: " << std::boolalpha << m_handle.done() << std::endl;
```

ä½ ä¼šå‘ç°æœ€åä¸€æ¬¡è°ƒç”¨å®Œ resume åå®ƒæ‰å˜æˆ `true`ã€‚

---

éœ€è¦æˆ‘è¡¥å……ï¼š

* `co_await` æƒ…å†µä¸‹çš„ `done()` æœºåˆ¶ï¼›
* `suspend_never` ä¸ `suspend_always` å¯¹åç¨‹çŠ¶æ€çš„å½±å“ï¼›
* yield å’Œ return å…±å­˜æ—¶å¯¹ resume è¯­ä¹‰çš„æ§åˆ¶ï¼›

éƒ½å¯ä»¥ç»§ç»­é—®ã€‚


##  ==runå‡½æ•°çš„ä½œç”¨==

éå¸¸æ£’çš„é—®é¢˜ï¼è¿™ä¸ªé—®é¢˜çœ‹èµ·æ¥ç®€å•ï¼Œä½†å®é™…ä¸Šæ¶‰åŠ C++20 åç¨‹çš„åº•å±‚ **ç”Ÿå‘½å‘¨æœŸæ„é€ è¿‡ç¨‹ã€ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆé€»è¾‘** å’Œä½ è‡ªå·±å®šä¹‰çš„ `Task` ç±»å‹è¡Œä¸ºã€‚

---

## ğŸŒŸ é—®é¢˜ï¼š

```cpp
auto task = run(5);
```

è¿™æ˜¯åç¨‹çš„åˆ›å»ºè¯­å¥ã€‚é‚£ä¹ˆï¼Œ**åœ¨è¿™ä¸€è¡Œæ‰§è¡Œçš„è¿‡ç¨‹ä¸­åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**

---

## ğŸ§  ç­”æ¡ˆæ¦‚è¦ï¼š

> å½“æ‰§è¡Œ `auto task = run(5);` è¿™ä¸€æ­¥æ—¶ï¼Œ**åç¨‹æ²¡æœ‰çœŸæ­£è¿è¡Œèµ·æ¥ï¼Œåªæ˜¯è¢«æ„é€ å‡ºæ¥ï¼Œè¿›å…¥äº†åˆå§‹æŒ‚èµ·çŠ¶æ€ã€‚**
>
> ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç”Ÿæˆï¼š
>
> 1. `promise_type` å¯¹è±¡ï¼›
> 2. åç¨‹å¸§ï¼ˆåœ¨å †ä¸Šï¼‰ï¼›
> 3. è°ƒç”¨ `get_return_object()` åˆ›å»º `Task`ï¼›
> 4. è°ƒç”¨ `initial_suspend()` â†’ è¿”å› `suspend_always`ï¼Œæ‰€ä»¥åç¨‹æŒ‚èµ·ï¼›
> 5. æœ€åè¿”å›ä½ è‡ªå®šä¹‰çš„ `Task` å¯¹è±¡ã€‚

---

## ğŸ”¬ è¯¦ç»†æ­¥éª¤ï¼ˆç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„é€»è¾‘ï¼‰

ä½ å®šä¹‰çš„ `run()` æ˜¯ä¸€ä¸ªåç¨‹å‡½æ•°ï¼Œå› ä¸ºé‡Œé¢ç”¨äº† `co_yield` å’Œ `co_return`ã€‚

```cpp
Task run(int i);
```

æ‰§è¡Œ `run(5)` æ—¶ï¼Œ**å‘ç”Ÿäº†ä¸‹é¢è¿™äº›è‡ªåŠ¨åŒ–è¿‡ç¨‹**ï¼Œå…¨éƒ¨ç”±ç¼–è¯‘å™¨ç”Ÿæˆï¼š

---

### âœ… ç¬¬ä¸€æ­¥ï¼šåˆ›å»º `promise_type` å¯¹è±¡

ç¼–è¯‘å™¨ç”Ÿæˆä¸€æ®µä»£ç é€»è¾‘ç›¸å½“äºï¼š

```cpp
Task::promise_type promise; // æœ¬è´¨æ˜¯ new å‡ºæ¥çš„ï¼ˆåœ¨åç¨‹å¸§é‡Œï¼‰
```

* è¿™ä¸ªå¯¹è±¡æ˜¯åç¨‹è¿è¡Œçš„â€œä¸­æ§â€ï¼Œåç»­æ‰€æœ‰çŠ¶æ€éƒ½ç»‘å®šåœ¨è¿™é‡Œã€‚

---

### âœ… ç¬¬äºŒæ­¥ï¼šæ„é€ åç¨‹å¸§ï¼Œå¹¶ç”Ÿæˆ `coroutine_handle`

ç¼–è¯‘å™¨ä¸ºåç¨‹å¸§åˆ†é…å†…å­˜ï¼ˆé»˜è®¤åœ¨ **å †ä¸Š**ï¼‰ï¼Œåç¨‹å¸§ä¸­åŒ…å«ï¼š

* å±€éƒ¨å˜é‡çŠ¶æ€
* å½“å‰æŒ‡ä»¤ä½ç½®
* `promise_type` å®ä¾‹

ç„¶åè·å–ä¸€ä¸ª `coroutine_handle`ï¼š

```cpp
auto handle = std::coroutine_handle<promise_type>::from_promise(promise);
```

> æœ¬è´¨ä¸Šå°±æ˜¯ `coroutine_handle` æ˜¯æŒ‡å‘åç¨‹å¸§çš„æŒ‡é’ˆï¼Œè€Œå¸§é‡Œæœ‰ `promise_type`ã€‚

---

### âœ… ç¬¬ä¸‰æ­¥ï¼šè°ƒç”¨ `promise.get_return_object()`ï¼Œè·å–è¿”å›å¯¹è±¡

ä½ åœ¨ `promise_type` é‡Œå®šä¹‰äº†è¿™ä¸ªæ–¹æ³•ï¼š

```cpp
Task get_return_object() {
    auto handle = handle_type::from_promise(*this);
    return Task(handle);
}
```

å®ƒä¼šæ„é€ ä½ è‡ªå®šä¹‰çš„ `Task` å¯¹è±¡ï¼ŒæŠŠåç¨‹å¥æŸ„åŒ…è£…è¿›å»ã€‚

---

### âœ… ç¬¬å››æ­¥ï¼šè°ƒç”¨ `promise.initial_suspend()`

```cpp
constexpr std::suspend_always initial_suspend() { return {}; }
```

è¡¨ç¤ºåç¨‹åˆ›å»ºå**ç«‹å³æŒ‚èµ·**ï¼Œä¸è‡ªåŠ¨è¿è¡Œï¼Œéœ€è¦æ‰‹åŠ¨ resumeã€‚

æ‰€ä»¥åç¨‹æœ¬ä½“ `run()` çš„è¯­å¥éƒ½è¿˜æ²¡æœ‰å¼€å§‹æ‰§è¡Œï¼ˆåŒ…æ‹¬ `std::cout << "task 5 start"` ä¹Ÿæ²¡æ‰“å°ï¼‰ã€‚

---

### âœ… ç¬¬äº”æ­¥ï¼šè¿”å› `Task` å¯¹è±¡ï¼ˆæ•´ä¸ªè¡¨è¾¾å¼ç»“æœï¼‰

```cpp
Task task = run(5);  // æ‰§è¡Œå®Œä¸Šé¢æ‰€æœ‰æ­¥éª¤åï¼Œtask è¢«èµ‹å€¼
```

ä½ å¾—åˆ°çš„ `Task` å¯¹è±¡é‡Œï¼š

* `m_handle` æŒ‡å‘åç¨‹å¸§ï¼›
* åç¨‹å°šæœªå¼€å§‹è¿è¡Œï¼›
* å¯ä»¥é€šè¿‡ `task.next()` æ¥é€æ­¥ resume æ‰§è¡Œã€‚

---

## ğŸ“Œ å›¾è§£åç¨‹åˆ›å»ºè¿‡ç¨‹

```text
run(5)
  |
  |-- create promise_type
  |
  |-- create coroutine frame (å †ä¸Š)
  |
  |-- get coroutine_handle from promise
  |
  |-- call promise.get_return_object()
  |     -> return Task(handle)
  |
  |-- call promise.initial_suspend()
        -> suspend_always â†’ åç¨‹æš‚åœ
  |
  |-- è¿”å› Task
```

---

## ğŸ§ª éªŒè¯ï¼šåç¨‹æ²¡æœ‰ç«‹å³è¿è¡Œ

ä½ å¯ä»¥åœ¨ `run()` å‡½æ•°çš„ç¬¬ä¸€å¥æ‰“å°ï¼š

```cpp
std::cout << "task " << i << " start" << std::endl;
```

å³ä½¿ä½ å†™äº†è¿™å¥ï¼Œä¹Ÿä¸ä¼šåœ¨ `auto task = run(5);` è¿™ä¸€æ­¥æ‰“å°ä»»ä½•ä¸œè¥¿ã€‚

ç›´åˆ°ä½ æ‰§è¡Œï¼š

```cpp
task.next();
```

åç¨‹æ‰çœŸæ­£æ¢å¤ã€æ‰§è¡Œåˆ°ç¬¬ä¸€ä¸ª `co_yield` å¹¶æŒ‚èµ·ã€‚

---

## ğŸ”š å°ç»“

æ‰§è¡Œ `auto task = run(5);` æ—¶å‘ç”Ÿäº†ä»¥ä¸‹äº‹ä»¶ï¼š

| æ­¥éª¤  | åŠ¨ä½œ                                   |
| --- | ------------------------------------ |
| â‘    | ç¼–è¯‘å™¨æ„é€  `promise_type`                 |
| â‘¡   | åˆ›å»ºåç¨‹å¸§ï¼ˆå †åˆ†é…ï¼‰                           |
| â‘¢   | ç”Ÿæˆåç¨‹å¥æŸ„ï¼ˆæŒ‡å‘å¸§ï¼‰                          |
| â‘£   | è°ƒç”¨ `get_return_object()` â†’ è¿”å› `Task` |
| â‘¤   | è°ƒç”¨ `initial_suspend()` â†’ åç¨‹è‡ªåŠ¨æŒ‚èµ·      |
| âœ…   | `run()` æ²¡æœ‰æ‰§è¡Œä»»ä½•è¯­å¥ï¼Œåç¨‹å°šæœªå¼€å§‹              |

# promise: åç¨‹æ ¸å¿ƒ

è¿™æ®µè¯ä¸»è¦è§£é‡Šäº†C++åç¨‹ä¸­**promiseå¯¹è±¡çš„æ„é€ é€»è¾‘**ï¼Œä»¥åŠä¸ºä»€ä¹ˆåç¨‹çš„å‚æ•°åˆ—è¡¨ä¼šä¸promiseçš„æ„é€ å‡½æ•°å…³è”ï¼Œæ ¸å¿ƒæ˜¯ä¸ºäº†è®©promiseèƒ½è·å–åç¨‹è¿è¡Œæ‰€éœ€çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ™®é€šå‚æ•°å’Œæˆå‘˜å‡½æ•°çš„`this`æŒ‡é’ˆï¼‰ã€‚


### å…ˆæ‹†è§£æ ¸å¿ƒé€»è¾‘ï¼špromiseçš„æ„é€ è§„åˆ™
å½“ä½ è°ƒç”¨ä¸€ä¸ªåç¨‹æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå…ˆåœ¨åç¨‹å¯¹åº”çš„`promise_type`ï¼ˆåç¨‹å¿…é¡»å…³è”çš„ç±»å‹ï¼‰ä¸­åˆ›å»ºä¸€ä¸ª`promise`å¯¹è±¡ï¼ˆå­˜æ”¾åœ¨åç¨‹å¸§ä¸­ï¼‰ã€‚è¿™ä¸ª`promise`å¯¹è±¡çš„æ„é€ å‡½æ•°é€‰æ‹©éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š
1. ä¼˜å…ˆåŒ¹é…**åç¨‹çš„å‚æ•°åˆ—è¡¨**ä¸`promise`çš„æ„é€ å‡½æ•°å‚æ•°åˆ—è¡¨ï¼ˆå‚æ•°ç±»å‹å¯è½¬æ¢å³å¯ï¼Œä¸å¿…å®Œå…¨ä¸€è‡´ï¼‰ï¼›
2. è‹¥åŒ¹é…å¤±è´¥ï¼Œå†çœ‹`promise`æ˜¯å¦æœ‰**æ— å‚æ„é€ å‡½æ•°**ï¼Œæœ‰åˆ™ç”¨å®ƒï¼›
3. è‹¥å‰ä¸¤è€…éƒ½ä¸æ»¡è¶³ï¼Œç¼–è¯‘æŠ¥é”™ã€‚


### å…³é”®ï¼šä¸ºä»€ä¹ˆåç¨‹å‚æ•°è¦å’Œpromiseæ„é€ å‡½æ•°å…³è”ï¼Ÿ
æ ¸å¿ƒç›®çš„æ˜¯è®©`promise`å¯¹è±¡åœ¨åˆ›å»ºæ—¶å°±èƒ½æ‹¿åˆ°åç¨‹è¿è¡Œæ‰€éœ€çš„**ä¸Šä¸‹æ–‡ä¿¡æ¯**ã€‚è¿™äº›ä¿¡æ¯å¯èƒ½æ˜¯ï¼š
- æ™®é€šåç¨‹çš„å‚æ•°ï¼ˆå¦‚å‡½æ•°å‚æ•°ï¼‰ï¼›
- æˆå‘˜å‡½æ•°ä½œä¸ºåç¨‹æ—¶çš„`this`æŒ‡é’ˆï¼ˆç±»çš„ä¸Šä¸‹æ–‡ï¼‰ã€‚


### é‡ç‚¹ç†è§£ï¼šæˆå‘˜å‡½æ•°ä½œä¸ºåç¨‹çš„åœºæ™¯
åœ¨C++ä¸­ï¼Œç±»çš„æˆå‘˜å‡½æ•°è°ƒç”¨æ—¶ä¼š**éšå¼ä¼ é€’`this`æŒ‡é’ˆ**ï¼ˆç¼–è¯‘å™¨å±‚é¢ï¼Œæˆå‘˜å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å…¶å®æ˜¯`ç±»å* this`ï¼Œåªæ˜¯ç”¨æˆ·ä¸ç”¨æ˜¾å¼å†™ï¼‰ã€‚

å½“æˆå‘˜å‡½æ•°æ˜¯åç¨‹æ—¶ï¼Œè¿™ä¸ª`this`æŒ‡é’ˆå¯¹åç¨‹è‡³å…³é‡è¦â€”â€”åç¨‹éœ€è¦é€šè¿‡`this`è®¿é—®ç±»çš„æˆå‘˜å˜é‡å’Œå…¶ä»–æ–¹æ³•ã€‚å› æ­¤ï¼Œç¼–è¯‘å™¨å¿…é¡»æŠŠ`this`æŒ‡é’ˆä¼ é€’ç»™`promise`å¯¹è±¡ï¼Œè€Œä¼ é€’çš„æ–¹å¼å°±æ˜¯é€šè¿‡`promise`çš„æ„é€ å‡½æ•°ã€‚

#### ç¤ºä¾‹è¯´æ˜
å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç±»`MyClass`ï¼Œå…¶ä¸­çš„æˆå‘˜å‡½æ•°`coro_func`æ˜¯åç¨‹ï¼š
```cpp
class MyClass {
private:
    int value = 100; // ç±»çš„æˆå‘˜å˜é‡
public:
    // åç¨‹ï¼ˆæˆå‘˜å‡½æ•°ï¼‰
    MyCoro coro_func(int x) {
        co_return value + x; // åç¨‹ä¸­éœ€è¦è®¿é—®this->value
    }
};
```

ä»ç¼–è¯‘å™¨è§†è§’çœ‹ï¼Œè¿™ä¸ªåç¨‹çš„å‚æ•°åˆ—è¡¨å…¶å®æ˜¯`(MyClass* this, int x)`ï¼ˆ`this`æ˜¯éšå¼çš„ï¼‰ã€‚ä¸ºäº†è®©`promise`èƒ½æ‹¿åˆ°`this`ï¼ˆå¦åˆ™åç¨‹æ— æ³•è®¿é—®`value`ï¼‰ï¼Œ`promise_type`çš„æ„é€ å‡½æ•°å¿…é¡»æ¥å—`MyClass*`å’Œ`int`ä½œä¸ºå‚æ•°ï¼š
```cpp
struct MyCoro::promise_type {
    MyClass* self; // å­˜å‚¨thisæŒ‡é’ˆ
    int x;         // å­˜å‚¨åç¨‹å‚æ•°x

    // æ„é€ å‡½æ•°ï¼šæ¥æ”¶thisæŒ‡é’ˆå’Œåç¨‹å‚æ•°x
    promise_type(MyClass* t, int arg) : self(t), x(arg) {}

    // ... å…¶ä»–å¿…è¦æˆå‘˜ï¼ˆå¦‚get_return_objectã€initial_suspendç­‰ï¼‰
};
```

è¿™æ ·ï¼Œå½“`MyClass`çš„å¯¹è±¡è°ƒç”¨`coro_func(5)`æ—¶ï¼Œç¼–è¯‘å™¨ä¼šï¼š
1. è¯†åˆ«åç¨‹çš„å®é™…å‚æ•°æ˜¯`(thisæŒ‡é’ˆ, 5)`ï¼›
2. ç”¨`promise_type(MyClass* t, int arg)`æ„é€ `promise`å¯¹è±¡ï¼Œå°†`this`å’Œ`5`ä¼ å…¥ï¼›
3. `promise`ä¸­å­˜å‚¨äº†`self`ï¼ˆ`this`æŒ‡é’ˆï¼‰ï¼Œåç¨‹è¿è¡Œæ—¶å°±èƒ½é€šè¿‡`self->value`è®¿é—®ç±»æˆå‘˜ã€‚


### æ€»ç»“
C++åç¨‹è®¾è®¡ä¸­ï¼Œâ€œåç¨‹å‚æ•°åˆ—è¡¨ä¸promiseæ„é€ å‡½æ•°å…³è”â€çš„æ ¸å¿ƒç›®çš„æ˜¯ï¼š  
è®©`promise`å¯¹è±¡åœ¨åˆ›å»ºæ—¶å°±èƒ½è·å–åç¨‹è¿è¡Œæ‰€éœ€çš„å…¨éƒ¨ä¸Šä¸‹æ–‡ï¼ˆæ™®é€šå‚æ•°æˆ–æˆå‘˜å‡½æ•°çš„`this`æŒ‡é’ˆï¼‰ï¼Œä»è€Œæ”¯æŒåç¨‹å¯¹è¿™äº›ä¿¡æ¯çš„è®¿é—®ï¼ˆæ¯”å¦‚æˆå‘˜å‡½æ•°åç¨‹è®¿é—®ç±»æˆå‘˜ï¼‰ã€‚è¿™æ˜¯C++é€šè¿‡â€œæ„é€ å‡½æ•°å‚æ•°åŒ¹é…â€å®ç°ä¸Šä¸‹æ–‡ä¼ é€’çš„è‡ªç„¶è®¾è®¡ã€‚
