
# C++ åç¨‹ï¼šç†è§£å¯¹ç§°æ€§åˆ‡æ¢ï¼ˆSymmetric Transferï¼‰

æœ¬æ–‡å‘è¡¨äº 2020 å¹´ 5 æœˆ 11 æ—¥

åç¨‹æŠ€æœ¯è§„èŒƒï¼ˆCoroutines TSï¼‰ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§æå¥½çš„æ–¹å¼ï¼Œå¯ä»¥åƒå†™åŒæ­¥ä»£ç ä¸€æ ·å»ç¼–å†™å¼‚æ­¥ä»£ç ã€‚ä½ åªéœ€è¦åœ¨åˆé€‚çš„ä½ç½®â€œæ’’â€ä¸Š `co_await`ï¼Œç¼–è¯‘å™¨å°±ä¼šè´Ÿè´£åœ¨åç¨‹æŒ‚èµ·æ—¶ä¿å­˜çŠ¶æ€ï¼Œå¹¶åœ¨æŒ‚èµ·ç‚¹ä¹‹é—´ä¿æŒçŠ¶æ€ï¼Œç­‰åˆ°æ“ä½œå®Œæˆåå†æ¢å¤åç¨‹çš„æ‰§è¡Œã€‚

ç„¶è€Œï¼ŒæŒ‰ç…§æœ€åˆçš„è§„èŒƒï¼ŒCoroutines TS å­˜åœ¨ä¸€ä¸ªå¾ˆç³Ÿç³•çš„é™åˆ¶ï¼Œå¦‚æœä¸å°å¿ƒå°±ä¼šå¯¼è‡´ **æ ˆæº¢å‡ºï¼ˆstack overflowï¼‰**ã€‚ä¸ºäº†é¿å…è¿™ç§æ ˆæº¢å‡ºï¼Œä½ ä¸å¾—ä¸åœ¨ `task<T>` ç±»å‹ä¸­å¼•å…¥é¢å¤–çš„åŒæ­¥å¼€é”€ï¼Œä»¥å®‰å…¨åœ°é˜²èŒƒè¿™ä¸€é—®é¢˜ã€‚

å¹¸è¿çš„æ˜¯ï¼Œ2018 å¹´å¯¹åç¨‹è®¾è®¡åšäº†ä¸€å¤„è°ƒæ•´ï¼Œå¼•å…¥äº†ä¸€ä¸ªåä¸º **â€œå¯¹ç§°è½¬ç§»â€ï¼ˆsymmetric transferï¼‰** çš„èƒ½åŠ›ï¼Œå®ƒå…è®¸åœ¨ä¸æ¶ˆè€—é¢å¤–æ ˆç©ºé—´çš„æƒ…å†µä¸‹ï¼Œä»ä¸€ä¸ªåç¨‹æŒ‚èµ·å¹¶ç›´æ¥æ¢å¤å¦ä¸€ä¸ªåç¨‹ã€‚è¿™ä¸ªèƒ½åŠ›çš„åŠ å…¥ï¼Œæ¶ˆé™¤äº† Coroutines TS ä¸­çš„ä¸€ä¸ªå…³é”®é™åˆ¶ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿæ›´ç®€å•ã€æ›´é«˜æ•ˆåœ°å®ç°å¼‚æ­¥åç¨‹ç±»å‹ï¼ŒåŒæ—¶ä¸ä¼šç‰ºç‰²é˜²æ­¢æ ˆæº¢å‡ºçš„å®‰å…¨æ€§ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¼šå°è¯•è§£é‡Šæ ˆæº¢å‡ºé—®é¢˜ï¼Œä»¥åŠè¿™ä¸ªå…³é”®çš„â€œå¯¹ç§°è½¬ç§»â€èƒ½åŠ›æ˜¯å¦‚ä½•è®©æˆ‘ä»¬è§£å†³å®ƒçš„ã€‚

---

## é¦–å…ˆä»‹ç»ä¸€ä¸‹ task åç¨‹æ˜¯å¦‚ä½•å·¥ä½œçš„

è€ƒè™‘ä¸‹é¢çš„åç¨‹ï¼š

```cpp
task foo() {
  co_return;
}

task bar() {
  co_await foo();
}
```

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„ `task` ç±»å‹ï¼Œå®ƒä¼šåœ¨å¦ä¸€ä¸ªåç¨‹ç­‰å¾…å®ƒï¼ˆ`co_await`ï¼‰æ—¶æ‰ä¼šå»¶è¿Ÿæ‰§è¡Œï¼ˆlazy executionï¼‰å…¶å‡½æ•°ä½“ã€‚è¿™ä¸ªç‰¹å®šçš„ `task` ç±»å‹ä¸æ”¯æŒè¿”å›å€¼ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æï¼Œå½“ `bar()` æ‰§è¡Œ `co_await foo()` æ—¶ï¼Œå‘ç”Ÿäº†ä»€ä¹ˆï¼š

1. **`bar()` è°ƒç”¨ `foo()`**
   æ³¨æ„ï¼Œå¯¹äºè°ƒç”¨æ–¹æ¥è¯´ï¼Œåç¨‹åªæ˜¯ä¸€ä¸ªæ™®é€šå‡½æ•°ã€‚

2. **`foo()` è°ƒç”¨è¿‡ç¨‹**

   * ä¸ºåç¨‹å¸§åˆ†é…å­˜å‚¨ç©ºé—´ï¼ˆé€šå¸¸æ˜¯åœ¨å †ä¸Šåˆ†é…ï¼‰
   * å°†å‚æ•°å¤åˆ¶åˆ°åç¨‹å¸§ï¼ˆè¿™é‡Œæ²¡æœ‰å‚æ•°ï¼Œæ‰€ä»¥æ˜¯ç©ºæ“ä½œï¼‰
   * åœ¨åç¨‹å¸§ä¸­æ„é€  promise å¯¹è±¡
   * è°ƒç”¨ `promise.get_return_object()` è·å– `foo()` çš„è¿”å›å€¼ã€‚è¿™ä¼šç”Ÿæˆä¸€ä¸ª `task` å¯¹è±¡ï¼Œå¹¶ç”¨ä¸€ä¸ªæŒ‡å‘åˆšåˆšåˆ›å»ºçš„åç¨‹å¸§çš„ `std::coroutine_handle` æ¥åˆå§‹åŒ–å®ƒã€‚
   * åœ¨åˆå§‹æŒ‚èµ·ç‚¹ï¼ˆå³ `{` å¤„ï¼‰æŒ‚èµ·åç¨‹æ‰§è¡Œ
   * å°† `task` å¯¹è±¡è¿”å›ç»™ `bar()`

3. **`bar()` å¯¹è¿”å›çš„ task è¿›è¡Œ `co_await`**

   * `bar()` åç¨‹æŒ‚èµ·ï¼Œç„¶åè°ƒç”¨è¯¥ task çš„ `await_suspend()` æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªæŒ‡å‘ `bar()` åç¨‹å¸§çš„ `std::coroutine_handle`ã€‚
   * `await_suspend()` æ–¹æ³•å°† `bar()` çš„å¥æŸ„ä¿å­˜åˆ° `foo()` çš„ promise å¯¹è±¡ä¸­ï¼Œç„¶åè°ƒç”¨ `foo()` çš„å¥æŸ„ `.resume()` æ¥æ¢å¤ `foo()` åç¨‹æ‰§è¡Œã€‚

4. **`foo()` æ‰§è¡Œ**

   * `foo()` åŒæ­¥æ‰§è¡Œå¹¶è¿è¡Œåˆ°ç»“æŸã€‚

5. **`foo()` åˆ°è¾¾æœ€ç»ˆæŒ‚èµ·ç‚¹**ï¼ˆå³ `}`ï¼‰

   * åœ¨ final suspend å¤„æŒ‚èµ·ï¼Œç„¶åæ¢å¤ promise ä¸­ä¿å­˜çš„åç¨‹å¥æŸ„ï¼Œä¹Ÿå°±æ˜¯ `bar()` åç¨‹ã€‚

6. **`bar()` æ¢å¤æ‰§è¡Œ**

   * ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°åˆ°è¾¾åŒ…å« `co_await` è¡¨è¾¾å¼çš„è¯­å¥æœ«å°¾ï¼Œæ­¤æ—¶ä¼šè°ƒç”¨ `foo()` è¿”å›çš„ä¸´æ—¶ `task` å¯¹è±¡çš„ææ„å‡½æ•°ã€‚

7. **`task` ææ„**

   * ææ„å‡½æ•°ä¼šè°ƒç”¨ `foo()` çš„åç¨‹å¥æŸ„ `.destroy()`ï¼Œé”€æ¯åç¨‹å¸§åŠå…¶ä¸­çš„ promise å¯¹è±¡å’Œå‚æ•°å‰¯æœ¬ã€‚

çœ‹èµ·æ¥ï¼Œä¸€ä¸ªç®€å•çš„è°ƒç”¨ä¹ŸåŒ…å«äº†å¾ˆå¤šæ­¥éª¤ã€‚

ä¸ºäº†æ›´æ·±å…¥ç†è§£ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹åœ¨ **æ²¡æœ‰å¯¹ç§°è½¬ç§»æ”¯æŒ** çš„ Coroutines TS è®¾è®¡ä¸‹ï¼Œä¸€ä¸ª `task` ç±»çš„ç®€å•å®ç°ä¼šæ˜¯ä»€ä¹ˆæ ·å­ã€‚

---

## `task` å®ç°å¤§çº²

ç±»çš„è½®å»“å¤§æ¦‚å¦‚ä¸‹ï¼š

```cpp
class task {
public:
  class promise_type { /* è§ä¸‹æ–‡ */ };

  task(task&& t) noexcept
  : coro_(std::exchange(t.coro_, {}))
  {}

  ~task() {
    if (coro_)
      coro_.destroy();
  }

  class awaiter { /* è§ä¸‹æ–‡ */ };

  awaiter operator co_await() && noexcept;

private:
  explicit task(std::coroutine_handle<promise_type> h) noexcept
  : coro_(h)
  {}

  std::coroutine_handle<promise_type> coro_;
};
```

ä¸€ä¸ª `task` å¯¹è±¡ç‹¬å ï¼ˆexclusive ownershipï¼‰æŒæœ‰ä¸€ä¸ª `std::coroutine_handle`ï¼Œå®ƒå¯¹åº”ç€è°ƒç”¨åç¨‹æ—¶åˆ›å»ºçš„åç¨‹å¸§ã€‚`task` æ˜¯ä¸€ä¸ª RAII å¯¹è±¡ï¼Œç¡®ä¿å½“å®ƒé”€æ¯æ—¶ï¼Œä¼šè°ƒç”¨ `.destroy()` æ¥é‡Šæ”¾åç¨‹å¸§ã€‚

ä¸‹é¢æˆ‘ä»¬å†å±•å¼€ `promise_type` çš„å®ç°ç»†èŠ‚ã€‚


---

## å®ç° `task::promise_type`

åœ¨[ä¸Šä¸€ç¯‡æ–‡ç« ](https://lewissbaker.github.io/2018/09/05/understanding-the-promise-type)ä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œ`promise_type` æˆå‘˜å®šä¹‰äº† **Promise** å¯¹è±¡çš„ç±»å‹ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šåœ¨åç¨‹å¸§ä¸­åˆ›å»ºï¼Œå¹¶ä¸”è´Ÿè´£æ§åˆ¶åç¨‹çš„è¡Œä¸ºã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®ç° `get_return_object()`ï¼Œç”¨äºåœ¨åç¨‹è¢«è°ƒç”¨æ—¶æ„é€ è¦è¿”å›çš„ `task` å¯¹è±¡ã€‚
è¿™ä¸ªæ–¹æ³•åªéœ€è¦ç”¨æ–°åˆ›å»ºçš„åç¨‹å¸§å¯¹åº”çš„ `std::coroutine_handle` æ¥åˆå§‹åŒ– `task` å³å¯ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `std::coroutine_handle::from_promise()` æ–¹æ³•ï¼Œé€šè¿‡ promise å¯¹è±¡æ¥ç”Ÿæˆè¿™æ ·çš„å¥æŸ„ã€‚

```cpp
class task::promise_type {
public:
  task get_return_object() noexcept {
    return task{std::coroutine_handle<promise_type>::from_promise(*this)};
  }
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¸Œæœ›åç¨‹åœ¨å‡½æ•°ä½“çš„èµ·å§‹ä½ç½®ï¼ˆ`{`ï¼‰å¤„ **åˆå§‹æŒ‚èµ·**ï¼Œè¿™æ ·å½“è¿”å›çš„ `task` è¢«ç­‰å¾…ï¼ˆ`co_await`ï¼‰æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¿™ä¸ªç‚¹æ¢å¤åç¨‹çš„æ‰§è¡Œã€‚

é‡‡ç”¨æ‡’å¯åŠ¨ï¼ˆlazy startï¼‰çš„å¥½å¤„æœ‰å¾ˆå¤šï¼š

1. **å¯ä»¥åœ¨å¯åŠ¨åç¨‹ä¹‹å‰ç»‘å®š continuation**ï¼ˆå³åç»­è¦æ¢å¤çš„åç¨‹çš„ `std::coroutine_handle`ï¼‰ã€‚è¿™æ ·æˆ‘ä»¬å°±ä¸éœ€è¦ä½¿ç”¨çº¿ç¨‹åŒæ­¥æ¥å¤„ç†åœ¨å¯åŠ¨åç¨‹å’Œç»‘å®š continuation ä¹‹é—´å¯èƒ½å‡ºç°çš„[[ç«äº‰æ¡ä»¶]]ã€‚
2. **å¯ä»¥è®© `task` ææ„å‡½æ•°æ— æ¡ä»¶é”€æ¯åç¨‹å¸§**â€”â€”æˆ‘ä»¬ä¸ç”¨æ‹…å¿ƒåç¨‹æ˜¯å¦æ­£åœ¨å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œå› ä¸ºåç¨‹åœ¨è¢«ç­‰å¾…ä¹‹å‰æ˜¯ä¸ä¼šæ‰§è¡Œçš„ï¼›è€Œä¸€æ—¦åç¨‹å¼€å§‹æ‰§è¡Œï¼Œè°ƒç”¨æ–¹æ‰€åœ¨çš„åç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œå› æ­¤ç›´åˆ°åç¨‹æ‰§è¡Œå®Œæ¯•å‰éƒ½ä¸ä¼šå»è°ƒç”¨ `task` ææ„å‡½æ•°ã€‚è¿™ä½¿å¾—ç¼–è¯‘å™¨æ›´æœ‰æœºä¼šå°†åç¨‹å¸§çš„åˆ†é…ä¼˜åŒ–ä¸ºåœ¨è°ƒç”¨è€…çš„æ ˆå¸§ä¸­è¿›è¡Œï¼ˆå³ [P0981R0](https://wg21.link/P0981R0) æåˆ°çš„ **Heap Allocation eLision Optimisation, HALO** ä¼˜åŒ–ï¼‰ã€‚
3. **æå‡å¼‚å¸¸å®‰å…¨æ€§**ã€‚å¦‚æœä½ æ²¡æœ‰ç«‹åˆ» `co_await` è¿”å›çš„ `task`ï¼Œè€Œæ˜¯åšäº†å…¶ä»–å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„æ“ä½œï¼Œå¯¼è‡´æ ˆå±•å¼€å¹¶è§¦å‘ `task` ææ„ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°é”€æ¯åç¨‹ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“å®ƒè¿˜æ²¡æœ‰å¼€å§‹æ‰§è¡Œã€‚è¿™æ ·å°±é¿å…äº†é™·å…¥å°´å°¬çš„é€‰æ‹©ï¼šè¦ä¹ˆåˆ†ç¦»æ‰§è¡Œï¼ˆå¯èƒ½å¯¼è‡´æ‚¬ç©ºå¼•ç”¨ï¼‰ï¼Œè¦ä¹ˆåœ¨ææ„ä¸­é˜»å¡ï¼Œè¦ä¹ˆè°ƒç”¨ `std::terminate()`ï¼Œè¦ä¹ˆå‡ºç°æœªå®šä¹‰è¡Œä¸ºã€‚æˆ‘åœ¨ [CppCon 2019 ç»“æ„åŒ–å¹¶å‘æ¼”è®²](https://www.youtube.com/watch?v=1Wy5sq3s2rg) ä¸­å¯¹è¿™ä¸€ç‚¹æœ‰æ›´è¯¦ç»†çš„è¯´æ˜ã€‚

ä¸ºäº†è®©åç¨‹åœ¨èµ·å§‹ä½ç½®æŒ‚èµ·ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ `initial_suspend()` æ–¹æ³•ï¼Œå¹¶è¿”å›å†…ç½®ç±»å‹ `suspend_always`ï¼š

```cpp
  std::suspend_always initial_suspend() noexcept {
    return {};
  }
```

ç„¶åï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ `return_void()` æ–¹æ³•ï¼Œå½“æ‰§è¡Œ `co_return;` æˆ–è€…åç¨‹æ‰§è¡Œæµåˆ°è¾¾æœ«å°¾æ—¶ä¼šè°ƒç”¨å®ƒã€‚è¿™ä¸ªæ–¹æ³•å®é™…ä¸Šä¸éœ€è¦åšä»»ä½•äº‹ï¼Œåªæ˜¯ä¸ºäº†å‘Šè¯‰ç¼–è¯‘å™¨åœ¨è¯¥åç¨‹ç±»å‹ä¸­å…è®¸ä½¿ç”¨ `co_return;`ã€‚

```cpp
  void return_void() noexcept {}
```

æˆ‘ä»¬è¿˜éœ€è¦å®ç° `unhandled_exception()` æ–¹æ³•ï¼Œå®ƒä¼šåœ¨å¼‚å¸¸é€ƒå‡ºåç¨‹ä½“æ—¶è¢«è°ƒç”¨ã€‚
åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠ task åç¨‹ä½“è§†ä¸º `noexcept`ï¼Œå¦‚æœå‘ç”Ÿå¼‚å¸¸å°±è°ƒç”¨ `std::terminate()`ï¼š

```cpp
  void unhandled_exception() noexcept {
    std::terminate();
  }
```

æœ€åï¼Œå½“åç¨‹æ‰§è¡Œåˆ°é—­åˆèŠ±æ‹¬å· `}` æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›åç¨‹åœ¨ **final-suspend ç‚¹** æŒ‚èµ·ï¼Œç„¶åæ¢å¤å®ƒçš„ continuationï¼ˆå³ç­‰å¾…å½“å‰åç¨‹å®Œæˆçš„é‚£ä¸ªåç¨‹ï¼‰ã€‚

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ promise ä¸­æ·»åŠ ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œç”¨æ¥ä¿å­˜ continuation çš„ `std::coroutine_handle`ã€‚
åŒæ—¶ï¼Œè¿˜éœ€è¦å®šä¹‰ä¸€ä¸ª `final_suspend()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªå¯ç­‰å¾…å¯¹è±¡ï¼ˆawaitableï¼‰ï¼Œåœ¨å½“å‰åç¨‹æŒ‚èµ·åæ¢å¤ continuationã€‚

**ä¸ºä»€ä¹ˆå¿…é¡»ç­‰åˆ°æŒ‚èµ·åå†æ¢å¤ continuationï¼Ÿ**
[[å› ä¸º continuation å¯èƒ½ä¼šç«‹å³è°ƒç”¨ `task` ææ„å‡½æ•°]]ï¼Œè€Œææ„å‡½æ•°ä¼šè°ƒç”¨ `.destroy()` æ¥é”€æ¯åç¨‹å¸§ã€‚`.destroy()` åªèƒ½ä½œç”¨åœ¨**å·²æŒ‚èµ·**çš„åç¨‹ä¸Šï¼Œæ‰€ä»¥å¦‚æœåœ¨æŒ‚èµ·ä¹‹å‰å°±æ¢å¤ continuationï¼Œå°±ä¼šè§¦å‘æœªå®šä¹‰è¡Œä¸ºã€‚

ç¼–è¯‘å™¨ä¼šåœ¨é—­åˆèŠ±æ‹¬å·å¤„è‡ªåŠ¨æ’å…¥ `co_await promise.final_suspend();` è¯­å¥ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è°ƒç”¨ `final_suspend()` æ–¹æ³•æ—¶ï¼Œåç¨‹**è¿˜æ²¡æœ‰**è¿›å…¥æŒ‚èµ·çŠ¶æ€ã€‚åªæœ‰ç­‰åˆ°è¿”å›çš„ awaitable çš„ `await_suspend()` æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œåç¨‹æ‰ä¼šæŒ‚èµ·ã€‚

```cpp
  struct final_awaiter {
    bool await_ready() noexcept {
      return false;
    }

    void await_suspend(std::coroutine_handle<promise_type> h) noexcept {
      // åç¨‹ç°åœ¨å·²ç»åœ¨ final-suspend ç‚¹æŒ‚èµ·
      // ä» promise ä¸­å–å‡º continuationï¼Œå¹¶æ¢å¤å®ƒ
      h.promise().continuation.resume();
    }

    void await_resume() noexcept {}
  };

  final_awaiter final_suspend() noexcept {
    return {};
  }

  std::coroutine_handle<> continuation;
};
```

å¥½äº†ï¼Œè¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº† `promise_type` çš„å®ç°ã€‚
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç° `task::operator co_await()` è¿™ä¸€éƒ¨åˆ†å³å¯ã€‚

---

## å®ç° `task::operator co_await()`

ä½ å¯èƒ½è¿˜è®°å¾—ï¼Œåœ¨[ã€ŠUnderstanding operator co\_await()ã€‹](https://lewissbaker.github.io/2017/11/17/understanding-operator-co-await) ä¸€æ–‡ä¸­æåˆ°ï¼Œå½“ç¼–è¯‘å™¨åœ¨æ±‚å€¼ä¸€ä¸ª `co_await` è¡¨è¾¾å¼æ—¶ï¼Œå¦‚æœç±»å‹å®šä¹‰äº† `operator co_await()`ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šå…ˆè°ƒç”¨è¯¥è¿ç®—ç¬¦ï¼Œç„¶åè¦æ±‚è¿”å›çš„å¯¹è±¡å¿…é¡»å®šä¹‰ `await_ready()`ã€`await_suspend()` å’Œ `await_resume()` è¿™ä¸‰ä¸ªæ–¹æ³•ã€‚

å½“ä¸€ä¸ªåç¨‹ç­‰å¾…ï¼ˆ`co_await`ï¼‰ä¸€ä¸ª `task` æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›ï¼š

1. ç­‰å¾…æ–¹åç¨‹**æ€»æ˜¯æŒ‚èµ·**ï¼›
2. ä¸€æ—¦æŒ‚èµ·ï¼Œå°±å°†ç­‰å¾…æ–¹åç¨‹çš„å¥æŸ„ï¼ˆ`std::coroutine_handle`ï¼‰å­˜å‚¨åˆ°å³å°†æ¢å¤çš„åç¨‹ï¼ˆä¹Ÿå°±æ˜¯ `task` å¯¹åº”çš„åç¨‹ï¼‰çš„ promise ä¸­ï¼›
3. ç„¶åè°ƒç”¨è¯¥ `task` çš„ `std::coroutine_handle` çš„ `.resume()` æ–¹æ³•ï¼Œä»è€Œå¼€å§‹æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚

å› æ­¤ï¼Œå®ç°èµ·æ¥å°±æ˜¯ä¸‹é¢è¿™æ ·ç›¸å¯¹ç›´æ¥çš„ä»£ç ï¼š

```cpp
class task::awaiter {
public:
  bool await_ready() noexcept {
    return false;
  }

  void await_suspend(std::coroutine_handle<> continuation) noexcept {
    // å°†ç­‰å¾…æ–¹åç¨‹çš„å¥æŸ„ä¿å­˜åˆ° task çš„ promise ä¸­
    // è¿™æ ·åœ¨ final_suspend() ä¸­å°±å¯ä»¥æ¢å¤è¿™ä¸ªåç¨‹
    coro_.promise().continuation = continuation;

    // ç„¶åæ¢å¤ task å¯¹åº”çš„åç¨‹
    // è¯¥åç¨‹ç›®å‰æŒ‚èµ·åœ¨ initial_suspendï¼ˆå³å‡½æ•°ä½“èµ·å§‹ä½ç½® `{`ï¼‰
    coro_.resume();
  }

  void await_resume() noexcept {}

private:
  explicit awaiter(std::coroutine_handle<task::promise_type> h) noexcept
  : coro_(h)
  {}

  std::coroutine_handle<task::promise_type> coro_;
};

task::awaiter task::operator co_await() && noexcept {
  return awaiter{coro_};
}
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ä¸€ä¸ªå¯æ­£å¸¸å·¥ä½œçš„ `task` ç±»å‹æ‰€éœ€çš„å…¨éƒ¨ä»£ç ã€‚

å®Œæ•´ä»£ç å¯ä»¥åœ¨ Compiler Explorer æŸ¥çœ‹ï¼š
[https://godbolt.org/z/-Kw6Nf](https://godbolt.org/z/-Kw6Nf)


## æ ˆæº¢å‡ºé—®é¢˜

ä¸Šé¢è¿™ç§ `task` å®ç°çš„é™åˆ¶ï¼Œä¼šåœ¨ä½ åœ¨åç¨‹ä¸­å†™å¾ªç¯å¹¶ä¸”åœ¨å¾ªç¯ä½“ä¸­ `co_await` å¯èƒ½**åŒæ­¥å®Œæˆ**çš„ä»»åŠ¡æ—¶å‡ºç°ã€‚

ä¾‹å¦‚ï¼š

```cpp
task completes_synchronously() {
  co_return;
}

task loop_synchronously(int count) {
  for (int i = 0; i < count; ++i) {
    co_await completes_synchronously();
  }
}
```

å¯¹äºå‰é¢æè¿°çš„è¿™ç§ç®€å• `task` å®ç°æ¥è¯´ï¼Œå½“ `count` ä¸º 10ã€1000 ç”šè‡³ 100â€™000 æ—¶ï¼Œ`loop_synchronously()` å¯èƒ½éƒ½èƒ½æ­£å¸¸è¿è¡Œã€‚ä½†æ€»ä¼šæœ‰ä¸€ä¸ªæ›´å¤§çš„å€¼ï¼Œä¼šå¯¼è‡´è¿™ä¸ªåç¨‹å¼€å§‹å´©æºƒã€‚

ä¾‹å¦‚ï¼Œå‚è§ï¼š[https://godbolt.org/z/gy5Q8q](https://godbolt.org/z/gy5Q8q)ï¼Œå½“ `count` ä¸º 1â€™000â€™000 æ—¶ä¼šå´©æºƒã€‚

é€ æˆå´©æºƒçš„åŸå› æ˜¯ **æ ˆæº¢å‡ºï¼ˆstack overflowï¼‰**ã€‚

è¦ç†è§£ä¸ºä»€ä¹ˆè¿™æ®µä»£ç ä¼šå¯¼è‡´æ ˆæº¢å‡ºï¼Œæˆ‘ä»¬éœ€è¦çœ‹çœ‹ä»£ç è¿è¡Œæ—¶åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Œå°¤å…¶æ˜¯æ ˆå¸§ï¼ˆstack-frameï¼‰æ˜¯å¦‚ä½•å˜åŒ–çš„ã€‚

---

å½“ `loop_synchronously()` åç¨‹ç¬¬ä¸€æ¬¡å¼€å§‹æ‰§è¡Œæ—¶ï¼Œæ˜¯å› ä¸ºæŸä¸ªå…¶ä»–åç¨‹ `co_await` äº†å®ƒè¿”å›çš„ `task`ã€‚
è¿™ä¼šå¯¼è‡´ç­‰å¾…æ–¹åç¨‹æŒ‚èµ·ï¼Œå¹¶è°ƒç”¨ `task::awaiter::await_suspend()`ï¼Œè€Œè¯¥å‡½æ•°ä¼šè°ƒç”¨ `resume()` æ¥æ¢å¤ `loop_synchronously()` çš„åç¨‹å¥æŸ„ã€‚

æ­¤æ—¶ï¼Œ`loop_synchronously()` åˆšå¯åŠ¨æ—¶çš„æ ˆ/å †å¸ƒå±€å¤§è‡´å¦‚ä¸‹ï¼š

```
           Stack                                                   Heap
+------------------------------+  <-- top of stack   +--------------------------+
| loop_synchronously$resume    | active coroutine -> | loop_synchronously frame |
+------------------------------+                     | +----------------------+ |
| coroutine_handle::resume     |                     | | task::promise        | |
+------------------------------+                     | | - continuation --.   | |
| task::awaiter::await_suspend |                     | +------------------|---+ |
+------------------------------+                     | ...                |     |
| awaiting_coroutine$resume    |                     +--------------------|-----+
+------------------------------+                                          V
|  ....                        |                     +--------------------------+
+------------------------------+                     | awaiting_coroutine frame |
                                                     |                          |
                                                     +--------------------------+
```

> **æ³¨æ„**ï¼šå½“ä¸€ä¸ªåç¨‹å‡½æ•°è¢«ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨é€šå¸¸ä¼šå°†å®ƒæ‹†åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼š
>
> 1. **ramp function**ï¼šè´Ÿè´£æ„é€ åç¨‹å¸§ã€å¤åˆ¶å‚æ•°ã€æ„é€  promise å¯¹è±¡å¹¶ç”Ÿæˆè¿”å›å€¼ï¼›
> 2. **åç¨‹ä¸»ä½“ï¼ˆcoroutine bodyï¼‰**ï¼šåŒ…å«ç”¨æˆ·ç¼–å†™çš„åç¨‹å‡½æ•°ä½“é€»è¾‘ã€‚
>
> æˆ‘åœ¨è¿™é‡Œç”¨ `$resume` åç¼€è¡¨ç¤ºåç¨‹ä¸»ä½“éƒ¨åˆ†ã€‚
>
> ä¹‹åçš„åšå®¢æ–‡ç« ä¼šæ›´è¯¦ç»†ä»‹ç»è¿™ç§æ‹†åˆ†ã€‚

---

æ¥ç€ï¼Œå½“ `loop_synchronously()` ç­‰å¾… `completes_synchronously()` è¿”å›çš„ `task` æ—¶ï¼š

1. å½“å‰åç¨‹æŒ‚èµ·ï¼Œå¹¶è°ƒç”¨ `task::awaiter::await_suspend()`ï¼›
2. `await_suspend()` æ–¹æ³•è°ƒç”¨ `resume()` æ¥æ¢å¤ `completes_synchronously()` åç¨‹ã€‚

`completes_synchronously()` ä¼šåŒæ­¥æ‰§è¡Œåˆ°ç»“æŸï¼Œå¹¶åœ¨æœ€ç»ˆæŒ‚èµ·ç‚¹ï¼ˆfinal-suspendï¼‰æŒ‚èµ·ï¼›
ç„¶åè°ƒç”¨ `task::promise::final_awaiter::await_suspend()`ï¼Œè¯¥æ–¹æ³•åˆä¼šè°ƒç”¨ `.resume()` æ¢å¤ `loop_synchronously()` åç¨‹ã€‚

---

æœ€ç»ˆï¼Œå½“ `loop_synchronously()` æ¢å¤æ‰§è¡Œã€è¿˜æ²¡é”€æ¯ `completes_synchronously()` è¿”å›çš„ä¸´æ—¶ `task` æ—¶ï¼Œç¨‹åºçš„æ ˆ/å †çŠ¶æ€å¤§è‡´å¦‚ä¸‹ï¼š

```
           Stack                                                   Heap
+-------------------------------+ <-- top of stack
| loop_synchronously$resume     | active coroutine -.
+-------------------------------+                   |
| coroutine_handle::resume      |            .------'
+-------------------------------+            |
| final_awaiter::await_suspend  |            |
+-------------------------------+            |  +--------------------------+ <-.
| completes_synchronously$resume|            |  | completes_synchronously  |   |
+-------------------------------+            |  | frame                    |   |
| coroutine_handle::resume      |            |  +--------------------------+   |
+-------------------------------+            '---.                             |
| task::awaiter::await_suspend  |                V                             |
+-------------------------------+ <-- prev top  +--------------------------+   |
| loop_synchronously$resume     |     of stack  | loop_synchronously frame |   |
+-------------------------------+               | +----------------------+ |   |
| coroutine_handle::resume      |               | | task::promise        | |   |
+-------------------------------+               | | - continuation --.   | |   |
| task::awaiter::await_suspend  |               | +------------------|---+ |   |
+-------------------------------+               | - task temporary --|---------'
| awaiting_coroutine$resume     |               +--------------------|-----+
+-------------------------------+                                    V
|  ....                         |               +--------------------------+
+-------------------------------+               | awaiting_coroutine frame |
                                                |                          |
                                                +--------------------------+
```

---

æ¥ä¸‹æ¥ï¼Œç¨‹åºä¼šè°ƒç”¨ `task` çš„ææ„å‡½æ•°ï¼Œé”€æ¯ `completes_synchronously()` åç¨‹å¸§ï¼›
ç„¶å `count` è‡ªå¢ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œå†æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„ `completes_synchronously()` åç¨‹å¸§å¹¶æ¢å¤å®ƒã€‚

æœ¬è´¨ä¸Šï¼Œè¿™å¯¼è‡´ `loop_synchronously()` å’Œ `completes_synchronously()` **äº’ç›¸é€’å½’è°ƒç”¨**ã€‚
æ¯å‘ç”Ÿä¸€æ¬¡è¿™æ ·çš„è°ƒç”¨ï¼Œå°±ä¼šé¢å¤–æ¶ˆè€—ä¸€ç‚¹æ ˆç©ºé—´ï¼›
å½“å¾ªç¯æ¬¡æ•°è¶³å¤Ÿå¤šæ—¶ï¼Œæ ˆç©ºé—´æœ€ç»ˆä¼šè¢«è€—å°½ï¼Œè§¦å‘æ ˆæº¢å‡ºï¼Œä»è€Œå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºï¼ˆé€šå¸¸æ˜¯ç¨‹åºç›´æ¥å´©æºƒï¼‰ã€‚

[[éå¸¸é‡è¦!]]

[[geminiçš„è§£é‡Š]]

---

åœ¨è¿™ç§æ„é€ ä¸‹ï¼Œåœ¨åç¨‹ä¸­å†™å¾ªç¯æ—¶å¾ˆå®¹æ˜“æ— æ„é—´å†™å‡º**æ— ç•Œé€’å½’**ï¼Œè€Œä¸”ä»ä»£ç è¡¨é¢ä¸Šçœ‹å®Œå…¨ä¸åƒé€’å½’ã€‚

é‚£ä¹ˆï¼Œåœ¨æœ€åˆçš„ Coroutines TS è®¾è®¡ä¸‹ï¼Œè¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆä¼šæ˜¯ä»€ä¹ˆæ ·å‘¢ï¼Ÿ

## åç¨‹ TS æ–¹æ¡ˆ

[[ç†è§£ !!!!]]
å¥½ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•é¿å…è¿™ç§**æ— é™é€’å½’**çš„é—®é¢˜å‘¢ï¼Ÿ

åœ¨ä¸Šé¢çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `await_suspend()` è¿”å› **`void`** çš„ç‰ˆæœ¬ã€‚è€Œåœ¨ Coroutines TS é‡Œï¼Œè¿˜å­˜åœ¨ä¸€ä¸ªè¿”å› **`bool`** çš„ `await_suspend()` ç‰ˆæœ¬â€”â€”

* å¦‚æœè¿”å› `true`ï¼Œè¡¨ç¤ºåç¨‹è¢«æŒ‚èµ·ï¼Œæ‰§è¡Œä¼šå›åˆ°è°ƒç”¨ `resume()` çš„åœ°æ–¹ï¼›
* å¦‚æœè¿”å› `false`ï¼Œè¡¨ç¤ºåç¨‹ä¼š**ç«‹å³ç»§ç»­æ‰§è¡Œ**ï¼Œè€Œä¸”ä¸ä¼šå†é¢å¤–æ¶ˆè€—æ ˆç©ºé—´ã€‚

å› æ­¤ï¼Œè¦é¿å…æ— é™çš„ç›¸äº’é€’å½’ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯åœ¨ **`task::awaiter::await_suspend()`** ä¸­ï¼Œå¦‚æœä»»åŠ¡æ˜¯**åŒæ­¥å®Œæˆ**çš„ï¼Œå°±è¿”å› `false`ï¼Œè®©å½“å‰åç¨‹ç›´æ¥ç»§ç»­æ‰§è¡Œï¼Œè€Œä¸æ˜¯ç”¨ `std::coroutine_handle::resume()` å†å»é€’å½’æ¢å¤å®ƒã€‚

ä¸ºäº†å®ç°ä¸€ä¸ªé€šç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªå…³é”®æ­¥éª¤ï¼š

---

### 1. åœ¨ `task::awaiter::await_suspend()` ä¸­

* å…ˆé€šè¿‡ `.resume()` å¯åŠ¨åç¨‹æ‰§è¡Œï¼›
* å½“ `.resume()` è¿”å›æ—¶ï¼Œæ£€æŸ¥åç¨‹æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆï¼š

  * å¦‚æœå®Œæˆï¼Œåˆ™è¿”å› `false`ï¼Œè®©ç­‰å¾…å®ƒçš„åç¨‹**ç«‹å³æ¢å¤**ï¼›
  * å¦‚æœæ²¡æœ‰å®Œæˆï¼Œåˆ™è¿”å› `true`ï¼Œè¡¨ç¤ºåº”å½“å›åˆ° `resume()` çš„è°ƒç”¨è€…ã€‚

---

### 2. åœ¨ `task::promise_type::final_awaiter::await_suspend()` ä¸­

* è¿™ä¸ªæ–¹æ³•ä¼šåœ¨åç¨‹æ‰§è¡Œå®Œæˆæ—¶è¿è¡Œã€‚
* æˆ‘ä»¬éœ€è¦åˆ¤æ–­ç­‰å¾…å®ƒçš„åç¨‹æ˜¯å¦ï¼ˆæˆ–å°†ä¼šï¼‰åœ¨ `task::awaiter::await_suspend()` ä¸­è¿”å› `true`ï¼š

  * å¦‚æœè¿”å› `true`ï¼Œåˆ™éœ€è¦åœ¨è¿™é‡Œè°ƒç”¨ `.resume()` æ¢å¤ç­‰å¾…æ–¹ï¼›
  * å¦‚æœä¸ä¼šè¿”å› `true`ï¼Œåˆ™é¿å…æ¢å¤ï¼Œè®© `await_suspend()` è¿”å› `false` å³å¯ã€‚

---

ä¸è¿‡ï¼Œè¿™é‡Œæœ‰ä¸ªé¢å¤–çš„å¤æ‚æƒ…å†µï¼š
åç¨‹å¯èƒ½ä¼š**åœ¨å½“å‰çº¿ç¨‹å¯åŠ¨æ‰§è¡Œ**ï¼Œç„¶åæŒ‚èµ·ï¼Œå†åœ¨**å¦ä¸€ä¸ªçº¿ç¨‹æ¢å¤å¹¶å®Œæˆ**ï¼Œè€Œè¿™ä¸€åˆ‡å¯èƒ½å‘ç”Ÿåœ¨ `.resume()` è°ƒç”¨è¿˜æ²¡è¿”å›ä¹‹å‰ã€‚
å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³ **æ­¥éª¤ 1 å’Œæ­¥éª¤ 2 å¯èƒ½å¹¶å‘å‘ç”Ÿçš„ç«äº‰é—®é¢˜**ã€‚

è§£å†³åŠæ³•æ˜¯ä½¿ç”¨ä¸€ä¸ª **`std::atomic`** å€¼æ¥å†³å®šè°èµ¢å¾—è¿™åœºâ€œæ¯”èµ›â€ã€‚

---

### ä»£ç å®ç°

```cpp
class task::promise_type {
  ...
  std::coroutine_handle<> continuation;
  std::atomic<bool> ready = false;
};

bool task::awaiter::await_suspend(
    std::coroutine_handle<> continuation) noexcept {
  promise_type& promise = coro_.promise();
  promise.continuation = continuation;
  coro_.resume();
  return !promise.ready.exchange(true, std::memory_order_acq_rel);
}

void task::promise_type::final_awaiter::await_suspend(
    std::coroutine_handle<promise_type> h) noexcept {
  promise_type& promise = h.promise();
  if (promise.ready.exchange(true, std::memory_order_acq_rel)) {
    // åç¨‹ä¸æ˜¯åŒæ­¥å®Œæˆçš„ï¼Œè¿™é‡Œæ¢å¤ç­‰å¾…æ–¹
    promise.continuation.resume();
  }
}
```

åœ¨ [Compiler Explorer ç¤ºä¾‹](https://godbolt.org/z/7fm8Za) ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ
å½“æ‰§è¡Œ `count == 1'000'000` çš„æƒ…å†µæ—¶ï¼Œå®ƒå†ä¹Ÿä¸ä¼šå´©æºƒäº†ã€‚

---

è¿™å…¶å®å°±æ˜¯ `cppcoro::task<T>` [æºç å®ç°](https://github.com/lewissbaker/cppcoro/blob/master/include/cppcoro/task.hpp) é‡‡ç”¨çš„åŠæ³•ï¼ˆåœ¨æŸäº›å¹³å°ä¸Šç°åœ¨ä¾ç„¶å¦‚æ­¤ï¼‰ï¼Œç”¨æ¥é¿å…**æ— é™é€’å½’é—®é¢˜**ï¼Œè€Œä¸”å®é™…æ•ˆæœä¸€ç›´å¾ˆä¸é”™ã€‚

ğŸ‰ è§£å†³äº†ï¼å¥½åƒå¯ä»¥å‘ç‰ˆæœ¬äº†ï¼Œå¯¹å§ï¼Ÿå—¯â€¦â€¦å¯¹å§ï¼Ÿ

## é—®é¢˜

è™½ç„¶ä¸Šé¢çš„è§£å†³æ–¹æ¡ˆç¡®å®è§£å†³äº†é€’å½’é—®é¢˜ï¼Œä½†å®ƒä¹Ÿæœ‰å‡ ä¸ªç¼ºç‚¹ã€‚

é¦–å…ˆï¼Œå®ƒå¼•å…¥äº†å¯¹ `std::atomic` æ“ä½œçš„éœ€æ±‚ï¼Œè€ŒåŸå­æ“ä½œçš„å¼€é”€å¯èƒ½ç›¸å½“å¤§ã€‚
å½“æŒ‚èµ·ç­‰å¾…çš„åç¨‹æ—¶ï¼Œè°ƒç”¨æ–¹ä¼šè¿›è¡Œä¸€æ¬¡åŸå­äº¤æ¢ï¼›å½“è¢«è°ƒç”¨æ–¹è¿è¡Œåˆ°å®Œæˆæ—¶ï¼Œä¹Ÿä¼šè¿›è¡Œä¸€æ¬¡åŸå­äº¤æ¢ã€‚
å¦‚æœä½ çš„åº”ç”¨ç¨‹åºå§‹ç»ˆåªåœ¨å•çº¿ç¨‹ä¸­è¿è¡Œï¼Œé‚£ä¹ˆå³ä½¿æ ¹æœ¬ä¸éœ€è¦çº¿ç¨‹åŒæ­¥ï¼Œä½ ä¹Ÿä»ç„¶è¦ä¸ºè¿™äº›åŸå­æ“ä½œä»˜å‡ºæ€§èƒ½ä»£ä»·ã€‚

å…¶æ¬¡ï¼Œå®ƒå¼•å…¥äº†é¢å¤–çš„åˆ†æ”¯åˆ¤æ–­ã€‚
ä¸€ä¸ªåˆ†æ”¯åœ¨è°ƒç”¨æ–¹ï¼Œç”¨æ¥å†³å®šæ˜¯æŒ‚èµ·è¿˜æ˜¯ç«‹å³æ¢å¤åç¨‹ï¼›å¦ä¸€ä¸ªåˆ†æ”¯åœ¨è¢«è°ƒç”¨æ–¹ï¼Œç”¨æ¥å†³å®šæ˜¯æ¢å¤ç»§ç»­æ‰§è¡Œè¿˜æ˜¯æŒ‚èµ·ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™äº›é¢å¤–åˆ†æ”¯çš„å¼€é”€ï¼ˆç”šè‡³åŒ…æ‹¬åŸå­æ“ä½œçš„å¼€é”€ï¼‰é€šå¸¸ä¼šè¢«åç¨‹ä¸­ä¸šåŠ¡é€»è¾‘çš„æ‰§è¡Œæ—¶é—´æ‰€æ©ç›–ã€‚
ä½†æ˜¯ï¼Œåç¨‹ä¸€ç›´è¢«å®£ä¼ ä¸ºé›¶å¼€é”€æŠ½è±¡ï¼ˆzero-cost abstractionï¼‰ï¼Œç”šè‡³æœ‰äººä¼šåˆ©ç”¨åç¨‹æš‚åœå‡½æ•°æ‰§è¡Œæ¥é¿å…ç­‰å¾… L1 ç¼“å­˜æœªå‘½ä¸­ï¼ˆå¯å‚è€ƒ Gor åœ¨ [CppCon çš„ nanocoroutines æ¼”è®²](https://www.youtube.com/watch?v=j9tlJAqMV7U) äº†è§£æ›´å¤šç»†èŠ‚ï¼‰ã€‚

ç¬¬ä¸‰ï¼Œä¹Ÿæ˜¯å¯èƒ½æœ€é‡è¦çš„ä¸€ç‚¹ï¼Œå®ƒä¼šå¼•å…¥**ç­‰å¾…åç¨‹æ¢å¤æ—¶æ‰§è¡Œä¸Šä¸‹æ–‡çš„ä¸ç¡®å®šæ€§**ã€‚

å‡è®¾æˆ‘æœ‰å¦‚ä¸‹ä»£ç ï¼š

```cpp
cppcoro::static_thread_pool tp;

task foo()
{
  std::cout << "foo1 " << std::this_thread::get_id() << "\n";
  // æŒ‚èµ·åç¨‹å¹¶é‡æ–°è°ƒåº¦åˆ°çº¿ç¨‹æ± çº¿ç¨‹ä¸Š
  co_await tp.schedule();
  std::cout << "foo2 " << std::this_thread::get_id() << "\n";
}

task bar()
{
  std::cout << "bar1 " << std::this_thread::get_id() << "\n";
  co_await foo();
  std::cout << "bar2" << std::this_thread::get_id() << "\n";
}
```

åœ¨åŸå§‹å®ç°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä¿è¯ `co_await foo()` ä¹‹åçš„ä»£ç ï¼Œä¼š**ç›´æ¥åœ¨ `foo()` å®Œæˆçš„åŒä¸€çº¿ç¨‹å†…å†…è”æ‰§è¡Œ**ã€‚

ä¾‹å¦‚ï¼Œä¸€ç§å¯èƒ½çš„è¾“å‡ºæ˜¯ï¼š

```
bar1 1234
foo1 1234
foo2 3456
bar2 3456
```

ç„¶è€Œï¼Œåœ¨å¼•å…¥åŸå­æ“ä½œçš„ä¿®æ”¹ç‰ˆä¸­ï¼Œ`foo()` å®Œæˆå’Œ `bar()` æŒ‚èµ·ä¹‹é—´å¯èƒ½ä¼šå‘ç”Ÿç«äº‰ï¼Œè¿™æ„å‘³ç€ `co_await foo()` ä¹‹åçš„ä»£ç æœ‰å¯èƒ½ä¼šåœ¨ `bar()` æœ€åˆè¿è¡Œçš„çº¿ç¨‹ä¸Šç»§ç»­æ‰§è¡Œã€‚

ä¾‹å¦‚ï¼Œä¸‹é¢è¿™æ ·çš„è¾“å‡ºå°±æœ‰å¯èƒ½å‘ç”Ÿï¼š

```
bar1 1234
foo1 1234
foo2 3456
bar2 1234
```

å¯¹äºå¾ˆå¤šä½¿ç”¨åœºæ™¯æ¥è¯´ï¼Œè¿™ç§è¡Œä¸ºå·®å¼‚å¯èƒ½æ— å…³ç´§è¦ã€‚
ä½†æ˜¯ï¼Œå¯¹äº**æœ¬èº«å°±æ˜¯ä¸ºäº†åˆ‡æ¢æ‰§è¡Œä¸Šä¸‹æ–‡**çš„ç®—æ³•æ¥è¯´ï¼Œè¿™å°±å¯èƒ½æ˜¯ä¸ªä¸¥é‡é—®é¢˜ã€‚

æ¯”å¦‚ï¼Œ`via()` ç®—æ³•ä¼šç­‰å¾…ä¸€ä¸ª Awaitable å®Œæˆï¼Œç„¶åä¿è¯æ¥ä¸‹æ¥çš„æ‰§è¡Œå‘ç”Ÿåœ¨æŒ‡å®šè°ƒåº¦å™¨çš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­ã€‚
ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ `via()` ç®—æ³•ï¼š

```cpp
template<typename Awaitable, typename Scheduler>
task<await_result_t<Awaitable>> via(Awaitable a, Scheduler s)
{
  auto result = co_await std::move(a);
  co_await s.schedule();
  co_return result;
}

task<T> get_value();
void consume(const T&);

task<void> consumer(static_thread_pool::scheduler s)
{
  T result = co_await via(get_value(), s);
  consume(result);
}
```

åœ¨åŸå§‹ç‰ˆæœ¬ä¸­ï¼Œ`consume()` æ€»æ˜¯ä¿è¯åœ¨è°ƒåº¦å™¨ `s` æ‰€å…³è”çš„çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚
ç„¶è€Œï¼Œåœ¨ä½¿ç”¨åŸå­æ“ä½œçš„ä¿®æ”¹ç‰ˆä¸­ï¼Œ`consume()` æœ‰å¯èƒ½ä¼šåœ¨ `s` æ‰€å…³è”çš„çº¿ç¨‹æ± çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šåœ¨ `consumer()` åç¨‹æœ€åˆè¿è¡Œçš„çº¿ç¨‹ä¸­æ‰§è¡Œã€‚

æ‰€ä»¥é—®é¢˜æ¥äº†ï¼š
**æˆ‘ä»¬è¯¥å¦‚ä½•åœ¨ä¸å¼•å…¥åŸå­æ“ä½œå¼€é”€ã€é¢å¤–åˆ†æ”¯åˆ¤æ–­ã€ä»¥åŠæ‰§è¡Œä¸Šä¸‹æ–‡ä¸ç¡®å®šæ€§çš„æƒ…å†µä¸‹ï¼Œè§£å†³æ ˆæº¢å‡ºé—®é¢˜ï¼Ÿ**

## è¿›å…¥ â€œå¯¹ç§°åˆ‡æ¢ï¼ˆsymmetric transferï¼‰â€ï¼

[[è¿›å…¥â€œå¯¹ç§°åˆ‡æ¢"]]
Gor Nishanov åœ¨ 2018 å¹´å‘å¸ƒçš„è®ºæ–‡ [P0913R0](https://wg21.link/P0913R0) ã€ŠAdd symmetric coroutine control transferã€‹ï¼ˆä¸ºåç¨‹æ·»åŠ å¯¹ç§°æ§åˆ¶åˆ‡æ¢ï¼‰æå‡ºäº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œå…è®¸ä¸€ä¸ªåç¨‹åœ¨æŒ‚èµ·æ—¶å¯¹ç§°åœ°åˆ‡æ¢åˆ°å¦ä¸€ä¸ªåç¨‹ï¼Œå¹¶ä¸”**ä¸ä¼š**é¢å¤–æ¶ˆè€—æ ˆç©ºé—´ã€‚

è¿™ç¯‡è®ºæ–‡æå‡ºäº†ä¸¤ä¸ªå…³é”®æ”¹åŠ¨ï¼š

* å…è®¸ `await_suspend()` è¿”å›ä¸€ä¸ª `std::coroutine_handle<T>`ï¼Œç”¨æ¥è¡¨ç¤ºæ‰§è¡Œåº”è¯¥**å¯¹ç§°åˆ‡æ¢**åˆ°è¿”å›çš„åç¨‹å¥æŸ„æ‰€æŒ‡å‘çš„åç¨‹ã€‚
* æ·»åŠ ä¸€ä¸ª `std::experimental::noop_coroutine()` å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªç‰¹æ®Šçš„ `std::coroutine_handle`ï¼Œå¯ä»¥ä» `await_suspend()` è¿”å›å®ƒï¼Œä»¥æŒ‚èµ·å½“å‰åç¨‹å¹¶ç›´æ¥è®© `.resume()` è°ƒç”¨è¿”å›ï¼Œè€Œä¸æ˜¯åˆ‡æ¢åˆ°å¦ä¸€ä¸ªåç¨‹ã€‚

é‚£ä¹ˆï¼Œâ€œå¯¹ç§°åˆ‡æ¢â€åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ

å½“ä½ é€šè¿‡è°ƒç”¨æŸä¸ª `std::coroutine_handle` çš„ `.resume()` æ¥æ¢å¤ä¸€ä¸ªåç¨‹æ—¶ï¼Œ**è°ƒç”¨ `.resume()` çš„é‚£ä¸ªå‡½æ•°ä¼šä¾ç„¶å¤„äºæ´»åŠ¨æ ˆå¸§ä¸­**ï¼ŒåŒæ—¶è¢«æ¢å¤çš„åç¨‹å¼€å§‹æ‰§è¡Œã€‚å½“è¿™ä¸ªåç¨‹ä¸‹ä¸€æ¬¡æŒ‚èµ·æ—¶ï¼Œå¦‚æœ `await_suspend()` è¿”å› `void`ï¼ˆæ— æ¡ä»¶æŒ‚èµ·ï¼‰æˆ– `true`ï¼ˆæ¡ä»¶æŒ‚èµ·ï¼‰ï¼Œé‚£ä¹ˆè¿™æ¬¡ `.resume()` è°ƒç”¨å°±ä¼šè¿”å›ã€‚

è¿™å¯ä»¥çœ‹ä½œæ˜¯\*\*â€œéå¯¹ç§°åˆ‡æ¢â€ï¼ˆasymmetric transferï¼‰\*\*â€”â€”å®ƒå’Œæ™®é€šå‡½æ•°è°ƒç”¨çš„è¡Œä¸ºä¸€æ ·ã€‚è°ƒç”¨ `.resume()` çš„åœ°æ–¹å¯ä»¥æ˜¯ä»»ä½•å‡½æ•°ï¼ˆå¯èƒ½æ˜¯åç¨‹ï¼Œä¹Ÿå¯èƒ½ä¸æ˜¯ï¼‰ã€‚å½“è¢«æ¢å¤çš„åç¨‹æŒ‚èµ·å¹¶ä¸” `await_suspend()` è¿”å› `true` æˆ– `void` æ—¶ï¼Œæ‰§è¡Œæµç¨‹å°±ä¼šå›åˆ° `.resume()` çš„è°ƒç”¨ç‚¹ã€‚

**æ¯æ¬¡è°ƒç”¨ `.resume()` æ¢å¤åç¨‹æ—¶ï¼Œéƒ½ä¼šä¸ºè¯¥åç¨‹çš„æ‰§è¡Œåˆ›å»ºä¸€ä¸ªæ–°çš„æ ˆå¸§**ã€‚

è€Œåœ¨\*\*â€œå¯¹ç§°åˆ‡æ¢â€**ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•åœ°æŒ‚èµ·ä¸€ä¸ªåç¨‹ï¼Œç„¶åæ¢å¤å¦ä¸€ä¸ªåç¨‹ã€‚ä¸¤è€…ä¹‹é—´æ²¡æœ‰éšå¼çš„è°ƒç”¨è€… / è¢«è°ƒç”¨è€…å…³ç³»â€”â€”å½“ä¸€ä¸ªåç¨‹æŒ‚èµ·æ—¶ï¼Œå®ƒå¯ä»¥åˆ‡æ¢åˆ°**ä»»ä½•\*\*å·²æŒ‚èµ·çš„åç¨‹ï¼ˆåŒ…æ‹¬å®ƒè‡ªå·±ï¼‰ï¼Œå¹¶ä¸éœ€è¦åœ¨ä¸‹æ¬¡æŒ‚èµ·æˆ–å®Œæˆæ—¶åˆ‡å›åˆ°ä¸Šä¸€ä¸ªåç¨‹ã€‚

---

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼Œå½“ `awaiter` ä½¿ç”¨äº†å¯¹ç§°åˆ‡æ¢æ—¶ï¼Œç¼–è¯‘å™¨æ˜¯å¦‚ä½•å°† `co_await` è¡¨è¾¾å¼è½¬åŒ–çš„ï¼š

```cpp
{
  decltype(auto) value = <expr>;
  decltype(auto) awaitable =
      get_awaitable(promise, static_cast<decltype(value)&&>(value));
  decltype(auto) awaiter =
      get_awaiter(static_cast<decltype(awaitable)&&>(awaitable));
  if (!awaiter.await_ready())
  {
    using handle_t = std::coroutine_handle<P>;

    //<suspend-coroutine>

    auto h = awaiter.await_suspend(handle_t::from_promise(p));
    h.resume();
    //<return-to-caller-or-resumer>
    
    //<resume-point>
  }

  return awaiter.await_resume();
}
```

---

å…³é”®çš„ä¸åŒä¹‹å¤„åœ¨äºè¿™é‡Œï¼š

```cpp
auto h = awaiter.await_suspend(handle_t::from_promise(p));
h.resume();
//<return-to-caller-or-resumer>
```

åœ¨åç¨‹çŠ¶æ€æœºè¢«é™çº§ï¼ˆloweringï¼‰ä¹‹åï¼ˆè¿™ä¸ªæ˜¯å¦ä¸€ç¯‡æ–‡ç« çš„ä¸»é¢˜ï¼‰ï¼Œ`<return-to-caller-or-resumer>` åŸºæœ¬ä¸Šä¼šå˜æˆä¸€ä¸ª `return;` è¯­å¥â€”â€”è¿™ä¼šè®©ä¸Šä¸€æ¬¡è°ƒç”¨ `.resume()` æ¢å¤è¯¥åç¨‹çš„åœ°æ–¹**ç›´æ¥è¿”å›**åˆ°å®ƒçš„è°ƒç”¨è€…ã€‚

è¿™æ„å‘³ç€æˆ‘ä»¬å‡ºç°äº†è¿™æ ·ä¸€ç§æƒ…å†µï¼š**åœ¨ä¸€ä¸ªå‡½æ•°ä½“ï¼ˆæœ¬èº«å°±æ˜¯ `std::coroutine_handle::resume()` çš„å®ç°ï¼‰ä¸­è°ƒç”¨å¦ä¸€ä¸ªç­¾åç›¸åŒçš„ `std::coroutine_handle::resume()`ï¼Œå¹¶ä¸”ç´§æ¥ç€æ‰§è¡Œ `return;`**ã€‚

---

æœ‰äº›ç¼–è¯‘å™¨åœ¨å¼€å¯ä¼˜åŒ–æ—¶ï¼Œä¼šå°†è¿™ç§â€œåœ¨è¿”å›å‰è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°â€çš„æ¨¡å¼ä¼˜åŒ–ä¸º**å°¾è°ƒç”¨ï¼ˆtail-callï¼‰**ï¼Œå‰ææ˜¯æ»¡è¶³ä¸€å®šæ¡ä»¶ã€‚

è€Œå°¾è°ƒç”¨ä¼˜åŒ–æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œè¿™æ ·å°±èƒ½é¿å…ä¹‹å‰é‡åˆ°çš„**æ ˆæº¢å‡º**é—®é¢˜ã€‚ä½†æˆ‘ä»¬ä¸æƒ³ä¾èµ–ç¼–è¯‘å™¨ä¼˜åŒ–å™¨çš„â€œå¿ƒæƒ…â€æ¥å†³å®šæ˜¯å¦è¿›è¡Œå°¾è°ƒç”¨ï¼Œè€Œæ˜¯å¸Œæœ›å³ä½¿åœ¨**æœªå¼€å¯ä¼˜åŒ–**æ—¶ä¹Ÿèƒ½ä¿è¯å°¾è°ƒç”¨è½¬æ¢ã€‚

ä¸è¿‡ï¼Œåœ¨ç»§ç»­ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ä»”ç»†çœ‹çœ‹ä»€ä¹ˆæ˜¯**å°¾è°ƒç”¨ï¼ˆtail-callï¼‰**ã€‚


### å°¾è°ƒç”¨ï¼ˆTail-callsï¼‰

[[è¯¦ç»†è§£é‡Šï¼]]

å°¾è°ƒç”¨æ˜¯æŒ‡ï¼šåœ¨è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°å‰ï¼Œå½“å‰å‡½æ•°çš„æ ˆå¸§ï¼ˆstack-frameï¼‰ä¼šå…ˆè¢«å¼¹å‡ºï¼ˆpopï¼‰ï¼Œå¹¶ä¸”å½“å‰å‡½æ•°çš„è¿”å›åœ°å€ç›´æ¥å˜ä¸ºè¢«è°ƒç”¨å‡½æ•°çš„è¿”å›åœ°å€â€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œè¢«è°ƒç”¨å‡½æ•°ä¼šç›´æ¥è¿”å›åˆ°å½“å‰å‡½æ•°çš„è°ƒç”¨è€…é‚£é‡Œã€‚

åœ¨ X86/X64 æ¶æ„ä¸Šï¼Œè¿™é€šå¸¸æ„å‘³ç€ç¼–è¯‘å™¨ä¼šç”Ÿæˆè¿™æ ·çš„ä»£ç ï¼šå…ˆå¼¹å‡ºå½“å‰æ ˆå¸§ï¼Œç„¶åç”¨ `jmp` æŒ‡ä»¤è·³è½¬åˆ°è¢«è°ƒç”¨å‡½æ•°çš„å…¥å£ç‚¹ï¼Œè€Œä¸æ˜¯ç”¨ `call` æŒ‡ä»¤è°ƒç”¨åå†åœ¨è¿”å›æ—¶å¼¹å‡ºå½“å‰æ ˆå¸§ã€‚

ä¸è¿‡ï¼Œè¿™ç§ä¼˜åŒ–é€šå¸¸åªåœ¨ä¸€äº›å—é™çš„æƒ…å†µä¸‹æ‰èƒ½åšã€‚

å…·ä½“æ¥è¯´ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

* **è°ƒç”¨çº¦å®š**ï¼ˆcalling conventionï¼‰æ”¯æŒå°¾è°ƒç”¨ï¼Œå¹¶ä¸”è°ƒç”¨æ–¹å’Œè¢«è°ƒç”¨æ–¹çš„è°ƒç”¨çº¦å®šä¸€è‡´ï¼›
* **è¿”å›ç±»å‹ä¸€è‡´**ï¼›
* **æ²¡æœ‰éœ€è¦åœ¨è°ƒç”¨åé”€æ¯çš„éå¹³å‡¡ææ„å¯¹è±¡**ï¼ˆnon-trivial destructorsï¼‰ï¼›
* è°ƒç”¨ä¸åœ¨ `try/catch` å—å†…éƒ¨ã€‚

`symmetric-transfer` å½¢å¼çš„ `co_await`ï¼ˆå¯¹ç§°è½¬ç§»ï¼‰åœ¨è®¾è®¡æ—¶å°±è€ƒè™‘åˆ°äº†è®©åç¨‹æ»¡è¶³è¿™äº›è¦æ±‚ã€‚æˆ‘ä»¬é€ä¸ªæ¥çœ‹ã€‚

---

**è°ƒç”¨çº¦å®š**
å½“ç¼–è¯‘å™¨å°†ä¸€ä¸ªåç¨‹è½¬æ¢æˆæœºå™¨ç æ—¶ï¼Œå®é™…ä¸Šä¼šæŠŠå®ƒæ‹†æˆä¸¤éƒ¨åˆ†ï¼š

1. **ramp**ï¼ˆå¡é“å‡½æ•°ï¼‰ï¼šåˆ†é…å¹¶åˆå§‹åŒ–åç¨‹å¸§ï¼ˆcoroutine frameï¼‰ï¼›
2. **body**ï¼ˆä¸»ä½“å‡½æ•°ï¼‰ï¼šåŒ…å«ç”¨æˆ·ç¼–å†™çš„åç¨‹ä½“çŠ¶æ€æœºã€‚

åç¨‹çš„å‡½æ•°ç­¾åï¼ˆä»¥åŠç”¨æˆ·æŒ‡å®šçš„è°ƒç”¨çº¦å®šï¼‰åªå½±å“ ramp éƒ¨åˆ†ï¼›è€Œ body éƒ¨åˆ†å®Œå…¨ç”±ç¼–è¯‘å™¨æ§åˆ¶ï¼Œå¹¶ä¸”ä¸ä¼šè¢«ç”¨æˆ·ä»£ç ç›´æ¥è°ƒç”¨â€”â€”å®ƒåªä¼šè¢« ramp å‡½æ•°æˆ–è€… `std::coroutine_handle::resume()` è°ƒç”¨ã€‚

ç”±äº body éƒ¨åˆ†çš„è°ƒç”¨çº¦å®šå¯¹ç”¨æˆ·ä¸å¯è§ï¼Œç¼–è¯‘å™¨å°±å¯ä»¥è‡ªç”±é€‰æ‹©æ”¯æŒå°¾è°ƒç”¨çš„è°ƒç”¨çº¦å®šï¼Œå¹¶ä¸”æ‰€æœ‰åç¨‹ä¸»ä½“éƒ½ä¼šç»Ÿä¸€ä½¿ç”¨è¿™ç§çº¦å®šã€‚

---

**è¿”å›ç±»å‹ä¸€è‡´**
æºåç¨‹å’Œç›®æ ‡åç¨‹çš„ `.resume()` æ–¹æ³•è¿”å›ç±»å‹éƒ½æ˜¯ `void`ï¼Œæ‰€ä»¥è¿™ä¸ªæ¡ä»¶å¤©ç„¶æ»¡è¶³ã€‚

---

**æ²¡æœ‰éå¹³å‡¡ææ„å¯¹è±¡**
å°¾è°ƒç”¨è¦æ±‚åœ¨è°ƒç”¨ç›®æ ‡å‡½æ•°å‰é‡Šæ”¾å½“å‰æ ˆå¸§ï¼Œè¿™æ„å‘³ç€æ ˆä¸Šæ‰€æœ‰å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå¿…é¡»åœ¨è°ƒç”¨å‰ç»“æŸã€‚

é€šå¸¸è¿™ä¼šæˆä¸ºé—®é¢˜ï¼Œå› ä¸ºæ ˆä¸Šå¯èƒ½æœ‰å¸¦éå¹³å‡¡ææ„çš„å¯¹è±¡ï¼Œå®ƒä»¬ç”Ÿå‘½å‘¨æœŸå°šæœªç»“æŸã€‚

ä½†æ˜¯ï¼Œåç¨‹åœ¨æŒ‚èµ·ï¼ˆsuspendï¼‰æ—¶ä¸ä¼šé€€å‡ºä»»ä½•ä½œç”¨åŸŸã€‚å®ƒçš„åšæ³•æ˜¯ï¼š**æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸè·¨è¶ŠæŒ‚èµ·ç‚¹çš„å¯¹è±¡éƒ½ä¼šæ”¾è¿›åç¨‹å¸§ä¸­ï¼Œè€Œä¸æ˜¯æ”¾åœ¨æ ˆä¸Š**ã€‚

é‚£äº›ç”Ÿå‘½å‘¨æœŸä¸è·¨è¶ŠæŒ‚èµ·ç‚¹çš„å±€éƒ¨å˜é‡å¯ä»¥æ”¾åœ¨æ ˆä¸Šï¼Œä½†å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸä¼šåœ¨åç¨‹ä¸‹æ¬¡æŒ‚èµ·å‰ç»“æŸï¼Œå› æ­¤åœ¨å°¾è°ƒç”¨å‰å·²ç»ææ„å®Œæ¯•ã€‚

æ‰€ä»¥ï¼Œè¿™é‡Œä¸ä¼šæœ‰æ ˆä¸Šå¯¹è±¡éœ€è¦åœ¨å°¾è°ƒç”¨è¿”å›åå†ææ„çš„é—®é¢˜ã€‚

[[éå¹³å‡¡ææ„å‡½æ•°]]

---

**è°ƒç”¨ä¸åœ¨ try/catch å—å†…éƒ¨**
è¿™ä¸ªæ¯”è¾ƒæ£˜æ‰‹ï¼Œå› ä¸ºæ¯ä¸ªåç¨‹çš„ç”¨æˆ·ä»£ç å¤–é¢éƒ½æœ‰ä¸€ä¸ª**éšå¼çš„** `try/catch` å—ã€‚

æ ¹æ®æ ‡å‡†ï¼Œåç¨‹çš„ç»“æ„æ˜¯è¿™æ ·çš„ï¼š

```cpp
{
  promise_type promise;
  co_await promise.initial_suspend();
  try { F; }
  catch (...) { promise.unhandled_exception(); }
final_suspend:
  co_await promise.final_suspend();
}
```

å…¶ä¸­ `F` æ˜¯ç”¨æˆ·ç¼–å†™çš„åç¨‹ä½“ã€‚

æ‰€ä»¥ï¼Œé™¤ `initial_suspend` å’Œ `final_suspend` å¤–çš„æ‰€æœ‰ `co_await` è¡¨è¾¾å¼éƒ½åœ¨è¿™ä¸ªéšå¼çš„ try å—é‡Œã€‚

ä¸è¿‡ï¼Œç¼–è¯‘å™¨å®ç°ä¼šç»•è¿‡è¿™ä¸ªé—®é¢˜â€”â€”å®ƒä¼šè®© `.resume()` çš„è°ƒç”¨**åœ¨ try å—å¤–éƒ¨æ‰§è¡Œ**ã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“å‰ C++ è§„èŒƒå¹¶æ²¡æœ‰æ˜ç¡®è¦æ±‚å®ç°è¿™æ ·åšï¼Œè¿™åªæ˜¯ä¸€ä¸ªéè§„èŒƒæ€§çš„è¯´æ˜ï¼ˆnoteï¼‰æš—ç¤ºå¯èƒ½éœ€è¦è¿™æ ·åšã€‚æœªæ¥å¯èƒ½ä¼šä¿®è®¢æ ‡å‡†æ¥æ˜ç¡®è¿™ä¸€ç‚¹ã€‚

---

ç»¼ä¸Šï¼Œåç¨‹åœ¨æ‰§è¡Œ symmetric-transferï¼ˆå¯¹ç§°è½¬ç§»ï¼‰æ—¶ï¼Œä¸€èˆ¬éƒ½èƒ½æ»¡è¶³å°¾è°ƒç”¨çš„æ‰€æœ‰è¦æ±‚ã€‚ç¼–è¯‘å™¨ä¼šä¿è¯è¿™æ˜¯ä¸€ä¸ªå°¾è°ƒç”¨ï¼Œä¸è®ºæ˜¯å¦å¼€å¯ä¼˜åŒ–é€‰é¡¹ã€‚

è¿™æ„å‘³ç€ï¼Œåªè¦ç”¨è¿”å› `std::coroutine_handle` çš„ `await_suspend()` ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŒ‚èµ·å½“å‰åç¨‹å¹¶åˆ‡æ¢åˆ°å¦ä¸€ä¸ªåç¨‹æ‰§è¡Œï¼Œè€Œä¸ä¼šé¢å¤–æ¶ˆè€—æ ˆç©ºé—´ã€‚

è¿™æ ·æˆ‘ä»¬å°±èƒ½å†™å‡ºäº’ç›¸é€’å½’æ¢å¤ï¼ˆresumeï¼‰çš„åç¨‹ï¼Œä¸”é€’å½’æ·±åº¦ä¸å—æ ˆé™åˆ¶ï¼Œä¸ä¼šå‘ç”Ÿæ ˆæº¢å‡ºã€‚

è¿™æ­£æ˜¯ä¿®å¤ `task` å®ç°æ‰€éœ€è¦çš„ç‰¹æ€§ã€‚

## `task` å†æ¢

ç°åœ¨æˆ‘ä»¬å·²ç»æŒæ¡äº†æ–°çš„â€œå¯¹ç§°åˆ‡æ¢â€ï¼ˆsymmetric transferï¼‰èƒ½åŠ›ï¼Œè®©æˆ‘ä»¬å›å¤´ä¿®æ­£ä¸€ä¸‹ `task` ç±»å‹çš„å®ç°ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹å®ç°ä¸­çš„ä¸¤ä¸ª `await_suspend()` æ–¹æ³•ï¼š

* ç¬¬ä¸€å¤„ä¿®æ”¹ï¼šå½“æˆ‘ä»¬ `await` è¿™ä¸ª `task` æ—¶ï¼Œéœ€è¦é€šè¿‡**å¯¹ç§°åˆ‡æ¢**æ¥æ¢å¤ï¼ˆresumeï¼‰`task` åç¨‹ã€‚
* ç¬¬äºŒå¤„ä¿®æ”¹ï¼šå½“ `task` åç¨‹æ‰§è¡Œå®Œæˆæ—¶ï¼Œéœ€è¦é€šè¿‡**å¯¹ç§°åˆ‡æ¢**æ¥æ¢å¤ç­‰å¾…å®ƒçš„åç¨‹ã€‚

---

### 1. ä¿®æ”¹ `await` æ–¹å‘

åŸæ¥çš„ `task::awaiter` æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š

```cpp
void task::awaiter::await_suspend(
    std::coroutine_handle<> continuation) noexcept {
  // å°† continuation å­˜å‚¨åˆ° task çš„ promise ä¸­ï¼Œ
  // è¿™æ · final_suspend() å°±èƒ½åœ¨ task å®Œæˆæ—¶æ¢å¤è¿™ä¸ªåç¨‹ã€‚
  coro_.promise().continuation = continuation;

  // ç„¶åæ¢å¤ task åç¨‹ï¼Œå®ƒæ­¤æ—¶æ­£æŒ‚èµ·åœ¨åˆå§‹æŒ‚èµ·ç‚¹ï¼ˆä¹Ÿå°±æ˜¯èŠ±æ‹¬å·çš„èµ·å§‹å¤„ï¼‰ã€‚
  coro_.resume();
}
```

ä¿®æ”¹ä¸ºï¼š

```cpp
std::coroutine_handle<> task::awaiter::await_suspend(
    std::coroutine_handle<> continuation) noexcept {
  // å°† continuation å­˜å‚¨åˆ° task çš„ promise ä¸­ï¼Œ
  // è¿™æ · final_suspend() å°±èƒ½åœ¨ task å®Œæˆæ—¶æ¢å¤è¿™ä¸ªåç¨‹ã€‚
  coro_.promise().continuation = continuation;

  // é€šè¿‡è¿”å›åç¨‹å¥æŸ„çš„æ–¹å¼ï¼Œç›´æ¥è¿›è¡Œå°¾æ¢å¤ï¼ˆtail resumeï¼‰ï¼Œ
  // æ¢å¤ task åç¨‹ï¼Œå®ƒæ­¤æ—¶æ­£æŒ‚èµ·åœ¨åˆå§‹æŒ‚èµ·ç‚¹ï¼ˆä¹Ÿå°±æ˜¯èŠ±æ‹¬å·çš„èµ·å§‹å¤„ï¼‰ã€‚
  return coro_;
}
```

---

### 2. ä¿®æ”¹è¿”å›è·¯å¾„

åŸæ¥çš„ `task::promise_type::final_awaiter` æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š

```cpp
void task::promise_type::final_awaiter::await_suspend(
    std::coroutine_handle<promise_type> h) noexcept {
  // åç¨‹ç°åœ¨æŒ‚èµ·åœ¨ final-suspend ç‚¹ã€‚
  // ä» promise ä¸­å–å‡º continuation å¹¶æ¢å¤å®ƒã€‚
  h.promise().continuation.resume();
}
```

ä¿®æ”¹ä¸ºï¼š

```cpp
std::coroutine_handle<> task::promise_type::final_awaiter::await_suspend(
    std::coroutine_handle<promise_type> h) noexcept {
  // åç¨‹ç°åœ¨æŒ‚èµ·åœ¨ final-suspend ç‚¹ã€‚
  // ä» promise ä¸­å–å‡º continuationï¼Œå¹¶é€šè¿‡å¯¹ç§°åˆ‡æ¢æ¢å¤å®ƒã€‚
  return h.promise().continuation;
}
```

---

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ª `task` å®ç°ï¼š

* ä¸ä¼šå†å‡ºç° `void` è¿”å›çš„ `await_suspend` ç‰ˆæœ¬çš„**æ ˆæº¢å‡ºé—®é¢˜**
* ä¹Ÿä¸ä¼šå‡ºç° `bool` è¿”å›çš„ `await_suspend` ç‰ˆæœ¬çš„**éç¡®å®šæ€§æ¢å¤ä¸Šä¸‹æ–‡é—®é¢˜**

### å¯è§†åŒ–è°ƒç”¨æ ˆ

è®©æˆ‘ä»¬å›åˆ°æœ€åˆçš„ç¤ºä¾‹ï¼š

```cpp
task completes_synchronously() {
  co_return;
}

task loop_synchronously(int count) {
  for (int i = 0; i < count; ++i) {
    co_await completes_synchronously();
  }
}
```

å½“ `loop_synchronously()` åç¨‹ç¬¬ä¸€æ¬¡å¼€å§‹æ‰§è¡Œæ—¶ï¼Œæ˜¯å› ä¸ºæŸä¸ªå…¶ä»–åç¨‹ `co_await` äº† `loop_synchronously()` è¿”å›çš„ `task`ã€‚
è¿™ä¸ªè°ƒç”¨è¿‡ç¨‹æ˜¯é€šè¿‡**å¯¹ç§°è½¬ç§»**ï¼ˆsymmetric transferï¼‰ä»å¦ä¸€ä¸ªåç¨‹å¯åŠ¨çš„ï¼Œè€Œé‚£ä¸ªåç¨‹æœ¬èº«åˆæ˜¯é€šè¿‡ `std::coroutine_handle::resume()` æ¢å¤çš„ã€‚

å› æ­¤ï¼Œå½“ `loop_synchronously()` åˆšå¼€å§‹æ‰§è¡Œæ—¶ï¼Œè°ƒç”¨æ ˆå¤§è‡´å¦‚ä¸‹ï¼š

```
           Stack                                                Heap
+---------------------------+  <-- top of stack   +--------------------------+
| loop_synchronously$resume | active coroutine -> | loop_synchronously frame |
+---------------------------+                     | +----------------------+ |
| coroutine_handle::resume  |                     | | task::promise        | |
+---------------------------+                     | | - continuation --.   | |
|     ...                   |                     | +------------------|---+ |
+---------------------------+                     | ...                |     |
                                                  +--------------------|-----+
                                                                       V
                                                  +--------------------------+
                                                  | awaiting_coroutine frame |
                                                  |                          |
                                                  +--------------------------+
```


---

ç°åœ¨ï¼Œå½“å®ƒæ‰§è¡Œ `co_await completes_synchronously()` æ—¶ï¼Œä¼šè¿›è¡Œä¸€æ¬¡**å¯¹ç§°è½¬ç§»**åˆ° `completes_synchronously` åç¨‹ã€‚

æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š

1. è°ƒç”¨ `task::operator co_await()`ï¼Œè¿”å›ä¸€ä¸ª `task::awaiter` å¯¹è±¡ï¼›
2. æŒ‚èµ·å½“å‰åç¨‹ï¼Œè°ƒç”¨ `task::awaiter::await_suspend()`ï¼›
3. `await_suspend()` è¿”å› `completes_synchronously` åç¨‹çš„ `coroutine_handle`ï¼›
4. æ‰§è¡Œä¸€æ¬¡**å°¾è°ƒç”¨**ï¼ˆtail-callï¼‰/ è·³è½¬åˆ° `completes_synchronously` åç¨‹ï¼Œè¿™ä¼šå…ˆå¼¹å‡º `loop_synchronously` çš„æ ˆå¸§ï¼Œå†æ¿€æ´» `completes_synchronously` çš„å¸§ã€‚

æ­¤æ—¶ï¼Œ`completes_synchronously` åˆšæ¢å¤æ—¶ï¼Œè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š


```
              Stack                                          Heap
                                            .-> +--------------------------+ <-.
                                            |   | completes_synchronously  |   |
                                            |   | frame                    |   |
                                            |   | +----------------------+ |   |
                                            |   | | task::promise        | |   |
                                            |   | | - continuation --.   | |   |
                                            |   | +------------------|---+ |   |
                                            `-, +--------------------|-----+   |
                                              |                      V         |
+-------------------------------+ <-- top of  | +--------------------------+   |
| completes_synchronously$resume|     stack   | | loop_synchronously frame |   |
+-------------------------------+ active -----' | +----------------------+ |   |
| coroutine_handle::resume      | coroutine     | | task::promise        | |   |
+-------------------------------+               | | - continuation --.   | |   |
|     ...                       |               | +------------------|---+ |   |
+-------------------------------+               | task temporary     |     |   |
                                                | - coro_       -----|---------`
                                                +--------------------|-----+
                                                                     V
                                                +--------------------------+
                                                | awaiting_coroutine frame |
                                                |                          |
                                                +--------------------------+
```

> æ³¨æ„ï¼šæ ˆå¸§æ•°é‡å¹¶æ²¡æœ‰å¢åŠ ã€‚

---

å½“ `completes_synchronously` æ‰§è¡Œåˆ°ç»“å°¾ï¼ˆ`}`ï¼‰æ—¶ï¼Œä¼šè¿›å…¥ `co_await promise.final_suspend()`ã€‚

æ­¤æ—¶ï¼š

1. æŒ‚èµ· `completes_synchronously`ï¼›
2. è°ƒç”¨ `final_awaiter::await_suspend()`ï¼Œå®ƒè¿”å›**å»¶ç»­åç¨‹**ï¼ˆcontinuationï¼‰çš„ `std::coroutine_handle`ï¼ˆä¹Ÿå°±æ˜¯ `loop_synchronously` çš„å¥æŸ„ï¼‰ï¼›
3. è¿›è¡Œ**å¯¹ç§°è½¬ç§»**åˆ° `loop_synchronously` åç¨‹ã€‚

---

åˆšæ¢å¤ `loop_synchronously` æ—¶ï¼Œè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š

```
           Stack                                                   Heap
                                                   +--------------------------+ <-.
                                                   | completes_synchronously  |   |
                                                   | frame                    |   |
                                                   | +----------------------+ |   |
                                                   | | task::promise        | |   |
                                                   | | - continuation --.   | |   |
                                                   | +------------------|---+ |   |
                                                   +--------------------|-----+   |
                                                                        V         |
+----------------------------+  <-- top of stack   +--------------------------+   |
| loop_synchronously$resume  | active coroutine -> | loop_synchronously frame |   |
+----------------------------+                     | +----------------------+ |   |
| coroutine_handle::resume() |                     | | task::promise        | |   |
+----------------------------+                     | | - continuation --.   | |   |
|     ...                    |                     | +------------------|---+ |   |
+----------------------------+                     | task temporary     |     |   |
                                                   | - coro_       -----|---------`
                                                   +--------------------|-----+
                                                                        V
                                                   +--------------------------+
                                                   | awaiting_coroutine frame |
                                                   |                          |
                                                   +--------------------------+
```


æ¥ä¸‹æ¥ï¼Œ`loop_synchronously` ä¼šæ‰§è¡Œ `completes_synchronously()` è°ƒç”¨è¡¨è¾¾å¼æœ«å°¾çš„åˆ†å·å¤„çš„ä¸´æ—¶ `task` ææ„å‡½æ•°ï¼Œè¿™ä¼šé”€æ¯ `completes_synchronously` çš„åç¨‹å¸§ï¼Œé‡Šæ”¾å†…å­˜ã€‚äºæ˜¯å˜æˆï¼š

```
           Stack                                                   Heap
+---------------------------+  <-- top of stack   +--------------------------+
| loop_synchronously$resume | active coroutine -> | loop_synchronously frame |
+---------------------------+                     | +----------------------+ |
| coroutine_handle::resume  |                     | | task::promise        | |
+---------------------------+                     | | - continuation --.   | |
|     ...                   |                     | +------------------|---+ |
+---------------------------+                     | ...                |     |
                                                  +--------------------|-----+
                                                                       V
                                                  +--------------------------+
                                                  | awaiting_coroutine frame |
                                                  |                          |
                                                  +--------------------------+
```

---

æˆ‘ä»¬åˆå›åˆ°æ‰§è¡Œ `loop_synchronously`ï¼Œæ ˆå¸§å’Œåç¨‹å¸§æ•°é‡ä¸å¼€å§‹æ—¶ç›¸åŒã€‚
å› æ­¤ï¼Œæ— è®ºå¾ªç¯å¤šå°‘æ¬¡ï¼Œéƒ½åªä¼šä½¿ç”¨**å¸¸é‡ç©ºé—´**ï¼Œä¸ä¼šå‘ç”Ÿæ ˆè†¨èƒ€ã€‚

å®Œæ•´çš„æ”¯æŒå¯¹ç§°è½¬ç§»ç‰ˆæœ¬ `task` å®ç°å¯è§ï¼š[https://godbolt.org/z/9baieF](https://godbolt.org/z/9baieF)

## å¯¹ç§°ä¼ è¾“ä½œä¸º `await_suspend` çš„é€šç”¨å½¢å¼

ç°åœ¨æˆ‘ä»¬çœ‹åˆ°å¯¹ç§°ä¼ è¾“å½¢å¼çš„ `awaitable` æ¦‚å¿µçš„å¼ºå¤§å’Œé‡è¦æ€§ï¼Œæˆ‘æƒ³å‘ä½ å±•ç¤ºï¼Œè¿™ç§å½¢å¼å®é™…ä¸Šæ˜¯é€šç”¨çš„å½¢å¼ï¼Œç†è®ºä¸Šå¯ä»¥å–ä»£ `void` å’Œ `bool` è¿”å›å½¢å¼çš„ `await_suspend()`ã€‚

ä½†é¦–å…ˆæˆ‘ä»¬éœ€è¦çœ‹çœ‹ææ¡ˆ [P0913R0](https://wg21.link/P0913R0) ä¸­æ·»åŠ åˆ°åç¨‹è®¾è®¡ä¸­çš„å¦ä¸€éƒ¨åˆ†ï¼š`std::noop_coroutine()`ã€‚

### ç»ˆæ­¢é€’å½’

åœ¨åç¨‹çš„å¯¹ç§°ä¼ è¾“å½¢å¼ä¸­ï¼Œæ¯æ¬¡åç¨‹æŒ‚èµ·æ—¶ï¼Œéƒ½ä¼šå¯¹å¦ä¸€ä¸ªåç¨‹è¿›è¡Œå¯¹ç§°æ¢å¤ã€‚è¿™åœ¨æˆ‘ä»¬æœ‰å¦ä¸€ä¸ªåç¨‹éœ€è¦æ¢å¤æ—¶éå¸¸å¥½ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬æ²¡æœ‰å¦ä¸€ä¸ªåç¨‹éœ€è¦æ‰§è¡Œï¼Œåªæ˜¯éœ€è¦æŒ‚èµ·å¹¶è®©æ‰§è¡Œè¿”å›åˆ° `std::coroutine_handle::resume()` çš„è°ƒç”¨è€…ã€‚

`void` è¿”å›å½¢å¼å’Œ `bool` è¿”å›å½¢å¼çš„ `await_suspend()` éƒ½å…è®¸åç¨‹æŒ‚èµ·å¹¶ä» `std::coroutine_handle::resume()` è¿”å›ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•ç”¨å¯¹ç§°ä¼ è¾“å½¢å¼æ¥åšè¿™ä¸ªå‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„å†…ç½® `std::coroutine_handle`ï¼Œå®ƒå«åšâ€œnoop åç¨‹å¥æŸ„â€ï¼Œå¯ä»¥é€šè¿‡å‡½æ•° `std::noop_coroutine()` æ¥è·å¾—ã€‚

â€œnoop åç¨‹å¥æŸ„â€ä¹‹æ‰€ä»¥è¿™æ ·å‘½åï¼Œæ˜¯å› ä¸ºå®ƒçš„ `.resume()` å®ç°åªæ˜¯ç«‹å³è¿”å›ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¢å¤åç¨‹æ—¶ä¸ä¼šåšä»»ä½•æ“ä½œã€‚é€šå¸¸ï¼Œå®ƒçš„å®ç°åªåŒ…å«ä¸€æ¡ `ret` æŒ‡ä»¤ã€‚

å¦‚æœ `await_suspend()` æ–¹æ³•è¿”å› `std::noop_coroutine()` å¥æŸ„ï¼Œé‚£ä¹ˆå®ƒå°±ä¸ä¼šæŠŠæ‰§è¡Œè½¬ç§»åˆ°ä¸‹ä¸€ä¸ªåç¨‹ï¼Œè€Œæ˜¯å°†æ‰§è¡Œè½¬å›åˆ° `std::coroutine_handle::resume()` çš„è°ƒç”¨è€…ã€‚

### è¡¨ç¤ºå…¶ä»–å½¢å¼çš„ `await_suspend()`

æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å±•ç¤ºå¦‚ä½•ä½¿ç”¨å¯¹ç§°ä¼ è¾“å½¢å¼æ¥è¡¨ç¤ºå…¶ä»–å½¢å¼çš„ `await_suspend()`ã€‚

#### `void` è¿”å›å½¢å¼

```cpp
void my_awaiter::await_suspend(std::coroutine_handle<> h) {
  this->coro = h;
  enqueue(this);
}
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ `bool` è¿”å›å½¢å¼æ¥å†™ï¼š

```cpp
bool my_awaiter::await_suspend(std::coroutine_handle<> h) {
  this->coro = h;
  enqueue(this);
  return true;
}
```

å¹¶ä¸”å¯ä»¥ä½¿ç”¨å¯¹ç§°ä¼ è¾“å½¢å¼æ¥å†™ï¼š

```cpp
std::noop_coroutine_handle my_awaiter::await_suspend(
    std::coroutine_handle<> h) {
  this->coro = h;
  enqueue(this);
  return std::noop_coroutine();
}
```

#### `bool` è¿”å›å½¢å¼

```cpp
bool my_awaiter::await_suspend(std::coroutine_handle<> h) {
  this->coro = h;
  if (try_start(this)) {
    // æ“ä½œå°†å¼‚æ­¥å®Œæˆã€‚
    // è¿”å› true å°†æ‰§è¡Œè½¬ç§»åˆ° coroutine_handle::resume() çš„è°ƒç”¨è€…ã€‚
	// coroutine_hanldle::resume()
    return true;
  }

  // æ“ä½œå·²åŒæ­¥å®Œæˆã€‚
  // è¿”å› false å°†ç«‹å³æ¢å¤å½“å‰åç¨‹ã€‚
  return false;
}
```

ä¹Ÿå¯ä»¥ä½¿ç”¨å¯¹ç§°ä¼ è¾“å½¢å¼æ¥å†™ï¼š

```cpp
std::coroutine_handle<> my_awaiter::await_suspend(std::coroutine_handle<> h) {
  this->coro = h;
  if (try_start(this)) {
    // æ“ä½œå°†å¼‚æ­¥å®Œæˆã€‚
    // è¿”å› std::noop_coroutine() å°†æ‰§è¡Œè½¬ç§»åˆ° coroutine_handle::resume() çš„è°ƒç”¨è€…ã€‚
	// coroutine_handle::resume()
    return std::noop_coroutine();
  }

  // æ“ä½œå·²åŒæ­¥å®Œæˆã€‚
  // è¿”å›å½“å‰åç¨‹çš„å¥æŸ„å°†ç«‹å³æ¢å¤å½“å‰åç¨‹ã€‚
  // the current coroutine
  return h;
}
```

### ä¸ºä»€ä¹ˆæœ‰è¿™ä¸‰ç§å½¢å¼ï¼Ÿ

é‚£ä¹ˆï¼Œæ—¢ç„¶æˆ‘ä»¬æœ‰äº†å¯¹ç§°ä¼ è¾“å½¢å¼çš„ `await_suspend()`ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦ `void` å’Œ `bool` è¿”å›å½¢å¼å‘¢ï¼Ÿ

åŸå› éƒ¨åˆ†æ˜¯å†å²åŸå› ï¼Œéƒ¨åˆ†æ˜¯å®ç”¨æ€§è€ƒè™‘ï¼Œéƒ¨åˆ†æ˜¯æ€§èƒ½æ–¹é¢çš„åŸå› ã€‚

`void` è¿”å›å½¢å¼å®é™…ä¸Šå®Œå…¨å¯ä»¥é€šè¿‡åœ¨ `await_suspend()` ä¸­è¿”å› `std::noop_coroutine_handle` æ¥æ›¿ä»£ï¼Œå› ä¸ºè¿™ä¼šå‘ç¼–è¯‘å™¨å‘å‡ºç­‰æ•ˆçš„ä¿¡å·ï¼Œè¡¨ç¤ºåç¨‹æ— æ¡ä»¶åœ°å°†æ‰§è¡Œè½¬ç§»åˆ° `std::coroutine_handle::resume()` çš„è°ƒç”¨è€…ã€‚

ä¿ç•™ `void` è¿”å›å½¢å¼çš„åŸå› ï¼Œä¸ªäººè®¤ä¸ºï¼Œéƒ¨åˆ†æ˜¯å› ä¸ºå®ƒåœ¨å¼•å…¥å¯¹ç§°ä¼ è¾“å½¢å¼ä¹‹å‰å·²ç»è¢«å¹¿æ³›ä½¿ç”¨ï¼Œéƒ¨åˆ†æ˜¯å› ä¸º `void` å½¢å¼åœ¨æ— æ¡ä»¶æŒ‚èµ·çš„æƒ…å†µä¸‹å¯¼è‡´æ›´å°‘çš„ä»£ç /è¾“å…¥ã€‚

ç„¶è€Œï¼Œ`bool` è¿”å›å½¢å¼ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç›¸è¾ƒäºå¯¹ç§°ä¼ è¾“å½¢å¼ï¼Œå¯ä»¥åœ¨ä¼˜åŒ–æ–¹é¢ç•¥å¾®æœ‰ä¼˜åŠ¿ã€‚

è€ƒè™‘ä»¥ä¸‹æƒ…å†µï¼šæˆ‘ä»¬æœ‰ä¸€ä¸ª `bool` è¿”å›å½¢å¼çš„ `await_suspend()` æ–¹æ³•ï¼Œå®ƒå®šä¹‰åœ¨å¦ä¸€ä¸ªç¿»è¯‘å•å…ƒä¸­ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨å¯ä»¥åœ¨ç­‰å¾…åç¨‹ä¸­ç”Ÿæˆä»£ç ï¼ŒæŒ‚èµ·å½“å‰åç¨‹ï¼Œç„¶ååœ¨è°ƒç”¨ `await_suspend()` è¿”å›åï¼Œæ¡ä»¶æ€§åœ°æ¢å¤å®ƒï¼Œåªéœ€è¦æ‰§è¡Œä¸‹ä¸€å—ä»£ç ã€‚å¦‚æœ `await_suspend()` è¿”å› `false`ï¼Œå®ƒçŸ¥é“ä¸‹ä¸€æ­¥è¯¥æ‰§è¡Œä»€ä¹ˆä»£ç ã€‚

å¯¹äºå¯¹ç§°ä¼ è¾“å½¢å¼ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦è¡¨ç¤ºç›¸åŒçš„ç»“æœï¼šè¦ä¹ˆè¿”å›åˆ°è°ƒç”¨è€…/æ¢å¤ï¼Œè¦ä¹ˆæ¢å¤å½“å‰åç¨‹ã€‚æˆ‘ä»¬éœ€è¦è¿”å› `std::noop_coroutine()` æˆ–å½“å‰åç¨‹çš„å¥æŸ„ï¼Œè€Œä¸æ˜¯è¿”å› `true` æˆ– `false`ã€‚æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸¤ä¸ªå¥æŸ„å¼ºåˆ¶è½¬æ¢ä¸º `std::coroutine_handle<void>` ç±»å‹å¹¶è¿”å›å®ƒã€‚

ç„¶è€Œï¼Œç°åœ¨ç”±äº `await_suspend()` æ–¹æ³•å®šä¹‰åœ¨å¦ä¸€ä¸ªç¿»è¯‘å•å…ƒä¸­ï¼Œç¼–è¯‘å™¨æ— æ³•çœ‹åˆ°è¿”å›çš„å¥æŸ„å¼•ç”¨çš„æ˜¯å“ªä¸ªåç¨‹ï¼Œå› æ­¤å½“å®ƒæ¢å¤åç¨‹æ—¶ï¼Œå¯èƒ½éœ€è¦æ‰§è¡Œä¸€äº›æ›´æ˜‚è´µçš„é—´æ¥è°ƒç”¨ï¼Œå¯èƒ½è¿˜éœ€è¦ä¸€äº›åˆ†æ”¯æ“ä½œæ¥æ¢å¤åç¨‹ï¼Œè€Œ `bool` è¿”å›å½¢å¼åˆ™åªéœ€è¦ä¸€ä¸ªåˆ†æ”¯ã€‚

ç°åœ¨ï¼Œå¯èƒ½æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸç§æ–¹å¼ä½¿å¯¹ç§°ä¼ è¾“ç‰ˆæœ¬è·å¾—ä¸ `bool` è¿”å›å½¢å¼ç›¸å½“çš„æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä»£ç ï¼Œä½¿å¾— `await_suspend()` åœ¨å†…è”å‡½æ•°ä¸­å®šä¹‰ï¼Œä½†è°ƒç”¨ä¸€ä¸ªåœ¨å¤–éƒ¨ç¿»è¯‘å•å…ƒä¸­å®šä¹‰çš„ `bool` è¿”å›å½¢å¼çš„æ–¹æ³•ï¼Œç„¶åæœ‰æ¡ä»¶åœ°è¿”å›é€‚å½“çš„å¥æŸ„ã€‚

ä¾‹å¦‚ï¼š

```cpp
struct my_awaiter {
  bool await_ready();

  // ç†è®ºä¸Šï¼Œç¼–è¯‘å™¨åº”è¯¥èƒ½å¤Ÿå°†æ­¤ä¼˜åŒ–ä¸ºä¸ bool è¿”å›å½¢å¼ç›¸åŒï¼Œ
  // ä½†ç›®å‰å°šæœªè¿›è¡Œè¿™ç§ä¼˜åŒ–ã€‚
  std::coroutine_handle<> await_suspend(std::coroutine_handle<> h) {
    if (try_start(h)) {
      return std::noop_coroutine();
    } else {
      return h;
    }
  }

  void await_resume();

private:
  // è¯¥æ–¹æ³•åœ¨å¤–éƒ¨ç¿»è¯‘å•å…ƒä¸­å®šä¹‰ã€‚
  bool try_start(std::coroutine_handle<> h);
}
```

ç„¶è€Œï¼Œç›®å‰çš„ç¼–è¯‘å™¨ï¼ˆä¾‹å¦‚ Clang 10ï¼‰å°šä¸èƒ½å°†æ­¤ä¼˜åŒ–ä¸ºä¸ç­‰æ•ˆçš„ `bool` è¿”å›å½¢å¼ä¸€æ ·é«˜æ•ˆçš„ä»£ç ã€‚è¯è™½å¦‚æ­¤ï¼Œé™¤éä½ åœ¨ä¸€ä¸ªéå¸¸ç´§å¯†çš„å¾ªç¯ä¸­ç­‰å¾…è¿™ä¸ªï¼Œå¦åˆ™ä½ å¯èƒ½ä¸ä¼šæ³¨æ„åˆ°å·®å¼‚ã€‚

å› æ­¤ï¼Œç›®å‰çš„ä¸€èˆ¬è§„åˆ™æ˜¯ï¼š

* å¦‚æœä½ éœ€è¦æ— æ¡ä»¶åœ°è¿”å›åˆ° `.resume()` è°ƒç”¨è€…ï¼Œä½¿ç”¨ `void` è¿”å›å½¢å¼ã€‚
* å¦‚æœä½ éœ€è¦æœ‰æ¡ä»¶åœ°è¿”å›åˆ° `.resume()` è°ƒç”¨è€…æˆ–æ¢å¤å½“å‰åç¨‹ï¼Œä½¿ç”¨ `bool` è¿”å›å½¢å¼ã€‚
* å¦‚æœä½ éœ€è¦æ¢å¤å¦ä¸€ä¸ªåç¨‹ï¼Œä½¿ç”¨å¯¹ç§°ä¼ è¾“å½¢å¼ã€‚

## æ€»ç»“

C++20 ä¸­æ–°å¢çš„å¯¹ç§°ä¼ è¾“åŠŸèƒ½ä½¿å¾—ç¼–å†™äº’ç›¸é€’å½’æ¢å¤çš„åç¨‹å˜å¾—æ›´åŠ å®¹æ˜“ï¼Œè€Œæ— éœ€æ‹…å¿ƒå †æ ˆæº¢å‡ºã€‚è¿™ä¸€åŠŸèƒ½æ˜¯å®ç°é«˜æ•ˆä¸”å®‰å…¨çš„å¼‚æ­¥åç¨‹ç±»å‹ï¼ˆå¦‚æœ¬æ–‡ä¸­å±•ç¤ºçš„ `task` ç±»å‹ï¼‰çš„å…³é”®ã€‚

è¿™ç¯‡å…³äºå¯¹ç§°ä¼ è¾“çš„æ–‡ç« æ¯”é¢„æœŸçš„è¦é•¿å¾ˆå¤šã€‚å¦‚æœä½ åšæŒçœ‹åˆ°è¿™é‡Œï¼Œæ„Ÿè°¢ä½ çš„è€å¿ƒï¼å¸Œæœ›ä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰ç”¨ã€‚

åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†æ·±å…¥æ¢è®¨ç¼–è¯‘å™¨å¦‚ä½•å°†åç¨‹å‡½æ•°è½¬åŒ–ä¸ºçŠ¶æ€æœºã€‚

## æ„Ÿè°¢

æ„Ÿè°¢ Eric Niebler å’Œ Corentin Jabot å¯¹æœ¬æ–‡è‰ç¨¿æä¾›çš„åé¦ˆã€‚
