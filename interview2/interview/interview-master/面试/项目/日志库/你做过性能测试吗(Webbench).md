### 性能测试



### 测试工具：Webbench

Webbench能测试处在相同硬件上，**不同服务的性能以及不同硬件上同一个服务的运行状况。**

webbench的标准测试可以向我们展示服务器的两项内容：**每秒钟相应请求数和每秒钟传输数据量。**

**Webbench最多可以模拟3万个并发连接去测试网站的负载能力。**

##### 测试实例

```shell
webbench -t 60 -c 100 http://www.baidu.com/
```

> - `-t` 表示时间,benchmark持续多久
> - `-c` 表示客户端数, time时间内请求多少次。

测试结果

```shell
[...]# webbench -t 60 -c 100 http://www.baidu.com/
Webbench - Simple Web Benchmark 1.5
Copyright (c) Radim Kolar 1997-2004, GPL Open Source Software.

Benchmarking: GET http://www.baidu.com/
100 clients, running 60 sec.

Speed=2942 pages/min, 15162326 bytes/sec.
Requests: 2938 susceed, 4 failed.

```

- 并发连接总数：100
- 访问服务器时间：60s
- 每秒钟响应请求数：2942 pages/min
- 每秒钟传输数据量：15162326 bytes/sec
- 2938访问成功，4失败



Webbench**实现的核心原理是**：

1. 父进程fork若干个子进程，

2. 每个子进程在用户要求时间或默认的时间内对目标web循环发出实际访问请求，
3. 子进程在时间到后结束，
4. 父进程在所有子进程退出后统计并给用户显示最后的测试结果，然后退出。

##### 父子进程通过管道进行通信：

* 子进程通过管道写端向父进程传递在若干次请求访问完毕后记录到的总信息

* 父进程通过管道读端读取子进程发来的相关信息，






#### 测试数据

#### 1. 单线程连续写1亿条日志的效率

写1亿条日志（每条日志长度为100字节）测试调用总耗时，测5次，结果如下：

| 方式  |  第1次  |  第2次  |  第3次  |  第4次  |  第5次  |  平均  |   速度/s   |
| :---: | :-----: | :-----: | :-----: | :-----: | :-----: | :----: | :--------: |
| MuLog | 79.816s | 78.694s | 79.489s | 79.731s | 79.220s | 79.39s | 125.96万/s |

**每秒127万条**长为*100字节*的日志的写入

#### 2、多线程各写1千万条日志的效率

开5个线程各写1千万条日志（每条日志长度为100字节）测试调用总耗时，测5次，结果如下：

| 方式  |  第1次  |  第2次  |  第3次  |  第4次  |  第5次  |  平均   |   速度/s   |
| ----- | :-----: | :-----: | :-----: | :-----: | :-----: | :-----: | :--------: |
| MuLog | 36.896s | 37.011s | 38.524s | 37.197s | 38.034s | 37.532s | 133.22万/s |

多线程（5线程）运行下，`MuLog`写日志效率是传统同步日志的近`3.8`倍，可以达到**每秒135.5万条**长为*100字节*的日志的写入



 QPS每秒查询率(Query Per Second) 
　　每秒查询率QPS是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准，在因特网上，作为域名系统服务器的机器的性能经常用每秒查询率来衡量。对应fetches/sec，即**每秒的响应请求数**，也即是最大吞吐能力。



#### 2. 对server QPS的影响

现有一个Reactor模式实现的echo Server（基于Muluo），其纯净的QPS大致为`19.32万/s`
现在分别使用`MuLog`来测试：echo Server在每收到一个数据就调用一次日志打印下的QPS表现

采集12次实时QPS，统计后大致结果如下：

|   方式   | 最低QPS  | 最高QPS  | 平均QPS  | QPS损失比 |
| :------: | :------: | :------: | :------: | :-------: |
| ` MuLog` | 154979次 | 178697次 | 167198次 |  13.46%   |

>传统同步日志损失了`40%`左右
>`MuLog`使得echo Server QPS从19.32w万/s降低至`16.72万/s`，损失了`13.46%`



参考：https://blog.csdn.net/weixin_38333555/article/details/81457817