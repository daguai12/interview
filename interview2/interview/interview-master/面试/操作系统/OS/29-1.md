### 虚拟地址空间的分布

虚拟地址空间0~3G用于应用层
虚拟地址空间3~4G用于内核层
![image](https://pic1.zhimg.com/80/v2-fa4e727f2a22ac21128986094bc8f8a0_1440w.jpg)

内核空间分为**3部分**，ZONE_DMA，ZONE_NORMAL，ZONE_HIGHMEME。

* ZONE_DMA，0-16M，直接内存访问。该区域的物理页面专门供I/O设备的DMA使用。
* ZONR_NORMAL，16M-896M，内核最重要的部分，该区域的物理页面是内核能够直接使用的。
* ZONE_HIGHMEM，896M-结束，共128M，高端内存。主要用于32位Linux系统中，映射高于1G的物理内存。64位不需要高端内存。



一个程序本质上都是由BSS段、data段、text段三个组成的。可以看到一个可执行程序在存储（没有调入内存）时分为代码段、数据区和未初始化数据区三部分。

BSS段（未初始化数据区）：通常用来存放程序中未初始化的全局变量和静态变量的一块内存区域。BSS段属于静态分配，程序结束后静态变量资源由系统自动释放。

数据段：存放程序中已初始化的全局变量的一块内存区域。数据段也属于静态内存分配

代码段：存放程序执行代码的一块内存区域。这部分区域的大小在程序运行前就已经确定，并且内存区域属于只读。在代码段中，也有可能包含一些只读的常数变量

text段和data段在编译时已经分配了空间，而BSS段并不占用可执行文件的大小，它是由链接器来获取内存的。

bss段（未进行初始化的数据）的内容并不存放在磁盘上的程序文件中。其原因是内核在程序开始运行前将它们设置为0。需要存放在程序文件中的只有正文段和初始化数据段。

data段（已经初始化的数据）则为数据分配空间，数据保存到目标文件中。

数据段包含经过初始化的全局变量以及它们的值。BSS段的大小从可执行文件中得到，然后链接器得到这个大小的内存块，紧跟在数据段的后面。当这个内存进入程序的地址空间后全部清零。包含数据段和BSS段的整个区段此时通常称为数据区。

可执行程序在运行时又多出两个区域：栈区和堆区。

栈区：由编译器自动释放，存放函数的参数值、局部变量等。每当一个函数被调用时，该函数的返回类型和一些调用的信息被存放到栈中。然后这个被调用的函数再为他的自动变量和临时变量在栈上分配空间。每调用一个函数一个新的栈就会被使用。栈区是从高地址位向低地址位增长的，是一块连续的内存区域，最大容量是由系统预先定义好的，申请的栈空间超过这个界限时会提示溢出，用户能从栈中获取的空间较小。

堆区：用于动态分配内存，位于BSS和栈中间的地址区域。由程序员申请分配和释放。堆是从低地址位向高地址位增长，采用链式存储结构。频繁的malloc/free造成内存空间的不连续，产生碎片。当申请堆空间时库函数是按照一定的算法搜索可用的足够大的空间。因此堆的效率比栈要低的多。





运行时内存大致分为四个数据区：常量区、全局数据区(静态区)、堆区、栈区

## 常量区

存储了未被作为初始化使用的字符串常量和 const 修饰的全局变量，特点是只能读不能写，受到操作系统运行时保护，强行修改会导致 segmentation fault，生命周期同程序运行过程。

```c
/* 字符串 "hello world" 存在字符串常量区, 
 指针 str 本身存储在全局数据区或者栈上(函数内) */
char *str = "hello world";
```

## 全局数据区

存储了全部的全局变量，和所有被 static 修饰的变量（包括全局和局部），其特点是生命周期很长（为一次程序的运行过程）并且只被初始化一次。

```c
int global = 2;   // 存在全局数据区   
int main(int argc, char *argv[]){ 
      static int static_global = 1; // 静态局部变量也是存在全局数据区    
      int local = 2;                //  存在栈上，见下   
      return 0;
}
```

## 栈区

存储了所有自动存储（不加任何存储类型关键字( static 等)修饰或被 auto 修饰）的局部变量，其特点是生命周期很短，仅仅是该变量所在函数的一次调用过程, 函数被调用时被自动分配并在函数返回后回收

```c
// num 和 localnum都是分配在栈上   
int func(int num){      
     int localnum = -1;     
     return localnum * num;   
}
```

很多 C/C++ 初学者容易犯的一个错误就是返回局部变量的指针或者指针，但是这个指针所指向的局部变量在函数返回后就会被自动回收(退栈)。所以当对返回的局部变量的指针被dereference时也会发生无法预料的错误。

## 堆区

是由操作系统负责维护的大片内存池，使用时需手动申请, 一般是调用 malloc 家族函数进行动态内存分配，但使用完毕后需要使用 free 手动释放，否则会造成严重的内存泄漏。所有分配的内存当该进程退出后就会被操作系统回收，但是对于需要长期运行的服务器程序来说，就必须保证内存泄漏尽量少(完全没有基本不可能，除非程序很简单)。

```c
int *p = (int*)malloc(100 * sizeof(int));   
for(int i = 0; i < 100; i++){ 
        p[i] = i;      
}  
free(p);
p = NULL;
```

