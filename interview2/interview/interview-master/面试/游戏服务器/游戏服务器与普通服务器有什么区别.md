## **游戏服务器架构通识**

**· 前言**

· 我们将从游戏服务器发展的简单历程出发，鸟瞰一下目前大多数的游戏服务器架构。

· 这里尽可能的避免陷入细节的技术问题，而是从技术进化的结果状态，反推原始问题是什么。希望能通过这个过程，解释清楚游戏服务器是在解决什么问题，痛点到底在哪里。

**· 一、早期网游服务器。**



![img](https://pic4.zhimg.com/80/v2-d0d7eed73b05de796146c3a8c621adcc_1440w.jpg)



· 蛮荒时期的游戏服务器框架我们一笔带过，那时的游戏服务器和一个小Web服务没有区别。

· 蛮荒时代的服务器只负责存储玩家账号、数据、转发场景内其他玩家的行为。很多移动、使用技能等关键逻辑在服务器上根本没有。随意就能用变速齿轮改变游戏速度。

· 从传奇的时代开始，游戏服务器就不再是简单的上传存档、下载存档、访问页面而已。游戏服务器内部出现了游戏逻辑，既能用于同步每个玩家看到的世界，又能让逻辑与客户端分离，避免早期的网络游戏那种毫无防范的逻辑体系（对外挂防御能力为0）。

· 这种架构奇怪的地方是处理网络连接数据传输的压力和逻辑处理的压力在同一个服务器上（存储模块可能也在同一个进程），就算逻辑处理压力为0，承载人数也高不到哪去。

**· 二、早期游戏服务器的改进版本**

· 当开发者们有了初步经验以后，新作品的开发，自然而然的过渡到了如下的形式：

![img](https://pic1.zhimg.com/80/v2-4c91ae5157453352ee6a9e00f8ef834a_1440w.jpg)



· 游戏逻辑服务依然是在一台服务器上，单进程（逻辑处理本身肯定是在一个线程中，可以有子线程负责内网通信）。但是我们自然的想到，存储负载和网络连接负载可以从逻辑服上拆出来。

· 由于连接服务器本身没有时序性，很容易做分布式的（其实大部分游戏还是只用一个连接服），存储服务不要求高实时性，高峰期存盘间隔可以稍长一些，不会对游戏服造成影响。

· **三、成熟形态的服务器框架（这节是重点）**

· 1、逻辑服务器的负载均摊方法一：按照功能划分多个服务器进程

![img](https://pic2.zhimg.com/80/v2-83d176b88c6ffcf64211a8d34ba9d842_1440w.jpg)



· 2、逻辑服务器的负载均摊方法二：按照场景划分多个服务器进程

![img](https://pic3.zhimg.com/80/v2-3c87d414d04a2ab57c24f6bb78af5d45_1440w.jpg)



· 难点在逻辑的设计上，要像做手术一样把本来是一体的功能切开，并抽象出若干个API来保持联系（服务器之间是TCP连接）。

· 在分解时，要找联系相对最薄弱的环节入手，比如场景和场景之间分开、单独抽出聊天服务、组队服务、好友服务。

· 无论如何分解，最终结果只能是有限个服务。而且分解的越细，开发难度就越大。因为跨服务器逻辑是把简单的同步逻辑变成了异步Callback逻辑，而且容易出现时序问题等不易测试的问题。

· 单个场景服务几乎是无法分解的。分解单个场景难度巨大以至于出现了BigWorld引擎来专门的解决场景分割问题，后面会谈到。

· 这种成熟形态的游戏服务器已经能满足现实中99%的频繁交互类网游需求，是大型MMO端游、页游的主流形式。

**· 对比Web服务器**

大致只说一点：由于数据库的存在以及HTTP请求的特性，Web服务器天生就是并发的，也一直在高并发的路上越走越远。![img](https://pic2.zhimg.com/80/v2-e465c12055355c1170130c7c9602a9d2_1440w.jpg)



**· 附：开房间式的网络游戏**



· 开房间式的网络游戏也是游戏的一个重要分支，英雄联盟、DOTA、很多手游例如皇室战争、王者荣耀等等。

· 这种游戏房间之间几乎没有交互，只有大厅内有交互，可以理解为原始形态的游戏服务器的平行扩展。

· 房间式游戏扩展难度较小，只是需要根据玩家数量动态扩展游戏房间的数量、服务器数量。很像网站的架构。

· 这种游戏架构最最适合放在云平台上，设计合理的话，它可能遇到的问题和大型网站几乎一模一样。不需要特别的讨论它们。

· 只是，毕竟游戏不都是开房间的玩法。

## **· 小结：游戏服务器框架特点**

· 1、真正的数据都在内存中，数据库性能不那么重要

· 注：很多大型游戏采用了共享内存，避免宕机时损失过大。

· 2、单CPU性能比CPU数量重要的多。

· 3、目前有很多游戏，特别是手游，使用Redis读写代替内存读写，甚至也有用Mongo的。

· 4、开新服、旧区合服的情况，非常适合云平台。

**· 先进服务器框架**

1、BigWorld。理念过于超前，把并发性做到极致，开发友好度弱到极致，已废。

2、Skynet。本人强烈推荐，谁学谁知道，除了必须要用lua语言，没有什么缺点。



**· 聊聊十万行代码**

· 游戏服务器开发速度受美术资源制作速度、客户端开发速度制约。近几年我猜测服务器方面并不会有大的技术革新。

· 游戏开发未来的趋势是多元化、低门槛化、大众化。很长一段时间内BigWorld这种大怪兽级别的引擎不会再崛起。

· 分布式框架的崛起时间点，无论如何，也在VR技术成熟之后了。