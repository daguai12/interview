# asyncç”¨æ³•

```cpp
std::string fetchDataFromDB(std::string query){
  std::this_thread::sleep_for(std::chrono::seconds(2));
  std::cout << "children thread has finish misson" << std::endl;
  return std::string("Data:" + query);
}

void use_async()
{
  std::future<std::string> result = std::async(std::launch::async,fetchDataFromDB,"Data");
  std::cout << "Main thread do somthing...." << std::endl;
  std::string value = result.get();
  std::cout << value << std::endl;
}

void use_defered_async()
{
  std::future<std::string> result = std::async(std::launch::deferred,fetchDataFromDB,"Data");
  std::this_thread::sleep_for(std::chrono::seconds(3));
  std::cout << "Main Thread do somthing..." << std::endl;
  std::string value = result.get();
  std::cout << value << std::endl;
}
```

é€šè¿‡ä½¿ç”¨`std::async`å¯ä»¥åˆ›å»ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œè¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ª`std::future<T>`å¯¹è±¡ï¼Œç”¨äºæ¥æ”¶ç»“æœã€‚

`std::async`çš„ç¬¬ä¸€ä¸ªå‚æ•°æœ‰ä¸¤ä¸­é€‰æ‹©:
1. `std::launch::async`: è¡¨ç¤ºè¯¥å¼‚æ­¥ä»»åŠ¡ç«‹é©¬æ‰§è¡Œã€‚
2. `std::launch::defered`: è¡¨ç¤ºè¯¥å¼‚æ­¥ä»»åŠ¡åªæœ‰å†è°ƒç”¨`future.get()`æˆ–`future.wait()`æˆå‘˜æ–¹æ³•æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œã€‚

>å¦‚æœä¸æŒ‡å®šç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¼šé‡‡ç”¨é»˜è®¤é€‰é¡¹(`std::launch::async | std::launch::defered`)ï¼Œå‡½æ•°çš„å…·ä½“è¡Œä¸ºå–å†³äºç¼–è¯‘å™¨ã€‚


# futureçš„wait()å’Œget()

1. **std::future::get()**
	`std::future::get()`æ˜¯ä¸€ä¸ªé˜»å¡è°ƒç”¨ï¼Œç”¨äºè·å–`std::future`å¯¹è±¡è¡¨ç¤ºçš„å€¼æˆ–è€…å¼‚å¸¸ã€‚å¦‚æœå¼‚æ­¥ä»»åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼Œ`get()`ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆã€‚å¦‚æœä»»åŠ¡å·²å®Œæˆï¼Œ`get()`ä¼šç«‹å³è¿”å›ä»»åŠ¡çš„ç»“æœã€‚é‡è¦çš„æ˜¯ï¼Œ`get()`åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå› ä¸ºä»–ä¼šç§»åŠ¨æˆ–æ¶ˆè€—æ‰`std::future`å¯¹è±¡çš„çŠ¶æ€ã€‚ä¸€æ—¦`get()`è¢«è°ƒç”¨ï¼Œ`std::future`å¯¹è±¡å°±ä¸èƒ½åœ¨è¢«è°ƒç”¨ç”¨æ¥è·å–ç»“æœã€‚
2. **std::future::wait()**
	`std::future::wait()` ä¹Ÿæ˜¯ä¸€ä¸ªé˜»å¡è°ƒç”¨ï¼Œä½†å®ƒä¸ `get()` çš„ä¸»è¦åŒºåˆ«åœ¨äº `wait()` ä¸ä¼šè¿”å›ä»»åŠ¡çš„ç»“æœã€‚å®ƒåªæ˜¯ç­‰å¾…å¼‚æ­¥ä»»åŠ¡å®Œæˆã€‚å¦‚æœä»»åŠ¡å·²ç»å®Œæˆï¼Œ`wait()` ä¼šç«‹å³è¿”å›ã€‚å¦‚æœä»»åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼Œ`wait()` ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆã€‚ä¸ `get()` ä¸åŒï¼Œ`wait()` å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ï¼Œå®ƒä¸ä¼šæ¶ˆè€—æ‰ `std::future` å¯¹è±¡çš„çŠ¶æ€ã€‚
	


`std::future`çš„`wait_for()`æˆ–`wait_until()`æ–¹æ³•æ¥æ£€æŸ¥å¼‚æ­¥æ“ä½œæ˜¯å¦å®Œæˆã€‚è¿™äº›æ–¹æ³•è¿”å›ä¸€ä¸ªè¡¨ç¤ºæ“ä½œçŠ¶æ€çš„`std::future_status`å€¼ã€‚

```cpp
void use_wait_for()
{
  std::future<std::string> result = std::async(std::launch::async,fetchDataFromDB,"Data");
  if(result.wait_for(std::chrono::seconds(1)) == std::future_status::ready){
    std::cout << "Task finished quickly! Result = " << result.get() << std::endl;
  }else{
    std::cout << "Still waiting... doing other work\n";
    result.wait();
    std::cout << "Done.Result = " << result.get() << std::endl; //é”™è¯¯ï¼get()äºŒæ¬¡è°ƒç”¨ä¼šæŠ›å‡ºå¼‚å¸¸
  }

}
```

**future_statusæšä¸¾å€¼**

```cpp
enum class future_status{
	ready, //å¼‚æ­¥ä»»åŠ¡å·²å®Œæˆ
	timeout, //ç­‰å¾…æ—¶é—´è¶…æ—¶ï¼Œä»»åŠ¡æœªå®Œæˆ
	defered //ä»»åŠ¡æ˜¯"å»¶è¿Ÿæ‰§è¡Œâ€œçš„(å³launch::defered)
}
```

æ‰€ä»¥åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå»ºè®®åŠ åˆ¤æ–­ï¼š

```cpp
if (fut.wait_for(std::chrono::seconds(0)) == std::future_status::ready) {
    int value = fut.get();
    ...
}

```

# å°†ä»»åŠ¡å’Œfutureå…³è”

`std::packaged_task`å’Œ`std::future`æ˜¯C++11ä¸­å¼•å…¥çš„ä¸¤ä¸ªç±»ï¼Œå®ƒä»¬ç”¨äºå¤„ç†å¼‚æ­¥ä»»åŠ¡çš„ç»“æœã€‚
`std::packaged_task`æ˜¯ä¸€ä¸ªå¯è°ƒç”¨ç›®æ ‡ï¼Œå®ƒåŒ…è£…äº†ä¸€ä¸ªä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡å¯ä»¥åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸Šè¿è¡Œã€‚å®ƒå¯ä»¥æ•è·ä»»åŠ¡è¿”å›å€¼æˆ–å¼‚å¸¸ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨`std::future`å¯¹è±¡ä¸­ï¼Œä»¥ä¾¿ä»¥åä½¿ç”¨ã€‚
`std::future`ä»£è¡¨ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ç»“æœã€‚å®ƒå¯ä»¥ç”¨äºä»å¼‚æ­¥ä»»åŠ¡ä¸­è·å–è¿”å›å€¼æˆ–å¼‚å¸¸ã€‚
ä»¥ä¸‹æ˜¯ä½¿ç”¨`std::packaged_task`å’Œ`std::future`çš„åŸºæœ¬æ­¥éª¤:

1. åˆ›å»ºä¸€ä¸ªstd::packaged_taskå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…è£…äº†è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚
2. è°ƒç”¨std::packaged_taskå¯¹è±¡çš„get_future()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªä¸ä»»åŠ¡å…³è”çš„std::futureå¯¹è±¡ã€‚
3. åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸Šè°ƒç”¨std::packaged_taskå¯¹è±¡çš„operator()ï¼Œä»¥æ‰§è¡Œä»»åŠ¡ã€‚
4. åœ¨éœ€è¦ä»»åŠ¡ç»“æœçš„åœ°æ–¹ï¼Œè°ƒç”¨ä¸ä»»åŠ¡å…³è”çš„std::futureå¯¹è±¡çš„get()æ–¹æ³•ï¼Œä»¥è·å–ä»»åŠ¡çš„è¿”å›å€¼æˆ–å¼‚å¸¸ã€‚

```cpp
int my_task() {
    std::this_thread::sleep_for(std::chrono::seconds(5));
    std::cout << "my task run 5 s" << std::endl;
    return 42;
}

void use_package() {
    // åˆ›å»ºä¸€ä¸ªåŒ…è£…äº†ä»»åŠ¡çš„ std::packaged_task å¯¹è±¡  
    std::packaged_task<int()> task(my_task);

    // è·å–ä¸ä»»åŠ¡å…³è”çš„ std::future å¯¹è±¡  
    std::future<int> result = task.get_future();

    // åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡  
    std::thread t(std::move(task));
    t.detach(); // å°†çº¿ç¨‹ä¸ä¸»çº¿ç¨‹åˆ†ç¦»ï¼Œä»¥ä¾¿ä¸»çº¿ç¨‹å¯ä»¥ç­‰å¾…ä»»åŠ¡å®Œæˆ  

    // ç­‰å¾…ä»»åŠ¡å®Œæˆå¹¶è·å–ç»“æœ  
    int value = result.get();
    std::cout << "The result is: " << value << std::endl;

}
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåŒ…è£…äº†ä»»åŠ¡çš„std::packaged_taskå¯¹è±¡ï¼Œå¹¶è·å–äº†ä¸ä»»åŠ¡å…³è”çš„std::futureå¯¹è±¡ã€‚ç„¶åï¼Œæˆ‘ä»¬åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡ï¼Œå¹¶ç­‰å¾…ä»»åŠ¡å®Œæˆå¹¶è·å–ç»“æœã€‚æœ€åï¼Œæˆ‘ä»¬è¾“å‡ºç»“æœã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ std::function å’Œ std::package_task æ¥åŒ…è£…å¸¦å‚æ•°çš„å‡½æ•°ã€‚std::package_task æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œå®ƒåŒ…è£…äº†ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œå¹¶å…è®¸æˆ‘ä»¬å°†å…¶ä½œä¸ºå¼‚æ­¥ä»»åŠ¡ä¼ é€’ã€‚

**æ³¨æ„ç‚¹:**

> **`std::packaged_task` å¯¹è±¡åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡**ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼š
>
> * ä½ åªèƒ½è°ƒç”¨å®ƒä¸€æ¬¡ï¼ˆæ¯”å¦‚é€šè¿‡ `task()` æˆ–ä¼ ç»™çº¿ç¨‹ï¼‰ï¼Œ
> * ç¬¬äºŒæ¬¡å†è°ƒç”¨å®ƒä¼š **æŠ›å¼‚å¸¸æˆ–å¯¼è‡´æœªå®šä¹‰è¡Œä¸º**ï¼Œå› ä¸ºå®ƒçš„ `future` åªèƒ½è®¾ç½®ä¸€æ¬¡ç»“æœã€‚

```cpp
#include <iostream>
#include <future>

int add(int a, int b) {
    return a + b;
}

int main() {
    std::packaged_task<int(int, int)> task(add);
    std::future<int> fut = task.get_future();

    task(2, 3);  // âœ… ç¬¬ä¸€æ¬¡è°ƒç”¨ OKï¼Œfut ä¸­æœ‰å€¼äº†

    // å†æ¬¡è°ƒç”¨ä¼šå‡ºé”™ï¼ˆå› ä¸º future çš„å€¼åªèƒ½è®¾ç½®ä¸€æ¬¡ï¼‰
    // task(4, 5);  // âŒ é”™è¯¯ï¼future åªèƒ½è¢«è®¾ç½®ä¸€æ¬¡

    std::cout << "Result: " << fut.get() << std::endl;

    return 0;
}
```

å¦‚æœä½ å°è¯•å†æ¬¡è°ƒç”¨ `task(4, 5)`ï¼Œä¼šå‘ç”Ÿä»¥ä¸‹å‡ ç§æƒ…å†µä¹‹ä¸€ï¼ˆå…·ä½“è¡Œä¸ºä¸å®ç°ç›¸å…³ï¼‰ï¼š

* æŠ›å‡ºå¼‚å¸¸ï¼š`std::future_error`ï¼ˆåŸå› ï¼š`promise_already_satisfied`ï¼‰
* ç¨‹åºå´©æºƒï¼ˆæœªå®šä¹‰è¡Œä¸ºï¼‰
* æ ¹æœ¬ä¸è¿è¡Œç¬¬äºŒæ¬¡é€»è¾‘


## ä¸ºä»€ä¹ˆåªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Ÿ

è¿™æ˜¯ç”± **`std::future` çš„è®¾è®¡é™åˆ¶**å†³å®šçš„ï¼š

* æ¯ä¸ª `future` åªèƒ½è·å–ä¸€æ¬¡ç»“æœï¼ˆ`get()`ï¼‰
* æ¯ä¸ª `promise`ï¼ˆæˆ– packaged\_task å†…éƒ¨çš„ promiseï¼‰ä¹Ÿåªèƒ½ **è®¾ç½®ä¸€æ¬¡å€¼**

å½“ä½ ç¬¬ä¸€æ¬¡è°ƒç”¨ `task()` æ—¶ï¼Œå®ƒå·²ç»è®¾ç½®äº†å€¼ï¼Œ`future` å°±ç»‘å®šä¸Šäº†ç»“æœã€‚
åé¢å†è°ƒç”¨å°±**æ— æ³•å†æ¬¡å­˜å…¥å€¼**ï¼Œå› æ­¤æ ‡å‡†åº“ä¸å…è®¸è¿™æ ·åšã€‚


## å¦‚æœæƒ³é‡å¤ç”¨æ€ä¹ˆåŠï¼Ÿ

å°±**é‡æ–°åˆ›å»ºä¸€ä¸ª `packaged_task` å¯¹è±¡**ï¼š

```cpp
std::packaged_task<int(int, int)> task(add);
auto fut1 = task.get_future();
task(1, 2);
std::cout << fut1.get() << std::endl;

// é‡æ–°æ„é€ ä¸€ä¸ªæ–°çš„ä»»åŠ¡
std::packaged_task<int(int, int)> task2(add);
auto fut2 = task2.get_future();
task2(3, 4);
std::cout << fut2.get() << std::endl;
```


# promiseç”¨æ³•

C++11å¼•å…¥äº†`std::promise`å’Œ`std::future`ä¸¤ä¸ªç±»ï¼Œç”¨äºå®ç°å¼‚æ­¥ç¼–ç¨‹ã€‚`std::promise`ç”¨äºåœ¨æŸä¸€çº¿ç¨‹ä¸­è®¾ç½®æŸä¸ªå€¼æˆ–å¼‚å¸¸ï¼Œè€Œ`std::future`åˆ™ç”¨äºåœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è·å–è¿™ä¸ªå€¼æˆ–å¼‚å¸¸ã€‚

ä¸‹é¢æ˜¯`std::promise`çš„åŸºæœ¬ç”¨æ³•:

```cpp
void set_value(std::promise<int> prom){
  //è®¾ç½®promiseçš„å€¼
  prom.set_value(10);
}

void use_promise(){
  //åˆ›å»ºä¸€ä¸ªpromiseå¯¹è±¡
  std::promise<int> prom;
  //è·å–ä¸promiseç›¸å…³è”çš„futureå¯¹è±¡
  std::future<int> fut = prom.get_future();
  //åœ¨æ–°çº¿ç¨‹ä¸­è®¾ç½®promiseçš„å€¼
  std::thread t(set_value,std::move(prom));
  // åœ¨ä¸»çº¿ç¨‹ä¸­è·å–futureçš„å€¼
  std::cout << "Waiting for the thread to set the value...\n";
  std::cout << "Value set by the thread: " << fut.get() << '\n';
  t.join();
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª`std::promise<int>`å¯¹è±¡ï¼Œç„¶åé€šè¿‡è°ƒç”¨`get_future()`æ–¹æ³•è·å–ä¸ä¹‹ç›¸å…³è”çš„`std::future<int>`å¯¹è±¡ã€‚ç„¶åï¼Œæˆ‘ä»¬åœ¨æ–°çº¿ç¨‹ä¸­é€šè¿‡è°ƒç”¨`set_value()`æ–¹æ³•è®¾ç½®`promise`çš„å€¼ï¼Œå¹¶åœ¨ä¸»çº¿ç¨‹ä¸­é€šè¿‡è°ƒç”¨`fut.get()`æ–¹æ³•è·å–è¿™ä¸ªå€¼ã€‚æ³¨æ„ï¼Œåœ¨è°ƒç”¨`fut.get()`æ–¹æ³•æ—¶ï¼Œå¦‚æœpromiseçš„å€¼è¿˜æ²¡æœ‰è¢«è®¾ç½®ï¼Œåˆ™è¯¥æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°å€¼è¢«è®¾ç½®ä¸ºæ­¢ã€‚

é™¤äº†`set_value()`æ–¹æ³•å¤–ï¼Œ`std::promise`è¿˜æœ‰ä¸€ä¸ª`set_exception()`æ–¹æ³•ï¼Œç”¨äºè®¾ç½®å¼‚å¸¸ã€‚è¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ª`std::exception_ptr`å‚æ•°ï¼Œè¯¥å‚æ•°å¯ä»¥é€šè¿‡è°ƒç”¨`std::current_execption()`æ–¹æ³•è·å–ã€‚

```cpp
void set_execption(std::promise<void> prom){
  try{
    std::runtime_error("An error occur int childthread ....");
  }catch(...){
    prom.set_exception(std::current_exception());
  }
}

void use_execption(){
  std::promise<void> prom;
  std::future<void> fut = prom.get_future();
  std::thread t(set_execption,std::move(prom));
  try{
    std::cout << "Waiting for the thread to set the execption...\n";
  } catch(const std::exception& e)
  {
    std::cout << "Exception set by the thread: " << e.what() << '\n';
  }
  t.join();
}
```

**å½“æˆ‘ä»¬ä½¿ç”¨promiseæ—¶è¦æ³¨æ„ä¸€ç‚¹ï¼Œå¦‚æœpromiseè¢«é‡Šæ”¾äº†ï¼Œè€Œå…¶ä»–çº¿ç¨‹è¿˜æœªä½¿ç”¨ä¸promiseå…³è”çš„futureï¼Œå½“å…¶ä½¿ç”¨è¿™ä¸ªfutureä¼šæŠ¥é”™ã€‚å¦‚ä¸‹æ˜¯ä¸€æ®µé”™è¯¯å±•ç¤ºï¼š

```cpp
void use_promise_destruct(){
  std::thread t;
  std::future<int> fut;
  {
    //åˆ›å»ºä¸€ä¸ªpromiseå¯¹è±¡
    std::promise<int> prom;
    //è·å–ä¸promiseç›¸å…³è”çš„futureå¯¹è±¡
    std::future<int> fut = prom.get_future();
    //åœ¨æ–°çº¿ç¨‹ä¸­è®¾ç½®promiseçš„å€¼
    t = std::thread(set_value,std::move(prom));
  }
  //åœ¨ä¸»çº¿ç¨‹ä¸­è·å–futureçš„å€¼
  std::cout << "Waiting for the thread to set the value...\n";
  std::cout << "Value set by the thread:" << fut.get() << '\n';
  t.join();
}
```

**éšç€å±€éƒ¨ä½œç”¨åŸŸ}çš„ç»“æŸï¼Œpromå¯èƒ½è¢«é‡Šæ”¾ä¹Ÿå¯èƒ½ä¼šè¢«å»¶è¿Ÿé‡Šæ”¾ï¼Œå¦‚æœç«‹å³é‡Šæ”¾åˆ™fut.get()è·å–çš„å€¼ä¼šæŠ¥error_valueçš„é”™è¯¯ã€‚**

# æ€»ç»“

## ğŸ” å›é¡¾ï¼š`std::promise` çš„ä½œç”¨

* `std::promise<T>` æ˜¯ç”¨æ¥**åœ¨çº¿ç¨‹é—´ä¼ é€’æŸä¸ªç»“æœæˆ–å¼‚å¸¸**çš„ã€‚
* å’Œå®ƒç»‘å®šçš„ `std::future<T>` å¯ä»¥åœ¨**å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è·å–è¿™ä¸ªç»“æœ/å¼‚å¸¸**ã€‚
* é€šå¸¸åœ¨**å¼‚æ­¥ç¼–ç¨‹**æˆ–**çº¿ç¨‹é€šä¿¡ä¸­**ä½¿ç”¨ã€‚


## â—é—®é¢˜æ ¸å¿ƒï¼šä¸ºä»€ä¹ˆ `std::promise` è¢«é”€æ¯åï¼Œ`future.get()` ä¼šæŠ›å¼‚å¸¸ï¼Ÿ

è¿™æ˜¯å› ä¸ºï¼š

## âœ… promise çš„è§„åˆ™

* ä½ å¿…é¡» **æ˜¾ç¤ºåœ°è°ƒç”¨ `promise.set_value()` æˆ– `set_exception()`** æ¥æ»¡è¶³ `future` çš„éœ€æ±‚ã€‚
* å¦‚æœ `promise` è¢«é”€æ¯æ—¶ï¼Œè¿˜**æ²¡æœ‰è°ƒç”¨è¿‡è¿™ä¸¤ä¸ªå‡½æ•°**ï¼Œé‚£ `future.get()` è°ƒç”¨æ—¶ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚

### âŒ æŠ¥é”™æœºåˆ¶

* å½“ `std::promise` è¢«é”€æ¯è€Œæ²¡æœ‰è®¾ç½®å€¼æˆ–å¼‚å¸¸æ—¶ï¼Œ`std::future` å†…éƒ¨çŠ¶æ€å˜æˆâ€œbroken promiseï¼ˆæ‰¿è¯ºæ–­è£‚ï¼‰â€ã€‚
* æ­¤æ—¶ï¼Œè°ƒç”¨ `fut.get()` ä¼šæŠ›å‡ºï¼š

```cpp
std::future_error: Broken promise
```

---

## ğŸ“Œ ä¸¾ä¸ªæ›´æ¸…æ™°çš„ä¾‹å­

```cpp
std::future<int> fut;
{
    std::promise<int> prom;
    fut = prom.get_future();
    // æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰ prom.set_value(x) ä¹Ÿæ²¡æœ‰ prom.set_exception(...)
}
// prom åœ¨è¿™é‡Œè¢«ææ„ï¼Œfuture å˜æˆ "broken promise"

int val = fut.get();  // â—ä¼šæŠ›å‡º std::future_error
```

---

## ğŸ§  åŸå› å›¾è§£

```
  Thread A (ä¸»çº¿ç¨‹)                    Thread B (å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹)

  promise<int> prom;                  [ä¸å­˜åœ¨ or è¿˜æ²¡æ‰§è¡Œä»»åŠ¡]
      |
      +--> future<int> fut;

  // prom è¢«é”€æ¯äº†
  // æ²¡æœ‰è°ƒç”¨ set_value or set_exception

  fut.get();     --> â— std::future_error("Broken promise")
```

---

## âœ… å¦‚ä½•é¿å…è¿™ç±»é—®é¢˜ï¼Ÿ

### æ–¹æ³• 1ï¼šç¡®ä¿ promise è®¾ç½®äº†å€¼æˆ–å¼‚å¸¸

```cpp
prom.set_value(42);
// æˆ–è€…åœ¨å¼‚å¸¸åˆ†æ”¯ä¸­ set_exception()
```

### æ–¹æ³• 2ï¼šä½¿ç”¨ `std::shared_ptr<std::promise<T>>`

* ç”¨äºå¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶æŒæœ‰æˆ–å»¶è¿Ÿé‡Šæ”¾ promise çš„æƒ…å†µã€‚

```cpp
auto prom = std::make_shared<std::promise<int>>();
std::future<int> fut = prom->get_future();

std::thread([prom]() {
    prom->set_value(123);  // shared_ptr ä¿è¯å®ƒä¸ä¼šè¿‡æ—©é”€æ¯
}).detach();

int result = fut.get();  // å®‰å…¨
```


## ğŸ”„ ä¸ `set_exception()` çš„é…åˆ

* åœ¨ catch(...) ä¸­è°ƒç”¨ `set_exception(std::current_exception())` æ˜¯æ ‡å‡†åšæ³•ã€‚
* å¯ä»¥è®© `fut.get()` ç›´æ¥ `throw` å‡ºåŸæ¥çš„å¼‚å¸¸ã€‚


# å…±äº«ç±»å‹çš„future
å½“æˆ‘ä»¬éœ€è¦å¤šä¸ªçº¿ç¨‹ç­‰å¾…åŒä¸€ä¸ªæ‰§è¡Œç»“æœæ—¶ï¼Œéœ€è¦ä½¿ç”¨std::shared_futureã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªé€‚åˆä½¿ç”¨std::shared_futureçš„åœºæ™¯ï¼Œå¤šä¸ªçº¿ç¨‹ç­‰å¾…åŒä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ç»“æœï¼š
å‡è®¾ä½ æœ‰ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œéœ€è¦å¤šä¸ªçº¿ç¨‹ç­‰å¾…å…¶å®Œæˆï¼Œç„¶åè¿™äº›çº¿ç¨‹éœ€è¦è®¿é—®ä»»åŠ¡çš„ç»“æœã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨std::shared_futureæ¥å…±äº«å¼‚æ­¥ä»»åŠ¡çš„ç»“æœã€‚

```cpp
void myFunction(std::promise<int>&& promise){
  //æ¨¡æ‹Ÿä¸€äº›å·¥ä½œ
  std::this_thread::sleep_for(std::chrono::seconds(1));
  promise.set_value(42);
}

void threadFunction(std::shared_future<int> future){
  try{
    int result = future.get();
    std::cout << "Result:" << result << std::endl;
  }
  catch(const std::future_error& e){
    std::cout << "Future error: " << e.what() << std::endl;
  }
}

void use_shared_future(){
  std::promise<int> promise;
  std::shared_future<int> future = promise.get_future();

  std::thread myThread1(myFunction,std::move(promise)); //å°†promiseç§»åŠ¨åˆ°çº¿ç¨‹ä¸­

  //ä½¿ç”¨sharedï¼ˆï¼‰æ–¹æ³•è·å–æ–°çš„ shared_futureå¯¹è±¡
  std::thread myThread2(threadFunction,future);
  std::thread myThread3(threadFunction,future);

  myThread1.join();
  myThread2.join();
  myThread3.join();
}
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª`std::promise<int>`å¯¹è±¡`promise`å’Œä¸€ä¸ªä¸ä¹‹å…³è”çš„`std::shared_future<int>`å¯¹è±¡`future`ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†`promise`å¯¹è±¡ç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹`myThread1`ä¸­ï¼Œè¯¥çº¿ç¨‹å°†æ‰§è¡ŒmyFunctionå‡½æ•°ï¼Œå¹¶åœ¨å®Œæˆåè®¾ç½®`promise`çš„å€¼ã€‚æˆ‘ä»¬è¿˜åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹`myThread2å’ŒmyThread3`ï¼Œå®ƒä»¬å°†ç­‰å¾…`future`å¯¹è±¡çš„ç»“æœã€‚å¦‚æœ`myThread1`æˆåŠŸåœ°è®¾ç½®äº†`promise`çš„å€¼ï¼Œé‚£ä¹ˆ`future.get()`å°†è¿”å›è¯¥å€¼ã€‚è¿™äº›çº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®å’Œç­‰å¾…`future`å¯¹è±¡çš„ç»“æœï¼Œè€Œä¸ä¼šç›¸äº’å¹²æ‰°ã€‚

ä½†æ˜¯å¤§å®¶è¦æ³¨æ„ï¼Œå¦‚æœä¸€ä¸ªfutureè¢«ç§»åŠ¨ç»™ä¸¤ä¸ªshared_futureæ˜¯é”™è¯¯çš„ã€‚

```cpp
void use_shared_future() {
    std::promise<int> promise;
    std::shared_future<int> future = promise.get_future();

    std::thread myThread1(myFunction, std::move(promise)); // å°† promise ç§»åŠ¨åˆ°çº¿ç¨‹ä¸­

    std::thread myThread2(threadFunction, std::move(future));
    std::thread myThread3(threadFunction, std::move(future));

    myThread1.join();
    myThread2.join();
    myThread3.join();
}
```

è¿™ç§ç”¨æ³•æ˜¯é”™è¯¯çš„ï¼Œä¸€ä¸ª`future`é€šè¿‡éšå¼æ„é€ ä¼ é€’ç»™`shared_future`ä¹‹åï¼Œè¿™ä¸ª`shared_future`è¢«ç§»åŠ¨ä¼ é€’ç»™ä¸¤ä¸ªçº¿ç¨‹æ˜¯ä¸åˆç†çš„ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡ç§»åŠ¨å`shared_future`çš„ç”Ÿå‘½å‘¨æœŸè¢«è½¬ç§»äº†ï¼Œæ¥ä¸‹æ¥`myThread3`æ„é€ æ—¶ç”¨çš„`std::move(future)`futureå·²ç»å¤±æ•ˆäº†ï¼Œä¼šæŠ¥é”™ï¼Œä¸€èˆ¬éƒ½æ˜¯`no state `ä¹‹ç±»çš„é”™è¯¯ã€‚

ä½†å½“ å¤šä¸ªçº¿ç¨‹éƒ½éœ€è¦ç­‰å¾…åŒä¸€ä¸ªä»»åŠ¡ç»“æœæ—¶ï¼Œå°±è¦ç”¨ `std::shared_future<T>`ï¼Œå®ƒ
- å¯ä»¥**è¢«å¤åˆ¶**ï¼›
- æ¯ä¸ªå‰¯æœ¬éƒ½å¯ä»¥è°ƒç”¨ .get()ï¼›
- .get() **ä¸ä¼šæ¶ˆè€—çŠ¶æ€**ï¼ˆä¸åƒ std::futureï¼‰ï¼›
- æ‰€æœ‰çº¿ç¨‹åœ¨ä»»åŠ¡å®Œæˆåéƒ½å¯ä»¥æ‹¿åˆ°ç»“æœã€‚

# å¼‚å¸¸å¤„ç†
`std::future`æ˜¯C++çš„ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œå®ƒç”¨äºè¡¨ç¤ºä¸€ä¸ªå¯èƒ½è¿˜æ²¡æœ‰å‡†å¤‡å¥½çš„å¼‚æ­¥æ“ä½œç»“æœã€‚ä½ å¯ä»¥é€šè¿‡è°ƒç”¨`std::future::get`æ–¹æ³•æ¥è·å–è¿™ä¸ªç»“æœã€‚å¦‚æœåœ¨è·å–ç»“æœæ—¶å‘é€äº†å¼‚å¸¸ï¼Œå‘¢ä¹ˆ`std::future::get`ä¼šé‡æ–°æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚

```cpp
void may_throw(){
  throw std::runtime_error("Oops,something went wrong!");
}

void use_catch(){
  std::future<void> result(std::async(std::launch::async,may_throw));
  try{
    result.get();
  }catch(const std::exception& e){
    std::cout << e.what() << std::endl;
  }
}
```
