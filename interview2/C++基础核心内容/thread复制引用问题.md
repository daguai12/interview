ä½ çš„ä»£ç ä¼š**æŠ¥é”™**ï¼Œå› ä¸ºä½ å°†ä¸€ä¸ª `int` ç±»å‹çš„å˜é‡ï¼ˆ`num`ï¼‰ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°ï¼ˆ`change_params`ï¼‰çš„å‚æ•°æ˜¯ **`int&`ï¼ˆå¼•ç”¨ç±»å‹ï¼‰**ï¼Œè€Œä½ åœ¨çº¿ç¨‹åˆ›å»ºæ—¶å¹¶**æ²¡æœ‰æ˜¾å¼ä½¿ç”¨ `std::ref`** æ¥ä¼ é€’å¼•ç”¨ï¼Œå¯¼è‡´ç¼–è¯‘å™¨è¯•å›¾ç”¨ `num` å¤åˆ¶æ„é€ å‡ºä¸€ä¸ª `int&`ï¼ˆéæ³•ï¼‰ï¼Œå› æ­¤ä¼šç¼–è¯‘å¤±è´¥æˆ–è¿è¡Œè¡Œä¸ºé”™è¯¯ã€‚

---

## ğŸ” æˆ‘ä»¬æ¥é€æ­¥åˆ†æï¼š

### ğŸ‘‡ ä½ çš„ä»£ç ï¼š

```cpp
void change_params(int& param) {
    param++;
}

void ref_oops() {
    int num = 100;
    std::cout << num << std::endl;

    std::thread t(change_params, num); // <-- æœ‰é—®é¢˜
    t.join();

    std::cout << num << std::endl;
}
```

---

## ğŸš¨ é—®é¢˜å‡ºåœ¨è¿™é‡Œï¼š

```cpp
std::thread t(change_params, num);
```

* è¿™é‡Œ `num` æ˜¯ä¸€ä¸ª **int**ï¼Œä½ ä¼ å…¥çš„æ˜¯ **å€¼ï¼ˆby valueï¼‰**ã€‚
* ä½†å‡½æ•° `change_params` çš„å‚æ•°ç±»å‹æ˜¯ `int&`ï¼Œå³**å¼•ç”¨**ã€‚
* `std::thread` ä¼šå°è¯• **å¤åˆ¶å‚æ•°åˆ°æ–°çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­**ã€‚
* ä¹Ÿå°±æ˜¯è¯´ï¼Œ`std::thread` ä¼šå°è¯•å¤åˆ¶ `num`ï¼Œç„¶åä¼ ç»™ `change_params(int&)`ï¼Œä½†è¿™æ˜¯ **éæ³•çš„**ï¼Œå› ä¸ºä¸èƒ½ç”¨ä¸€ä¸ªå³å€¼ï¼ˆä¸´æ—¶å˜é‡ï¼‰æ¥åˆå§‹åŒ–ä¸€ä¸ª `int&` å‚æ•°ï¼ˆéœ€è¦å·¦å€¼å¼•ç”¨ï¼‰ã€‚

---

## âœ… æ­£ç¡®æ–¹å¼ï¼šç”¨ `std::ref`

ä½ åº”è¯¥æ˜ç¡®å‘Šè¯‰ `std::thread` è¦ä¼ é€’ä¸€ä¸ª**å¼•ç”¨**ï¼Œæ–¹æ³•æ˜¯ä½¿ç”¨ `std::ref(num)`ï¼š

```cpp
std::thread t(change_params, std::ref(num));
```

è¿™æ · `std::thread` çŸ¥é“ä¸è¦å¤åˆ¶ `num`ï¼Œè€Œæ˜¯å°†å…¶**æŒ‰å¼•ç”¨**ä¼ é€’ç»™ç›®æ ‡å‡½æ•°ã€‚

---

## âœ… ä¿®æ”¹åçš„å®Œæ•´ä»£ç 

```cpp
#include <iostream>
#include <thread>
#include <functional> // for std::ref

void change_params(int& param) {
    param++;
}

void ref_oops() {
    int num = 100;
    std::cout << "Before thread: " << num << std::endl;

    std::thread t(change_params, std::ref(num)); // æ­£ç¡®ä¼ å¼•ç”¨
    t.join();

    std::cout << "After thread: " << num << std::endl;
}
```

è¾“å‡ºï¼š

```
Before thread: 100
After thread: 101
```

---

## ğŸ“Œ æ€»ç»“ï¼šä¸ºä»€ä¹ˆè¦ç”¨ `std::ref`

* `std::thread` é»˜è®¤æŒ‰å€¼å¤åˆ¶ä¼ å…¥çš„å‚æ•°ã€‚
* å¦‚æœä½ è¦ä¼ **å¼•ç”¨å‚æ•°**ï¼Œå¿…é¡»ç”¨ `std::ref` æ˜¾å¼åŒ…è£…ã€‚
* å¦åˆ™ä¼šæŠ¥é”™æˆ–è€…å‡ºç°å¼•ç”¨ç»‘å®šåˆ°ä¸´æ—¶å¯¹è±¡çš„æœªå®šä¹‰è¡Œä¸ºã€‚

---

æœ‰éœ€è¦æˆ‘å¯ä»¥è¡¥å……ä¸‹åº•å±‚æ¨¡æ¿æ¨å¯¼è¿‡ç¨‹æˆ– `std::thread` æ„é€ å‡½æ•°çš„å®ç°æœºåˆ¶ã€‚éœ€è¦å—ï¼Ÿ

å¾ˆå¥½ï¼Œé‚£æˆ‘ä»¬ç°åœ¨**æ·±å…¥åº•å±‚åˆ†æ `std::thread(change_params, num)` ä¸ºä»€ä¹ˆä¸è¡Œ**ï¼Œä»¥åŠä¸ºä»€ä¹ˆ `std::ref(num)` å°±èƒ½è®©å®ƒæ­£å¸¸å·¥ä½œã€‚æˆ‘ä»¬ä¼šä»æ¨¡æ¿æ¨å¯¼ã€ç±»å‹æ¨æ¼”ã€å¼•ç”¨æŠ˜å ç­‰è§’åº¦è®²æ¸…æ¥šã€‚

---

## ğŸ§  ä¸€ã€èƒŒæ™¯çŸ¥è¯†ï¼š`std::thread` çš„æ„é€ åŸç†

### `std::thread` çš„æ„é€ å‡½æ•°ï¼ˆæ ¸å¿ƒç­¾åï¼‰ï¼š

```cpp
template<class Function, class... Args>
explicit thread(Function&& f, Args&&... args);
```

è¿™æ˜¯ä¸€ä¸ª **å®Œç¾è½¬å‘æ„é€ å‡½æ•°**ï¼Œå®ƒä¼šå°†å‚æ•° `f` å’Œ `args...` å®Œç¾è½¬å‘ç»™çº¿ç¨‹æ‰§è¡Œå‡½æ•°ã€‚ä½ å¯ä»¥è¿™æ ·ç†è§£å®ƒçš„æ ¸å¿ƒæœºåˆ¶ï¼š

```cpp
// ä¼ªä»£ç ï¼šstd::thread æ„é€ å‡½æ•°å†…éƒ¨å¤§æ¦‚ç­‰ä»·äº
std::thread::thread(f, args...)
{
    // å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œè°ƒç”¨ï¼š
    std::invoke(f, args...); // C++17 èµ·ä½¿ç”¨ std::invoke
}
```

---

## ğŸ“¦ äºŒã€ä½ å†™çš„ä»£ç åœ¨å¹²ä»€ä¹ˆï¼Ÿ

```cpp
int num = 100;
std::thread t(change_params, num); // âŒ é”™è¯¯
```

è¿™ä¸ªç­‰ä»·äºè°ƒç”¨ï¼š

```cpp
thread::thread(void(&)(int&), int)
```

ä½†ä½ ä¼ çš„å‚æ•°æ˜¯ `num`ï¼ˆä¸€ä¸ª `int`ï¼Œå€¼ç±»å‹ï¼‰ï¼Œè€Œç›®æ ‡å‡½æ•°è¦æ±‚çš„æ˜¯ `int&`ã€‚äºæ˜¯é—®é¢˜æ¥äº†ã€‚

---

## âŒ ä¸‰ã€æ¨¡æ¿æ¨å¯¼å¤±è´¥åˆ†æ

### å‡½æ•°ç­¾åï¼š

```cpp
void change_params(int& param);
```

æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ª**å·¦å€¼å¼•ç”¨å‡½æ•°å‚æ•°**ï¼Œä¸èƒ½ç»‘å®šå³å€¼ï¼ˆä¸´æ—¶å¯¹è±¡ï¼‰ã€‚

---

### æ¨å¯¼è¿‡ç¨‹ï¼š

```cpp
std::thread t(change_params, num);

// å±•å¼€åæ¨¡æ¿æ¨å¯¼å¤§è‡´ä¸ºï¼š
template<typename F, typename... Args>
thread(F&& f, Args&&... args);

// æ¨å¯¼å‡ºï¼š
F = void(&)(int&)     // å‡½æ•°æŒ‡é’ˆ
Args = int            // å€¼ç±»å‹
```

äºæ˜¯ï¼šç­‰ä»·äºåœ¨æ–°çº¿ç¨‹ä¸­è°ƒç”¨ï¼š

```cpp
change_params(int(/*å€¼*/)); // âŒ é”™è¯¯ï¼šä¸èƒ½å°† int ç»‘å®šåˆ° int&
```

è¿™å°±ä¼šå¯¼è‡´**ç¼–è¯‘é”™è¯¯**ï¼š

```
no matching function for call to 'change_params(int)'
```

---

## âœ… å››ã€æ­£ç¡®æ–¹å¼ï¼šä½¿ç”¨ `std::ref`

ä½ å†™ï¼š

```cpp
std::thread t(change_params, std::ref(num));
```

å°±å˜æˆï¼š

```cpp
std::thread(change_params, std::reference_wrapper<int>(num));
```

è¿™ä¸ª `reference_wrapper<int>` æ˜¯ä¸€ä¸ªå°å‹ç±»ï¼Œç”¨äºå®‰å…¨åœ°**åŒ…è£…å¼•ç”¨**ã€‚å…¶å†…éƒ¨é‡è½½äº† `operator int&()`ï¼Œå¯ä»¥åœ¨è°ƒç”¨å‡½æ•°æ—¶è‡ªåŠ¨è½¬æ¢ä¸º `int&`ã€‚

äºæ˜¯ï¼š

```cpp
std::invoke(change_params, std::reference_wrapper<int>) // è‡ªåŠ¨è½¬æˆ int&
=> change_params(int&); // âœ” æ­£ç¡®ç»‘å®šå¼•ç”¨
```

---

## ğŸ§© äº”ã€å¼•ç”¨æŠ˜å  & å®Œç¾è½¬å‘çš„é™·é˜±

è¿™ä¸€è¡Œï¼š

```cpp
template<class F, class... Args>
thread(F&& f, Args&&... args);
```

æ˜¯**å®Œç¾è½¬å‘æ¨¡æ¿**ï¼Œå…¶ä¸­ï¼š

* `F&&` å’Œ `Args&&` å®é™…æ˜¯ **universal reference**ï¼ˆå³å¯ä»¥ç»‘å®šå·¦å€¼/å³å€¼ï¼‰
* ä½†åœ¨è°ƒç”¨ `std::invoke(f, args...)` æ—¶ï¼Œæ‰€æœ‰å‚æ•°ä¼šè¢«ä»¥ `std::forward` æ–¹å¼è½¬å‘

é—®é¢˜æ˜¯ï¼šå³ä½¿ `num` æ˜¯å·¦å€¼ï¼Œå®ƒè¢«æ¨å¯¼ä¸º `int`ï¼Œç„¶åä¼ é€’ç»™ `change_params(int&)` æ—¶ï¼Œä»ç„¶æ˜¯æŒ‰å€¼ä¼ é€’ï¼Œè€Œ `change_params` ä¸èƒ½æ¥å—å€¼ã€‚

> C++ ä¸­ä¸ä¼šè‡ªåŠ¨æŠŠä¸€ä¸ª `int` ç»‘å®šæˆ `int&`ï¼Œé™¤éä½ æ˜ç¡®å‘Šè¯‰ç¼–è¯‘å™¨ â€œè¿™æ˜¯å¼•ç”¨â€ â€”â€” æ‰€ä»¥ä½ å°±å¾—ç”¨ `std::ref(num)`ã€‚

---

## ğŸ”š å…­ã€æ€»ç»“

| å†™æ³•                              | æ¨å¯¼å‚æ•°                            | èƒ½å¦ç»‘å®š                |
| ------------------------------- | ------------------------------- | ------------------- |
| `std::thread(f, num)`           | `Args = int`                    | âŒ æ— æ³•ç»‘å®šåˆ° `int&`      |
| `std::thread(f, std::ref(num))` | `Args = reference_wrapper<int>` | âœ… è½¬æ¢æˆ `int&` è‡ªåŠ¨ç»‘å®šæˆåŠŸ |

### âœ… ä½¿ç”¨ `std::ref` æ˜¯å‘Šè¯‰ `std::thread`ï¼šâ€œè¯·**æŒ‰å¼•ç”¨ä¼ é€’**æˆ‘è¿™ä¸ªå‚æ•°ï¼Œè€Œä¸æ˜¯å¤åˆ¶ä¸€ä»½ã€‚â€

---

å¦‚æœä½ æ„Ÿå…´è¶£ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸¦ä½ çœ‹çœ‹ `std::reference_wrapper` çš„æºç å®ç°ï¼Œæˆ–è€… `std::invoke` çš„æ¨å¯¼è¿‡ç¨‹ã€‚éœ€è¦å—ï¼Ÿ
