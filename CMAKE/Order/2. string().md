### CMake 中 string() 命令的详细教程

CMake 的 `string()` 命令是一个核心且多功能的内置命令，用于对字符串进行各种操作，包括连接、替换、提取、比较、生成随机值、编码转换、正则匹配等。它是 CMake 脚本处理文本数据的首选工具，尤其适用于版本解析、模板替换、路径操纵或条件逻辑。`string()` 命令在配置阶段执行（非生成阶段），支持列表（分号分隔的字符串数组），并跨平台兼容。相比外部工具，它高效且无需依赖。

**注意**：`string()` 操作总是针对变量（用 `${VAR}` 引用输入），结果存回变量。支持 UTF-8 等编码，但默认 ASCII。官方文档（CMake 3.28+）列出约 20 个子命令，按功能分类。CMake 3.20+ 引入 `cmake_path()` 用于路径，但 `string()` 仍通用文本处理。

#### 1. string() 命令的基本语法
```
string(<command> <input> <output> [arguments...])
```
- `<command>`：子命令，指定操作类型（如 `REPLACE`、`REGEX` 等）。
- `<input>`：输入字符串或变量（通常 `${VAR}`）。
- `<output>`：输出变量名（结果存入其中）。
- `[arguments...]`：子命令特定参数，如模式、替换值。
- 特殊：某些子命令（如 `RANDOM`）无 `<input>`；列表用 `;` 分隔。
- 返回值：修改 `<output>` 变量；失败时可能为空或报错。
- 常见选项：许多子命令支持 `ENCODING <type>`（UTF-8 等，CMake 3.1+）和 `ESCAPE_QUOTES`（转义引号）。

`string()` 的优势是链式使用（如 REGEX 后 REPLACE），但正则需 Perl 风格（支持 `\d`、`^` 等）。对于大文本，结合 `file(READ)` 使用。

#### 2. 子命令详细说明
按功能分类，基于官方文档。每个包括语法、描述、参数、示例。

##### 2.1 连接与追加（Concatenation & Append）
- **APPEND**
  - 语法：`string(APPEND <string> <suffix1> [<suffix2> ...])`
  - 描述：向 `<string>` 变量追加后缀（无分隔符）。
  - 参数：`<suffixN>` 可为变量或字面量。
  - 示例：`string(APPEND MY_VAR "Hello" " World")` → `MY_VAR = Hello World`。
  - 注意：修改原变量；用于构建路径如 `${DIR}/${FILE}`。

- **CONCAT**（CMake 3.0+，推荐）
  - 语法：`string(CONCAT <output> <input1> [<input2> ...])`
  - 描述：连接多个输入到 `<output>`（无分隔）。
  - 示例：`string(CONCAT FULL_PATH "${DIR}" "/" "${FILE}")` → `FULL_PATH = /home/user/main.cpp`。
  - 注意：比 APPEND 更灵活，支持多输入。

- **JOIN**（CMake 3.12+）
  - 语法：`string(JOIN <separator> <output> <input1>... )`
  - 描述：用 `<separator>` 连接输入列表到 `<output>`。
  - 示例：`string(JOIN "," VERSIONS_LIST 1.1 1.2 1.3)` → `VERSIONS_LIST = 1.1,1.2,1.3`。
  - 注意：`<separator>` 可为空；用于 CSV 等。

##### 2.2 替换与修改（Replacement & Modification）
- **REPLACE**
  - 语法：`string(REPLACE <match> <replace> <input> <output>)`
  - 描述：全局替换 `<input>` 中的 `<match>` 为 `<replace>`，存入 `<output>`。
  - 示例：`string(REPLACE "." "_" VER "1.2.3" VER_US)` → `VER_US = 1_2_3`。
  - 注意：`<match>` 是字面；支持转义如 `\\` 为 `\`。

- **CONFIGURE**（CMake 3.0+）
  - 语法：`string(CONFIGURE <string> [ESCAPE_QUOTES] [NEWLINE_STYLE <style>] [@ONLY] [OUTPUT_VARIABLE <output>] )`
  - 描述：替换 `<string>` 中的 `${VAR}` 或 `@VAR@` 为变量值（模板式）。
  - 参数：`@ONLY` 只替换 `@VAR@`；`NEWLINE_STYLE` 如 UNIX/LF/DOS/CRLF；`ESCAPE_QUOTES` 转义 `"`。
  - 示例：`string(CONFIGURE "Version: @VER@" @ONLY OUTPUT_VARIABLE CONF_VER)`（假设 `VER=1.2`）→ `CONF_VER = Version: 1.2`。
  - 注意：类似 `configure_file()`，但内存中操作。

##### 2.3 正则表达式操作（REGEX）
- **REGEX MATCH**
  - 语法：`string(REGEX MATCH <regex> <input> <output>)`
  - 描述：匹配 `<input>` 与 `<regex>`，存完整匹配到 `<output>`；捕获组到 `CMAKE_MATCH_N`。
  - 示例：`string(REGEX MATCH "v([0-9.]+)" "v1.2.3" MATCHED)` → `MATCHED = v1.2.3`，`CMAKE_MATCH_1 = 1.2.3`。
  - 注意：Perl 风格；`^` 开头，`$` 结尾。

- **REGEX MATCHALL**（CMake 3.9+）
  - 语法：`string(REGEX MATCHALL <regex> <input> <output>)`
  - 描述：匹配所有非重叠实例，存列表到 `<output>`。
  - 示例：`string(REGEX MATCHALL "[a-z]+" "abc123def" MATCHES)` → `MATCHES = abc;def`。

- **REGEX REPLACE**
  - 语法：`string(REGEX REPLACE <regex> <replace> <input> <output>)`
  - 描述：用 `<replace>` 替换匹配的 `<regex>`（支持 `\1` 捕获组）。
  - 示例：`string(REGEX REPLACE "([0-9]+)" "NUM-\\1" "Ver123" OUT)` → `OUT = VerNUM-123`。
  - 注意：`<replace>` 可含 `\0`（全匹配）、`\1` 等。

##### 2.4 提取与查找（Extraction & Search）
- **SUBSTRING**
  - 语法：`string(SUBSTRING <string> <begin> <length> <output>)`
  - 描述：从 `<begin>`（0-based）提取 `<length>` 字符到 `<output>`。
  - 示例：`string(SUBSTRING "Hello World" 6 5 SUB)` → `SUB = World`。
  - 注意：`<begin>` 超长为空；`<length>` 为 -1 取到末尾（CMake 3.17+）。

- **FIND**
  - 语法：`string(FIND <string> <substring> <output> [REVERSE])`
  - 描述：查找 `<substring>` 在 `<string>` 中的位置（0-based），存入 `<output>`；未找到为 -1。
  - 参数：`REVERSE` 从末尾搜索（CMake 3.17+）。
  - 示例：`string(FIND "Hello World" "World" POS)` → `POS = 6`。

- **LENGTH**
  - 语法：`string(LENGTH <string> <output>)`
  - 描述：计算 `<string>` 长度（UTF-8 字符数），存入 `<output>`。
  - 示例：`string(LENGTH "v1.2.3-beta" LEN)` → `LEN = 10`。
  - 注意：列表长度用 `list(LENGTH)`。

##### 2.5 比较与生成（Comparison & Generation）
- **COMPARE**
  - 语法：`string(COMPARE [LESS|GREATER|EQUAL|LESS_EQUAL|GREATER_EQUAL] <string1> <string2> <result>)`
  - 描述：比较两个字符串，存结果（1 为真，0 为假）到 `<result>`。
  - 示例：`string(COMPARE EQUAL "1.2" "1.2" IS_EQ)` → `IS_EQ = 1`。
  - 注意：字典序比较；用于版本检查。

- **RANDOM**（CMake 3.9+）
  - 语法：`string(RANDOM [LENGTH <length>] [ALPHABET <alphabet>] [RANDOM_SEED <seed>] <output>)`
  - 描述：生成随机字符串到 `<output>`。
  - 参数：`LENGTH` 默认 8；`ALPHABET` 如 `0123456789ABCDEF`；`RANDOM_SEED` 固定种子。
  - 示例：`string(RANDOM LENGTH 16 ALPHABET "01" RAND_BIN)` → `RAND_BIN = 101010...`（随机二进制）。
  - 注意：用于临时文件名。

##### 2.6 编码与转义（Encoding & Escaping）
- **ENCODE** / **DECODE**（CMake 3.19+）
  - 语法：`string(ENCODE <string> <output> [TYPE <type>])` / `string(DECODE <hex-string> <output> [TYPE <type>])`
  - 描述：Base64 编码/解码 `<string>` 到 `<output>`。
  - 参数：`TYPE` 如 BASE64（默认）。
  - 示例：`string(ENCODE "Hello" ENC)` → `ENC = SGVsbG8=`。
  - 注意：用于二进制数据传输。

- **HEX** / **TOUPPER** / **TOLOWER**
  - 语法：`string(HEX <string> <output>)` 等。
  - 描述：转为十六进制、`toupper`/`tolower` 转换大小写。
  - 示例：`string(TOUPPER "hello" UPPER)` → `UPPER = HELLO`。

- **SPLIT**（CMake 3.29+）
  - 语法：`string(SPLIT <separator> <output> <input>)`
  - 描述：用 `<separator>` 分割 `<input>` 到 `<output>` 列表。
  - 示例：`string(SPLIT "," "1,2,3" PARTS)` → `PARTS = 1;2;3`。

##### 2.7 哈希（Hashing）
- **<HASH>**（如 MD5、SHA256）
  - 语法：`string(<HASH> <input> <output>)`
  - 描述：计算哈希值到 `<output>`（小写十六进制）。
  - 示例：`string(SHA256 "secret" HASH_VAL)` → `HASH_VAL = 2bb80d...`。
  - 支持算法：MD5、SHA1、SHA224、SHA256、SHA384、SHA512（CMake 3.17+）。

#### 3. 案例选择：一个简单的版本处理器
我们用一个 C++ 项目示例：解析版本字符串 "v1.2.3-beta"，提取部分、替换、连接、生成头文件。演示 REGEX、REPLACE、CONCAT、JOIN、LENGTH、RANDOM、CONFIGURE。

**项目结构**：
```
string_tutorial/
├── CMakeLists.txt
└── src/
    └── main.cpp  # #include "version.h" \n int main() { std::cout << PROJECT_VERSION; return 0; }
```

**完整的 CMakeLists.txt**：
```cmake
cmake_minimum_required(VERSION 3.10)
project(StringTutorial)

set(CMAKE_CXX_STANDARD 11)

set(VERSION_STR "v1.2.3-beta")

# 1. REGEX MATCH 提取版本
string(REGEX MATCH "v([0-9.]+)-(.+)" _ "${VERSION_STR}")
set(MAJOR_VER "${CMAKE_MATCH_1}")  # 1.2.3
set(TAG "${CMAKE_MATCH_2}")        # beta

# 2. REPLACE 替换点为下划线
string(REPLACE "." "_" VER_US "${MAJOR_VER}")

# 3. CONCAT 连接描述
string(CONCAT DESC "Version ${MAJOR_VER} (${TAG})")

# 4. JOIN 列表连接
string(JOIN "." PARTS_LIST 1 2 3)  # 1.2.3

# 5. LENGTH 和 FIND
string(LENGTH "${VERSION_STR}" TOTAL_LEN)
string(FIND "${VERSION_STR}" "-" DASH_POS)

# 6. RANDOM 生成 ID
string(RANDOM LENGTH 8 RAND_ID)

# 7. CONFIGURE 模板
set(TEMPLATE "// Version: @VERSION@\n// ID: @ID@\n#define PROJECT_VERSION \"@PARTS@\"")
string(CONFIGURE "${TEMPLATE}" @ONLY OUTPUT_VARIABLE CONF_TEMPLATE)
string(REPLACE "@VERSION@" "${DESC}" CONF_TEMPLATE "${CONF_TEMPLATE}")
string(REPLACE "@ID@" "${RAND_ID}" CONF_TEMPLATE "${CONF_TEMPLATE}")
string(REPLACE "@PARTS@" "${PARTS_LIST}" CONF_TEMPLATE "${CONF_TEMPLATE}")

# 8. TOUPPER
string(TOUPPER "${TAG}" UPPER_TAG)

# 9. 生成头文件
file(MAKE_DIRECTORY "${CMAKE_CURRENT_BINARY_DIR}/gen")
file(WRITE "${CMAKE_CURRENT_BINARY_DIR}/gen/version.h" "${CONF_TEMPLATE}")

# 打印调试
message(STATUS "Extracted: ${MAJOR_VER}, Tag: ${TAG}")
message(STATUS "Description: ${DESC}")
message(STATUS "Length: ${TOTAL_LEN}, Dash at: ${DASH_POS}")
message(STATUS "Random ID: ${RAND_ID}")
message(STATUS "Upper Tag: ${UPPER_TAG}")

# 构建
add_executable(MyApp src/main.cpp)
target_include_directories(MyApp PRIVATE "${CMAKE_CURRENT_BINARY_DIR}/gen")
```

#### 4. 逐步详细解释
- **string(REGEX MATCH ...)**：捕获 "v1.2.3" 和 "beta" 到 `CMAKE_MATCH_1/2`。
- **string(REPLACE ...)**：生成 "1_2_3"。
- **string(CONCAT ...)**：构建 "Version 1.2.3 (beta)"。
- **string(JOIN ...)**：模拟版本部分。
- **string(LENGTH/FIND ...)**：`TOTAL_LEN=10`，`DASH_POS=6`。
- **string(RANDOM ...)**：生成如 "a1b2c3d4"。
- **string(CONFIGURE + REPLACE)**：替换模板，生成头文件内容。
- **string(TOUPPER ...)**：`BETA`。
- **file(WRITE ...)**：输出到 `version.h`。
- **message(STATUS ...)**：配置时打印。

#### 5. 如何运行这个案例
1. 创建目录/文件。
2. `mkdir build && cd build`
3. `cmake ..`（配置，打印结果；生成 `gen/version.h`）。
4. `make`（构建）。
5. 运行 `./MyApp`：输出 "1.2.3"（从宏）。

**预期配置输出**（示例）：
```
Extracted: 1.2.3, Tag: beta
Description: Version 1.2.3 (beta)
Length: 10, Dash at: 6
Random ID: x7y8z9a0
Upper Tag: BETA
```

#### 6. 常见错误与注意事项
- **变量引用**：输入用 `${VAR}`，输出是变量名（无 `$`）。
- **正则**：测试用工具；空匹配为空字符串，用 `if(MATCHED)` 检查。
- **列表**：`string(REPLACE)` 处理整个列表；用 `foreach()` 循环单个。
- **编码**：非 ASCII 加 `ENCODING UTF-8`（如 `string(LENGTH ... ENCODING UTF-8)`）。
- **性能**：小操作无问题；大字符串（>1MB）分块。
- **版本兼容**：`JOIN` 需 3.12+；`RANDOM` 3.9+；旧版用 `set(OUT "${A}${B}")`。
- **替代**：路径用 `cmake_path()`；文件用 `file(READ/WRITE)`。
- **高级**：结合 `list()` 处理列表；哈希用于校验。

这个教程覆盖官方核心子命令。如果你需要特定子命令扩展、更多示例或集成到项目，告诉我！